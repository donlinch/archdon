<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片投票遊戲</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 24px;
        }
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        .option {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            aspect-ratio: 1 / 1; /* 維持正方形比例 */
            background-color: #f8f9fa; /* 圖片非正方形時的背景 */
            display: flex; /* 使內部 img 可以更好地居中 */
            align-items: center; /* 垂直居中 img */
            justify-content: center; /* 水平居中 img */
        }
        .option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .option .zoom-icon { /* 放大鏡圖示樣式 */
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10; /* 確保在圖片之上 */
        }
        .option:hover .zoom-icon {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .option img {
            width: 100%;
            height: 100%; /* 讓圖片填滿父容器的高度 */
            object-fit: contain; /* 完整顯示圖片，不裁切 */
            display: block;
            max-width: 100%; /* 確保圖片不會超出容器寬度 */
            max-height: 100%; /* 確保圖片不會超出容器高度 */
        }
        .option.selected {
            border: 4px solid #3498db;
            box-shadow: 0 0 0 4px #3498db, 0 5px 15px rgba(0, 0, 0, 0.2); /* 讓邊框更明顯 */
        }
        .option-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 1.1em;
        }
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 auto;
            display: block;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            display: none; /* 初始隱藏 */
            width: 100%;
            margin-top: 30px;
        }
        .results h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .result-item {
            margin-bottom: 15px;
        }
        .result-label {
            display: flex;
            justify-content: space-between;
            align-items: center; /* 新增：垂直居中對齊 */
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .result-item-image { /* 新增：結果項目圖片樣式 */
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        .progress-bar {
            height: 24px;
            border-radius: 12px;
            background-color: #eaeaea;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0;
            transition: width 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .thank-you {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #27ae60;
            font-weight: bold;
            display: none; /* 初始隱藏 */
        }
        .restart-button {
            background-color: #2ecc71;
            margin-top: 20px;
        }
        .restart-button:hover {
            background-color: #27ae60;
        }

        /* Lightbox 樣式 */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
        }
        .lightbox-content {
            position: relative;
            margin: auto;
            padding: 0;
            max-width: 95vw; /* 增加視窗寬度的最大佔比 */
            max-height: 95vh; /* 增加視窗高度的最大佔比 */
        }
        .lightbox-content img {
            display: block;
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            margin: auto;
        }
        .lightbox-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .lightbox-close:hover,
        .lightbox-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* 響應式設計：單欄 */
        @media (max-width: 600px) {
            .options {
                grid-template-columns: repeat(2, 1fr); /* 手機上也維持一排兩個 */
                gap: 10px; /* 縮小手機上的間距 */
            }
            /* .option img 的高度將由 aspect-ratio 控制，此處無需特別設定 height */
        }

        /* 設定按鈕 (FAB) */
        .settings-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            line-height: 50px; /* 垂直居中圖示 */
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1005; /* 高於 lightbox */
            transition: background-color 0.3s;
        }
        .settings-fab:hover {
            background-color: #2980b9;
        }

        /* 抽屜樣式 */
        .drawer {
            position: fixed;
            top: 0;
            right: -350px; /* 初始位置在螢幕外，寬度為350px */
            width: 350px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1010; /* 最高層級 */
            transition: right 0.3s ease-in-out;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .drawer.open {
            right: 0; /* 滑入螢幕 */
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .drawer-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #2c3e50;
        }
        .drawer-close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .drawer-close-button:hover {
            color: #2c3e50;
        }
        .drawer-content {
            flex-grow: 1;
            overflow-y: auto; /* 如果內容過多則滾動 */
        }
        .drawer-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .drawer-item-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-item-list li:last-child {
            border-bottom: none;
        }
        .drawer-item-list .edit-item-button {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .drawer-item-list .edit-item-button:hover {
            background-color: #bdc3c7;
        }
        .drawer-add-new-button { /* 與主頁面 .button 樣式類似，但可能需要微調 */
            margin-top: 20px;
            width: 100%;
        }

        /* 抽屜覆蓋層 */
        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1009; /* 低於抽屜，高於設定按鈕和 lightbox */
        }
        .drawer-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <button id="settings-fab" class="settings-fab">⚙️</button>

    <div id="settings-drawer" class="drawer">
        <div class="drawer-header">
            <h2>管理投票項目</h2>
            <button id="close-drawer-button" class="drawer-close-button">&times;</button>
        </div>
        <div class="drawer-content">
            <ul id="drawer-item-list" class="drawer-item-list">
                <!-- 範例項目，之後會由 JS 動態生成 -->
                <li><span>可愛狗狗</span> <button class="edit-item-button">編輯</button></li>
                <li><span>美味蛋糕</span> <button class="edit-item-button">編輯</button></li>
                <li><span>創意甜點</span> <button class="edit-item-button">編輯</button></li>
                <li><span>精緻小點</span> <button class="edit-item-button">編輯</button></li>
            </ul>
            <button id="drawer-add-new-button" class="button drawer-add-new-button">新增項目</button>
        </div>
    </div>
    <div id="drawer-overlay" class="drawer-overlay"></div>

    <div class="container">
        <div id="campaign-selection-area">
            <h1>選擇一個投票活動</h1>
            <ul id="campaign-list">
                <!-- 投票活動標題將由 JS 動態載入 -->
            </ul>
        </div>

        <div id="vote-area" style="display: none;">
            <button id="back-to-campaigns-button" class="button" style="margin-bottom: 15px; background-color: #7f8c8d;">返回活動列表</button>
            <h1 id="vote-title"></h1>
            <div class="options">
                <!-- 投票選項將由 JS 動態載入 -->
            </div>
            <button id="vote-button" class="button" disabled>投票</button>
            
            <div class="results">
                <h2>投票結果</h2>
                <!-- 結果項目會由 JavaScript 動態生成或更新 -->
            </div>
            <div class="thank-you">感謝您的投票！</div>
            <button id="restart-button" class="button restart-button" style="display: none;">再次投票</button>
        </div>
    </div>

    <!-- Lightbox HTML 結構 -->
    <div id="myLightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-content">
            <img id="lightboxImg" src="#" alt="Lightbox Image">
        </div>
    </div>

    <script>
        // API 基礎路徑 (如果您的 API 不是在同一個域名下，需要填寫完整路徑)
        const API_BASE_URL = '/api/voit'; // 假設的 API 路徑

        let currentCampaignData = null; // 當前選擇的投票活動數據 (從 API 獲取)
        // campaignVotes 將不再由前端維護，而是從 API 獲取結果

        document.addEventListener('DOMContentLoaded', function() {
            const campaignSelectionArea = document.getElementById('campaign-selection-area');
            const campaignListUl = document.getElementById('campaign-list');
            const voteArea = document.getElementById('vote-area');
            const voteTitleH1 = document.getElementById('vote-title');
            const optionsContainer = voteArea.querySelector('.options');
            const voteButton = document.getElementById('vote-button');
            const resultsDiv = voteArea.querySelector('.results');
            const thankYouMessage = voteArea.querySelector('.thank-you');
            const restartButton = document.getElementById('restart-button');
            const backToCampaignsButton = document.getElementById('back-to-campaigns-button');
            
            const lightbox = document.getElementById('myLightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            const closeLightboxButton = document.querySelector('.lightbox-close');

            const settingsFab = document.getElementById('settings-fab');
            const settingsDrawer = document.getElementById('settings-drawer');
            const closeDrawerButton = document.getElementById('close-drawer-button');
            const drawerOverlay = document.getElementById('drawer-overlay');
            
            let selectedOptionId = null;

            async function renderCampaignList() {
                campaignListUl.innerHTML = '<li>載入中...</li>';
                try {
                    const response = await fetch(`${API_BASE_URL}/campaigns`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const campaigns = await response.json();
                    
                    campaignListUl.innerHTML = ''; // 清空列表
                    if (campaigns && campaigns.length > 0) {
                        campaigns.forEach(campaign => {
                            const listItem = document.createElement('li');
                            // API 回應的 campaign 物件應有 campaign_id 和 title 欄位
                            listItem.textContent = campaign.title;
                            listItem.style.cursor = 'pointer';
                            listItem.style.padding = '10px';
                            listItem.style.borderBottom = '1px solid #eee';
                            listItem.addEventListener('click', () => loadCampaign(campaign.campaign_id));
                            campaignListUl.appendChild(listItem);
                        });
                    } else {
                        campaignListUl.innerHTML = '<li>目前沒有可投票的活動。</li>';
                    }
                } catch (error) {
                    console.error("無法獲取投票活動列表:", error);
                    campaignListUl.innerHTML = '<li>無法載入投票活動，請稍後再試。</li>';
                }
                campaignSelectionArea.style.display = 'block';
                voteArea.style.display = 'none';
            }

            async function loadCampaign(campaignId) {
                optionsContainer.innerHTML = '<p>載入投票選項中...</p>';
                voteTitleH1.textContent = '載入中...';
                campaignSelectionArea.style.display = 'none';
                voteArea.style.display = 'block'; // 先顯示 voteArea 讓使用者看到載入狀態

                try {
                    const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    currentCampaignData = await response.json(); // API 回應應包含 title 和 options 陣列
                    
                    if (!currentCampaignData || !currentCampaignData.options) {
                        throw new Error('無效的活動數據格式');
                    }

                    selectedOptionId = null;
                    voteButton.disabled = true;
                    resultsDiv.style.display = 'none';
                    thankYouMessage.style.display = 'none';
                    restartButton.style.display = 'none';
                    optionsContainer.style.display = 'grid';
                    voteButton.style.display = 'block';

                    voteTitleH1.textContent = currentCampaignData.title;
                    optionsContainer.innerHTML = '';

                    currentCampaignData.options.forEach(opt => { // API 回應的 option 物件應有 option_id, name, image_url
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option';
                        optionDiv.setAttribute('data-id', opt.option_id);
                        optionDiv.setAttribute('data-name', opt.name);

                        const zoomIconSpan = document.createElement('span');
                        zoomIconSpan.className = 'zoom-icon';
                        zoomIconSpan.innerHTML = '&#128269;';
                        
                        const imgElement = document.createElement('img');
                        imgElement.src = opt.image_url;
                        imgElement.alt = opt.name;

                        const optionContentDiv = document.createElement('div');
                        optionContentDiv.className = 'option-content';
                        optionContentDiv.textContent = opt.name;
                        
                        optionContentDiv.style.display = 'none';
                        imgElement.onload = () => { optionContentDiv.style.display = 'none'; };
                        imgElement.onerror = () => { optionContentDiv.style.display = 'block'; };
                        if (imgElement.complete && imgElement.naturalHeight !== 0) optionContentDiv.style.display = 'none';
                        else if (imgElement.complete && imgElement.naturalHeight === 0) optionContentDiv.style.display = 'block';

                        optionDiv.appendChild(zoomIconSpan);
                        optionDiv.appendChild(imgElement);
                        optionDiv.appendChild(optionContentDiv);
                        optionsContainer.appendChild(optionDiv);

                        optionDiv.addEventListener('click', function() {
                            if (voteButton.style.display === 'none') return;
                            document.querySelectorAll('#vote-area .option').forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                            selectedOptionId = this.getAttribute('data-id');
                            voteButton.disabled = false;
                        });

                        zoomIconSpan.addEventListener('click', (event) => {
                            event.stopPropagation();
                            lightboxImg.src = imgElement.src;
                            lightbox.style.display = 'flex';
                        });
                    });
                    
                    initializeResultsStructureForCampaign();

                } catch (error) {
                    console.error(`無法載入投票活動 ${campaignId}:`, error);
                    voteTitleH1.textContent = '錯誤';
                    optionsContainer.innerHTML = `<p>無法載入投票選項，請<a href="#" onclick="loadCampaign(${campaignId}); return false;">重試</a>或返回活動列表。</p>`;
                }
            }
            
            backToCampaignsButton.addEventListener('click', renderCampaignList);

            function initializeResultsStructureForCampaign() {
                resultsDiv.innerHTML = '<h2>投票結果</h2>';
                if (!currentCampaignData || !currentCampaignData.options) return;

                currentCampaignData.options.forEach(opt => {
                    const resultItemHTML = `
                        <div class="result-item" data-result-id="${opt.option_id}">
                            <div class="result-label">
                                <div>
                                    <img src="${opt.image_url}" alt="${opt.name}" class="result-item-image">
                                    <span>${opt.name}</span>
                                </div>
                                <span class="percentage">0% (0票)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress" id="progress-${currentCampaignData.campaign_id}-${opt.option_id}">0%</div>
                            </div>
                        </div>
                    `;
                    resultsDiv.insertAdjacentHTML('beforeend', resultItemHTML);
                });
            }
            
            voteButton.addEventListener('click', async function() {
                if (selectedOptionId && currentCampaignData) {
                    voteButton.disabled = true;
                    voteButton.textContent = '投票中...';
                    try {
                        const response = await fetch(`${API_BASE_URL}/campaigns/${currentCampaignData.campaign_id}/vote`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ option_id: selectedOptionId })
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({message: '投票失敗，請稍後再試'}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        // 投票成功，顯示結果
                        optionsContainer.style.display = 'none';
                        voteButton.style.display = 'none';
                        resultsDiv.style.display = 'block';
                        thankYouMessage.style.display = 'block';
                        restartButton.style.display = 'block';
                        showResultsForCampaign(); // 從 API 獲取最新結果
                    } catch (error) {
                        console.error("投票失敗:", error);
                        alert(`投票失敗：${error.message}`);
                    } finally {
                        voteButton.disabled = false;
                        voteButton.textContent = '投票';
                    }
                }
            });

            async function showResultsForCampaign() {
                if (!currentCampaignData) return;
                resultsDiv.innerHTML = '<h2>投票結果</h2><p>載入結果中...</p>'; // 先顯示載入中

                try {
                    const response = await fetch(`${API_BASE_URL}/campaigns/${currentCampaignData.campaign_id}/results`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const resultsData = await response.json(); // 預期格式 { option_id_1: count1, option_id_2: count2, ... }

                    initializeResultsStructureForCampaign(); // 重新繪製結果區基本結構

                    let totalVotes = 0;
                    currentCampaignData.options.forEach(opt => {
                        totalVotes += (resultsData[opt.option_id] || 0);
                    });
                
                    currentCampaignData.options.forEach((opt, index) => {
                        const votesForOption = resultsData[opt.option_id] || 0;
                        const percentage = totalVotes > 0 ? ((votesForOption / totalVotes) * 100) : 0;
                        
                        const resultItem = resultsDiv.querySelector(`.result-item[data-result-id="${opt.option_id}"]`);
                        if (resultItem) {
                            const progressBar = resultItem.querySelector(`#progress-${currentCampaignData.campaign_id}-${opt.option_id}`);
                            const percentageSpan = resultItem.querySelector('.percentage');
                            
                            setTimeout(() => {
                                progressBar.style.width = `${percentage.toFixed(1)}%`;
                                progressBar.textContent = `${percentage.toFixed(1)}%`;
                                percentageSpan.textContent = `${percentage.toFixed(1)}% (${votesForOption}票)`;
                            }, 50 * (index + 1)); // 稍微加快動畫
                        }
                    });
                } catch (error) {
                     console.error("無法獲取投票結果:", error);
                     resultsDiv.innerHTML = '<h2>投票結果</h2><p>無法載入結果，請稍後再試。</p>';
                }
            }
            
            restartButton.addEventListener('click', function() {
                if (!currentCampaignData) return;
                loadCampaign(currentCampaignData.campaign_id);
            });

            // Lightbox 關閉邏輯
            if (closeLightboxButton) {
                closeLightboxButton.addEventListener('click', () => { lightbox.style.display = 'none'; });
            }
            if (lightbox) {
                lightbox.addEventListener('click', (event) => {
                    if (event.target === lightbox) { lightbox.style.display = 'none'; }
                });
            }

            // 設定抽屜開關邏輯
            if (settingsFab && settingsDrawer && closeDrawerButton && drawerOverlay) {
                settingsFab.addEventListener('click', () => {
                    settingsDrawer.classList.add('open');
                    drawerOverlay.classList.add('active');
                });
                function closeDrawer() {
                    settingsDrawer.classList.remove('open');
                    drawerOverlay.classList.remove('active');
                }
                closeDrawerButton.addEventListener('click', closeDrawer);
                drawerOverlay.addEventListener('click', closeDrawer);
            }
            
            renderCampaignList(); // 初始渲染活動列表
        });
    </script>
</body>
</html>