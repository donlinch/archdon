<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片投票遊戲</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 24px;
        }
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        .option {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            aspect-ratio: 1 / 1; /* 維持正方形比例 */
            background-color: #f8f9fa; /* 圖片非正方形時的背景 */
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .option .zoom-icon { 
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10; 
        }
        .option:hover .zoom-icon {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .option img {
            width: 100%;
            height: 100%; 
            object-fit: contain; 
            display: block;
            max-width: 100%; 
            max-height: 100%; 
        }
        .option.selected {
            border: 4px solid #3498db;
            box-shadow: 0 0 0 4px #3498db, 0 5px 15px rgba(0, 0, 0, 0.2); 
        }
        .option-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 1.1em;
        }
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 auto;
            display: block;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            display: none; 
            width: 100%;
            margin-top: 30px;
        }
        .results h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .result-item {
            margin-bottom: 15px;
        }
        .result-label {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .result-item-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
            vertical-align: middle;
        }
        .result-item-no-image { 
            display: inline-block;
            width: 40px; 
            height: 1px; 
            margin-right: 10px; 
        }
        .progress-bar {
            height: 24px;
            border-radius: 12px;
            background-color: #eaeaea;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0;
            transition: width 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .thank-you {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #27ae60;
            font-weight: bold;
            display: none; 
        }
        .restart-button {
            background-color: #2ecc71;
            margin-top: 20px;
        }
        .restart-button:hover {
            background-color: #27ae60;
        }

        /* Lightbox 樣式 */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
        }
        .lightbox-content {
            position: relative;
            margin: auto;
            padding: 0;
            max-width: 95vw; 
            max-height: 95vh; 
        }
        .lightbox-content img {
            display: block;
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            margin: auto;
        }
        .lightbox-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .lightbox-close:hover,
        .lightbox-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .options {
                grid-template-columns: repeat(2, 1fr); 
                gap: 10px; 
            }
        }

        .settings-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            line-height: 50px; 
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1005; 
            transition: background-color 0.3s;
        }
        .settings-fab:hover {
            background-color: #2980b9;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: -350px; 
            width: 350px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1010; 
            transition: right 0.3s ease-in-out;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .drawer.open {
            right: 0; 
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .drawer-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #2c3e50;
        }
        .drawer-close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .drawer-close-button:hover {
            color: #2c3e50;
        }
        .drawer-content {
            flex-grow: 1;
            overflow-y: auto; 
        }
        .drawer-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .drawer-item-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-item-list li:last-child {
            border-bottom: none;
        }
        .drawer-item-list .edit-item-button {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .drawer-item-list .edit-item-button:hover {
            background-color: #bdc3c7;
        }
        .drawer-add-new-button { 
            margin-top: 20px;
            width: 100%;
        }

        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1009; 
        }
        .drawer-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <button id="settings-fab" class="settings-fab">⚙️</button>

    <div id="settings-drawer" class="drawer">
        <div class="drawer-header">
            <h2>管理投票項目</h2>
            <button id="close-drawer-button" class="drawer-close-button">&times;</button>
        </div>
        <div class="drawer-content">
            <ul id="drawer-item-list" class="drawer-item-list">
                <li><span>可愛狗狗</span> <button class="edit-item-button">編輯</button></li>
                <li><span>美味蛋糕</span> <button class="edit-item-button">編輯</button></li>
                <li><span>創意甜點</span> <button class="edit-item-button">編輯</button></li>
                <li><span>精緻小點</span> <button class="edit-item-button">編輯</button></li>
            </ul>
            <button id="drawer-add-new-button" class="button drawer-add-new-button">新增項目</button>
        </div>
    </div>
    <div id="drawer-overlay" class="drawer-overlay"></div>

    <div class="container">
        <div id="campaign-selection-area">
            <h1>選擇一個投票活動</h1>
            <ul id="campaign-list">
            </ul>
        </div>

        <div id="vote-area" style="display: none;">
            <button id="back-to-campaigns-button" class="button" style="margin-bottom: 15px; background-color: #7f8c8d;">返回活動列表</button>
            <h1 id="vote-title"></h1>
            <div class="options">
            </div>
            <button id="vote-button" class="button" disabled>投票</button>
            
            <div class="results">
                <h2>投票結果</h2>
            </div>
            <div class="thank-you">感謝您的投票！</div>
            <button id="restart-button" class="button restart-button" style="display: none;">再次投票</button>
        </div>
    </div>

    <div id="myLightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-content">
            <img id="lightboxImg" src="#" alt="Lightbox Image">
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/voit'; 

        let currentCampaignData = null; 

        document.addEventListener('DOMContentLoaded', function() {
            const campaignSelectionArea = document.getElementById('campaign-selection-area');
            const campaignListUl = document.getElementById('campaign-list');
            const voteArea = document.getElementById('vote-area');
            const voteTitleH1 = document.getElementById('vote-title');
            const optionsContainer = voteArea.querySelector('.options');
            const voteButton = document.getElementById('vote-button');
            const resultsDiv = voteArea.querySelector('.results');
            const thankYouMessage = voteArea.querySelector('.thank-you');
            const restartButton = document.getElementById('restart-button');
            const backToCampaignsButton = document.getElementById('back-to-campaigns-button');
            
            const lightbox = document.getElementById('myLightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            const closeLightboxButton = document.querySelector('.lightbox-close');

            const settingsFab = document.getElementById('settings-fab');
            const settingsDrawer = document.getElementById('settings-drawer');
            const closeDrawerButton = document.getElementById('close-drawer-button');
            const drawerOverlay = document.getElementById('drawer-overlay');
            const drawerContent = settingsDrawer.querySelector('.drawer-content'); 
            const drawerItemList = document.getElementById('drawer-item-list'); 
            const drawerAddNewButton = document.getElementById('drawer-add-new-button'); 
            
            let selectedOptionId = null;

            async function renderCampaignList() {
                campaignListUl.innerHTML = '<li>載入中...</li>';
                try {
                    const response = await fetch(`${API_BASE_URL}/campaigns`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const campaigns = await response.json();
                    
                    campaignListUl.innerHTML = ''; 
                    if (campaigns && campaigns.length > 0) {
                        campaigns.forEach(campaign => {
                            const listItem = document.createElement('li');
                            listItem.textContent = campaign.title;
                            listItem.style.cursor = 'pointer';
                            listItem.style.padding = '10px';
                            listItem.style.borderBottom = '1px solid #eee';
                            listItem.addEventListener('click', () => loadCampaign(campaign.campaign_id));
                            campaignListUl.appendChild(listItem);
                        });
                    } else {
                        campaignListUl.innerHTML = '<li>目前沒有可投票的活動。</li>';
                    }
                } catch (error) {
                    console.error("無法獲取投票活動列表:", error);
                    campaignListUl.innerHTML = '<li>無法載入投票活動，請稍後再試。</li>';
                }
                campaignSelectionArea.style.display = 'block';
                voteArea.style.display = 'none';
            }

            async function loadCampaign(campaignId) {
                optionsContainer.innerHTML = '<p>載入投票選項中...</p>';
                voteTitleH1.textContent = '載入中...';
                campaignSelectionArea.style.display = 'none';
                voteArea.style.display = 'block'; 

                try {
                    const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    currentCampaignData = await response.json(); 
                    
                    if (!currentCampaignData || !currentCampaignData.options) {
                        throw new Error('無效的活動數據格式');
                    }

                    voteTitleH1.textContent = currentCampaignData.title;
                    optionsContainer.innerHTML = ''; // 清空舊選項
                    selectedOptionId = null;
                    voteButton.disabled = true;

                    if (currentCampaignData.currentUserHasVoted) {
                        // 用戶已投票，直接顯示結果
                        optionsContainer.style.display = 'none';
                        voteButton.style.display = 'none';
                        resultsDiv.style.display = 'block';
                        thankYouMessage.textContent = '您已對此活動投過票。';
                        thankYouMessage.style.display = 'block';
                        restartButton.textContent = '查看/刷新結果'; // 可以考慮更改按鈕文字
                        restartButton.style.display = 'block';
                        showResultsForCampaign();
                    } else {
                        // 用戶未投票，顯示投票選項
                        resultsDiv.style.display = 'none';
                        thankYouMessage.style.display = 'none';
                        restartButton.style.display = 'none';
                        optionsContainer.style.display = 'grid';
                        voteButton.style.display = 'block';
                        voteButton.textContent = '投票'; // 確保按鈕文字正確
                        
                        currentCampaignData.options.forEach(opt => {
                            const optionDiv = document.createElement('div');
                            optionDiv.className = 'option';
                            optionDiv.setAttribute('data-id', opt.option_id);
                            optionDiv.setAttribute('data-name', opt.name);

                            const optionContentDiv = document.createElement('div');
                            optionContentDiv.className = 'option-content';
                            optionContentDiv.textContent = opt.name;

                            if (opt.image_url && opt.image_url.trim() !== '') {
                                const zoomIconSpan = document.createElement('span');
                                zoomIconSpan.className = 'zoom-icon';
                                zoomIconSpan.innerHTML = '&#128269;';
                                
                                const imgElement = document.createElement('img');
                                imgElement.src = opt.image_url;
                                imgElement.alt = opt.name;
                                
                                imgElement.onerror = () => {
                                    if(zoomIconSpan.parentNode) zoomIconSpan.remove();
                                    optionContentDiv.style.position = 'static';
                                    optionContentDiv.style.background = 'transparent';
                                    optionContentDiv.style.color = '#555';
                                    optionContentDiv.style.height = '100%';
                                    optionContentDiv.style.display = 'flex';
                                    optionContentDiv.style.alignItems = 'center';
                                    optionContentDiv.style.justifyContent = 'center';
                                    optionDiv.style.backgroundColor = '#f0f0f0';
                                    imgElement.remove();
                                };
                                if (imgElement.complete && imgElement.naturalHeight === 0 && imgElement.src) {
                                    imgElement.onerror();
                                }

                                optionDiv.appendChild(zoomIconSpan);
                                optionDiv.appendChild(imgElement);
                                optionDiv.appendChild(optionContentDiv);

                                zoomIconSpan.addEventListener('click', (event) => {
                                    event.stopPropagation();
                                    if(imgElement.src && imgElement.naturalHeight !== 0) {
                                        lightboxImg.src = imgElement.src;
                                        lightbox.style.display = 'flex';
                                    }
                                });
                            } else {
                                optionContentDiv.style.position = 'static';
                                optionContentDiv.style.background = 'transparent';
                                optionContentDiv.style.color = '#333';
                                optionContentDiv.style.height = '100%';
                                optionContentDiv.style.display = 'flex';
                                optionContentDiv.style.alignItems = 'center';
                                optionContentDiv.style.justifyContent = 'center';
                                optionContentDiv.style.padding = '10px';
                                optionDiv.style.backgroundColor = '#e9ecef';
                                optionDiv.appendChild(optionContentDiv);
                            }
                            
                            optionsContainer.appendChild(optionDiv);

                            optionDiv.addEventListener('click', function() {
                                if (voteButton.style.display === 'none') return;
                                document.querySelectorAll('#vote-area .option').forEach(o => o.classList.remove('selected'));
                                this.classList.add('selected');
                                selectedOptionId = this.getAttribute('data-id');
                                voteButton.disabled = false;
                            });
                        });
                    }
                    
                    initializeResultsStructureForCampaign(); // 總是在加載活動後初始化結果區結構，即使是已投票狀態

                } catch (error) {
                    console.error(`無法載入投票活動 ${campaignId}:`, error);
                    voteTitleH1.textContent = '錯誤';
                    optionsContainer.innerHTML = `<p>無法載入投票選項，請<a href="#" onclick="loadCampaign(${campaignId}); return false;">重試</a>或返回活動列表。</p>`;
                }
            }
            
            backToCampaignsButton.addEventListener('click', renderCampaignList);

            function initializeResultsStructureForCampaign() {
                resultsDiv.innerHTML = '<h2>投票結果</h2>'; // 確保先清空並設置標題
                if (!currentCampaignData || !currentCampaignData.options) return;
                    optionsContainer.innerHTML = '';

                    currentCampaignData.options.forEach(opt => { 
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option';
                        optionDiv.setAttribute('data-id', opt.option_id);
                        optionDiv.setAttribute('data-name', opt.name);

                        const optionContentDiv = document.createElement('div');
                        optionContentDiv.className = 'option-content';
                        optionContentDiv.textContent = opt.name;

                        if (opt.image_url && opt.image_url.trim() !== '') {
                            const zoomIconSpan = document.createElement('span');
                            zoomIconSpan.className = 'zoom-icon';
                            zoomIconSpan.innerHTML = '&#128269;';
                            
                            const imgElement = document.createElement('img');
                            imgElement.src = opt.image_url;
                            imgElement.alt = opt.name;
                            
                            imgElement.onerror = () => { 
                                if(zoomIconSpan.parentNode) zoomIconSpan.remove(); 
                                optionContentDiv.style.position = 'static';
                                optionContentDiv.style.background = 'transparent';
                                optionContentDiv.style.color = '#555'; 
                                optionContentDiv.style.height = '100%';
                                optionContentDiv.style.display = 'flex';
                                optionContentDiv.style.alignItems = 'center';
                                optionContentDiv.style.justifyContent = 'center';
                                optionDiv.style.backgroundColor = '#f0f0f0'; 
                                imgElement.remove(); 
                            };
                            if (imgElement.complete && imgElement.naturalHeight === 0 && imgElement.src) {
                                imgElement.onerror(); 
                            }

                            optionDiv.appendChild(zoomIconSpan);
                            optionDiv.appendChild(imgElement);
                            optionDiv.appendChild(optionContentDiv); 

                            zoomIconSpan.addEventListener('click', (event) => {
                                event.stopPropagation();
                                if(imgElement.src && imgElement.naturalHeight !== 0) { 
                                    lightboxImg.src = imgElement.src;
                                    lightbox.style.display = 'flex';
                                }
                            });
                        } else {
                            optionContentDiv.style.position = 'static';
                            optionContentDiv.style.background = 'transparent';
                            optionContentDiv.style.color = '#333';
                            optionContentDiv.style.height = '100%';
                            optionContentDiv.style.display = 'flex';
                            optionContentDiv.style.alignItems = 'center';
                            optionContentDiv.style.justifyContent = 'center';
                            optionContentDiv.style.padding = '10px';
                            optionDiv.style.backgroundColor = '#e9ecef'; 
                            optionDiv.appendChild(optionContentDiv);
                        }
                        
                        optionsContainer.appendChild(optionDiv);

                        optionDiv.addEventListener('click', function() {
                            if (voteButton.style.display === 'none') return;
                            document.querySelectorAll('#vote-area .option').forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                            selectedOptionId = this.getAttribute('data-id');
                            voteButton.disabled = false;
                        });
                    });
                    
                    initializeResultsStructureForCampaign();

                } catch (error) {
                    console.error(`無法載入投票活動 ${campaignId}:`, error);
                    voteTitleH1.textContent = '錯誤';
                    optionsContainer.innerHTML = `<p>無法載入投票選項，請<a href="#" onclick="loadCampaign(${campaignId}); return false;">重試</a>或返回活動列表。</p>`;
                }
            }
            
            backToCampaignsButton.addEventListener('click', renderCampaignList);

            function initializeResultsStructureForCampaign() {
                resultsDiv.innerHTML = '<h2>投票結果</h2>';
                if (!currentCampaignData || !currentCampaignData.options) return;

                currentCampaignData.options.forEach(opt => {
                    const resultItemHTML = `
                        <div class="result-item" data-result-id="${opt.option_id}">
                            <div class="result-label">
                                <div>
                                    ${opt.image_url ? `<img src="${opt.image_url}" alt="${opt.name}" class="result-item-image">` : '<span class="result-item-no-image"></span>'}
                                    <span>${opt.name}</span>
                                </div>
                                <span class="percentage">0% (0票)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress" id="progress-${currentCampaignData.campaign_id}-${opt.option_id}">0%</div>
                            </div>
                        </div>
                    `;
                    resultsDiv.insertAdjacentHTML('beforeend', resultItemHTML);
                });
            }
            
            voteButton.addEventListener('click', async function() {
                if (selectedOptionId && currentCampaignData) {
                    voteButton.disabled = true;
                    voteButton.textContent = '投票中...';
                    try {
                        const response = await fetch(`${API_BASE_URL}/campaigns/${currentCampaignData.campaign_id}/vote`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ option_id: selectedOptionId })
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({message: '投票失敗，請稍後再試'}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        optionsContainer.style.display = 'none';
                        voteButton.style.display = 'none';
                        resultsDiv.style.display = 'block';
                        thankYouMessage.style.display = 'block';
                        restartButton.style.display = 'block';
                        showResultsForCampaign(); 
                    } catch (error) {
                        console.error("投票失敗:", error);
                        alert(`投票失敗：${error.message}`);
                    } finally {
                        voteButton.disabled = false;
                        voteButton.textContent = '投票';
                    }
                }
            });

            async function showResultsForCampaign() {
                if (!currentCampaignData) return;
                resultsDiv.innerHTML = '<h2>投票結果</h2><p>載入結果中...</p>'; 

                try {
                    const response = await fetch(`${API_BASE_URL}/campaigns/${currentCampaignData.campaign_id}/results`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const resultsData = await response.json(); 

                    initializeResultsStructureForCampaign(); 

                    let totalVotes = 0;
                    currentCampaignData.options.forEach(opt => {
                        totalVotes += (resultsData[opt.option_id] || 0);
                    });
                
                    currentCampaignData.options.forEach((opt, index) => {
                        const votesForOption = resultsData[opt.option_id] || 0;
                        const percentage = totalVotes > 0 ? ((votesForOption / totalVotes) * 100) : 0;
                        
                        const resultItem = resultsDiv.querySelector(`.result-item[data-result-id="${opt.option_id}"]`);
                        if (resultItem) {
                            const progressBar = resultItem.querySelector(`#progress-${currentCampaignData.campaign_id}-${opt.option_id}`);
                            const percentageSpan = resultItem.querySelector('.percentage');
                            
                            setTimeout(() => {
                                progressBar.style.width = `${percentage.toFixed(1)}%`;
                                progressBar.textContent = `${percentage.toFixed(1)}%`;
                                percentageSpan.textContent = `${percentage.toFixed(1)}% (${votesForOption}票)`;
                            }, 50 * (index + 1)); 
                        }
                    });
                } catch (error) {
                     console.error("無法獲取投票結果:", error);
                     resultsDiv.innerHTML = '<h2>投票結果</h2><p>無法載入結果，請稍後再試。</p>';
                }
            }
            
            restartButton.addEventListener('click', function() {
                if (!currentCampaignData) return;
                loadCampaign(currentCampaignData.campaign_id);
            });

            if (closeLightboxButton) {
                closeLightboxButton.addEventListener('click', () => { lightbox.style.display = 'none'; });
            }
            if (lightbox) {
                lightbox.addEventListener('click', (event) => {
                    if (event.target === lightbox) { lightbox.style.display = 'none'; }
                });
            }

            if (settingsFab && settingsDrawer && closeDrawerButton && drawerOverlay) {
                settingsFab.addEventListener('click', () => {
                    settingsDrawer.classList.add('open');
                    drawerOverlay.classList.add('active');
                });
                function closeDrawer() {
                    settingsDrawer.classList.remove('open');
                    drawerOverlay.classList.remove('active');
                    showDefaultDrawerContent(); 
                }
                closeDrawerButton.addEventListener('click', closeDrawer);
                drawerOverlay.addEventListener('click', closeDrawer);

                function showDefaultDrawerContent() {
                    if (!drawerContent) return; 
                    drawerContent.innerHTML = `
                        <ul id="drawer-item-list" class="drawer-item-list">
                            <li><span>(此處將顯示現有投票活動列表)</span></li>
                        </ul>
                        <button id="drawer-add-new-button" class="button drawer-add-new-button">新增投票活動</button>
                    `;
                    const newDrawerButton = document.getElementById('drawer-add-new-button');
                    if (newDrawerButton) {
                        newDrawerButton.addEventListener('click', showAddNewCampaignForm);
                    }
                }

                function showAddNewCampaignForm() {
                    if (!drawerContent) return;
                    drawerContent.innerHTML = `
                        <h3>新增投票活動</h3>
                        <form id="add-campaign-form" style="display: flex; flex-direction: column; gap: 10px;">
                            <div>
                                <label for="new-campaign-title" style="display: block; margin-bottom: 5px;">活動標題:</label>
                                <input type="text" id="new-campaign-title" name="title" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label for="new-campaign-description" style="display: block; margin-bottom: 5px;">活動描述 (可選):</label>
                                <textarea id="new-campaign-description" name="description" style="width: 100%; padding: 8px; box-sizing: border-box; min-height: 60px;"></textarea>
                            </div>
                            <div>
                                <label for="new-campaign-password" style="display: block; margin-bottom: 5px;">編輯密碼 (4-6位):</label>
                                <input type="password" id="new-campaign-password" name="edit_password" required minlength="4" maxlength="6" style="width: 100%; padding: 8px; box-sizing: border-box;">
                            </div>
                            <h4>投票選項 (至少1個)</h4>
                            <div id="new-campaign-options-container">
                                <div class="campaign-option-input-group" style="margin-bottom:10px; padding-bottom:10px; border-bottom: 1px dashed #ccc;">
                                    <label style="display:block; margin-bottom:3px;">選項 1 名稱:</label>
                                    <input type="text" name="option_name[]" placeholder="選項名稱" required style="width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 5px;">
                                    <label style="display:block; margin-bottom:3px;">選項 1 圖片URL (可選):</label>
                                    <input type="url" name="option_image_url[]" placeholder="圖片URL (可選)" style="width: 100%; padding: 8px; box-sizing: border-box;">
                                </div>
                            </div>
                            <button type="button" id="add-another-option-button" class="button" style="background-color: #5cb85c; width: auto; padding: 8px 12px; font-size: 0.9em;">增加選項</button>
                            <hr style="margin: 15px 0;">
                            <button type="submit" class="button">創建活動</button>
                            <button type="button" id="cancel-add-campaign" class="button" style="background-color: #7f8c8d; margin-top:5px;">取消</button>
                        </form>
                    `;

                    document.getElementById('cancel-add-campaign').addEventListener('click', showDefaultDrawerContent);
                    document.getElementById('add-another-option-button').addEventListener('click', addCampaignOptionInput);
                    document.getElementById('add-campaign-form').addEventListener('submit', handleAddNewCampaignSubmit);
                }

                function addCampaignOptionInput() {
                    const container = document.getElementById('new-campaign-options-container');
                    const optionCount = container.querySelectorAll('.campaign-option-input-group').length + 1;
                    const newInputGroup = document.createElement('div');
                    newInputGroup.className = 'campaign-option-input-group';
                    newInputGroup.style.marginBottom = '10px';
                    newInputGroup.style.paddingBottom = '10px';
                    newInputGroup.style.borderBottom = '1px dashed #ccc';
                    
                    newInputGroup.innerHTML = `
                        <label style="display:block; margin-bottom:3px;">選項 ${optionCount} 名稱:</label>
                        <input type="text" name="option_name[]" placeholder="選項名稱" required style="width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 5px;">
                        <label style="display:block; margin-bottom:3px;">選項 ${optionCount} 圖片URL (可選):</label>
                        <input type="url" name="option_image_url[]" placeholder="圖片URL (可選)" style="width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 5px;">
                        <button type="button" class="remove-option-button" style="color:red; background:transparent; border:none; cursor:pointer; padding: 5px; float:right;">移除此選項</button>
                    `;
                    newInputGroup.querySelector('.remove-option-button').addEventListener('click', function() {
                        this.parentElement.remove();
                    });
                    container.appendChild(newInputGroup);
                }

                async function handleAddNewCampaignSubmit(event) {
                    event.preventDefault();
                    const form = event.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = '創建中...';

                    const title = form.title.value;
                    const description = form.description.value;
                    const edit_password = form.edit_password.value;
                    
                    const optionNames = Array.from(form.querySelectorAll('input[name="option_name[]"]')).map(input => input.value.trim());
                    const optionImageUrls = Array.from(form.querySelectorAll('input[name="option_image_url[]"]')).map(input => input.value.trim());

                    const options = optionNames.map((name, index) => ({
                        name: name,
                        image_url: optionImageUrls[index] 
                    })).filter(opt => opt.name); 

                    if (options.length === 0) {
                        alert('請至少填寫一個完整的投票選項（名稱和圖片URL）。');
                        submitButton.disabled = false;
                        submitButton.textContent = '創建活動';
                        return;
                    }
                     if (edit_password.length < 4 || edit_password.length > 6) {
                        alert('編輯密碼必須是4到6位。');
                        submitButton.disabled = false;
                        submitButton.textContent = '創建活動';
                        return;
                    }

                    const campaignData = { title, description, edit_password, options };
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/campaigns`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(campaignData)
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: '創建失敗，請檢查輸入或伺服器日誌。' }));
                            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                        }
                        alert('投票活動創建成功！');
                        closeDrawer();
                        renderCampaignList();
                    } catch (error) {
                        console.error("創建投票活動失敗:", error);
                        alert(`創建失敗：${error.message}`);
                    } finally {
                        if (form.querySelector('button[type="submit"]')) {
                           form.querySelector('button[type="submit"]').disabled = false;
                           form.querySelector('button[type="submit"]').textContent = '創建活動';
                        }
                    }
                }

                if(drawerAddNewButton) {
                   drawerAddNewButton.addEventListener('click', showAddNewCampaignForm);
                }
            } 
            
            renderCampaignList(); 
        });
    </script>
</body>
</html>