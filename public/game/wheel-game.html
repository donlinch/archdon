<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命運轉盤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: '微軟正黑體', Arial, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 20px;
            overflow-x: hidden;
        }

        h1 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            position: relative;
        }

        .wheel-container {
            position: relative;
            width: 100%;
            /* --- 調整容器寬度，讓指針有空間 --- */
            max-width: 360px; /* 稍微縮小一點，因為指針在上方 */
            margin: 20px auto 20px; /* 上方留出指針空間 */
            min-height: 360px; /* 確保高度 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            display: block;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-out;
            max-width: 100%;
            max-height: 100%;
        }

        .pointer {
            position: absolute;
            /* --- 修改指針位置到頂部 --- */
            top: -10px;          /* 放在容器頂部稍微突出的位置 */
            left: 50%;
            /* --- 水平居中 --- */
            transform: translateX(-50%);
            width: 30px;        /* 調整大小 */
            height: 40px;       /* 調整大小 */
            background-color: #ff5252;
            /* --- 修改指針形狀，使其指向下方 --- */
            clip-path: polygon(50% 100%, 0 0, 100% 0); /* 尖端在下 (y=100%)，底邊在上 (y=0) */
            z-index: 10;
            /* --- 移除之前的 right 和 translateY --- */
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            background-color: #ff5252;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 82, 82, 0.4);
        }

        button:hover {
            background-color: #ff3636;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.6);
        }

        button:active {
            transform: translateY(1px);
        }

        .edit-options-btn {
            background-color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            margin-top: 40px;
        }

        .edit-options-btn:hover {
            background-color: #3e8e41;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
        }

        .result {
            text-align: center;
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            min-height: 36px;
            color: #333;
            transition: transform 0.3s ease-out, color 0.3s;
            transform: scale(1);
        }

        .result.show-result {
            transform: scale(1.15);
            font-weight: bolder;
        }

        /* 彈出視窗樣式 (保持不變) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); overflow: auto; }
        .modal-content { background-color: white; margin: 5% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); animation: modalOpen 0.4s; max-height: 90vh; display: flex; flex-direction: column; }
        @keyframes modalOpen { from {opacity: 0; transform: translateY(-50px);} to {opacity: 1; transform: translateY(0);} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .modal-header h2 { color: #333; margin: 0; }
        .close { color: #888; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: #000; }
        .option-input { display: flex; align-items: center; margin-bottom: 15px; animation: fadeIn 0.3s; padding: 8px; border-radius: 8px; transition: background-color 0.3s; }
        .option-input:hover { background-color: #f5f5f5; }
        .option-input.highlight { background-color: #e8f5e9; animation: highlight 1s ease; }
        @keyframes highlight { 0% { background-color: #4CAF50; } 100% { background-color: #e8f5e9; } }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
        .option-input input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-right: 10px; transition: all 0.3s; }
        .option-input input:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); }
        .color-indicator { width: 25px; height: 25px; border-radius: 50%; margin-right: 10px; border: 1px solid #ddd; flex-shrink: 0; }
        .remove-option { background-color: #f44336; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; border: none; padding: 0; margin-left: 5px; flex-shrink: 0; transition: all 0.3s; }
        .remove-option:hover { background-color: #d32f2f; transform: scale(1.1); }
        .add-option { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 50px; cursor: pointer; font-size: 16px; margin: 10px 0; display: flex; align-items: center; justify-content: center; width: 100%; }
        .add-option:hover { background-color: #3e8e41; }
        .options-container { overflow-y: auto; max-height: 50vh; padding-right: 10px; margin-bottom: 10px; flex: 1; }
        .options-container::-webkit-scrollbar { width: 8px; }
        .options-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .options-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .options-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-footer { margin-top: 20px; text-align: center; }
        .save-options { padding: 12px 30px; background-color: #4CAF50; color: white; border: none; border-radius: 50px; cursor: pointer; font-size: 18px; transition: all 0.3s; width: 100%; }
        .save-options:hover { background-color: #3e8e41; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .no-options { text-align: center; color: #888; padding: 20px; font-style: italic; }

        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 24px; }
            .wheel-container { max-width: 300px; min-height: 320px; margin-top:15px;} /* 調整手機版大小和邊距 */
            .pointer { top: -8px; width: 25px; height: 35px; } /* 調整手機版指針大小和位置 */
            canvas { /* canvas大小由JS控制 */ }
            .modal-content { margin: 5% auto; padding: 15px; width: 95%; max-height: 85vh; }
            .option-input { margin-bottom: 10px; }
            .option-input input { padding: 10px; font-size: 14px; }
            .options-container { max-height: 40vh; }
            button { padding: 10px 20px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <h1>命運轉盤</h1>

    <div class="container">
        <div class="wheel-container">
            <div class="pointer"></div>
            <!-- Canvas 大小 -->
            <canvas id="wheel" width="350" height="350"></canvas>
        </div>

        <button id="spin">開始旋轉</button>

        <div class="result" id="result"></div>
    </div>

    <button id="editOptions" class="edit-options-btn">編輯選項</button>

    <!-- 選項編輯彈出視窗 (HTML 保持不變) -->
    <div id="optionsModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h2>編輯選項</h2>
                 <span class="close">×</span>
             </div>
             <div class="options-container" id="optionsContainer"></div>
             <button id="addOption" class="add-option">+ 新增選項</button>
             <div class="modal-footer">
                 <button class="save-options" id="saveOptions">儲存選項</button>
             </div>
         </div>
     </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const spinBtn = document.getElementById('spin');
            const resultElement = document.getElementById('result');
            const editOptionsBtn = document.getElementById('editOptions');
            const optionsModal = document.getElementById('optionsModal');
            const closeModal = document.querySelector('.close');
            const saveOptionsBtn = document.getElementById('saveOptions');
            const addOptionBtn = document.getElementById('addOption');
            const optionsContainer = document.getElementById('optionsContainer');

            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#7ED321', '#50E3C2',
                '#F8E71C', '#BD10E0', '#8B572A', '#4A90E2'
            ];

            let options = ['吃拉麵', '吃牛排', '吃披薩', '吃漢堡'];
            let spinning = false;
            let currentAngle = 0;
            let spinSpeed = 0;
            let maxSpinTime = 5000;
            let spinStartTime = 0;
            let animationId = null;

            // 渲染轉盤 (文字保持水平)
            function drawWheel() {
                const wheelRadius = canvas.width / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = wheelRadius;
                const centerY = wheelRadius;
                const radius = wheelRadius - 10;

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#ddd';
                ctx.stroke();

                if (options.length === 0) {
                    ctx.fillStyle = '#888';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('請新增選項', centerX, centerY);
                    return;
                }

                const sliceAngle = (2 * Math.PI) / options.length;

                for (let i = 0; i < options.length; i++) {
                    const startAngle = currentAngle + i * sliceAngle;
                    const endAngle = startAngle + sliceAngle;

                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fill();
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.stroke();

                    const text = options[i];
                    const textAngle = startAngle + sliceAngle / 2;
                    let textDistance = radius * 0.65;
                    let fontSize = 14;
                    if (options.length >= 8) { fontSize = 12; textDistance = radius * 0.7; }
                    if (options.length >= 12) { fontSize = 10; textDistance = radius * 0.75; }

                    const textX = centerX + Math.cos(textAngle) * textDistance;
                    const textY = centerY + Math.sin(textAngle) * textDistance;

                    ctx.save();
                    ctx.translate(textX, textY);
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const bgColor = colors[i % colors.length];
                    const brightness = calculateBrightness(bgColor); // 使用下方定義的簡易亮度計算
                    if (brightness > 180) {
                         ctx.fillStyle = '#333';
                         ctx.shadowColor = 'rgba(255,255,255,0.5)';
                         ctx.shadowBlur = 2;
                    } else {
                         ctx.fillStyle = 'white';
                         ctx.shadowColor = 'rgba(0,0,0,0.7)';
                         ctx.shadowBlur = 3;
                         ctx.shadowOffsetX = 1;
                         ctx.shadowOffsetY = 1;
                    }
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.fillText(text, 0, 0);
                    ctx.restore();
                }

                ctx.beginPath();
                ctx.arc(centerX, centerY, 15, 0, 2 * Math.PI);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#ccc';
                ctx.stroke();
            }

            // 簡易亮度計算 (避免依賴外部庫)
            function calculateBrightness(hexColor) {
                hexColor = hexColor.replace('#', '');
                let r = 0, g = 0, b = 0;
                 if (hexColor.length === 3) {
                     r = parseInt(hexColor[0] + hexColor[0], 16);
                     g = parseInt(hexColor[1] + hexColor[1], 16);
                     b = parseInt(hexColor[2] + hexColor[2], 16);
                 } else if (hexColor.length === 6) {
                     r = parseInt(hexColor.substring(0, 2), 16);
                     g = parseInt(hexColor.substring(2, 4), 16);
                     b = parseInt(hexColor.substring(4, 6), 16);
                 }
                 // 亮度 = (0.299*R + 0.587*G + 0.114*B)
                 return (0.299 * r + 0.587 * g + 0.114 * b);
            }


            // 顯示/新增/儲存選項 (保持不變)
            function showOptionsModal() { /* ... 省略相同代碼 ... */
                optionsContainer.innerHTML = '';
                if (options.length === 0) {
                    const noOptions = document.createElement('div');
                    noOptions.className = 'no-options';
                    noOptions.textContent = '目前沒有選項，請點擊下方按鈕新增';
                    optionsContainer.appendChild(noOptions);
                } else {
                    options.forEach((option, index) => {
                        addOptionToModal(option, index);
                    });
                }
                optionsModal.style.display = 'block';
                optionsContainer.scrollTop = 0;
            }

            function addOptionToModal(value = '', index = -1) { /* ... 省略相同代碼 ... */
                const noOptions = optionsContainer.querySelector('.no-options');
                if (noOptions) noOptions.remove();

                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-input';
                const effectiveIndex = index === -1 ? optionsContainer.querySelectorAll('.option-input').length : index;

                const colorIndicator = document.createElement('div');
                colorIndicator.className = 'color-indicator';
                colorIndicator.style.backgroundColor = colors[effectiveIndex % colors.length];

                const input = document.createElement('input');
                input.type = 'text';
                input.value = value;
                input.placeholder = `選項 ${effectiveIndex + 1}`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-option';
                removeBtn.textContent = '-';
                removeBtn.onclick = function() {
                    optionDiv.remove();
                    updateColorIndicators();
                    if (optionsContainer.children.length === 0) {
                        const noOptions = document.createElement('div');
                        noOptions.className = 'no-options';
                        noOptions.textContent = '目前沒有選項，請點擊下方按鈕新增';
                        optionsContainer.appendChild(noOptions);
                    }
                };

                optionDiv.appendChild(colorIndicator);
                optionDiv.appendChild(input);
                optionDiv.appendChild(removeBtn);
                optionsContainer.appendChild(optionDiv);

                if (value === '') {
                    input.focus();
                    optionDiv.classList.add('highlight');
                    setTimeout(() => optionDiv.classList.remove('highlight'), 1000);
                    optionsContainer.scrollTop = optionsContainer.scrollHeight;
                }
            }

            function updateColorIndicators() { /* ... 省略相同代碼 ... */
                const optionInputs = document.querySelectorAll('.option-input');
                 optionInputs.forEach((div, index) => {
                     const colorIndicator = div.querySelector('.color-indicator');
                     colorIndicator.style.backgroundColor = colors[index % colors.length];
                     const input = div.querySelector('input');
                     if(input) input.placeholder = `選項 ${index + 1}`;
                 });
            }

            function saveOptions() { /* ... 省略相同代碼 ... */
                 const inputs = document.querySelectorAll('.option-input input');
                 const newOptions = [];
                 inputs.forEach(input => {
                     if (input.value.trim() !== '') newOptions.push(input.value.trim());
                 });

                 if (newOptions.length > 0 || options.length === 0 && newOptions.length === 0) {
                     options = newOptions;
                     optionsModal.style.display = 'none';
                     drawWheel();
                 } else if (options.length > 0 && newOptions.length === 0){
                      if(confirm("您確定要刪除所有選項嗎？轉盤將無法使用。")) {
                          options = newOptions;
                          optionsModal.style.display = 'none';
                          drawWheel();
                      } else {
                          return;
                      }
                 }
            }

            // 動畫循環 (保持不變)
            function animateWheel(timestamp) { /* ... 省略相同代碼 ... */
                if (!spinStartTime) spinStartTime = timestamp;
                const elapsedTime = timestamp - spinStartTime;

                if (spinning) {
                    const progress = Math.min(elapsedTime / maxSpinTime, 1);
                    const easingProgress = 1 - Math.pow(1 - progress, 4);
                    const baseSpeed = 0.25;
                    const decelerationFactor = 1 - easingProgress;
                    spinSpeed = baseSpeed * decelerationFactor + 0.01;

                    currentAngle += spinSpeed;
                    drawWheel();

                    if (progress >= 1) {
                        finishSpin();
                    } else {
                        animationId = requestAnimationFrame(animateWheel);
                    }
                }
            }

            // 結束旋轉 - 調整結果計算邏輯
            function finishSpin() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }

                spinning = false;
                spinBtn.disabled = false;
                spinStartTime = 0;

                const numOptions = options.length;
                if (numOptions === 0) return;

                const sliceAngle = (2 * Math.PI) / numOptions;
                const finalAngle = ((currentAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);

                // --- 計算結果，指針在頂部 (3*PI/2 或 -PI/2) ---
                // 計算指針指向的角度 (相對於輪盤的 0 度)
                const pointerRad = (3 * Math.PI / 2); // 頂部的弧度
                const pointerEffectiveAngle = ((pointerRad - finalAngle) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

                // 找出這個角度所在的扇區索引
                const resultIndex = Math.floor(pointerEffectiveAngle / sliceAngle);

                // 確保索引有效
                const finalResultIndex = resultIndex % numOptions;
                const result = options[finalResultIndex];

                // 顯示結果和效果
                resultElement.textContent = `結果: ${result}`;
                resultElement.style.color = colors[finalResultIndex % colors.length];
                resultElement.classList.add('show-result');
                playSound();

                canvas.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    canvas.style.transform = 'scale(1)';
                }, 300);
            }

            // 初始化轉盤 (保持不變)
            function initWheel() { /* ... 省略相同代碼 ... */
                 drawWheel();
                 spinBtn.addEventListener('click', function() {
                     if (spinning) return;
                     if (options.length === 0) { alert('請先編輯選項！'); showOptionsModal(); return; }
                     if (options.length === 1) {
                         alert('只有一個選項，不用轉啦！');
                         resultElement.textContent = `結果: ${options[0]}`;
                         resultElement.style.color = colors[0];
                         resultElement.classList.add('show-result');
                         canvas.style.transform = 'scale(1.05)';
                         setTimeout(() => { canvas.style.transform = 'scale(1)'; }, 300);
                         playSound();
                         return;
                     }
                     spinning = true;
                     spinBtn.disabled = true;
                     resultElement.textContent = '';
                     resultElement.classList.remove('show-result');
                     spinStartTime = 0;
                     currentAngle = ((currentAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                     animationId = requestAnimationFrame(animateWheel);
                 });

                 editOptionsBtn.addEventListener('click', showOptionsModal);
                 closeModal.addEventListener('click', () => handleCloseModal());
                 window.addEventListener('click', (event) => { if (event.target === optionsModal) handleCloseModal(); });
                 addOptionBtn.addEventListener('click', () => { addOptionToModal(); updateColorIndicators(); });
                 saveOptionsBtn.addEventListener('click', saveOptions);
                 document.addEventListener('keydown', handleKeyDown);
            }

             // 處理關閉彈窗邏輯 (抽取成函數)
             function handleCloseModal() {
                 const inputs = document.querySelectorAll('.option-input input');
                 let hasNonEmpty = inputs.length > 0 && Array.from(inputs).some(input => input.value.trim() !== '');

                 if (options.length > 0 && !hasNonEmpty && optionsContainer.querySelectorAll('.option-input').length === 0) { // 檢查是否真的清空了
                     if (confirm("您已清空所有選項，確定要關閉嗎？轉盤將無法使用。")) {
                         optionsModal.style.display = 'none';
                         saveOptions(); // 保存空選項
                     }
                 } else {
                     optionsModal.style.display = 'none';
                     // 關閉時不自動保存未保存的更改，用戶需點擊保存按鈕
                     // 如果需要刷新回原來的選項，可以在這裡重新調用 showOptionsModal() 或 drawWheel()
                 }
             }

             // 處理鍵盤事件 (抽取成函數)
             function handleKeyDown(event) {
                 if (optionsModal.style.display === 'block') {
                     const activeElement = document.activeElement;
                     if (event.key === 'Enter' && activeElement && activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'BUTTON') { // 避免觸發按鈕
                         event.preventDefault();
                         addOptionToModal();
                         updateColorIndicators();
                     } else if (event.key === 'Enter' && event.ctrlKey) {
                          event.preventDefault();
                          saveOptions();
                     } else if (event.key === 'Escape') {
                          event.preventDefault();
                          handleCloseModal();
                     }
                 }
             }


            // 簡單的聲音效果 (保持不變)
            function playSound() { /* ... 省略相同代碼 ... */
                try {
                     const AudioContext = window.AudioContext || window.webkitAudioContext;
                     if (!AudioContext) { console.warn("瀏覽器不支持 AudioContext"); return; }
                     const audioCtx = new AudioContext(); // 修改变量名避免覆盖
                     const oscillator = audioCtx.createOscillator();
                     const gain = audioCtx.createGain();
                     oscillator.connect(gain);
                     gain.connect(audioCtx.destination);
                     oscillator.type = 'triangle';
                     const baseFreq = 440;
                     oscillator.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
                     oscillator.frequency.linearRampToValueAtTime(baseFreq * 1.5, audioCtx.currentTime + 0.1);
                     oscillator.frequency.linearRampToValueAtTime(baseFreq * 1.2, audioCtx.currentTime + 0.2);
                      oscillator.frequency.linearRampToValueAtTime(baseFreq * 2, audioCtx.currentTime + 0.3);
                     gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                     gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
                     oscillator.start(audioCtx.currentTime);
                     oscillator.stop(audioCtx.currentTime + 0.8);
                     setTimeout(() => { if (audioCtx.state !== 'closed') audioCtx.close(); }, 1000);
                 } catch(e) { console.error('音效播放失敗:', e); }
            }

            // 初始化
            initWheel();
        });
    </script>
</body>
</html>