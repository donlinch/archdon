<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命運轉盤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: '微軟正黑體', Arial, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 20px;
            overflow-x: hidden;
        }
        
        h1 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            position: relative;
        }
        
        .wheel-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            min-height: 350px;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s ease;
        }
        
        .pointer {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background-color: #ff5252;
            clip-path: polygon(50% 0, 0% 100%, 100% 100%);
            z-index: 10;
        }
        
        button {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            background-color: #ff5252;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 82, 82, 0.4);
        }
        
        button:hover {
            background-color: #ff3636;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .edit-options-btn {
            background-color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            margin-top: 40px;
        }
        
        .edit-options-btn:hover {
            background-color: #3e8e41;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
        }
        
        .result {
            text-align: center;
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            min-height: 36px;
            color: #333;
        }
        
        /* 彈出視窗樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalOpen 0.4s;
        }
        
        @keyframes modalOpen {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            color: #333;
            margin: 0;
        }
        
        .close {
            color: #888;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #000;
        }
        
        .option-input {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        
        .option-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .option-input input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        
        .color-indicator {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        
        .remove-option {
            background-color: #f44336;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border: none;
            padding: 0;
            margin-left: 5px;
        }
        
        .add-option {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .add-option:hover {
            background-color: #3e8e41;
        }
        
        .options-container {
            max-height: 300px;
            padding-right: 5px;
        }
        
        .modal-footer {
            margin-top: 20px;
            text-align: center;
        }
        
        .save-options {
            padding: 12px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .save-options:hover {
            background-color: #3e8e41;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <h1>命運轉盤</h1>
    
    <div class="container">
        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheel" width="350" height="350"></canvas>
        </div>
        
        <button id="spin">開始旋轉</button>
        
        <div class="result" id="result"></div>
    </div>
    
    <button id="editOptions" class="edit-options-btn">編輯選項</button>
    
    <!-- 選項編輯彈出視窗 -->
    <div id="optionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>編輯選項</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="options-container" id="optionsContainer"></div>
            
            <button id="addOption" class="add-option">+ 新增選項</button>
            
            <div class="modal-footer">
                <button class="save-options" id="saveOptions">儲存選項</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const spinBtn = document.getElementById('spin');
            const resultElement = document.getElementById('result');
            const editOptionsBtn = document.getElementById('editOptions');
            const optionsModal = document.getElementById('optionsModal');
            const closeModal = document.querySelector('.close');
            const saveOptionsBtn = document.getElementById('saveOptions');
            const addOptionBtn = document.getElementById('addOption');
            const optionsContainer = document.getElementById('optionsContainer');
            
            // 顏色陣列
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#7ED321', '#50E3C2',
                '#F8E71C', '#BD10E0', '#8B572A', '#4A90E2'
            ];
            
            // 初始選項
            let options = ['吃拉麵', '吃牛排', '吃披薩', '吃漢堡'];
            let spinning = false;
            let currentAngle = 0;
            let targetAngle = 0;
            let spinSpeed = 0;
            let maxSpinTime = 6000; // 最大旋轉時間 (毫秒)
            let spinStartTime = 0;
            let animationId = null;
            
            // 渲染轉盤
            function drawWheel() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) - 10;
                
                // 繪製轉盤背景
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#333';
                ctx.stroke();
                
                // 如果沒有選項，顯示提示
                if (options.length === 0) {
                    ctx.fillStyle = '#888';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('請新增選項', centerX, centerY);
                    return;
                }
                
                // 計算每一塊的角度
                const sliceAngle = (2 * Math.PI) / options.length;
                
                // 繪製每一塊
                for (let i = 0; i < options.length; i++) {
                    const startAngle = currentAngle + i * sliceAngle;
                    const endAngle = startAngle + sliceAngle;
                    
                    // 繪製扇形
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fill();
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'white';
                    ctx.stroke();
                    
                    // 繪製文字
                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(startAngle + sliceAngle / 2);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 3;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    
                    // 根據文字長度調整位置
                    const text = options[i];
                    let textDistance = radius * 0.85;
                    if (text.length > 8) textDistance = radius * 0.75;
                    if (text.length > 12) textDistance = radius * 0.65;
                    
                    ctx.fillText(text, textDistance, 5);
                    ctx.restore();
                }
                
                // 繪製中心圓
                ctx.beginPath();
                ctx.arc(centerX, centerY, 15, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#333';
                ctx.stroke();
                
                // 繪製裝飾線
                for (let i = 0; i < options.length; i++) {
                    const lineAngle = currentAngle + i * sliceAngle;
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(
                        centerX + radius * Math.cos(lineAngle),
                        centerY + radius * Math.sin(lineAngle)
                    );
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            // 顯示選項編輯視窗
            function showOptionsModal() {
                optionsContainer.innerHTML = '';
                
                options.forEach((option, index) => {
                    addOptionToModal(option, index);
                });
                
                optionsModal.style.display = 'block';
            }
            
            // 新增選項到彈出視窗
            function addOptionToModal(value = '', index = 0) {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-input';
                
                const colorIndicator = document.createElement('div');
                colorIndicator.className = 'color-indicator';
                colorIndicator.style.backgroundColor = colors[index % colors.length];
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = value;
                input.placeholder = `選項${optionsContainer.children.length + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-option';
                removeBtn.textContent = '-';
                removeBtn.addEventListener('click', function() {
                    if (optionsContainer.children.length > 1) {
                        optionDiv.remove();
                        updateColorIndicators();
                    }
                });
                
                optionDiv.appendChild(colorIndicator);
                optionDiv.appendChild(input);
                optionDiv.appendChild(removeBtn);
                optionsContainer.appendChild(optionDiv);
            }
            
            // 更新顏色指示器
            function updateColorIndicators() {
                const optionInputs = document.querySelectorAll('.option-input');
                optionInputs.forEach((option, index) => {
                    const colorIndicator = option.querySelector('.color-indicator');
                    colorIndicator.style.backgroundColor = colors[index % colors.length];
                });
            }
            
            // 儲存選項
            function saveOptions() {
                const inputs = document.querySelectorAll('.option-input input');
                options = [];
                
                inputs.forEach(input => {
                    if (input.value.trim() !== '') {
                        options.push(input.value.trim());
                    }
                });
                
                optionsModal.style.display = 'none';
                drawWheel();
            }
            
            // 動畫循環 - 修正版
            function animateWheel(timestamp) {
                if (!spinStartTime) {
                    spinStartTime = timestamp;
                }
                
                // 計算已經過的時間
                const elapsedTime = timestamp - spinStartTime;
                
                if (spinning) {
                    // 計算旋轉速度
                    const progress = Math.min(elapsedTime / maxSpinTime, 1);
                    
                    if (progress < 0.3) {
                        // 加速階段
                        spinSpeed = 0.1 + progress * 0.4;
                    } else if (progress < 0.8) {
                        // 勻速階段
                        spinSpeed = 0.22;
                    } else {
                        // 減速階段
                        spinSpeed = 0.22 * (1 - (progress - 0.8) / 0.2);
                    }
                    
                    // 旋轉轉盤
                    currentAngle += spinSpeed;
                    drawWheel();
                    
                    // 判斷是否需要停止旋轉
                    if (progress >= 1) {
                        finishSpin();
                    } else {
                        animationId = requestAnimationFrame(animateWheel);
                    }
                }
            }
            
            // 結束旋轉
            function finishSpin() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                spinning = false;
                spinBtn.disabled = false;
                spinStartTime = 0;
                
                // 計算結果
                const normalizedAngle = ((currentAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                const sliceAngle = (2 * Math.PI) / options.length;
                const winIndex = options.length - Math.floor(normalizedAngle / sliceAngle) - 1;
                const resultIndex = (winIndex % options.length + options.length) % options.length;
                const result = options[resultIndex];
                
                // 顯示結果
                resultElement.textContent = `結果: ${result}`;
                resultElement.style.color = colors[resultIndex % colors.length];
                
                // 播放音效
                playSound();
            }
            
            // 初始化轉盤
            function initWheel() {
                drawWheel();
                
                // 監聽旋轉按鈕
                spinBtn.addEventListener('click', function() {
                    if (spinning || options.length === 0) return;
                    
                    spinning = true;
                    spinBtn.disabled = true;
                    resultElement.textContent = '';
                    spinStartTime = 0;
                    
                    // 開始旋轉動畫
                    animationId = requestAnimationFrame(animateWheel);
                });
                
                // 監聽編輯選項按鈕
                editOptionsBtn.addEventListener('click', showOptionsModal);
                
                // 監聽關閉彈出視窗按鈕
                closeModal.addEventListener('click', function() {
                    optionsModal.style.display = 'none';
                });
                
                // 當點擊彈出視窗外部時關閉
                window.addEventListener('click', function(event) {
                    if (event.target === optionsModal) {
                        optionsModal.style.display = 'none';
                    }
                });
                
                // 監聽新增選項按鈕
                addOptionBtn.addEventListener('click', function() {
                    addOptionToModal();
                    updateColorIndicators();
                });
                
                // 監聽儲存選項按鈕
                saveOptionsBtn.addEventListener('click', saveOptions);
            }
            
            // 簡單的聲音效果
            function playSound() {
                try {
                    const audio = new AudioContext();
                    const oscillator = audio.createOscillator();
                    const gain = audio.createGain();
                    
                    oscillator.connect(gain);
                    gain.connect(audio.destination);
                    
                    // 模擬獎勵音效
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audio.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audio.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audio.currentTime + 0.2); // G5
                    oscillator.frequency.setValueAtTime(1046.50, audio.currentTime + 0.3); // C6
                    
                    gain.gain.setValueAtTime(0.2, audio.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.00001, audio.currentTime + 1);
                    
                    oscillator.start(audio.currentTime);
                    oscillator.stop(audio.currentTime + 1);
                } catch(e) {
                    console.log('音效播放失敗', e);
                }
            }
            
            // 初始化
            initWheel();
        });
    </script>
</body>
</html>