<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>找出 5 個不同之處（帶簡易編輯器）</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fffbe6;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    h1, h2 {
      color: #ff8c00;
      margin: 15px 0;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      flex-direction: column;
      gap: 10px;
    }
    .tab {
      padding: 10px 20px;
      background-color: #ff8c00;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    .tab.active {
      background-color: #e67e00;
      transform: scale(1.1);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .game-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .image-container {
      position: relative;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .image-container img {
      width: 90vw;
      max-width: 400px;
      height: auto;
      border: none;
      border-radius: 10px;
      display: block;
    }
    .image-label {
      font-size: 16px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 3px 8px;
      border-radius: 4px;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dot {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid red;
      border-radius: 50%;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }
    .dot.found {
      background-color: rgba(255, 0, 0, 0.5);
      animation: pulse 1s infinite alternate;
    }
    .dot.hint {
      border: 2px dashed gold;
      background-color: rgba(255, 255, 0, 0.3);
      box-shadow: 0 0 10px gold;
    }
    .editor-dot {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid red;
      border-radius: 50%;
      background-color: rgba(255, 0, 0, 0.3);
      cursor: move;
      transform: translate(-50%, -50%);
    }
    .editor-dot.reference {
      background-color: rgba(255, 0, 0, 0.2);
      border: 2px dashed red;
      cursor: default;
    }
    .label {
      position: absolute;
      font-weight: bold;
      color: red;
      background-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 20px;
      font-size: 12px;
      transform: translate(-50%, -50%);
      display: none;
    }
    .label.show {
      display: block;
    }
    .game-status-container {
      width: auto;
      max-width: 450px;
      margin: 0 auto 10px;
      padding: 8px 15px;
      background-color: #fff8e1;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-block;
    }
    #status {
      margin: 0;
      font-size: 18px;
      color: #008800;
      font-weight: bold;
      display: inline-block;
    }
    #timer {
      margin-left: 15px;
      display: inline-block;
      color: #ff6600;
      font-weight: bold;
    }
    #timer-display {
      font-weight: bold;
    }
    #message {
      min-height: 24px;
      font-size: 16px;
      color: #0066cc;
      font-weight: bold;
      margin: 0 0 0 15px;
      display: inline-block;
    }
    .controls {
      margin: 10px 0 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .button {
      padding: 10px 15px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .button:hover {
      background-color: #e67e00;
      transform: scale(1.05);
    }
    .button.hint {
      background-color: #ffc107;
    }
    .button.reset {
      background-color: #6c757d;
    }
    .difference-list {
      max-width: 90%;
      margin: 20px auto;
      text-align: left;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .difference-list.show {
      display: block;
    }
    .difference-list h3 {
      margin-top: 0;
      color: #ff8c00;
    }
    .difference-list ul {
      padding-left: 20px;
    }
    .difference-list li {
      margin-bottom: 8px;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.9; }
    }
    .editor-container {
      margin: 20px auto;
      max-width: 90%;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #output {
      width: 100%;
      height: 150px;
      font-family: monospace;
      white-space: pre-wrap;
      text-align: left;
      background: #f5f5f5;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow-y: auto;
      margin-top: 15px;
      font-size: 14px;
    }
    .edit-instructions {
      background-color: #fffbcc;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: left;
    }
    .edit-instructions p {
      margin: 5px 0;
    }
    .edit-instructions ul {
      margin: 5px 0;
      padding-left: 25px;
    }
    .edit-instructions li {
      margin-bottom: 5px;
    }
    /* 手機版特別設定（螢幕寬度小於 768px） */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      h1 {
        font-size: 24px;
        margin: 10px 0;
      }
      .game-container {
        flex-direction: column;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
      }
      .image-container {
        margin-bottom: 5px;
        width: 100%;
      }
      .image-container img {
        width: 100%;
        max-width: none;
        max-height: 40vh;
        object-fit: contain;
      }
      .controls {
        flex-direction: row;
        flex-wrap: wrap;
        margin: 5px 0 15px;
      }
      .button {
        width: auto;
        padding: 8px 12px;
        font-size: 14px;
      }
      .tabs {
        bottom: 10px;
        right: 10px;
      }
      .tab {
        padding: 8px 15px;
        font-size: 14px;
      }
      .game-status-container {
        margin: 5px auto;
        padding: 5px;
      }
      #status {
        font-size: 16px;
        margin: 5px 0;
      }
      #message {
        min-height: 20px;
        font-size: 14px;
      }
      .image-label {
        font-size: 14px;
        padding: 2px 6px;
      }
      .dot, .editor-dot {
        width: 24px;
        height: 24px;
      }
    }
    .level-transition {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }
    .level-transition.show {
      opacity: 1;
      visibility: visible;
    }
    .level-transition h2 {
      font-size: 32px;
      margin-bottom: 20px;
      color: #ffc107;
    }
    .level-transition p {
      font-size: 18px;
      margin-bottom: 30px;
    }
    .level-transition button {
      padding: 12px 24px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .level-transition button:hover {
      background-color: #e67e00;
      transform: scale(1.05);
    }
    .level-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      color: #ff8c00;
      z-index: 10;
    }
    .level-select {
      display: inline-block;
      position: relative;
      margin-left: 10px;
    }
    
    .level-select select {
      padding: 8px 12px;
      background-color: #6200ee;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      padding-right: 30px;
    }
    
    .level-select::after {
      content: "▼";
      font-size: 10px;
      color: white;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    
    /* Leaderboard styles */
    .leaderboard-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }
    
    .leaderboard-container.show {
      opacity: 1;
      visibility: visible;
    }
    
    .leaderboard-content {
      background-color: #fff;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .leaderboard-content h2 {
      margin-top: 0;
      color: #ff8c00;
    }
    
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .leaderboard-table th, .leaderboard-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .leaderboard-table th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }
    
    .leaderboard-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .leaderboard-table tr:hover {
      background-color: #f1f1f1;
    }
    
    .name-entry-form {
      margin-top: 20px;
      padding: 15px;
      background-color: #f2f2f2;
      border-radius: 8px;
    }
    
    .name-entry-form input {
      padding: 8px 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    
    .name-entry-form button {
      padding: 8px 15px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .leaderboard-buttons {
      margin-top: 20px;
      display: flex;
      gap: 15px;
    }
    
    .leaderboard-buttons button {
      padding: 10px 20px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .leaderboard-buttons button.secondary {
      background-color: #6c757d;
    }
  </style>
</head>
<body>
  
  <div class="tabs">
    <div class="tab active" data-tab="game">遊戲模式</div>
    <div class="tab" data-tab="editor">編輯器模式</div>
  </div>
  
  <div id="game-tab" class="tab-content active">
    <div class="game-container">
      <div class="image-container" id="left-image">
        <img src="https://sunnyyummy.onrender.com/uploads/1745928020704-22308.png" alt="原圖" />
        <!-- 差異點1: D vs O (第二個D變成O) -->
        <div class="dot" id="diff1" data-id="1" style="top: 30%; left: 67%;"></div>
        <div class="label" id="label1" style="top: 30%; left: 67%;">1</div>
        
        <!-- 差異點2: YOMMY vs YOMMY (MM vs M) -->
        <div class="dot" id="diff2" data-id="2" style="top: 70%; left: 67%;"></div>
        <div class="label" id="label2" style="top: 70%; left: 67%;">2</div>
        
        <!-- 差異點3: 右邊角色眼睛樣式 -->
        <div class="dot" id="diff3" data-id="3" style="top: 50%; left: 83%;"></div>
        <div class="label" id="label3" style="top: 50%; left: 83%;">3</div>
        
        <!-- 差異點4: 粉色帽子 -->
        <div class="dot" id="diff4" data-id="4" style="top: 50%; left: 38%;"></div>
        <div class="label" id="label4" style="top: 50%; left: 38%;">4</div>
        
        <!-- 差異點5: 中間角色表情 -->
        <div class="dot" id="diff5" data-id="5" style="top: 52%; left: 60%;"></div>
        <div class="label" id="label5" style="top: 52%; left: 60%;">5</div>
        
        <div class="image-label">原圖</div>
      </div>
      
      <div class="game-status-container">
        <div id="status">已找到：<span id="found-count">0</span> / <span id="total-count">5</span></div>
        <div id="timer" style="margin-left: 15px; display: inline-block; color: #ff6600; font-weight: bold;">時間：<span id="timer-display">00:00</span></div>
        <div id="message"></div>
      </div>
      
      <div class="image-container" id="right-image">
        <img src="https://sunnyyummy.onrender.com/uploads/1745928028967-85686.png" alt="修改版" />
        <!-- 差異點1: D vs O (第二個D變成O) -->
        <div class="dot" id="diff1-right" data-id="1" style="top: 30%; left: 67%;"></div>
        <div class="label" id="label1-right" style="top: 30%; left: 67%;">1</div>
        
        <!-- 差異點2: YOMMY vs YOMMY (MM vs M) -->
        <div class="dot" id="diff2-right" data-id="2" style="top: 70%; left: 67%;"></div>
        <div class="label" id="label2-right" style="top: 70%; left: 67%;">2</div>
        
        <!-- 差異點3: 右邊角色眼睛樣式 -->
        <div class="dot" id="diff3-right" data-id="3" style="top: 50%; left: 83%;"></div>
        <div class="label" id="label3-right" style="top: 50%; left: 83%;">3</div>
        
        <!-- 差異點4: 粉色帽子 -->
        <div class="dot" id="diff4-right" data-id="4" style="top: 50%; left: 38%;"></div>
        <div class="label" id="label4-right" style="top: 50%; left: 38%;">4</div>
        
        <!-- 差異點5: 中間角色表情 -->
        <div class="dot" id="diff5-right" data-id="5" style="top: 52%; left: 60%;"></div>
        <div class="label" id="label5-right" style="top: 52%; left: 60%;">5</div>
        
        <div class="image-label">修改版</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="button reset" id="reset-button">重新開始</button>
    </div>
  </div>
  
  <div id="editor-tab" class="tab-content">
    <h2>編輯器模式 ✏️</h2>
    
    <div class="game-container">
      <div class="image-container" id="edit-left">
        <img src="" alt="原圖" id="left-edit-img" />
        <div class="image-label">原圖</div>
      </div>
      
      <div class="image-container" id="edit-right">
        <img src="" alt="修改版" id="right-edit-img" />
        <div class="image-label">修改版</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="button reset" id="clear-editor">清除所有</button>
      <button class="button" id="save-editor" style="background-color: #28a745;">保存</button>
      <div class="level-select" style="display: flex; align-items: center; gap: 8px;">
        <select id="level-selector">
          <!-- 選項將由JavaScript動態填充 -->
        </select>
        <button class="button" id="delete-level" style="background-color: #dc3545;">刪除圖片</button>
      </div>
      <button class="button" id="add-new-level" style="background-color: #0275d8;">新增圖片</button>
      
    </div>
    
    <!-- 添加輸出區域 -->
    <div style="margin-top: 20px;">
      <textarea id="output" style="width: 100%; height: 100px; font-family: monospace;" readonly></textarea>
    </div>
    
    <!-- 新增圖片表單 -->
    <div id="new-level-form" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
      <h3>新增圖片</h3>
      <div style="margin-bottom: 10px;">
        <label>圖片名稱: <input type="text" id="new-level-name" style="margin-left: 10px;"></label>
      </div>
      <div style="margin-bottom: 10px;">
        <label>原圖URL: <input type="text" id="new-left-image" style="margin-left: 10px; width: 300px;"></label>
      </div>
      <div style="margin-bottom: 10px;">
        <label>修改版URL: <input type="text" id="new-right-image" style="margin-left: 10px; width: 300px;"></label>
      </div>
      <button class="button" id="submit-new-level" style="background-color: #28a745;">提交</button>
      <button class="button" id="cancel-new-level" style="background-color: #dc3545;">取消</button>
    </div>
  </div>
  
  <div class="level-transition" id="level-transition">
    <h2>恭喜完成第一關！</h2>
    <p>準備好挑戰第二關了嗎？</p>
    <button id="next-level-button">開始第二關</button>
  </div>
  
  <!-- 排行榜 -->
  <div class="leaderboard-container" id="leaderboard-container">
    <div class="leaderboard-content">
      <h2>排行榜</h2>
      <div id="name-entry-container" class="name-entry-form">
        <p>恭喜完成所有關卡！總耗時: <span id="final-time-display"></span></p>
        <input type="text" id="player-name" placeholder="請輸入您的名字" maxlength="20">
        <button id="submit-score">提交成績</button>
      </div>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>排名</th>
            <th>名字</th>
            <th>時間</th>
            <th>日期</th>
          </tr>
        </thead>
        <tbody id="leaderboard-rows">
          <!-- 排行榜資料將動態填入 -->
        </tbody>
      </table>
      <div class="leaderboard-buttons">
        <button id="close-leaderboard" class="secondary">關閉</button>
        <button id="restart-game">重新開始</button>
      </div>
    </div>
  </div>
  
  <script>
    // 切換標籤頁
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // 移除所有標籤和內容的active類
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // 添加active類到當前標籤和對應的內容
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab') + '-tab').classList.add('active');
      });
    });
    
    // ----- 遊戲模式代碼 -----
    const allLevels = [
      {
        // 第一關
        levelId: 1,
        storageKey: 'differentGameLevel1Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745928020704-22308.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745928028967-85686.png",
        // 保持第一關的初始點位數據，以便在localStorage沒有數據時使用
        differences: [
          { id: 'diff1', description: '差異點位於右上區域 (D vs O)', position: { top: '30%', left: '67%' } },
          { id: 'diff2', description: '差異點位於右下區域 (YOMMY vs YOMY)', position: { top: '70%', left: '67%' } },
          { id: 'diff3', description: '差異點位於右側眼睛樣式', position: { top: '50%', left: '83%' } },
          { id: 'diff4', description: '差異點位於左側粉色帽子', position: { top: '50%', left: '38%' } },
          { id: 'diff5', description: '差異點位於中間角色表情', position: { top: '52%', left: '60%' } }
        ]
      },
      {
        // 第二關
        levelId: 2,
        storageKey: 'differentGameLevel2Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745941255784-4084.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745941265630-74495.png",
        differences: [] // 初始為空，期望從 localStorage 載入
      },
      {
        // 第三關
        levelId: 3,
        storageKey: 'differentGameLevel3Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745944114845-94074.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745944121794-50612.png",
        differences: [ // 添加第三關的默認差異點 (如果 localStorage 沒有)
          { id: 'diff1', description: '第三關差異點A', position: { top: '20%', left: '25%' } },
          { id: 'diff2', description: '第三關差異點B', position: { top: '15%', left: '75%' } },
          { id: 'diff3', description: '第三關差異點C', position: { top: '50%', left: '50%' } },
          { id: 'diff4', description: '第三關差異點D', position: { top: '80%', left: '30%' } },
          { id: 'diff5', description: '第三關差異點E', position: { top: '75%', left: '70%' } }
        ]
      },
      {
        // 第四關 (範例)
        levelId: 4,
        storageKey: 'differentGameLevel4Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745945120161-78277.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745945134090-91988.png",
        differences: [ // 第四關的默認差異點
          { id: 'diff1', description: '第四關差異點1', position: { top: '25%', left: '15%' } },
          { id: 'diff2', description: '第四關差異點2', position: { top: '35%', left: '80%' } },
          { id: 'diff3', description: '第四關差異點3', position: { top: '60%', left: '50%' } },
          { id: 'diff4', description: '第四關差異點4', position: { top: '75%', left: '20%' } },
          { id: 'diff5', description: '第四關差異點5', position: { top: '85%', left: '70%' } }
        ]
      }
    ];

    // 創建 allLevels 的深拷貝以備修改
    const allLevelsData = JSON.parse(JSON.stringify(allLevels));

   // 修改 getRandomLevels 函數以確保返回正確的格式
async function getRandomLevels() {
  try {
    const response = await fetch('/api/diffrent-game/levels/random');
    const levels = await response.json();
    
    if (!levels || !Array.isArray(levels) || levels.length === 0) {
      console.warn('API未返回有效關卡，使用默認關卡');
      return allLevels; // 使用默認關卡
    }
    
    // 格式化確保每個level有正確的屬性
    const formattedLevels = levels.map(level => ({
      id: level.id,
      levelId: level.id,
      leftImage: level.left_image_url,
      rightImage: level.right_image_url
    }));
    console.log("隨機選擇的關卡:", formattedLevels.map(l => l.id));
    return formattedLevels;
  } catch (error) {
    console.error('無法獲取隨機關卡:', error);
    console.warn('使用默認關卡作為備用');
    return allLevels; // 失敗時使用默認關卡
  }
}

    // ----- 遊戲狀態變數 -----
    let gameLevels = []; // 儲存當前遊戲會用到的隨機關卡
    let currentLevel = 0;
    // let differences = []; // 不再需要全局 differences

    let foundCount = 0;
    const foundDifferences = new Set();
    const messageElement = document.getElementById('message');
    const foundCountElement = document.getElementById('found-count');
    const totalCountElement = document.getElementById('total-count');
    const resetButton = document.getElementById('reset-button');
    const showAnswersButton = document.getElementById('show-answers-button');
    const hintButton = document.getElementById('hint-button');
    const levelTransition = document.getElementById('level-transition');
    const nextLevelButton = document.getElementById('next-level-button');
    const deleteLevelButton = document.getElementById('delete-level');

    // 計時器相關變數
    let timerInterval;
    let startTime;
    let totalElapsedTime = 0;
    let timerRunning = false;
    const timerDisplay = document.getElementById('timer-display');

    let answersVisible = false;

    // ----- DOM 元素 -----
    const leftImageContainer = document.getElementById('left-image');
    const rightImageContainer = document.getElementById('right-image');
    const leftImageElement = leftImageContainer.querySelector('img');
    const rightImageElement = rightImageContainer.querySelector('img');
    const levelIndicator = document.createElement('div'); // 關卡指示器只需要創建一次
    levelIndicator.className = 'level-indicator';
    leftImageContainer.appendChild(levelIndicator); // 添加到左圖容器


    
    // 設置新遊戲或重置遊戲
    async function setupNewGame() {
      console.log("Setting up new game...");
      
      // 重置遊戲狀態
      foundDifferences.clear();
      foundCount = 0;
      foundCountElement.textContent = '0';
      messageElement.textContent = '';
      answersVisible = false;
      showAnswersButton.textContent = '顯示所有答案';

      // 重置計時器
      clearInterval(timerInterval);
      timerRunning = false;
      totalElapsedTime = 0;
      timerDisplay.textContent = '00:00';
      
      // 確保先有遊戲數據再開始計時器
      try {
        gameLevels = await getRandomLevels(); // 獲取新的隨機關卡列表
        
        if (!gameLevels || gameLevels.length === 0) {
          console.error("無法獲取遊戲關卡");
          messageElement.textContent = "載入遊戲關卡失敗，請重新整理頁面";
          return;
        }
        
        currentLevel = 0;
        startTimer(); // 啟動計時器
        
        // 加載第一個關卡
        loadLevel(currentLevel);
      } catch (error) {
        console.error("初始化遊戲失敗:", error);
        messageElement.textContent = "初始化遊戲失敗，請重新整理頁面";
      }
    }

    function updateTimer() {
        if (!timerRunning) return;
        const currentTime = Date.now();
        const elapsedTime = currentTime - startTime;
        const seconds = Math.floor((elapsedTime / 1000) % 60);
        const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        totalElapsedTime = elapsedTime;
    }

    function showCompletionMessage() {
      levelTransition.querySelector('h2').textContent = `恭喜完成第 ${currentLevel + 1} 關！`;
      if (currentLevel + 1 < gameLevels.length) {
        levelTransition.querySelector('p').textContent = `準備好挑戰第 ${currentLevel + 2} 關了嗎？`;
        nextLevelButton.textContent = `開始第 ${currentLevel + 2} 關`;
        nextLevelButton.disabled = false;
      } else {
        levelTransition.querySelector('p').textContent = `你已經完成所有關卡！`;
        nextLevelButton.textContent = `重新開始`;
        nextLevelButton.disabled = false;
        nextLevelButton.onclick = function() {
          levelTransition.classList.remove('show');
          setupNewGame();
        };
        setTimeout(checkLeaderboardAndShow, 1200);
      }
      levelTransition.classList.add('show');
    }

    async function checkLeaderboardAndShow() {
      // 1. 取得總秒數
      const timeText = timerDisplay.textContent; // 格式 00:34
      const [min, sec] = timeText.split(':').map(Number);
      const totalSeconds = min * 60 + sec;

      // 2. 取得排行榜
      let leaderboard = [];
      try {
        const res = await fetch('/api/diffrent-game/leaderboard');
        leaderboard = await res.json();
      } catch (e) {
        alert('無法取得排行榜，請稍後再試');
        return;
      }

      // 3. 檢查是否進前 50 名
      const isInTop50 = leaderboard.length < 50 || leaderboard.some(entry => totalSeconds < entry.time_seconds);

      // 4. 顯示排行榜
      showLeaderboard(leaderboard, isInTop50, totalSeconds);
    }

    function showLeaderboard(leaderboard, canSubmit, mySeconds) {
      // 顯示排行榜區塊
      const leaderboardContainer = document.getElementById('leaderboard-container');
      leaderboardContainer.classList.add('show');

      // 填入排行榜資料
      const tbody = document.getElementById('leaderboard-rows');
      tbody.innerHTML = '';
      leaderboard.slice(0, 50).forEach((entry, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td><td>${entry.name}</td><td>${entry.time}</td><td>${entry.date}</td>`;
        tbody.appendChild(tr);
      });

      // 顯示/隱藏名字輸入表單
      const nameEntry = document.getElementById('name-entry-container');
      if (canSubmit) {
        nameEntry.style.display = 'block';
        document.getElementById('final-time-display').textContent = timerDisplay.textContent;
        // 綁定送出事件（只需綁一次）
        document.getElementById('submit-score').onclick = async function() {
          const name = document.getElementById('player-name').value.trim();
          if (!name || name.length > 20) {
            alert('名字不能空白且最多 20 字');
            return false;
          }
          const ok = await submitScore(name, mySeconds);
          if (ok) {
            nameEntry.style.display = 'none';
            await checkLeaderboardAndShow(); // 重新載入排行榜
          }
          // 如果失敗，停留在輸入框，讓使用者可以再試一次
        };
      } else {
        nameEntry.style.display = 'none';
      }

      // 綁定重新開始
      document.getElementById('restart-game').onclick = function() {
        leaderboardContainer.classList.remove('show');
        setupNewGame();
      };
      document.getElementById('close-leaderboard').onclick = function() {
        leaderboardContainer.classList.remove('show');
      };
    }

    async function submitScore(name, seconds) {
      if (!name || name.length > 20) {
        alert('名字不能空白且最多 20 字');
        return false;
      }
      try {
        console.log('送出排行榜資料:', { player_name: name, time_seconds: seconds });

        const res = await fetch('/api/diffrent-game/leaderboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ player_name: name, time_seconds: seconds }) // 這裡修正
        });

        let responseData;
        try {
          responseData = await res.json();
        } catch (jsonErr) {
          responseData = await res.text();
        }

        console.log('排行榜 API 回應:', res.status, responseData);

        if (!res.ok) {
          alert('送出成績失敗：' + (responseData.error || responseData || res.statusText));
          return false;
        }
        return true;
      } catch (e) {
        alert('送出成績失敗（網路或程式錯誤）');
        console.error(e);
        return false;
      }
    }

    if (deleteLevelButton) {
      deleteLevelButton.addEventListener('click', async function() {
        const selectedLevelId = parseInt(levelSelector.value);
        if (isNaN(selectedLevelId)) {
          alert('請先選擇要刪除的圖片！');
          return;
        }
        if (!confirm(`確定要刪除 ID:${selectedLevelId} 這張圖片嗎？此動作無法復原。`)) {
          return;
        }
        try {
          const res = await fetch(`/api/diffrent-game/levels/${selectedLevelId}`, {
            method: 'DELETE'
          });
          if (res.ok) {
            alert('圖片已刪除！');
            await populateLevelSelector(); // 重新載入 selector
            clearEditorDisplay(); // 清空畫面
            if (editLeftImg) editLeftImg.src = "";
            if (editRightImg) editRightImg.src = "";
          } else {
            alert('刪除失敗，請稍後再試');
          }
        } catch (e) {
          alert('網路錯誤，無法刪除圖片');
        }
      });
    }

    // Helper function to format seconds into MM:SS
    function formatTime(totalSeconds) {
        if (totalSeconds === null || totalSeconds === undefined) return 'N/A';
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            // Return YYYY-MM-DD format
            return date.toISOString().split('T')[0];
        } catch (e) {
            return 'Invalid Date';
        }
    }

    // ----- 初始調用 與 按鈕事件 ----- //
    window.onload = async function() { // Make async
      // Initialize editor first (to populate selector)
      await populateLevelSelector(); // Wait for selector to be populated

      // Then setup the game (which might depend on selector/initial load)
      await setupNewGame(); // Wait for game setup

      // Set up event listeners that depend on elements being ready
      nextLevelButton.addEventListener('click', loadNextLevel);
      resetButton.addEventListener('click', setupNewGame);

      // Ensure editor output area is initially updated
      updateOutput(); // Call this after potential initial editor load
    };

    // Function to fetch and display leaderboard directly
    async function displayLeaderboardDirectly() {
      let leaderboard = [];
      try {
        const res = await fetch('/api/diffrent-game/leaderboard'); // Fetch current data
        if (!res.ok) throw new Error('Failed to fetch leaderboard');
        leaderboard = await res.json();
        // Call showLeaderboard, explicitly setting canSubmit to false and no score
        showLeaderboard(leaderboard, false, null);
      } catch (e) {
        alert('無法取得排行榜，請稍後再試');
        console.error("Error fetching leaderboard directly:", e);
      }
    }

    function pauseTimer() {
      if (timerRunning) {
        clearInterval(timerInterval);
        timerRunning = false;
        totalElapsedTime = Date.now() - startTime;
        console.log("Timer paused. Total elapsed time:", totalElapsedTime);
      }
    }

    // 從API載入關卡差異點數據
    async function loadDifferencesFromAPI(levelId) { // 只接收 levelId
      let differences = [];
      let savedDots = [];
      let success = false;
      
      try {
        const response = await fetch(`/api/diffrent-game/differences/${levelId}`);
        
        if (!response.ok) {
          throw new Error(`API響應錯誤: ${response.status}`);
        }
        
        const apiDifferences = await response.json();
        
        if (apiDifferences && Array.isArray(apiDifferences) && apiDifferences.length > 0) {
          console.log(`從API獲取到 ${apiDifferences.length} 個差異點 for level ${levelId}`);
          
          // 處理差異點格式以符合前端需求
          differences = apiDifferences.map(diff => ({
            id: `diff${diff.id}`, // 遊戲模式用的 ID
            description: diff.description || `差異點 ${diff.id}`
          }));
          
          savedDots = apiDifferences.map(diff => ({
            id: diff.id, // 編輯器和查找用的數字 ID
            rightPosition: {
              top: diff.position_top,
              left: diff.position_left
            }
          }));
          
          success = true;
        } else {
          console.warn(`關卡 ${levelId} API未返回差異點數據`);
          // 這裡不再嘗試使用默認值，調用者需要處理這種情況
        }
      } catch (error) {
        console.error(`從API載入關卡 ${levelId} 數據錯誤:`, error);
        // 調用者需要處理錯誤情況
      }
      
      // 返回獲取到的數據和成功狀態
      return { success, differences, savedDots };
    }

    // 修改 loadLevel 使其異步並正確處理數據
    async function loadLevel(levelIndex) {
      if (levelIndex < 0 || levelIndex >= gameLevels.length) {
        console.error("無效的關卡索引:", levelIndex);
        messageElement.textContent = "遊戲已完成或出現錯誤！";
        pauseTimer();
        return;
      }
      console.log(`Loading level index: ${levelIndex}`);
      const level = gameLevels[levelIndex]; // level has { id, levelId, leftImage, rightImage }

      if (!level || !level.id || !level.leftImage || !level.rightImage) {
        console.error("關卡對象缺少必要屬性:", level);
        messageElement.textContent = "無法載入關卡，數據不完整";
        return;
      }

      // 更新圖片
      leftImageElement.src = level.leftImage;
      rightImageElement.src = level.rightImage;
      levelIndicator.textContent = `關卡 ${levelIndex + 1}`;

      // 清空舊的差異點顯示
      resetGameDisplay();

      // 從API加載當前關卡的差異點數據
      const { success, differences: apiDifferences, savedDots: apiSavedDots } = await loadDifferencesFromAPI(level.id);
      
      let finalDifferences = [];
      let finalPositions = {}; // Map: dataId -> position {top, left}
      
      if (success && apiDifferences.length > 0) {
        console.log(`Level ${level.id} data loaded from API.`);
        finalDifferences = apiDifferences;
        apiSavedDots.forEach(dot => {
          finalPositions[dot.id] = dot.rightPosition;
        });
      } else {
        console.warn(`API failed or returned no data for level ${level.id}. Trying default data.`);
        const defaultLevelData = allLevels.find(l => l.levelId === level.id || l.id === level.id); // Find default data
        if (defaultLevelData && defaultLevelData.differences && defaultLevelData.differences.length > 0) {
          console.log(`Using default difference data for level ${level.id}.`);
          finalDifferences = defaultLevelData.differences; // Use default descriptions/ids
          // Attempt to get positions from default data if they exist
          finalDifferences.forEach((diff, index) => {
            const dataIdMatch = String(diff.id).match(/\d+$/);
            const dataId = dataIdMatch ? parseInt(dataIdMatch[0]) : index + 1;
            if (diff.position) {
              finalPositions[dataId] = diff.position;
            } else {
              // Fallback position if even default data lacks it
              finalPositions[dataId] = { top: `${15 + index * 15}%`, left: `${20 + index * 10}%` };
              console.warn(`Default data for diff ${dataId} also lacks position. Using fallback.`);
            }
          });
        } else {
          console.error(`No data found for level ${level.id} from API or defaults.`);
          messageElement.textContent = `錯誤：無法載入關卡 ${level.id} 的差異點！`;
          finalDifferences = [];
          finalPositions = {};
        }
      }
      
      // **** 將加載的數據存儲到當前 level 對象中，供 handleGameClick 等使用 ****
      level.differences = finalDifferences; // Store descriptions/diffIds
      level.positions = finalPositions; // Store positions map { dataId: {top, left} }
      
      // 創建差異點 DOM 元素
      createDifferencePoints(finalDifferences, finalPositions); // Pass data directly
    }

    // 修改 createDifferencePoints 以使用傳入的數據
    function createDifferencePoints(differences, positionsMap) {
      if (!differences || differences.length === 0) {
        console.warn('No differences provided to createDifferencePoints');
        totalCountElement.textContent = '0'; // Update total count display
        return;
      }
      
      // 清除現有點 (確保 resetGameDisplay 已被調用，但再次執行無害)
      // document.querySelectorAll('.dot, .label').forEach(el => {
      //   if (el !== levelIndicator) el.remove();
      // });
      
      const leftContainer = document.getElementById('left-image');
      const rightContainer = document.getElementById('right-image');
      
      if (!leftContainer || !rightContainer) {
        console.error('Image containers not found');
        return;
      }
      
      console.log(`Creating ${differences.length} difference points in DOM.`);
      totalCountElement.textContent = `${differences.length}`; // Update total count display
      foundCountElement.textContent = '0'; // Reset found count display for the new level
      
      // 為每個差異創建點
      differences.forEach((diff, index) => {
        const diffIdMatch = String(diff.id).match(/\d+$/);
        const dataId = diffIdMatch ? parseInt(diffIdMatch[0]) : index + 1; // Ensure dataId is a number
        
        // 從 map 中獲取位置
        const position = positionsMap[dataId];
        
        if (!position || !position.top || !position.left) {
          console.warn(`Position data missing or invalid for difference dataId ${dataId}. Skipping dot creation.`);
          // Assign a default position if needed, or skip
          // position = { top: `${15 + index * 15}%`, left: `${20 + index * 10}%` };
          return; // Skip creating this dot if position is invalid
        }
        
        // 確保使用百分比位置
        const posTop = String(position.top).includes('%') ? position.top : `${position.top}%`;
        const posLeft = String(position.left).includes('%') ? position.left : `${position.left}%`;
        const finalPosition = { top: posTop, left: posLeft };
        
        const dotIdBase = `diff${dataId}`;
        const labelIdBase = `label${dataId}`;
        
        // 創建左右圖的點和標籤
        createDotElement(leftContainer, dotIdBase, dataId, finalPosition);
        createLabelElement(leftContainer, labelIdBase, dataId, finalPosition);
        
        createDotElement(rightContainer, `${dotIdBase}-right`, dataId, finalPosition);
        createLabelElement(rightContainer, `${labelIdBase}-right`, dataId, finalPosition);
        
        // (Optional) 檢查 foundDifferences - resetGameDisplay 應該已經處理了顯示
        // if (foundDifferences.has(String(dataId))) { ... }
      });
    }

    // 輔助函數：創建點元素 (檢查)
    function createDotElement(container, id, dataId, position) {
      const dot = document.createElement('div');
      dot.className = 'dot';
      dot.id = id;
      dot.setAttribute('data-id', dataId); // 使用數字 ID 作為 data-id
      
      // 使用傳入的位置
      dot.style.top = position.top;
      dot.style.left = position.left;
      
      // 初始隱藏所有點
      dot.style.display = 'none';
      
      // 將點添加到提供的容器中（左或右圖）
      container.appendChild(dot);
      
      return dot;
    }

    // 輔助函數：創建標籤元素 (檢查)
    function createLabelElement(container, id, dataId, position) {
      const label = document.createElement('div');
      label.className = 'label';
      label.id = id;
      label.style.top = position.top;
      label.style.left = position.left;
      label.textContent = dataId; // 顯示數字 ID
      // 初始隱藏
      // label.style.display = 'none'; // label class handles this with .show
      container.appendChild(label);
    }

    function pauseTimer() {
      if (timerRunning) {
        clearInterval(timerInterval);
        timerRunning = false;
        totalElapsedTime = Date.now() - startTime;
        console.log("Timer paused. Total elapsed time:", totalElapsedTime);
      }
    }

    // 處理點擊事件
    function handleGameClick(e, container, isRight) {
      // 點擊的是圖片本身或容器，而不是點或標籤
      if (!e.target.matches('img') && e.target !== container) {
        return;
      }
      const level = gameLevels[currentLevel];
      if (!level || !level.differences || level.differences.length === 0 || !level.positions) return; // 沒有點可以找或位置數據缺失

      // 計算點擊相對於圖片的位置
      const img = container.querySelector('img');
      const rect = img.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      console.log(`Click at (${x.toFixed(2)}%, ${y.toFixed(2)}%) on ${isRight ? 'right' : 'left'} image`);

      // 檢查是否點擊在差異點附近
      let found = false;
      for (let i = 0; i < level.differences.length; i++) {
        const diff = level.differences[i];
        const diffIdMatch = String(diff.id).match(/\d+$/);
        if (!diffIdMatch) continue;
        const dataId = diffIdMatch[0]; // 獲取數字 ID (字符串形式)
        const dataIdNum = parseInt(dataId); // 數字形式用於查找 position map

        // **** 從 level.positions 獲取位置 ****
        const diffPosition = level.positions[dataIdNum];

        if (!diffPosition) {
          console.warn(`Position data not found in level.positions for dataId: ${dataIdNum}`);
          continue;
        }

        const diffX = parseFloat(diffPosition.left);
        const diffY = parseFloat(diffPosition.top);

        // 計算距離
        const distance = Math.sqrt(Math.pow(x - diffX, 2) + Math.pow(y - diffY, 2));
        const clickRadius = 5; // 點擊半徑（百分比）

        console.log(`Checking distance to diff ${dataId}: ${distance.toFixed(2)}% (Target: < ${clickRadius}%)`);

        if (distance < clickRadius) { // 調整點擊範圍
          if (!foundDifferences.has(dataId)) {
            console.log(`Found difference ${dataId}!`);
            foundDifferences.add(dataId);
            foundCount++;
            foundCountElement.textContent = `${foundCount}`;

            // 顯示左右兩邊的點和標籤
            document.querySelectorAll(`.dot[data-id="${dataId}"]`).forEach(dot => {
              dot.style.display = 'block';
              dot.classList.add('found');
            });
            document.querySelectorAll(`.label[data-id="${dataId}"]`).forEach(label => {
              label.classList.add('show');
            });

            messageElement.textContent = `找到了！`; // Use description from diff

            // 檢查是否找到所有差異點
            if (foundCount === level.differences.length) {
              console.log("All differences found for this level!");
              setTimeout(showCompletionMessage, 1000); // 延遲顯示過關信息
            }
          } else {
            console.log(`Difference ${dataId} already found.`);
            messageElement.textContent = `這個點已經找到了！`;
            setTimeout(() => { messageElement.textContent = ''; }, 1500);
          }
          found = true;
          break; // 找到一個就停止檢查
        }
      }

      // 如果點擊不在任何差異點附近
      if (!found && e.target.matches('img')) {
        console.log("Missed.");
        messageElement.textContent = '請再試一次';
        setTimeout(() => { messageElement.textContent = ''; }, 1000);
      }
    }
  </script>
</body>
</html>