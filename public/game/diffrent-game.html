<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>找出 5 個不同之處（帶簡易編輯器）</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fffbe6;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    h1, h2 {
      color: #ff8c00;
      margin: 15px 0;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      flex-direction: column;
      gap: 10px;
    }
    .tab {
      padding: 10px 20px;
      background-color: #ff8c00;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    .tab.active {
      background-color: #e67e00;
      transform: scale(1.1);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .game-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .image-container {
      position: relative;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .image-container img {
      width: 90vw;
      max-width: 400px;
      height: auto;
      border: none;
      border-radius: 10px;
      display: block;
    }
    .image-label {
      font-size: 16px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 3px 8px;
      border-radius: 4px;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dot {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid red;
      border-radius: 50%;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }
    .dot.found {
      background-color: rgba(255, 0, 0, 0.5);
      animation: pulse 1s infinite alternate;
    }
    .dot.hint {
      border: 2px dashed gold;
      background-color: rgba(255, 255, 0, 0.3);
      box-shadow: 0 0 10px gold;
    }
    .label {
      position: absolute;
      font-weight: bold;
      color: red;
      background-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 20px;
      font-size: 12px;
      transform: translate(-50%, -50%);
      display: none;
    }
    .label.show {
      display: block;
    }
    .game-status-container {
      width: auto;
      max-width: 450px;
      margin: 0 auto 10px;
      padding: 8px 15px;
      background-color: #fff8e1;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-block;
    }
    #status {
      margin: 0;
      font-size: 18px;
      color: #008800;
      font-weight: bold;
      display: inline-block;
    }
    #timer {
      margin-left: 15px;
      display: inline-block;
      color: #ff6600;
      font-weight: bold;
    }
    #timer-display {
      font-weight: bold;
    }
    #message {
      min-height: 24px;
      font-size: 16px;
      color: #0066cc;
      font-weight: bold;
      margin: 0 0 0 15px;
      display: inline-block;
    }
    .controls {
      margin: 10px 0 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .button {
      padding: 10px 15px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .button:hover {
      background-color: #e67e00;
      transform: scale(1.05);
    }
    .button.hint {
      background-color: #ffc107;
    }
    .button.reset {
      background-color: #6c757d;
    }
    .difference-list {
      max-width: 90%;
      margin: 20px auto;
      text-align: left;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .difference-list.show {
      display: block;
    }
    .difference-list h3 {
      margin-top: 0;
      color: #ff8c00;
    }
    .difference-list ul {
      padding-left: 20px;
    }
    .difference-list li {
      margin-bottom: 8px;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.9; }
    }
    .level-transition {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }
    .level-transition.show {
      opacity: 1;
      visibility: visible;
    }
    .level-transition h2 {
      font-size: 32px;
      margin-bottom: 20px;
      color: #ffc107;
    }
    .level-transition p {
      font-size: 18px;
      margin-bottom: 30px;
    }
    .level-transition button {
      padding: 12px 24px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .level-transition button:hover {
      background-color: #e67e00;
      transform: scale(1.05);
    }
    .level-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      color: #ff8c00;
      z-index: 10;
    }
    .level-select {
      display: inline-block;
      position: relative;
      margin-left: 10px;
    }
    
    .level-select select {
      padding: 8px 12px;
      background-color: #6200ee;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      padding-right: 30px;
    }
    
    .level-select::after {
      content: "▼";
      font-size: 10px;
      color: white;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    
    /* Leaderboard styles */
    .leaderboard-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }
    
    .leaderboard-container.show {
      opacity: 1;
      visibility: visible;
    }
    
    .leaderboard-content {
      background-color: #fff;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .leaderboard-content h2 {
      margin-top: 0;
      color: #ff8c00;
    }
    
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .leaderboard-table th, .leaderboard-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .leaderboard-table th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }
    
    .leaderboard-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .leaderboard-table tr:hover {
      background-color: #f1f1f1;
    }
    
    .name-entry-form {
      margin-top: 20px;
      padding: 15px;
      background-color: #f2f2f2;
      border-radius: 8px;
    }
    
    .name-entry-form input {
      padding: 8px 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    
    .name-entry-form button {
      padding: 8px 15px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .leaderboard-buttons {
      margin-top: 20px;
      display: flex;
      gap: 15px;
    }
    
    .leaderboard-buttons button {
      padding: 10px 20px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .leaderboard-buttons button.secondary {
      background-color: #6c757d;
    }
  </style>
</head>
<body>
  
  <div class="tabs">
    <div class="tab active" data-tab="game">遊戲模式</div>
  </div>
  
  <div id="game-tab" class="tab-content active">
    <div class="game-container">
      <div class="image-container" id="left-image">
        <img src="https://sunnyyummy.onrender.com/uploads/1745928020704-22308.png" alt="原圖" />
        <!-- 差異點1: D vs O (第二個D變成O) -->
        <div class="dot" id="diff1" data-id="1" style="top: 30%; left: 67%;"></div>
        <div class="label" id="label1" style="top: 30%; left: 67%;">1</div>
        
        <!-- 差異點2: YOMMY vs YOMMY (MM vs M) -->
        <div class="dot" id="diff2" data-id="2" style="top: 70%; left: 67%;"></div>
        <div class="label" id="label2" style="top: 70%; left: 67%;">2</div>
        
        <!-- 差異點3: 右邊角色眼睛樣式 -->
        <div class="dot" id="diff3" data-id="3" style="top: 50%; left: 83%;"></div>
        <div class="label" id="label3" style="top: 50%; left: 83%;">3</div>
        
        <!-- 差異點4: 粉色帽子 -->
        <div class="dot" id="diff4" data-id="4" style="top: 50%; left: 38%;"></div>
        <div class="label" id="label4" style="top: 50%; left: 38%;">4</div>
        
        <!-- 差異點5: 中間角色表情 -->
        <div class="dot" id="diff5" data-id="5" style="top: 52%; left: 60%;"></div>
        <div class="label" id="label5" style="top: 52%; left: 60%;">5</div>
        
        <div class="image-label">原圖</div>
      </div>
      
      <div class="game-status-container">
        <div id="status">已找到：<span id="found-count">0</span> / <span id="total-count">5</span></div>
        <div id="timer" style="margin-left: 15px; display: inline-block; color: #ff6600; font-weight: bold;">時間：<span id="timer-display">00:00</span></div>
        <div id="message"></div>
      </div>
      
      <div class="image-container" id="right-image">
        <img src="https://sunnyyummy.onrender.com/uploads/1745928028967-85686.png" alt="修改版" />
        <!-- 差異點1: D vs O (第二個D變成O) -->
        <div class="dot" id="diff1-right" data-id="1" style="top: 30%; left: 67%;"></div>
        <div class="label" id="label1-right" style="top: 30%; left: 67%;">1</div>
        
        <!-- 差異點2: YOMMY vs YOMMY (MM vs M) -->
        <div class="dot" id="diff2-right" data-id="2" style="top: 70%; left: 67%;"></div>
        <div class="label" id="label2-right" style="top: 70%; left: 67%;">2</div>
        
        <!-- 差異點3: 右邊角色眼睛樣式 -->
        <div class="dot" id="diff3-right" data-id="3" style="top: 50%; left: 83%;"></div>
        <div class="label" id="label3-right" style="top: 50%; left: 83%;">3</div>
        
        <!-- 差異點4: 粉色帽子 -->
        <div class="dot" id="diff4-right" data-id="4" style="top: 50%; left: 38%;"></div>
        <div class="label" id="label4-right" style="top: 50%; left: 38%;">4</div>
        
        <!-- 差異點5: 中間角色表情 -->
        <div class="dot" id="diff5-right" data-id="5" style="top: 52%; left: 60%;"></div>
        <div class="label" id="label5-right" style="top: 52%; left: 60%;">5</div>
        
        <div class="image-label">修改版</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="button" id="leaderboard-button">排行榜</button>
      <button class="button" id="show-answers-button">顯示所有答案</button>
      <button class="button reset" id="reset-button">重新開始</button>
    </div>
  </div>
  
  <div class="level-transition" id="level-transition">
    <h2>恭喜完成第一關！</h2>
    <p>準備好挑戰第二關了嗎？</p>
    <button id="next-level-button">開始第二關</button>
  </div>
  
  <!-- 排行榜 -->
  <div class="leaderboard-container" id="leaderboard-container">
    <div class="leaderboard-content">
      <h2>排行榜</h2>
      <div id="name-entry-container" class="name-entry-form">
        <p>恭喜完成所有關卡！總耗時: <span id="final-time-display"></span></p>
        <input type="text" id="player-name" placeholder="請輸入您的名字" maxlength="20">
        <button id="submit-score">提交成績</button>
      </div>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>排名</th>
            <th>名字</th>
            <th>時間</th>
            <th>日期</th>
          </tr>
        </thead>
        <tbody id="leaderboard-rows">
          <!-- 排行榜資料將動態填入 -->
        </tbody>
      </table>
      <div class="leaderboard-buttons">
        <button id="close-leaderboard" class="secondary">關閉</button>
        <button id="restart-game">重新開始</button>
      </div>
    </div>
  </div>
  
  <script>
    // 切換標籤頁
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // 移除所有標籤和內容的active類
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // 添加active類到當前標籤和對應的內容
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab') + '-tab').classList.add('active');
      });
    });
    
    // ----- 遊戲模式代碼 -----
    const allLevels = [
      {
        // 第一關
        levelId: 1,
        storageKey: 'differentGameLevel1Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745928020704-22308.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745928028967-85686.png",
        // 保持第一關的初始點位數據，以便在localStorage沒有數據時使用
        differences: [
          { id: 'diff1', description: '差異點位於右上區域 (D vs O)', position: { top: '30%', left: '67%' } },
          { id: 'diff2', description: '差異點位於右下區域 (YOMMY vs YOMY)', position: { top: '70%', left: '67%' } },
          { id: 'diff3', description: '差異點位於右側眼睛樣式', position: { top: '50%', left: '83%' } },
          { id: 'diff4', description: '差異點位於左側粉色帽子', position: { top: '50%', left: '38%' } },
          { id: 'diff5', description: '差異點位於中間角色表情', position: { top: '52%', left: '60%' } }
        ]
      },
      {
        // 第二關
        levelId: 2,
        storageKey: 'differentGameLevel2Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745941255784-4084.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745941265630-74495.png",
        differences: [] // 初始為空，期望從 localStorage 載入
      },
      {
        // 第三關
        levelId: 3,
        storageKey: 'differentGameLevel3Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745944114845-94074.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745944121794-50612.png",
        differences: [ // 添加第三關的默認差異點 (如果 localStorage 沒有)
          { id: 'diff1', description: '第三關差異點A', position: { top: '20%', left: '25%' } },
          { id: 'diff2', description: '第三關差異點B', position: { top: '15%', left: '75%' } },
          { id: 'diff3', description: '第三關差異點C', position: { top: '50%', left: '50%' } },
          { id: 'diff4', description: '第三關差異點D', position: { top: '80%', left: '30%' } },
          { id: 'diff5', description: '第三關差異點E', position: { top: '75%', left: '70%' } }
        ]
      },
      {
        // 第四關 (範例)
        levelId: 4,
        storageKey: 'differentGameLevel4Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745945120161-78277.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745945134090-91988.png",
        differences: [ // 第四關的默認差異點
          { id: 'diff1', description: '第四關差異點1', position: { top: '25%', left: '15%' } },
          { id: 'diff2', description: '第四關差異點2', position: { top: '35%', left: '80%' } },
          { id: 'diff3', description: '第四關差異點3', position: { top: '60%', left: '50%' } },
          { id: 'diff4', description: '第四關差異點4', position: { top: '75%', left: '20%' } },
          { id: 'diff5', description: '第四關差異點5', position: { top: '85%', left: '70%' } }
        ]
      }
    ];

    // 創建 allLevels 的深拷貝以備修改
    const allLevelsData = JSON.parse(JSON.stringify(allLevels));

   // 修改 getRandomLevels 函數以確保返回正確的格式
async function getRandomLevels() {
  try {
    const response = await fetch('/api/diffrent-game/levels/random');
    const levels = await response.json();
    
    if (!levels || !Array.isArray(levels) || levels.length === 0) {
      console.warn('API未返回有效關卡，使用默認關卡');
      return allLevels; // 使用默認關卡
    }
    
    // 格式化確保每個level有正確的屬性
    const formattedLevels = levels.map(level => ({
      id: level.id,
      levelId: level.id,
      leftImage: level.left_image_url,
      rightImage: level.right_image_url
    }));
    console.log("隨機選擇的關卡:", formattedLevels.map(l => l.id));
    return formattedLevels;
  } catch (error) {
    console.error('無法獲取隨機關卡:', error);
    console.warn('使用默認關卡作為備用');
    return allLevels; // 失敗時使用默認關卡
  }
}

    // ----- 遊戲狀態變數 -----
    let gameLevels = []; // 儲存當前遊戲會用到的隨機關卡
    let currentLevel = 0;
    // let differences = []; // 不再需要全局 differences

    let foundCount = 0;
    const foundDifferences = new Set();
    const messageElement = document.getElementById('message');
    const foundCountElement = document.getElementById('found-count');
    const totalCountElement = document.getElementById('total-count');
    const resetButton = document.getElementById('reset-button');
    const showAnswersButton = document.getElementById('show-answers-button');
    const hintButton = document.getElementById('hint-button');
    const levelTransition = document.getElementById('level-transition');
    const nextLevelButton = document.getElementById('next-level-button');
    const deleteLevelButton = document.getElementById('delete-level');

    // 計時器相關變數
    let timerInterval;
    let startTime;
    let totalElapsedTime = 0;
    let timerRunning = false;
    const timerDisplay = document.getElementById('timer-display');

    let answersVisible = false;

    // ----- DOM 元素 -----
    const leftImageContainer = document.getElementById('left-image');
    const rightImageContainer = document.getElementById('right-image');
    const leftImageElement = leftImageContainer.querySelector('img');
    const rightImageElement = rightImageContainer.querySelector('img');
    const levelIndicator = document.createElement('div'); // 關卡指示器只需要創建一次
    levelIndicator.className = 'level-indicator';
    leftImageContainer.appendChild(levelIndicator); // 添加到左圖容器

    // ----- 編輯器模式變數 (Remove these) -----
    // const editLeftImg = document.getElementById('left-edit-img');
    // const editRightImg = document.getElementById('right-edit-img');
    // const levelSelector = document.getElementById('level-selector');
    // const saveEditorButton = document.getElementById('save-editor');
    // const clearEditorButton = document.getElementById('clear-editor');
    // const outputArea = document.getElementById('output');
    // const addNewLevelButton = document.getElementById('add-new-level');
    // const newLevelForm = document.getElementById('new-level-form');
    // const submitNewLevelButton = document.getElementById('submit-new-level');
    // const cancelNewLevelButton = document.getElementById('cancel-new-level');
    // const editorDifferences = [];
    // let currentEditorLevel = null;

    // ----- 編輯器模式函數 (Remove these functions) -----
    // async function populateLevelSelector() { ... }
    // async function loadLevelToEditor(levelId) { ... }
    // function clearEditorDisplay() { ... }
    // function addEditorDot(top, left, description) { ... }
    // function makeDraggable(element) { ... }
    // function updateOutput() { ... }
    // async function saveEditorData() { ... }
    // async function submitNewLevel() { ... }

    // 載入關卡（遊戲模式）
    async function loadLevel(index) {
      if (!gameLevels || index >= gameLevels.length) {
        console.error("Invalid level index or missing levels");
        return;
      }
      
      currentLevel = index;
      const level = gameLevels[index];
      console.log(`Loading level ${index + 1}:`, level);
      
      // 重置找到的差異
      foundDifferences.clear();
      foundCount = 0;
      foundCountElement.textContent = '0';
      answersVisible = false;
      showAnswersButton.textContent = '顯示所有答案';
      
      // 更新關卡指示器
      levelIndicator.textContent = `關卡 ${index + 1}/${gameLevels.length}`;
      
      // 設置圖片
      leftImageElement.src = level.leftImage;
      rightImageElement.src = level.rightImage;
      
      // 隱藏所有點和標籤
      document.querySelectorAll('.dot').forEach(dot => {
        dot.style.display = 'none';
        dot.classList.remove('found', 'hint');
      });
      document.querySelectorAll('.label').forEach(label => {
        label.classList.remove('show');
      });
      
      // 獲取差異點
      try {
        const response = await fetch(`/api/diffrent-game/differences/${level.id}`);
        if (!response.ok) {
          throw new Error(`無法獲取關卡 ${level.id} 的差異點`);
        }
        
        const differences = await response.json();
        level.differences = differences.map((diff, idx) => ({
          id: `diff${idx + 1}`,
          description: diff.description || `差異點 ${idx + 1}`,
          position: {
            top: diff.position_top + '%',
            left: diff.position_left + '%'
          }
        }));
        
        // 建立位置映射以便點擊檢測
        level.positions = {};
        level.differences.forEach((diff, idx) => {
          // 從 id 提取數字部分作為索引
          const match = String(diff.id).match(/\d+$/);
          if (match) {
            const numId = parseInt(match[0]);
            level.positions[numId] = {
              top: parseFloat(diff.position.top),
              left: parseFloat(diff.position.left)
            };
          }
        });
        
        totalCountElement.textContent = level.differences.length;
        console.log(`Loaded ${level.differences.length} differences for level ${index + 1}`);
        
        // Update the position of existing dots and labels based on fetched data
        level.differences.forEach(diff => {
          const match = String(diff.id).match(/\d+$/);
          if (!match) return;
          const dataId = match[0];
          
          const dots = document.querySelectorAll(`.dot[data-id="${dataId}"]`);
          const labels = document.querySelectorAll(`.label[data-id="${dataId}"]`);
          
          dots.forEach(dot => {
            dot.style.top = diff.position.top;
            dot.style.left = diff.position.left;
            dot.style.display = 'none'; // Ensure they start hidden
            dot.classList.remove('found', 'hint');
          });
          
          labels.forEach(label => {
            label.style.top = diff.position.top;
            label.style.left = diff.position.left;
            label.classList.remove('show'); // Ensure they start hidden
          });
        });
        
      } catch (error) {
        console.error('載入差異點失敗:', error);
        messageElement.textContent = '無法獲取差異點資料';
      }
    }

    // 加載下一關
    function loadNextLevel() {
      levelTransition.classList.remove('show');
      if (currentLevel + 1 < gameLevels.length) {
        loadLevel(currentLevel + 1);
      } else {
        // 如果是最後一關，則顯示完成信息
        setupNewGame();
      }
    }

    // 設置新遊戲或重置遊戲
    async function setupNewGame() {
      console.log("Setting up new game...");
      
      // 重置遊戲狀態
      foundDifferences.clear();
      foundCount = 0;
      foundCountElement.textContent = '0';
      messageElement.textContent = '';
      answersVisible = false;
      showAnswersButton.textContent = '顯示所有答案';

      // 重置計時器
      clearInterval(timerInterval);
      timerRunning = false;
      totalElapsedTime = 0;
      timerDisplay.textContent = '00:00';
      
      // 確保先有遊戲數據再開始計時器
      try {
        gameLevels = await getRandomLevels(); // 獲取新的隨機關卡列表
        
        if (!gameLevels || gameLevels.length === 0) {
          console.error("無法獲取遊戲關卡");
          messageElement.textContent = "載入遊戲關卡失敗，請重新整理頁面";
          return;
        }
        
        currentLevel = 0;
        startTimer(); // 啟動計時器
        
        // 加載第一個關卡
        loadLevel(currentLevel);
      } catch (error) {
        console.error("初始化遊戲失敗:", error);
        messageElement.textContent = "初始化遊戲失敗，請重新整理頁面";
      }
    }

    function startTimer() {
      if (timerRunning) return;
      
      timerRunning = true;
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }

    // ----- 事件監聽器 (Remove editor listeners) -----
    // if (levelSelector) { levelSelector.addEventListener(...) }
    // if (document.getElementById('edit-left')) { document.getElementById('edit-left').addEventListener(...) }
    // if (saveEditorButton) { saveEditorButton.addEventListener(...) }
    // if (clearEditorButton) { clearEditorButton.addEventListener(...) }
    // if (addNewLevelButton) { addNewLevelButton.addEventListener(...) }
    // if (submitNewLevelButton) { submitNewLevelButton.addEventListener(...) }
    // if (cancelNewLevelButton) { cancelNewLevelButton.addEventListener(...) }
    // if (deleteLevelButton) { deleteLevelButton.addEventListener(...) }

    // ----- 初始調用 -----
    window.onload = async function() {
      // Remove editor initialization: await populateLevelSelector();
      await setupNewGame();

      // Set up event listeners
      nextLevelButton.addEventListener('click', loadNextLevel);
      resetButton.addEventListener('click', setupNewGame);
      
      // 設置"排行榜"按鈕事件
      const leaderboardButton = document.getElementById('leaderboard-button');
      if (leaderboardButton) {
        leaderboardButton.addEventListener('click', displayLeaderboardDirectly);
      }
      
      // 設置"顯示所有答案"按鈕事件
      showAnswersButton.addEventListener('click', function() {
        answersVisible = !answersVisible;
        const level = gameLevels[currentLevel];
        if (!level || !level.differences) return;

        level.differences.forEach(diff => {
            const match = String(diff.id).match(/\d+$/);
            if (!match) return;
            const dataId = match[0];

            const dots = document.querySelectorAll(`.dot[data-id="${dataId}"]`);
            const labels = document.querySelectorAll(`.label[data-id="${dataId}"]`);

            if (answersVisible) {
                dots.forEach(dot => {
                    dot.style.display = 'block';
                    if (!foundDifferences.has(dataId)) {
                        dot.classList.add('hint'); // 對未找到的用提示樣式
                        dot.classList.remove('found');
                    }
                });
                labels.forEach(label => label.classList.add('show'));
            } else {
                // 隱藏答案
                dots.forEach(dot => {
                    if (!foundDifferences.has(dataId)) {
                        dot.style.display = 'none'; // 隱藏未找到的
                        dot.classList.remove('hint');
                    } else {
                        dot.classList.remove('hint'); // 確保已找到的沒有 hint 樣式
                    }
                });
                labels.forEach(label => {
                    if (!foundDifferences.has(dataId)) {
                        label.classList.remove('show'); // 隱藏未找到的標籤
                    }
                });
            }
        });

        showAnswersButton.textContent = answersVisible ? '隱藏答案' : '顯示所有答案';
        messageElement.textContent = answersVisible ? '已顯示所有答案' : '';
      });
      
      // 為遊戲模式中的每個圖片容器添加點擊事件
      leftImageContainer.addEventListener('click', function(e) {
        handleGameClick(e, this, false);
      });

      rightImageContainer.addEventListener('click', function(e) {
        handleGameClick(e, this, true);
      });
    };

    // Function to fetch and display leaderboard directly (按下排行榜按鈕時呼叫)
    async function displayLeaderboardDirectly() {
      let leaderboard = [];
      try {
        const res = await fetch('/api/diffrent-game/leaderboard'); // 取得排行榜
        if (!res.ok) {
           throw new Error(`Failed to fetch leaderboard: ${res.status} ${res.statusText}`);
        }
        leaderboard = await res.json();
        // Ensure leaderboard is an array before proceeding
        if (!Array.isArray(leaderboard)) {
            console.error("Leaderboard data is not an array:", leaderboard);
            alert("排行榜資料格式錯誤，無法處理。");
            // Optionally hide the leaderboard container if it was shown
            const leaderboardContainer = document.getElementById('leaderboard-container');
            if (leaderboardContainer) leaderboardContainer.classList.remove('show');
            return;
        }
        // 顯示排行榜，不需要提交分數
        showLeaderboard(leaderboard, false, null);
      } catch (e) {
        console.error("Error fetching leaderboard directly:", e); // Log the actual error
        alert('無法取得排行榜，請稍後再試');
      }
    }

    // 處理點擊事件
    function handleGameClick(e, container, isRight) {
      // 點擊的是圖片本身或容器，而不是點或標籤
      if (!e.target.matches('img') && e.target !== container) {
        return;
      }
      const level = gameLevels[currentLevel];
      if (!level || !level.differences || level.differences.length === 0 || !level.positions) return; // 沒有點可以找或位置數據缺失

      // 計算點擊相對於圖片的位置
      const img = container.querySelector('img');
      const rect = img.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      console.log(`Click at (${x.toFixed(2)}%, ${y.toFixed(2)}%) on ${isRight ? 'right' : 'left'} image`);

      // 檢查是否點擊在差異點附近
      let found = false;
      for (let i = 0; i < level.differences.length; i++) {
        const diff = level.differences[i];
        const diffIdMatch = String(diff.id).match(/\d+$/);
        if (!diffIdMatch) continue;
        const dataId = diffIdMatch[0]; // 獲取數字 ID (字符串形式)
        const dataIdNum = parseInt(dataId); // 數字形式用於查找 position map

        // **** 從 level.positions 獲取位置 ****
        const diffPosition = level.positions[dataIdNum];

        if (!diffPosition) {
          console.warn(`Position data not found in level.positions for dataId: ${dataIdNum}`);
          continue;
        }

        const diffX = parseFloat(diffPosition.left);
        const diffY = parseFloat(diffPosition.top);

        // 計算距離
        const distance = Math.sqrt(Math.pow(x - diffX, 2) + Math.pow(y - diffY, 2));
        const clickRadius = 5; // 點擊半徑（百分比）

        // **** ADD EXTRA LOGGING ****
        console.log(`BEFORE IF: i=${i}, dataId=${dataId}, distance=${distance.toFixed(2)}, clickRadius=${clickRadius}, condition=${distance < clickRadius}`);

        // ** Existing Log **
        console.log(`Checking distance to diff ${dataId}: ${distance.toFixed(2)}% (Target: < ${clickRadius}%)`);

        // ** The Core Conditional Logic **
        if (distance < clickRadius) { // Check if click is within radius
          if (!foundDifferences.has(dataId)) { // Check if not already found
            // This block executes if BOTH conditions are true
            // ** Modify log slightly for clarity **
            console.log(`INSIDE IF: Found difference ${dataId}!`); // Log the found difference
            foundDifferences.add(dataId);
            foundCount++;
            foundCountElement.textContent = `${foundCount}`;

            // 顯示左右兩邊的點和標籤
            document.querySelectorAll(`.dot[data-id="${dataId}"]`).forEach(dot => {
              dot.style.display = 'block';
              dot.classList.add('found');
            });
            document.querySelectorAll(`.label[data-id="${dataId}"]`).forEach(label => {
              label.classList.add('show');
            });

            messageElement.textContent = `找到了！`; // Use description from diff

            // 檢查是否找到所有差異點
            if (foundCount === level.differences.length) {
              console.log("All differences found for this level!");
              setTimeout(showCompletionMessage, 1000); // 延遲顯示過關信息
            }
          } else {
            console.log(`Difference ${dataId} already found.`);
            messageElement.textContent = `這個點已經找到了！`;
            setTimeout(() => { messageElement.textContent = ''; }, 1500);
          }
          found = true;
          break; // 找到一個就停止檢查
        }
      }

      // 如果點擊不在任何差異點附近
      if (!found && e.target.matches('img')) {
        console.log("Missed.");
        messageElement.textContent = '請再試一次';
        setTimeout(() => { messageElement.textContent = ''; }, 1000);
      }
    }

    function updateTimer() {
      if (!timerRunning) return;
      const currentTime = Date.now();
      const elapsedTime = currentTime - startTime;
      const seconds = Math.floor((elapsedTime / 1000) % 60);
      const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      totalElapsedTime = elapsedTime;
    }

    function showCompletionMessage() {
      levelTransition.querySelector('h2').textContent = `恭喜完成第 ${currentLevel + 1} 關！`;
      if (currentLevel + 1 < gameLevels.length) {
        levelTransition.querySelector('p').textContent = `準備好挑戰第 ${currentLevel + 2} 關了嗎？`;
        nextLevelButton.textContent = `開始第 ${currentLevel + 2} 關`;
        nextLevelButton.disabled = false;
        // 移除可能已存在的點擊事件
        nextLevelButton.onclick = null;
      } else {
        // 全部完成
        levelTransition.querySelector('p').textContent = `你已經完成所有關卡！`;
        nextLevelButton.textContent = `重新開始`;
        nextLevelButton.disabled = false;
        // 設定重新開始的點擊事件
        nextLevelButton.onclick = function() {
          levelTransition.classList.remove('show');
          setupNewGame();
        };
        setTimeout(checkLeaderboardAndShow, 1200);
      }
      levelTransition.classList.add('show');
    }

    async function checkLeaderboardAndShow() {
      // 1. 取得總秒數
      const timeText = timerDisplay.textContent; // 格式 00:34
      const [min, sec] = timeText.split(':').map(Number);
      const totalSeconds = min * 60 + sec;

      // 2. 取得排行榜
      let leaderboard = [];
      try {
        const res = await fetch('/api/diffrent-game/leaderboard');
        if (!res.ok) {
            throw new Error(`Failed to fetch leaderboard: ${res.status} ${res.statusText}`);
        }
        leaderboard = await res.json();
      } catch (e) { // Add the closing brace here
        console.error("Error fetching or parsing leaderboard:", e); // Log the actual error
        alert('無法取得排行榜，請稍後再試');
        return;
      }

      // Ensure leaderboard is an array before proceeding
      if (!Array.isArray(leaderboard)) {
          console.error("Leaderboard data is not an array:", leaderboard);
          alert("排行榜資料格式錯誤，無法處理。");
          return;
      }

      // 3. 檢查是否進前 50 名
      const isInTop50 = leaderboard.length < 50 || leaderboard.some(entry => totalSeconds < entry.time_seconds);

      // 4. 顯示排行榜
      showLeaderboard(leaderboard, isInTop50, totalSeconds);
    }

    function showLeaderboard(leaderboard, canSubmit, mySeconds) {
      // 顯示排行榜區塊
      const leaderboardContainer = document.getElementById('leaderboard-container');
      leaderboardContainer.classList.add('show');

      // 填入排行榜資料
      const tbody = document.getElementById('leaderboard-rows');
      tbody.innerHTML = '';
      leaderboard.slice(0, 50).forEach((entry, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td><td>${entry.player_name || 'N/A'}</td><td>${formatTime(entry.time_seconds)}</td><td>${formatDate(entry.created_at)}</td>`;
        tbody.appendChild(tr);
      });

      // 顯示/隱藏名字輸入表單
      const nameEntry = document.getElementById('name-entry-container');
      if (canSubmit) {
        nameEntry.style.display = 'block';
        document.getElementById('final-time-display').textContent = timerDisplay.textContent;
        // 綁定送出事件（只需綁一次）
        document.getElementById('submit-score').onclick = async function() {
          const name = document.getElementById('player-name').value.trim();
          if (!name || name.length > 20) {
            alert('名字不能空白且最多 20 字');
            return false;
          }
          const ok = await submitScore(name, mySeconds);
          if (ok) {
            nameEntry.style.display = 'none';
            await checkLeaderboardAndShow(); // 重新載入排行榜
          }
          // 如果失敗，停留在輸入框，讓使用者可以再試一次
        };
      } else {
        nameEntry.style.display = 'none';
      }

      // 綁定重新開始
      document.getElementById('restart-game').onclick = function() {
        leaderboardContainer.classList.remove('show');
        setupNewGame();
      };
      document.getElementById('close-leaderboard').onclick = function() {
        leaderboardContainer.classList.remove('show');
      };
    }

    // Helper function to format seconds into MM:SS
    function formatTime(totalSeconds) {
        if (totalSeconds === null || totalSeconds === undefined) return 'N/A';
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            // Return YYYY-MM-DD format
            return date.toISOString().split('T')[0];
        } catch (e) {
            return 'Invalid Date';
        }
    }

    async function submitScore(name, seconds) {
      if (!name || name.length > 20) {
        alert('名字不能空白且最多 20 字');
        return false;
      }
      try {
        console.log('送出排行榜資料:', { player_name: name, time_seconds: seconds });

        const res = await fetch('/api/diffrent-game/leaderboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ player_name: name, time_seconds: seconds })
        });

        let responseData;
        try {
          responseData = await res.json();
        } catch (jsonErr) {
          responseData = await res.text();
        }

        console.log('排行榜 API 回應:', res.status, responseData);

        if (!res.ok) {
          alert('送出成績失敗：' + (responseData.error || responseData || res.statusText));
          return false;
        }
        return true;
      } catch (e) {
        alert('送出成績失敗（網路或程式錯誤）');
        console.error(e);
        return false;
      }
    }
  </script>
</body>
</html>