<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>找出 5 個不同之處（帶簡易編輯器）</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fffbe6;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    h1, h2 {
      color: #ff8c00;
      margin: 15px 0;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      flex-direction: column;
      gap: 10px;
    }
    .tab {
      padding: 10px 20px;
      background-color: #ff8c00;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    .tab.active {
      background-color: #e67e00;
      transform: scale(1.1);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .game-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .image-container {
      position: relative;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .image-container img {
      width: 90vw;
      max-width: 400px;
      height: auto;
      border: none;
      border-radius: 10px;
      display: block;
    }
    .image-label {
      font-size: 16px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 3px 8px;
      border-radius: 4px;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dot {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid red;
      border-radius: 50%;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }
    .dot.found {
      background-color: rgba(255, 0, 0, 0.5);
      animation: pulse 1s infinite alternate;
    }
    .dot.hint {
      border: 2px dashed gold;
      background-color: rgba(255, 255, 0, 0.3);
      box-shadow: 0 0 10px gold;
    }
    .editor-dot {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid red;
      border-radius: 50%;
      background-color: rgba(255, 0, 0, 0.3);
      cursor: move;
      transform: translate(-50%, -50%);
    }
    .editor-dot.reference {
      background-color: rgba(255, 0, 0, 0.2);
      border: 2px dashed red;
      cursor: default;
    }
    .label {
      position: absolute;
      font-weight: bold;
      color: red;
      background-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 20px;
      font-size: 12px;
      transform: translate(-50%, -50%);
      display: none;
    }
    .label.show {
      display: block;
    }
    .game-status-container {
      width: auto;
      max-width: 450px;
      margin: 0 auto 10px;
      padding: 8px 15px;
      background-color: #fff8e1;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-block;
    }
    #status {
      margin: 0;
      font-size: 18px;
      color: #008800;
      font-weight: bold;
      display: inline-block;
    }
    #timer {
      margin-left: 15px;
      display: inline-block;
      color: #ff6600;
      font-weight: bold;
    }
    #timer-display {
      font-weight: bold;
    }
    #message {
      min-height: 24px;
      font-size: 16px;
      color: #0066cc;
      font-weight: bold;
      margin: 0 0 0 15px;
      display: inline-block;
    }
    .controls {
      margin: 10px 0 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .button {
      padding: 10px 15px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .button:hover {
      background-color: #e67e00;
      transform: scale(1.05);
    }
    .button.hint {
      background-color: #ffc107;
    }
    .button.reset {
      background-color: #6c757d;
    }
    .difference-list {
      max-width: 90%;
      margin: 20px auto;
      text-align: left;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .difference-list.show {
      display: block;
    }
    .difference-list h3 {
      margin-top: 0;
      color: #ff8c00;
    }
    .difference-list ul {
      padding-left: 20px;
    }
    .difference-list li {
      margin-bottom: 8px;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.9; }
    }
    .editor-container {
      margin: 20px auto;
      max-width: 90%;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #output {
      width: 100%;
      height: 150px;
      font-family: monospace;
      white-space: pre-wrap;
      text-align: left;
      background: #f5f5f5;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow-y: auto;
      margin-top: 15px;
      font-size: 14px;
    }
    .edit-instructions {
      background-color: #fffbcc;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: left;
    }
    .edit-instructions p {
      margin: 5px 0;
    }
    .edit-instructions ul {
      margin: 5px 0;
      padding-left: 25px;
    }
    .edit-instructions li {
      margin-bottom: 5px;
    }
    /* 手機版特別設定（螢幕寬度小於 768px） */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      h1 {
        font-size: 24px;
        margin: 10px 0;
      }
      .game-container {
        flex-direction: column;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
      }
      .image-container {
        margin-bottom: 5px;
        width: 100%;
      }
      .image-container img {
        width: 100%;
        max-width: none;
        max-height: 40vh;
        object-fit: contain;
      }
      .controls {
        flex-direction: row;
        flex-wrap: wrap;
        margin: 5px 0 15px;
      }
      .button {
        width: auto;
        padding: 8px 12px;
        font-size: 14px;
      }
      .tabs {
        bottom: 10px;
        right: 10px;
      }
      .tab {
        padding: 8px 15px;
        font-size: 14px;
      }
      .game-status-container {
        margin: 5px auto;
        padding: 5px;
      }
      #status {
        font-size: 16px;
        margin: 5px 0;
      }
      #message {
        min-height: 20px;
        font-size: 14px;
      }
      .image-label {
        font-size: 14px;
        padding: 2px 6px;
      }
      .dot, .editor-dot {
        width: 24px;
        height: 24px;
      }
    }
    .level-transition {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }
    .level-transition.show {
      opacity: 1;
      visibility: visible;
    }
    .level-transition h2 {
      font-size: 32px;
      margin-bottom: 20px;
      color: #ffc107;
    }
    .level-transition p {
      font-size: 18px;
      margin-bottom: 30px;
    }
    .level-transition button {
      padding: 12px 24px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .level-transition button:hover {
      background-color: #e67e00;
      transform: scale(1.05);
    }
    .level-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      color: #ff8c00;
      z-index: 10;
    }
    .level-select {
      display: inline-block;
      position: relative;
      margin-left: 10px;
    }
    
    .level-select select {
      padding: 8px 12px;
      background-color: #6200ee;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      padding-right: 30px;
    }
    
    .level-select::after {
      content: "▼";
      font-size: 10px;
      color: white;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    
    /* Leaderboard styles */
    .leaderboard-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }
    
    .leaderboard-container.show {
      opacity: 1;
      visibility: visible;
    }
    
    .leaderboard-content {
      background-color: #fff;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .leaderboard-content h2 {
      margin-top: 0;
      color: #ff8c00;
    }
    
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .leaderboard-table th, .leaderboard-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .leaderboard-table th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }
    
    .leaderboard-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .leaderboard-table tr:hover {
      background-color: #f1f1f1;
    }
    
    .name-entry-form {
      margin-top: 20px;
      padding: 15px;
      background-color: #f2f2f2;
      border-radius: 8px;
    }
    
    .name-entry-form input {
      padding: 8px 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    
    .name-entry-form button {
      padding: 8px 15px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .leaderboard-buttons {
      margin-top: 20px;
      display: flex;
      gap: 15px;
    }
    
    .leaderboard-buttons button {
      padding: 10px 20px;
      background-color: #ff8c00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .leaderboard-buttons button.secondary {
      background-color: #6c757d;
    }
  </style>
</head>
<body>
  
  <div class="tabs">
    <div class="tab active" data-tab="game">遊戲模式</div>
    <div class="tab" data-tab="editor">編輯器模式</div>
  </div>
  
  <div id="game-tab" class="tab-content active">
    <div class="game-container">
      <div class="image-container" id="left-image">
        <img src="https://sunnyyummy.onrender.com/uploads/1745928020704-22308.png" alt="原圖" />
        <!-- 差異點1: D vs O (第二個D變成O) -->
        <div class="dot" id="diff1" data-id="1" style="top: 30%; left: 67%;"></div>
        <div class="label" id="label1" style="top: 30%; left: 67%;">1</div>
        
        <!-- 差異點2: YOMMY vs YOMMY (MM vs M) -->
        <div class="dot" id="diff2" data-id="2" style="top: 70%; left: 67%;"></div>
        <div class="label" id="label2" style="top: 70%; left: 67%;">2</div>
        
        <!-- 差異點3: 右邊角色眼睛樣式 -->
        <div class="dot" id="diff3" data-id="3" style="top: 50%; left: 83%;"></div>
        <div class="label" id="label3" style="top: 50%; left: 83%;">3</div>
        
        <!-- 差異點4: 粉色帽子 -->
        <div class="dot" id="diff4" data-id="4" style="top: 50%; left: 38%;"></div>
        <div class="label" id="label4" style="top: 50%; left: 38%;">4</div>
        
        <!-- 差異點5: 中間角色表情 -->
        <div class="dot" id="diff5" data-id="5" style="top: 52%; left: 60%;"></div>
        <div class="label" id="label5" style="top: 52%; left: 60%;">5</div>
        
        <div class="image-label">原圖</div>
      </div>
      
      <div class="game-status-container">
        <div id="status">已找到：<span id="found-count">0</span> / <span id="total-count">5</span></div>
        <div id="timer" style="margin-left: 15px; display: inline-block; color: #ff6600; font-weight: bold;">時間：<span id="timer-display">00:00</span></div>
        <div id="message"></div>
      </div>
      
      <div class="image-container" id="right-image">
        <img src="https://sunnyyummy.onrender.com/uploads/1745928028967-85686.png" alt="修改版" />
        <!-- 差異點1: D vs O (第二個D變成O) -->
        <div class="dot" id="diff1-right" data-id="1" style="top: 30%; left: 67%;"></div>
        <div class="label" id="label1-right" style="top: 30%; left: 67%;">1</div>
        
        <!-- 差異點2: YOMMY vs YOMMY (MM vs M) -->
        <div class="dot" id="diff2-right" data-id="2" style="top: 70%; left: 67%;"></div>
        <div class="label" id="label2-right" style="top: 70%; left: 67%;">2</div>
        
        <!-- 差異點3: 右邊角色眼睛樣式 -->
        <div class="dot" id="diff3-right" data-id="3" style="top: 50%; left: 83%;"></div>
        <div class="label" id="label3-right" style="top: 50%; left: 83%;">3</div>
        
        <!-- 差異點4: 粉色帽子 -->
        <div class="dot" id="diff4-right" data-id="4" style="top: 50%; left: 38%;"></div>
        <div class="label" id="label4-right" style="top: 50%; left: 38%;">4</div>
        
        <!-- 差異點5: 中間角色表情 -->
        <div class="dot" id="diff5-right" data-id="5" style="top: 52%; left: 60%;"></div>
        <div class="label" id="label5-right" style="top: 52%; left: 60%;">5</div>
        
        <div class="image-label">修改版</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="button reset" id="reset-button">重新開始</button>
    </div>
  </div>
  
  <div id="editor-tab" class="tab-content">
    <h2>編輯器模式 ✏️</h2>
    
    <div class="game-container">
      <div class="image-container" id="edit-left">
        <img src="" alt="原圖" id="left-edit-img" />
        <div class="image-label">原圖</div>
      </div>
      
      <div class="image-container" id="edit-right">
        <img src="" alt="修改版" id="right-edit-img" />
        <div class="image-label">修改版</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="button reset" id="clear-editor">清除所有</button>
      <button class="button" id="save-editor" style="background-color: #28a745;">保存</button>
      <div class="level-select" style="display: flex; align-items: center; gap: 8px;">
        <select id="level-selector">
          <!-- 選項將由JavaScript動態填充 -->
        </select>
        <button class="button" id="delete-level" style="background-color: #dc3545;">刪除圖片</button>
      </div>
      <button class="button" id="add-new-level" style="background-color: #0275d8;">新增圖片</button>
      
    </div>
    
    <!-- 添加輸出區域 -->
    <div style="margin-top: 20px;">
      <textarea id="output" style="width: 100%; height: 100px; font-family: monospace;" readonly></textarea>
    </div>
    
    <!-- 新增圖片表單 -->
    <div id="new-level-form" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
      <h3>新增圖片</h3>
      <div style="margin-bottom: 10px;">
        <label>圖片名稱: <input type="text" id="new-level-name" style="margin-left: 10px;"></label>
      </div>
      <div style="margin-bottom: 10px;">
        <label>原圖URL: <input type="text" id="new-left-image" style="margin-left: 10px; width: 300px;"></label>
      </div>
      <div style="margin-bottom: 10px;">
        <label>修改版URL: <input type="text" id="new-right-image" style="margin-left: 10px; width: 300px;"></label>
      </div>
      <button class="button" id="submit-new-level" style="background-color: #28a745;">提交</button>
      <button class="button" id="cancel-new-level" style="background-color: #dc3545;">取消</button>
    </div>
  </div>
  
  <div class="level-transition" id="level-transition">
    <h2>恭喜完成第一關！</h2>
    <p>準備好挑戰第二關了嗎？</p>
    <button id="next-level-button">開始第二關</button>
  </div>
  
  <!-- 排行榜 -->
  <div class="leaderboard-container" id="leaderboard-container">
    <div class="leaderboard-content">
      <h2>排行榜</h2>
      <div id="name-entry-container" class="name-entry-form">
        <p>恭喜完成所有關卡！總耗時: <span id="final-time-display"></span></p>
        <input type="text" id="player-name" placeholder="請輸入您的名字" maxlength="20">
        <button id="submit-score">提交成績</button>
      </div>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>排名</th>
            <th>名字</th>
            <th>時間</th>
            <th>日期</th>
          </tr>
        </thead>
        <tbody id="leaderboard-rows">
          <!-- 排行榜資料將動態填入 -->
        </tbody>
      </table>
      <div class="leaderboard-buttons">
        <button id="close-leaderboard" class="secondary">關閉</button>
        <button id="restart-game">重新開始</button>
      </div>
    </div>
  </div>
  
  <script>
    // 切換標籤頁
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // 移除所有標籤和內容的active類
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // 添加active類到當前標籤和對應的內容
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab') + '-tab').classList.add('active');
      });
    });
    
    // ----- 遊戲模式代碼 -----
    const allLevels = [
      {
        // 第一關
        levelId: 1,
        storageKey: 'differentGameLevel1Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745928020704-22308.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745928028967-85686.png",
        // 保持第一關的初始點位數據，以便在localStorage沒有數據時使用
        differences: [
          { id: 'diff1', description: '差異點位於右上區域 (D vs O)', position: { top: '30%', left: '67%' } },
          { id: 'diff2', description: '差異點位於右下區域 (YOMMY vs YOMY)', position: { top: '70%', left: '67%' } },
          { id: 'diff3', description: '差異點位於右側眼睛樣式', position: { top: '50%', left: '83%' } },
          { id: 'diff4', description: '差異點位於左側粉色帽子', position: { top: '50%', left: '38%' } },
          { id: 'diff5', description: '差異點位於中間角色表情', position: { top: '52%', left: '60%' } }
        ]
      },
      {
        // 第二關
        levelId: 2,
        storageKey: 'differentGameLevel2Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745941255784-4084.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745941265630-74495.png",
        differences: [] // 初始為空，期望從 localStorage 載入
      },
      {
        // 第三關
        levelId: 3,
        storageKey: 'differentGameLevel3Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745944114845-94074.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745944121794-50612.png",
        differences: [ // 添加第三關的默認差異點 (如果 localStorage 沒有)
          { id: 'diff1', description: '第三關差異點A', position: { top: '20%', left: '25%' } },
          { id: 'diff2', description: '第三關差異點B', position: { top: '15%', left: '75%' } },
          { id: 'diff3', description: '第三關差異點C', position: { top: '50%', left: '50%' } },
          { id: 'diff4', description: '第三關差異點D', position: { top: '80%', left: '30%' } },
          { id: 'diff5', description: '第三關差異點E', position: { top: '75%', left: '70%' } }
        ]
      },
      {
        // 第四關 (範例)
        levelId: 4,
        storageKey: 'differentGameLevel4Data',
        leftImage: "https://sunnyyummy.onrender.com/uploads/1745945120161-78277.png",
        rightImage: "https://sunnyyummy.onrender.com/uploads/1745945134090-91988.png",
        differences: [ // 第四關的默認差異點
          { id: 'diff1', description: '第四關差異點1', position: { top: '25%', left: '15%' } },
          { id: 'diff2', description: '第四關差異點2', position: { top: '35%', left: '80%' } },
          { id: 'diff3', description: '第四關差異點3', position: { top: '60%', left: '50%' } },
          { id: 'diff4', description: '第四關差異點4', position: { top: '75%', left: '20%' } },
          { id: 'diff5', description: '第四關差異點5', position: { top: '85%', left: '70%' } }
        ]
      }
    ];

    // 創建 allLevels 的深拷貝以備修改
    const allLevelsData = JSON.parse(JSON.stringify(allLevels));

   // 修改 getRandomLevels 函數以確保返回正確的格式
async function getRandomLevels() {
  try {
    const response = await fetch('/api/diffrent-game/levels/random');
    const levels = await response.json();
    
    if (!levels || !Array.isArray(levels) || levels.length === 0) {
      console.warn('API未返回有效關卡，使用默認關卡');
      return allLevels; // 使用默認關卡
    }
    
    // 格式化確保每個level有正確的屬性
    const formattedLevels = levels.map(level => {
      // 檢查返回的API數據是否有所有必要的欄位
      if (!level.id || !level.left_image_url || !level.right_image_url) {
        console.warn(`API返回的關卡 ${level.id} 數據不完整，跳過該關卡`);
        return null;
      }
      
      return {
        id: level.id,
        levelId: level.id,
        storageKey: `differentGameLevel${level.id}Data`, // 確保有storageKey屬性
        leftImage: level.left_image_url,
        rightImage: level.right_image_url,
        differences: [], // 初始為空陣列，稍後會在loadLevel中從API加載
        positions: {} // 初始為空物件，稍後會在loadLevel中填充
      };
    }).filter(level => level !== null); // 過濾掉無效的關卡

    // 確保至少有一個有效的關卡
    if (formattedLevels.length === 0) {
      console.warn('沒有有效的API關卡數據，使用默認關卡');
      return allLevels;
    }
    
    console.log("隨機選擇的關卡:", formattedLevels.map(l => l.id));
    return formattedLevels;
  } catch (error) {
    console.error('無法獲取隨機關卡:', error);
    console.warn('使用默認關卡作為備用');
    return allLevels; // 失敗時使用默認關卡
  }
}

    // ----- 遊戲狀態變數 -----
    let gameLevels = []; // 儲存當前遊戲會用到的隨機關卡
    let currentLevel = 0;
    // let differences = []; // 不再需要全局 differences

    let foundCount = 0;
    const foundDifferences = new Set();
    const messageElement = document.getElementById('message');
    const foundCountElement = document.getElementById('found-count');
    const totalCountElement = document.getElementById('total-count');
    const resetButton = document.getElementById('reset-button');
    const showAnswersButton = document.getElementById('show-answers-button');
    const hintButton = document.getElementById('hint-button');
    const levelTransition = document.getElementById('level-transition');
    const nextLevelButton = document.getElementById('next-level-button');
    const deleteLevelButton = document.getElementById('delete-level');

    // 計時器相關變數
    let timerInterval;
    let startTime;
    let totalElapsedTime = 0;
    let timerRunning = false;
    const timerDisplay = document.getElementById('timer-display');

    let answersVisible = false;

    // ----- DOM 元素 -----
    const leftImageContainer = document.getElementById('left-image');
    const rightImageContainer = document.getElementById('right-image');
    const leftImageElement = leftImageContainer.querySelector('img');
    const rightImageElement = rightImageContainer.querySelector('img');
    const levelIndicator = document.createElement('div'); // 關卡指示器只需要創建一次
    levelIndicator.className = 'level-indicator';
    leftImageContainer.appendChild(levelIndicator); // 添加到左圖容器


    
    // 設置新遊戲或重置遊戲
    async function setupNewGame() {
      console.log("Setting up new game...");
      
      // 重置遊戲狀態
      foundDifferences.clear();
      foundCount = 0;
      foundCountElement.textContent = '0';
      messageElement.textContent = '';
      answersVisible = false;
      
      // 如果有"顯示所有答案"按鈕，重置它
      if (showAnswersButton) {
        showAnswersButton.textContent = '顯示所有答案';
      }

      // 重置計時器
      clearInterval(timerInterval);
      timerRunning = false;
      totalElapsedTime = 0;
      timerDisplay.textContent = '00:00';
      
      // 在載入關卡前先顯示加載信息
      messageElement.textContent = "載入關卡中...";
      
      // 確保先有遊戲數據再開始計時器
      try {
        console.log("Fetching random levels...");
        gameLevels = await getRandomLevels(); // 獲取新的隨機關卡列表
        
        if (!gameLevels || gameLevels.length === 0) {
          console.error("無法獲取遊戲關卡");
          messageElement.textContent = "載入遊戲關卡失敗，請重新整理頁面";
          return;
        }
        
        console.log(`Retrieved ${gameLevels.length} levels for new game.`);
        currentLevel = 0;
        messageElement.textContent = ""; // 清除加載信息
        
        // 加載第一個關卡
        await loadLevel(currentLevel);
        console.log("First level loaded successfully.");
        
        // 確認關卡已加載後再啟動計時器
        if (gameLevels[currentLevel] && gameLevels[currentLevel].differences && gameLevels[currentLevel].differences.length > 0) {
          console.log("Starting timer...");
          startTimer(); // 啟動計時器
        } else {
          console.error("First level data is incomplete, cannot start game.");
          messageElement.textContent = "關卡數據不完整，請重新整理頁面";
        }
      } catch (error) {
        console.error("初始化遊戲失敗:", error);
        messageElement.textContent = "初始化遊戲失敗，請重新整理頁面";
      }
    }

    function updateTimer() {
        if (!timerRunning) return;
        const currentTime = Date.now();
        const elapsedTime = currentTime - startTime;
        const seconds = Math.floor((elapsedTime / 1000) % 60);
        const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        totalElapsedTime = elapsedTime;
    }

    function showCompletionMessage() {
      levelTransition.querySelector('h2').textContent = `恭喜完成第 ${currentLevel + 1} 關！`;
      if (currentLevel + 1 < gameLevels.length) {
        levelTransition.querySelector('p').textContent = `準備好挑戰第 ${currentLevel + 2} 關了嗎？`;
        nextLevelButton.textContent = `開始第 ${currentLevel + 2} 關`;
        nextLevelButton.disabled = false;
      } else {
        levelTransition.querySelector('p').textContent = `你已經完成所有關卡！`;
        nextLevelButton.textContent = `重新開始`;
        nextLevelButton.disabled = false;
        nextLevelButton.onclick = function() {
          levelTransition.classList.remove('show');
          setupNewGame();
        };
        setTimeout(checkLeaderboardAndShow, 1200);
      }
      levelTransition.classList.add('show');
    }

    async function checkLeaderboardAndShow() {
      // 1. 取得總秒數
      const timeText = timerDisplay.textContent; // 格式 00:34
      const [min, sec] = timeText.split(':').map(Number);
      const totalSeconds = min * 60 + sec;

      // 2. 取得排行榜
      let leaderboard = [];
      try {
        const res = await fetch('/api/diffrent-game/leaderboard');
        leaderboard = await res.json();
      } catch (e) {
        alert('無法取得排行榜，請稍後再試');
        return;
      }

      // 3. 檢查是否進前 50 名
      const isInTop50 = leaderboard.length < 50 || leaderboard.some(entry => totalSeconds < entry.time_seconds);

      // 4. 顯示排行榜
      showLeaderboard(leaderboard, isInTop50, totalSeconds);
    }

    function showLeaderboard(leaderboard, canSubmit, mySeconds) {
      // 顯示排行榜區塊
      const leaderboardContainer = document.getElementById('leaderboard-container');
      leaderboardContainer.classList.add('show');

      // 填入排行榜資料
      const tbody = document.getElementById('leaderboard-rows');
      tbody.innerHTML = '';
      leaderboard.slice(0, 50).forEach((entry, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td><td>${entry.name}</td><td>${entry.time}</td><td>${entry.date}</td>`;
        tbody.appendChild(tr);
      });

      // 顯示/隱藏名字輸入表單
      const nameEntry = document.getElementById('name-entry-container');
      if (canSubmit) {
        nameEntry.style.display = 'block';
        document.getElementById('final-time-display').textContent = timerDisplay.textContent;
        // 綁定送出事件（只需綁一次）
        document.getElementById('submit-score').onclick = async function() {
          const name = document.getElementById('player-name').value.trim();
          if (!name || name.length > 20) {
            alert('名字不能空白且最多 20 字');
            return false;
          }
          const ok = await submitScore(name, mySeconds);
          if (ok) {
            nameEntry.style.display = 'none';
            await checkLeaderboardAndShow(); // 重新載入排行榜
          }
          // 如果失敗，停留在輸入框，讓使用者可以再試一次
        };
      } else {
        nameEntry.style.display = 'none';
      }

      // 綁定重新開始
      document.getElementById('restart-game').onclick = function() {
        leaderboardContainer.classList.remove('show');
        setupNewGame();
      };
      document.getElementById('close-leaderboard').onclick = function() {
        leaderboardContainer.classList.remove('show');
      };
    }

    async function submitScore(name, seconds) {
      if (!name || name.length > 20) {
        alert('名字不能空白且最多 20 字');
        return false;
      }
      try {
        console.log('送出排行榜資料:', { player_name: name, time_seconds: seconds });

        const res = await fetch('/api/diffrent-game/leaderboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ player_name: name, time_seconds: seconds }) // 這裡修正
        });

        let responseData;
        try {
          responseData = await res.json();
        } catch (jsonErr) {
          responseData = await res.text();
        }

        console.log('排行榜 API 回應:', res.status, responseData);

        if (!res.ok) {
          alert('送出成績失敗：' + (responseData.error || responseData || res.statusText));
          return false;
        }
        return true;
      } catch (e) {
        alert('送出成績失敗（網路或程式錯誤）');
        console.error(e);
        return false;
      }
    }

    if (deleteLevelButton) {
      deleteLevelButton.addEventListener('click', async function() {
        const selectedLevelId = parseInt(levelSelector.value);
        if (isNaN(selectedLevelId)) {
          alert('請先選擇要刪除的圖片！');
          return;
        }
        if (!confirm(`確定要刪除 ID:${selectedLevelId} 這張圖片嗎？此動作無法復原。`)) {
          return;
        }
        try {
          const res = await fetch(`/api/diffrent-game/levels/${selectedLevelId}`, {
            method: 'DELETE'
          });
          if (res.ok) {
            alert('圖片已刪除！');
            await populateLevelSelector(); // 重新載入 selector
            clearEditorDisplay(); // 清空畫面
            if (editLeftImg) editLeftImg.src = "";
            if (editRightImg) editRightImg.src = "";
          } else {
            alert('刪除失敗，請稍後再試');
          }
        } catch (e) {
          alert('網路錯誤，無法刪除圖片');
        }
      });
    }

    // Helper function to format seconds into MM:SS
    function formatTime(totalSeconds) {
        if (totalSeconds === null || totalSeconds === undefined) return 'N/A';
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            // Return YYYY-MM-DD format
            return date.toISOString().split('T')[0];
        } catch (e) {
            return 'Invalid Date';
        }
    }

    // ----- 初始調用 與 按鈕事件 ----- //
    window.onload = async function() {
      try {
        console.log("Window loaded, initializing game...");
        
        // 檢查必要的DOM元素是否存在
        if (!document.getElementById('left-image') || 
            !document.getElementById('right-image') || 
            !document.getElementById('found-count') || 
            !document.getElementById('total-count') || 
            !document.getElementById('message') || 
            !document.getElementById('timer-display')) {
          console.error("找不到必要的遊戲DOM元素");
          alert("頁面載入不完整，請重新整理");
          return;
        }
        
        // Initialize editor first (to populate selector)
        if (document.getElementById('level-selector')) {
          console.log("Initializing level selector...");
          await populateLevelSelector(); // Wait for selector to be populated
        }
        
        console.log("Starting new game...");
        await setupNewGame(); // Wait for game setup

        // Ensure editor output area is initially updated
        if (typeof updateOutput === 'function' && document.getElementById('output')) {
          updateOutput(); // Call this after potential initial editor load
        }

        // 設置按鈕事件監聽
        if (nextLevelButton) {
          nextLevelButton.addEventListener('click', loadNextLevel);
        }
        
        if (resetButton) {
          resetButton.addEventListener('click', setupNewGame);
        }
        
        // 添加開發者調試信息
        console.log("Game initialization complete!");
      } catch (error) {
        console.error("Game initialization failed:", error);
        if (messageElement) {
          messageElement.textContent = "遊戲初始化失敗，請重新整理頁面";
        } else {
          alert("遊戲初始化失敗，請重新整理頁面");
        }
      }
    };

    // Function to fetch and display leaderboard directly
    async function displayLeaderboardDirectly() {
      let leaderboard = [];
      try {
        const res = await fetch('/api/diffrent-game/leaderboard'); // Fetch current data
        if (!res.ok) throw new Error('Failed to fetch leaderboard');
        leaderboard = await res.json();
        // Call showLeaderboard, explicitly setting canSubmit to false and no score
        showLeaderboard(leaderboard, false, null);
      } catch (e) {
        alert('無法取得排行榜，請稍後再試');
        console.error("Error fetching leaderboard directly:", e);
      }
    }

    function pauseTimer() {
      if (timerRunning) {
        clearInterval(timerInterval);
        timerRunning = false;
        totalElapsedTime = Date.now() - startTime;
        console.log("Timer paused. Total elapsed time:", totalElapsedTime);
      }
    }
  </script>
</body>
</html>