<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML å ±å‘Šç”¢ç”Ÿå™¨ - SunnyYummy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <meta name="google-adsense-account" content="ca-pub-8966114892131293">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8966114892131293"
    crossorigin="anonymous"></script>
    <style>
        /* --- User Status Indicator --- */
        .user-status {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .user-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .user-status img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FF9800;
            object-fit: cover;
        }

        .user-status .username {
            margin-left: 8px;
            font-weight: 600;
            color: #2c3e50;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- åŸºæœ¬æ¨£å¼ --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fff5f7; /* ä¿æŒæ·¡ç²‰è‰²èƒŒæ™¯ */
            color: #333;
            padding-bottom: 70px; /* ç‚ºåº•éƒ¨å°èˆªç•™å‡ºç©ºé–“ */
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
        }

        /* --- é é¢æ¨™é¡Œ --- */
        .page-title-header {
            text-align: center;
            padding: 20px 0;
            background-color: #FFB74D;
            color: white;
            margin-bottom: 0px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .page-title {
            font-size: 1.8rem;
            margin: 0;
        }

        /* --- ä¸»å®¹å™¨æ¨£å¼ --- */
        .report-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            animation: fadeIn 0.5s ease;
        }

        /* --- è¡¨å–®æ¨£å¼ --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1em;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #FFB74D;
            box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.2);
            background-color: #fff;
        }

        textarea {
            min-height: 300px;
            line-height: 1.5;
            resize: vertical;
            font-family: monospace;
        }

        button {
            padding: 12px 24px;
            background-color: #FFB74D;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #FFA726;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:disabled {
            background-color: #e0e0e0;
            color: #a0a0a0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- é€£çµé¡¯ç¤ºå€åŸŸ --- */
        #link-display-area {
            margin-top: 20px;
            padding: 20px;
            background-color: #f0f8ff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 2px solid #e3f2fd;
            display: none; /* é è¨­éš±è— */
            animation: slideDown 0.5s ease;
        }

        #link-display-area p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: #555;
        }

        #generated-link {
            width: 100%;
            padding: 12px;
            border: 2px solid #e3f2fd;
            background-color: #fff;
            border-radius: 12px;
            font-family: monospace;
            cursor: text;
            margin-bottom: 15px;
        }

        #copy-link-button {
            background-color: #90CAF9;
            padding: 10px 20px;
            font-size: 0.9em;
        }

        #copy-link-button:hover {
            background-color: #64B5F6;
        }

        /* --- é™åˆ¶ä¿¡æ¯æ¨£å¼ --- */
        .limit-info {
            margin: 15px 0;
            padding: 10px 15px;
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .limit-info.warning {
            background-color: #fff8e1;
            border-left-color: #FFC107;
        }
        
        .limit-info.danger {
            background-color: #ffebee;
            border-left-color: #F44336;
        }

        /* --- ç‹€æ…‹èˆ‡éŒ¯èª¤è¨Šæ¯ --- */
        .status-error {
            color: #e53935;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 8px;
            display: none; /* é è¨­éš±è— */
        }

        /* --- åˆ†éš”ç·šå’Œå…è²¬è²æ˜ --- */
        hr {
            margin: 20px 0;
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,0.1), rgba(0,0,0,0));
        }

        .disclaimer {
            color: #555;
            font-size: 1em;
            line-height: 1.6;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #fff8e1;
            border-radius: 12px;
            border-left: 4px solid #FFB74D;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .disclaimer h3 {
            margin-bottom: 10px;
            color: #FF9800;
            font-size: 1.2em;
        }
        
        .disclaimer ol {
            margin: 10px 0 10px 25px;
        }
        
        .disclaimer li {
            margin-bottom: 8px;
        }
        
        .disclaimer .note {
            margin-top: 10px;
            font-style: italic;
            color: #F57C00;
        }
        
        /* --- æµç¨‹åœ–æ¨£å¼ --- */
        .flow-diagram {
            text-align: center;
            margin: 15px 0;
        }
        
        .flow-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* --- è¿”å›é€£çµ --- */
        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #1E88E5;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .back-link:hover {
            color: #1565C0;
            transform: translateX(-3px);
        }

        .back-link:before {
    content: "â† ";
}

/* --- å‹•ç•«æ•ˆæœ --- */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        transform: translateY(-20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- å¯æ„›è£é£¾å…ƒç´  --- */
.decoration {
    position: absolute;
    font-size: 2rem;
    opacity: 0.15;
    user-select: none;
    z-index: -1;
}

.decoration-1 {
    top: 15%;
    left: 5%;
    animation: float 8s ease-in-out infinite;
}

.decoration-2 {
    top: 50%;
    right: 7%;
    animation: float 6s ease-in-out infinite reverse;
}

.decoration-3 {
    bottom: 15%;
    left: 10%;
    animation: float 7s ease-in-out infinite 1s;
}

@keyframes float {
    0% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(5deg); }
    100% { transform: translateY(0) rotate(0deg); }
}

/* --- éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
@media (max-width: 768px) {
    .report-container {
        padding: 15px;
        margin: 15px;
    }

    button, input, textarea {
        font-size: 16px; /* é¿å…iOSä¸Šç¸®æ”¾ */
    }

    .decoration {
        display: none; /* åœ¨å°å±å¹•ä¸Šéš±è—è£é£¾ */
    }
}

/* éš±è—æ¨™é¡Œè¼¸å…¥æ¬„ä½ */
.hidden-field {
    display: none;
}

 /* Add styles for centered ad container */
 .ad-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            text-align: center;
            overflow: hidden;
        }

        /* å ±å‘Šåˆ—è¡¨æ¨£å¼ */
        .reports-list {
            margin-top: 20px;
        }
        
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .report-item:hover {
            background-color: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .report-title {
            font-weight: bold;
            color: #555;
        }
        
        .report-date {
            font-size: 0.85em;
            color: #888;
        }
        
        .report-actions {
            display: flex;
            gap: 8px;
        }
        
        .report-actions button {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            background-color: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .report-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .view-report-btn {
            color: #1E88E5;
        }
        
        .edit-report-btn {
            color: #FB8C00;
        }
        
        .delete-report-btn {
            color: #E53935;
        }
        
        .login-prompt {
            background-color: #fff8e1;
            border-left: 4px solid #FFB74D;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .login-prompt a {
            color: #F57C00;
            text-decoration: none;
            font-weight: bold;
        }
        
        .login-prompt a:hover {
            text-decoration: underline;
        }

</style>
</head>
<body>
    <!-- User Status Indicator -->
    <div id="userStatus" class="user-status">
        <img id="userStatusAvatar" src="/images/a01girlmove.gif" alt="User">
        <span id="userStatusName" class="username">æœªç™»å…¥</span>
    </div>

    <!-- è£é£¾å…ƒç´  -->
    <div class="decoration decoration-1">ğŸŒ¸</div>
    <div class="decoration decoration-2">âœ¨</div>
    <div class="decoration decoration-3">ğŸµ</div>

    <header class="page-title-header">
        <h1 class="page-title">HTML å ±å‘Šç”¢ç”Ÿå™¨</h1>
    </header>

    <main class="report-container">
        <div class="disclaimer">
            <h3>ä½¿ç”¨èªªæ˜ ğŸ“</h3>
            <div class="flow-diagram">
                <img src="https://sunnyyummy.onrender.com/uploads/1745256205982-28454.png" alt="ä½¿ç”¨æµç¨‹ï¼šæ–‡ä»¶ â†’ AIè™•ç† â†’ è½‰æ› â†’ é©—è­‰ â†’ åˆ†äº«å ±å‘Š" class="flow-image">
            </div>
            <p>é€™æ˜¯ä¸€å€‹ HTMLç¢¼è½‰ç¶²é å·¥å…·ï¼Œç‰¹åˆ¥é©åˆå°‡ç„¡èŠçš„æ–‡æª”ç”Ÿæˆçš„å…§å®¹è½‰ç‚ºå¯åˆ†äº«åˆå¥½çœ‹çš„ç¶²é ï¼š</p>
            <ol>
                <li>å°‡æ‚¨éœ€è¦çš„å ±å‘Šã€åœ–è¡¨æˆ–æ–‡æª”å‚³çµ¦AI</li>
                <li>è¦æ±‚ AI å°‡è©²å…§å®¹è½‰ç‚º HTML æ ¼å¼ä¸¦é€²è¡Œç¾åŒ–</li>
                <li>å°‡ AI ç”Ÿæˆçš„ HTML ç¨‹å¼ç¢¼è¤‡è£½è²¼ä¸Šåˆ°ä¸‹æ–¹çš„ç·¨è¼¯å€</li>
                <li>é»æ“Šå„²å­˜æŒ‰éˆ•å¾Œï¼Œç³»çµ±æœƒç”¢ç”Ÿä¸€å€‹å”¯ä¸€çš„ç¶²é é€£çµ</li>
                <li>åˆ†äº«æ­¤é€£çµçµ¦ä»–äººï¼Œå°æ–¹ç„¡éœ€ç™»å…¥å³å¯æŸ¥çœ‹æ‚¨çš„ç²¾ç¾å ±å‘Š</li>
            </ol>
            <p class="note">ğŸ“Œé€£çµç‚ºå…¬é–‹å­˜å–ï¼Œè«‹æ³¨æ„åˆ†äº«å°è±¡ï¼Œè«‹å‹¿åŒ…å«æ©Ÿå¯†è³‡è¨Šã€‚</p>
        </div>
        <a href="/" class="back-link">è¿”å›é¦–é </a>
        <hr>

        <!-- æœªç™»å…¥æç¤º (åˆå§‹éš±è—) -->
        <div id="login-prompt" class="login-prompt" style="display: none;">
            <p>ğŸ‘‹ æ‚¨ç›®å‰æ˜¯ä»¥è¨ªå®¢èº«ä»½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚<a href="/box.html">ç™»å…¥æœƒå“¡</a>å¾Œå¯ä»¥ç®¡ç†æ‚¨çš„æ‰€æœ‰å ±å‘Šï¼</p>
        </div>

        <form id="report-form">
            <div class="form-group" id="title-form-group" style="display: none;">
                <label for="report-title">å ±å‘Šæ¨™é¡Œ:</label>
                <input type="text" id="report-title" placeholder="è«‹è¼¸å…¥æ‚¨çš„å ±å‘Šæ¨™é¡Œ">
            </div>

            <div class="form-group">
                <label for="html-content">HTML å…§å®¹:</label>
                <textarea id="html-content" placeholder="åœ¨æ­¤è¼¸å…¥å®Œæ•´çš„ HTML ç¨‹å¼ç¢¼..." required></textarea>
            </div>

            <button id="save-button" type="submit">å„²å­˜ä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµ</button>
            <div id="status-error" class="status-error"></div>
        </form>

        <!-- ç”¨æ–¼é¡¯ç¤ºç”Ÿæˆçš„é€£çµ -->
        <div id="link-display-area">
            <p>âœ… å ±å‘Šå·²å„²å­˜ï¼è«‹è¤‡è£½ä¸¦ä¿ç®¡ä»¥ä¸‹é€£çµï¼š</p>
            <input type="text" id="generated-link" readonly>
            <button id="copy-link-button" type="button">è¤‡è£½é€£çµ</button>
        </div>

        <!-- æœƒå“¡å ±å‘Šåˆ—è¡¨å€åŸŸ -->
        <div id="member-reports-area" style="display: none;">
            <hr>
            <h3>æˆ‘çš„å ±å‘Šåˆ—è¡¨</h3>
            <div id="reports-list" class="reports-list">
                <!-- å ±å‘Šåˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                <p id="loading-reports">æ­£åœ¨è¼‰å…¥æ‚¨çš„å ±å‘Š...</p>
            </div>
        </div>
    </main>

    <!-- å¼•å…¥ JavaScript æª”æ¡ˆï¼Œä½¿ç”¨çµ•å°è·¯å¾‘ -->
    <script src="report-editor.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // User status elements
            const userStatusAvatar = document.getElementById('userStatusAvatar');
            const userStatusName = document.getElementById('userStatusName');
            const userStatus = document.getElementById('userStatus');
            
            // å ±å‘Šåˆ—è¡¨ç›¸é—œå…ƒç´ 
            const memberReportsArea = document.getElementById('member-reports-area');
            const reportsList = document.getElementById('reports-list');
            const loginPrompt = document.getElementById('login-prompt');
            const reportForm = document.getElementById('report-form');
            const titleFormGroup = document.getElementById('title-form-group');
            const reportTitleInput = document.getElementById('report-title');
            const htmlContentInput = document.getElementById('html-content');
            const saveButton = document.getElementById('save-button');
            const statusError = document.getElementById('status-error');
            const linkDisplayArea = document.getElementById('link-display-area');
            const generatedLinkInput = document.getElementById('generated-link');
            
            let currentEditingReportId = null; // *** æ–°å¢ï¼šç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„å ±å‘ŠID ***

            // æª¢æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„ç™»å…¥ä¿¡æ¯
            const savedUserId = localStorage.getItem('boxCurrentUserId');
            const savedUserToken = localStorage.getItem(`boxUserToken_${savedUserId}`);
            const savedUserAvatarUrl = localStorage.getItem('boxCurrentUserAvatar');
            const savedUserName = localStorage.getItem('boxCurrentUsername');
            const savedDisplayName = localStorage.getItem('boxCurrentDisplayName') || savedUserName;

            // Update the user status indicator
            if (savedUserId && savedUserToken && savedUserName) {
                userStatusAvatar.src = savedUserAvatarUrl || '/images/a01girlmove.gif';
                userStatusName.textContent = savedDisplayName;
                
                // ç”¨æˆ¶å·²ç™»å…¥
                memberReportsArea.style.display = 'block';
                loginPrompt.style.display = 'none';
                titleFormGroup.style.display = 'block'; // é¡¯ç¤ºæ¨™é¡Œè¼¸å…¥æ¡†
                
                // è¼‰å…¥ç”¨æˆ¶çš„å ±å‘Šåˆ—è¡¨
                loadUserReports(savedUserId, savedUserToken);
                
                // Add click event to navigate to user editor page
                userStatus.addEventListener('click', () => {
                    window.location.href = `/member-editor.html?userId=${savedUserId}`;
                });
            } else {
                userStatusAvatar.src = '/images/a01girlmove.gif';
                userStatusName.textContent = 'æœªç™»å…¥';
                
                // ç”¨æˆ¶æœªç™»å…¥
                memberReportsArea.style.display = 'none';
                loginPrompt.style.display = 'block';
                titleFormGroup.style.display = 'none'; // éš±è—æ¨™é¡Œè¼¸å…¥æ¡†
                
                userStatus.addEventListener('click', () => {
                    window.location.href = `box.html`;
                });
            }
            
            // æª¢æŸ¥ URL æ˜¯å¦åŒ…å« edit åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const editReportId = urlParams.get('edit');

            // å¦‚æœæœ‰ edit åƒæ•¸ä¸”ç”¨æˆ¶å·²ç™»å…¥ï¼Œè¼‰å…¥å ±å‘Šå…§å®¹
            if (editReportId && savedUserId && savedUserToken) {
                // è¨­ç½®ç·¨è¼¯æ¨¡å¼
                currentEditingReportId = editReportId;
                saveButton.textContent = 'æ›´æ–°å ±å‘Š';
                
                // æ·»åŠ å–æ¶ˆç·¨è¼¯æŒ‰éˆ•
                if (!document.getElementById('cancel-edit-btn')) {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'å–æ¶ˆç·¨è¼¯';
                    cancelButton.type = 'button';
                    cancelButton.id = 'cancel-edit-btn';
                    cancelButton.style.backgroundColor = '#78909c';
                    cancelButton.style.marginLeft = '10px';
                    cancelButton.addEventListener('click', resetFormToCreateMode);
                    saveButton.insertAdjacentElement('afterend', cancelButton);
                }
                
                // è¼‰å…¥å ±å‘Šå…§å®¹
                fetch(`/api/reports/report/${editReportId}`, {
                    headers: {
                        'Authorization': `Bearer ${savedUserToken}`
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–å ±å‘Šå…§å®¹');
                    return response.json();
                })
                .then(reportData => {
                    // å¡«å……ç·¨è¼¯å€åŸŸ
                    reportTitleInput.value = reportData.title;
                    htmlContentInput.value = reportData.html_content;
                    
                    // æ»¾å‹•åˆ°ç·¨è¼¯å€åŸŸ
                    titleFormGroup.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    alert(`è¼‰å…¥å ±å‘Šå…§å®¹å¤±æ•—: ${error.message}`);
                    resetFormToCreateMode(); // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œé‡ç½®ç‚ºæ–°å¢æ¨¡å¼
                });
            }
            
            // çµ±ä¸€è™•ç†è¡¨å–®æäº¤
            reportForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                saveButton.disabled = true;
                saveButton.textContent = currentEditingReportId ? 'æ›´æ–°ä¸­...' : 'å„²å­˜ä¸­...';
                statusError.textContent = '';
                linkDisplayArea.style.display = 'none';

                const title = reportTitleInput.value.trim();
                const htmlContent = htmlContentInput.value;

                // åŸºæœ¬é©—è­‰ (å°æ–°å¢å’Œæ›´æ–°éƒ½é©ç”¨)
                if (!savedUserId && !htmlContent) {
                    statusError.textContent = 'HTML å…§å®¹ä¸èƒ½ç‚ºç©ºã€‚';
                    saveButton.disabled = false;
                    saveButton.textContent = currentEditingReportId ? 'æ›´æ–°å ±å‘Š' : 'å„²å­˜ä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµ';
                    return;
                }
                if (savedUserId && !title) {
                    statusError.textContent = 'å ±å‘Šæ¨™é¡Œç‚ºå¿…å¡«é …ã€‚';
                    saveButton.disabled = false;
                    saveButton.textContent = currentEditingReportId ? 'æ›´æ–°å ±å‘Š' : 'å„²å­˜ä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµ';
                    return;
                }

                try {
                    let response;
                    const requestBody = {
                        title: title,
                        html_content: htmlContent
                    };
                    
                    if (currentEditingReportId) {
                        // *** ç·¨è¼¯æ¨¡å¼ï¼šç™¼é€ PUT è«‹æ±‚ ***
                        response = await fetch(`/api/reports/report/${currentEditingReportId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${savedUserToken}`
                            },
                            body: JSON.stringify(requestBody)
                        });
                    } else {
                        // *** æ–°å¢æ¨¡å¼ï¼šç™¼é€ POST è«‹æ±‚ ***
                        response = await fetch('/api/reports', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': savedUserToken ? `Bearer ${savedUserToken}` : ''
                            },
                            body: JSON.stringify({ // POSTè«‹æ±‚éœ€è¦é¡å¤–ä¿¡æ¯
                                ...requestBody,
                                title: savedUserId ? title : `è¨ªå®¢å ±å‘Š - ${new Date().toLocaleString()}`,
                                creator_id: savedUserId || 'guest'
                            })
                        });
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || (currentEditingReportId ? 'æ›´æ–°å¤±æ•—' : 'å„²å­˜å¤±æ•—'));
                    }
                    
                    if (currentEditingReportId) {
                        // æ›´æ–°æˆåŠŸ
                        alert('å ±å‘Šæ›´æ–°æˆåŠŸï¼');
                    } else {
                        // æ–°å¢æˆåŠŸ
                        generatedLinkInput.value = `${window.location.origin}/store/report/report-view.html?id=${data.id}`;
                        linkDisplayArea.style.display = 'block';
                    }

                    // é‡è¨­è¡¨å–®ä¸¦é‡æ–°è¼‰å…¥åˆ—è¡¨
                    resetFormToCreateMode();
                    if (savedUserId) {
                        loadUserReports(savedUserId, savedUserToken);
                    }

                } catch (error) {
                    statusError.textContent = `éŒ¯èª¤: ${error.message}`;
                } finally {
                    saveButton.disabled = false;
                    // æ–‡å­—åœ¨ resetFormToCreateMode ä¸­è™•ç†
                }
            });
            
            // *** æ–°å¢ï¼šé‡è¨­è¡¨å–®åˆ°æ–°å¢æ¨¡å¼çš„å‡½æ•¸ ***
            function resetFormToCreateMode() {
                currentEditingReportId = null;
                reportForm.reset();
                saveButton.textContent = 'å„²å­˜ä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµ';
                statusError.textContent = '';
                linkDisplayArea.style.display = 'none';
                
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ "å–æ¶ˆç·¨è¼¯" æŒ‰éˆ•
                const cancelButton = document.getElementById('cancel-edit-btn');
                if (cancelButton) {
                    cancelButton.remove();
                }
            }
            
            // è¼‰å…¥ç”¨æˆ¶å ±å‘Šåˆ—è¡¨å‡½æ•¸
            async function loadUserReports(userId, token) {
                try {
                    const response = await fetch(`/api/reports/user/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'ç„¡æ³•è§£æéŒ¯èª¤è¨Šæ¯' }));
                        throw new Error(errorData.error || 'ç„¡æ³•è¼‰å…¥å ±å‘Šåˆ—è¡¨');
                    }
                    
                    const reports = await response.json();
                    
                    // æ¸…ç©ºè¼‰å…¥è¨Šæ¯
                    reportsList.innerHTML = '';
                    
                    if (reports.length === 0) {
                        reportsList.innerHTML = '<p>æ‚¨é‚„æ²’æœ‰å»ºç«‹ä»»ä½•å ±å‘Š</p>';
                        return;
                    }
                    
                    // æ¸²æŸ“å ±å‘Šåˆ—è¡¨
                    reports.forEach(report => {
                        const reportItem = document.createElement('div');
                        reportItem.className = 'report-item';
                        reportItem.dataset.id = report.id;
                        
                        const createdDate = new Date(report.created_at);
                        const formattedDate = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}-${String(createdDate.getDate()).padStart(2, '0')}`;
                        
                        reportItem.innerHTML = `
                            <div class="report-info">
                                <div class="report-title">${report.title || 'æœªå‘½åå ±å‘Š'}</div>
                                <div class="report-date">å»ºç«‹æ–¼: ${formattedDate}</div>
                            </div>
                            <div class="report-actions">
                                <button class="view-report-btn" data-id="${report.id}">æŸ¥çœ‹</button>
                                <button class="edit-report-btn" data-id="${report.id}">ç·¨è¼¯</button>
                                <button class="delete-report-btn" data-id="${report.id}">åˆªé™¤</button>
                            </div>
                        `;
                        
                        reportsList.appendChild(reportItem);
                    });
                    
                    // æ·»åŠ äº‹ä»¶ç›£è½å™¨
                    setupReportActions();
                    
                } catch (error) {
                    console.error('è¼‰å…¥å ±å‘Šåˆ—è¡¨å¤±æ•—:', error);
                    reportsList.innerHTML = `<p>è¼‰å…¥å ±å‘Šå¤±æ•—: ${error.message}</p><button id="retry-load-btn">é‡è©¦</button>`;
                    
                    document.getElementById('retry-load-btn').addEventListener('click', () => {
                        loadUserReports(userId, token);
                    });
                }
            }
            
            // è¨­ç½®å ±å‘Šæ“ä½œæŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
            function setupReportActions() {
                // æŸ¥çœ‹å ±å‘ŠæŒ‰éˆ•
                document.querySelectorAll('.view-report-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const reportId = btn.dataset.id;
                        window.open(`/store/report/report-view.html?id=${reportId}`, '_blank');
                    });
                });
                
                // ç·¨è¼¯å ±å‘ŠæŒ‰éˆ•
                document.querySelectorAll('.edit-report-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const reportId = btn.dataset.id;
                        try {
                            // ç²å–å ±å‘Šå…§å®¹
                            const response = await fetch(`/api/reports/report/${reportId}`, {
                                headers: {
                                    'Authorization': `Bearer ${savedUserToken}`
                                }
                            });
                            
                            if (!response.ok) throw new Error('ç„¡æ³•ç²å–å ±å‘Šå…§å®¹');
                            
                            const reportData = await response.json();
                            
                            // *** é€²å…¥ç·¨è¼¯æ¨¡å¼ ***
                            currentEditingReportId = reportData.id;
                            
                            // å¡«å……ç·¨è¼¯å€åŸŸ
                            reportTitleInput.value = reportData.title;
                            htmlContentInput.value = reportData.html_content;
                            
                            // æ›´æ”¹æŒ‰éˆ•æ–‡å­—ä¸¦æ·»åŠ  "å–æ¶ˆç·¨è¼¯" æŒ‰éˆ•
                            saveButton.textContent = 'æ›´æ–°å ±å‘Š';
                            if (!document.getElementById('cancel-edit-btn')) {
                                const cancelButton = document.createElement('button');
                                cancelButton.textContent = 'å–æ¶ˆç·¨è¼¯';
                                cancelButton.type = 'button';
                                cancelButton.id = 'cancel-edit-btn';
                                cancelButton.style.backgroundColor = '#78909c';
                                cancelButton.style.marginLeft = '10px';
                                cancelButton.addEventListener('click', resetFormToCreateMode);
                                saveButton.insertAdjacentElement('afterend', cancelButton);
                            }
                            
                            // æ»¾å‹•åˆ°ç·¨è¼¯å€åŸŸ
                            titleFormGroup.scrollIntoView({ behavior: 'smooth' });
                            
                        } catch (error) {
                            alert(`ç·¨è¼¯å¤±æ•—: ${error.message}`);
                        }
                    });
                });
                
                // åˆªé™¤å ±å‘ŠæŒ‰éˆ•
                document.querySelectorAll('.delete-report-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä»½å ±å‘Šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) return;
                        
                        const reportId = btn.dataset.id;
                        try {
                            const response = await fetch(`/api/reports/report/${reportId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${savedUserToken}`
                                }
                            });
                            
                            if (!response.ok) throw new Error('åˆªé™¤å¤±æ•—');
                            
                            // å¾UIä¸­ç§»é™¤è©²å ±å‘Šé …
                            const reportItem = document.querySelector(`.report-item[data-id="${reportId}"]`);
                            reportItem.style.opacity = '0';
                            setTimeout(() => {
                                reportItem.remove();
                                
                                // å¦‚æœæ²’æœ‰å ±å‘Šäº†ï¼Œé¡¯ç¤ºæç¤º
                                if (document.querySelectorAll('.report-item').length === 0) {
                                    reportsList.innerHTML = '<p>æ‚¨é‚„æ²’æœ‰å»ºç«‹ä»»ä½•å ±å‘Š</p>';
                                }
                            }, 300);
                            
                        } catch (error) {
                            alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
                        }
                    });
                });
            }
        });
    </script>


 <!-- åº•éƒ¨å»£å‘Š -->
 <div class="ad-container">
    <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-8966114892131293"
    data-ad-slot="9887756394"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
</body>
</html>