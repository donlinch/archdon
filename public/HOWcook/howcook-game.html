<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È£üË≠úÁ®ãÂºèË®≠Ë®àÈÅäÊà≤</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Microsoft JhengHei', 'SF Pro Text', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            background-color: #f9f5f0;
            color: #333;
            font-size: 16px;
        }
        h1 {
            color: #8b4513;
            text-align: center;
            padding: 10px 0;
            font-size: 1.5rem;
        }
        .input-section {
            margin-bottom: 15px;
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .input-title {
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .recipe-challenge {
            padding: 10px;
            background-color: #fff9e6;
            border-radius: 5px;
            border: 1px solid #d2b48c;
        }
        .recipe-description {
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #5a3921;
        }
        .recipe-tips {
            font-size: 0.9rem;
            font-style: italic;
            color: #8b6b4f;
        }
        
        /* Á®ãÂºèÁ¢ºÁµÑÂêà‰ªãÈù¢Ê®£Âºè */
        .code-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .code-preview {
            flex: 1;
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            min-height: 200px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            overflow-y: auto;
            border: 1px solid #444;
        }
        .code-line {
            margin: 8px 0;
            padding: 5px 8px;
            border-left: 4px solid;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #3a3a3a;
            border-radius: 0 4px 4px 0;
            position: relative;
        }
        .code-line-group {
            margin: 15px 0;
            padding: 10px;
            border-left: 2px dashed #666;
            background-color: rgba(255,255,255,0.05);
            border-radius: 5px;
            position: relative;
        }
        .code-line:first-child {
            margin-top: 0;
        }
        .code-line .delete-btn {
            margin-left: auto;
            background: #ff5555;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .code-line:hover .delete-btn {
            opacity: 1;
        }
        .code-palette {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 300px;
        }
        .category-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #d2b48c;
            background-color: #f0e6d2;
            color: #5a3921;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .filter-btn.active, .filter-btn:hover {
            background-color: #8b4513;
            color: white;
            border-color: #5a3921;
        }
        .code-options {
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            overflow-y: auto;
            max-height: 250px;
        }
        .code-option {
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .code-option:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .code-option:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* ÊåâÈ°ûÂûãÂçÄÂàÜÈ°èËâ≤ */
        .code-line[data-type="ingredient"],
        .code-option[data-category="ingredients"] { 
            border-color: #a6e22e;
            background-color: #3c4a36;
        }
        .code-line[data-type="action"],
        .code-option[data-category="actions"] { 
            border-color: #f92672;
            background-color: #4a2a38;
        }
        .code-line[data-type="tool"],
        .code-option[data-category="tools"] { 
            border-color: #66d9ef;
            background-color: #2d4a52;
        }
        .code-line[data-type="seasoning"],
        .code-option[data-category="seasonings"] { 
            border-color: #fd971f;
            background-color: #4a3c2a;
        }
        .code-line[data-type="processed"] { 
            border-color: #ae81ff;
            background-color: #3a2d4a;
            margin-top:10px;
        }
        .combine-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #ae81ff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .combine-btn:hover {
            background-color: #9966ff;
        }

        .result-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff9e6;
            border: 1px dashed #d2b48c;
            border-radius: 10px;
        }
        .recipe-sentence {
            line-height: 1.6;
            color: #5a3921;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .ai-prompt {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-top: 10px;
            word-break: break-word;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            flex-grow: 1;
            max-width: 200px;
        }
        .run-btn {
            background-color: #4CAF50;
            color: white;
        }
        .run-btn:hover {
            background-color: #45a049;
        }
        .reset-btn {
            background-color: #d2b48c;
            color: white;
        }
        .reset-btn:hover {
            background-color: #8b4513;
        }
        .new-group-btn {
            background-color: #6b8bff;
            color: white;
        }
        .new-group-btn:hover {
            background-color: #5a79e0;
        }
        .emoji {
            font-size: 1.2rem;
            margin-right: 5px;
            vertical-align: middle;
        }
        .score-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 15px 0;
            color: #8b4513;
        }
        .diff-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .diff-table th, .diff-table td {
            border: 1px solid #d2b48c;
            padding: 8px;
            text-align: left;
        }
        .diff-table th {
            background-color: #f0e6d2;
        }
    </style>
</head>
<body>
    <h1><span class="emoji">üç≥</span>ÊñôÁêÜÁ®ãÂºèË®≠Ë®àÈÅäÊà≤</h1>
    
    <div class="input-section">
        <div class="input-title">‰ªäÊó•ÊåëÊà∞È°åÁõÆ</div>
        <div class="recipe-challenge">
            <div class="recipe-description" id="recipeDescription"></div>
            <div class="recipe-tips" id="recipeTips"></div>
        </div>
    </div>
    
    <div class="code-container">
        <!-- Êåá‰ª§Â†ÜÁñäÂçÄ -->
        <div class="code-preview" id="codePreview">
            <div class="code-line" id="initialMessage">// ÈªûÊìäÂè≥ÂÅ¥Êåá‰ª§ÈñãÂßãÁµÑÂêà...</div>
        </div>
        
        <!-- Ëá™Áî±ÈÅ∏ÊìáÈù¢Êùø -->
        <div class="code-palette">
            <div class="category-filter">
                <button class="filter-btn active" data-category="all">ÂÖ®ÈÉ®</button>
                <button class="filter-btn" data-category="combined">ÁµÑÂêà</button>
                <button class="filter-btn" data-category="ingredients">È£üÊùê</button>
                <button class="filter-btn" data-category="actions">Êìç‰Ωú</button>
                <button class="filter-btn" data-category="tools">Â∑•ÂÖ∑</button>
            </div>
            
            <div class="code-options" id="codeOptions">
                <!-- ÂãïÊÖãÁîüÊàêÁöÑÈÅ∏È†ÖÊåâÈàï -->
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-btn reset-btn" id="changeQuestionBtn">Êèõ‰∏ÄÈ°å</button>
        <button class="action-btn new-group-btn" id="newGroupBtn">Êñ∞ËôïÁêÜÁµÑ</button>
        <button class="action-btn run-btn" id="runCode">
            <span class="emoji">‚ö°</span> Âü∑Ë°åÊñôÁêÜ
        </button>
    </div>
    
    <!-- ÁµêÊûúÈ°ØÁ§∫ÂçÄ -->
    <div class="result-container" id="resultContainer">
        <div class="score-display" id="scoreDisplay">Áõ∏‰ººÂ∫¶Ë©ïÂàÜ: -</div>
        <div class="recipe-sentence" id="recipeResult">ÁµÑÂêà‰Ω†ÁöÑÊñôÁêÜÁ®ãÂºèÁ¢ºÔºåÁÑ∂ÂæåÈªûÊìä„ÄåÂü∑Ë°åÊñôÁêÜ„Äç‰æÜÁúãÁúãÁµêÊûúÔºÅ</div>
        <div id="aiPrompt"></div>
        <button class="action-btn" id="copyBtn" style="display:none; width:100%; margin-top:10px;">Ë§áË£ΩÂàÜÊûêÁµêÊûú</button>
    </div>

    <script>
        const recipeQuestions = [
            {
                "title": "ÂêêÂè∏ÊûúÈÜ¨",
                "description": "ÊåëÊà∞ÔºöË£Ω‰Ωú‰∏Ä‰ªΩÈ£ΩË∂≥ÊÑüÁöÑÊá∂‰∫∫Âø´ÈÄüÁáüÈ§äÊó©È§êÔºå2 ÂàÜÈêòÊêûÂÆö„ÄÇ",
                "ingredients": ["ÂêêÂè∏", "ÊûúÈÜ¨"],
                "actions": ["ÁÉ§"],
                "seasonings": [],
                "tools": ["È∫µÂåÖÊ©ü"],
                "tips": "ÂêêÂè∏ÂèØÊñºË∂ÖÂ∏ÇË≥ºË≤∑Ôºå‰øùË≥™ÊúüËºÉÁü≠„ÄÇÁî®È§êÂ∑æÁ¥ôÂåÖËëóÂèØ‰ª•ÈÇäËµ∞ÈÇäÂêÉ„ÄÇ"
            },
            {
                "title": "ÂæÆÊ≥¢ÁàêËç∑ÂåÖËõã",
                "description": "ÊåëÊà∞ÔºöË£Ω‰Ωú‰∏ÄÈÅìÁ∞°ÂñÆÊòìÂÅö‰∏îÂØåÂê´ËõãÁôΩË≥™ÁöÑËèúÈ§öÔºå120ÁßíÂÖßÂç≥ÂèØÂÆåÊàê„ÄÇ",
                "ingredients": ["ÈõûËõã", "È£≤Áî®Ê∞¥"],
                "actions": ["ÂæÆÊ≥¢", "Âä†ÈπΩ"],
                "seasonings": ["ËäùÈ∫ªÊ≤π"],
                "tools": ["ÂæÆÊ≥¢Áàê", "Â∞èÁ¢ó"],
                "tips": "ÁÇ∫ÈÅøÂÖçÂä†ÁÜ±ÊôÇËõãÈªÉÊø∫Âá∫ÔºåÂèØ‰ª•Âú®Á¢ó‰∏äÂä†Ëìã„ÄÇÁî®Á≠∑Â≠êÂú®ËõãÈªÉ‰∏äÊà≥ÂπæÂÄãÊ¥ûÊòØÈóúÈçµÔºÅ"
            },
            {
                "title": "ÁÇíÈùíËèú",
                "description": "ÊåëÊà∞ÔºöË£Ω‰Ωú‰∏Ä‰ªΩÁ∞°ÂñÆÁöÑÁÇíÈùíËèúÔºå‰øùÊåÅËî¨ËèúÁöÑËÑÜÂ∫¶ÂíåÁáüÈ§ä„ÄÇ",
                "ingredients": ["È´òÈ∫óËèú", "Â§ßËíú"],
                "actions": ["Âàá", "ÁÇí", "Âä†ÈπΩ"],
                "seasonings": [],
                "tools": ["ÁÇíÈçã"],
                "tips": "ÁÅ´ÂÄôË¶ÅÂ§ßÔºåÊôÇÈñìË¶ÅÁü≠ÔºåÈÄôÊ®£ÊâçËÉΩ‰øùÊåÅËî¨ËèúÁöÑËÑÜÂ∫¶„ÄÇ"
            },
            {
                "title": "ÂæÆÊ≥¢ÁàêËõãÁ≥ïÁöÑÂÅöÊ≥ï",
                "description": "ÂæÆÊ≥¢Áàê„ÄåÂèÆ„ÄçËõãÁ≥ïÔºåÂ§ßÁ¥ÑÈúÄË¶Å 2 ÂàÜÈêòÂ∞±ËÉΩÊêûÂÆöÔºÅÂàùÂ≠∏ËÄÖÊâÄÈúÄÊôÇÈñìÈ†êË®àÂª∂Èï∑Ëá≥ 20 ÂàÜÈêò„ÄÇ",
                "ingredients": ["ÈõûËõã", "È∫µÁ≤â", "ÈªÉÊ≤π", "Ê≥°ÊâìÁ≤â", "ÂíñÂï°Á≤â", "Â∑ßÂÖãÂäõ", "È∫•Áâá", "ÁâõÂ•∂", "Â†ÖÊûú", "È§Ö‰πæÂ±ë", "È¶ôËïâ"],
                "actions": ["ÂæÆÊ≥¢", "Âä†Á≥ñ", "Âä†ÈπΩ"],
                "tools": ["ÂæÆÊ≥¢Áàê", "ÂæÆÊ≥¢ÂÆπÂô®"],
                "tips": "Ê≥°ÊâìÁ≤âÂèØËÆìËõãÁ≥ïÊõ¥Ëì¨È¨Ü„ÄÇËã•Âä†ÂÖ•ÁâõÂ•∂Á≠âÊ∂≤È´îÈ£üÊùêÔºåÈúÄÂ∞ëÈáèÂ§öÊ¨°Ê∑ªÂä†ÔºåÁ¢∫‰øùÈ∫µÁ≥äËÉΩÁ∂≠ÊåÅÁ®†ÁãÄ„ÄÇÊâÄÊúâÈ£üÊùêÁöÑÁ∏ΩÈáè‰∏çÊáâË∂ÖÈÅéÂÆπÂô®ÁöÑ3/4Ôºå‰ª•ÂÖçÂä†ÁÜ±ÊôÇÊ∫¢Âá∫„ÄÇ"
            },
            {
                "title": "ÁâõÂ•∂ÁáïÈ∫•ÁöÑÂÅöÊ≥ï",
                "description": "È´òËõãÁôΩ„ÄÅÂØåÂê´Á©ÄÁâ©Á∫ñÁ∂≠„ÄÅÂÖ∑È£ΩË∂≥ÊÑüÁöÑÊá∂‰∫∫Âø´ÈÄüÁáüÈ§äÊó©È§êÔºå3 ÂàÜÈêòÊêûÂÆö„ÄÇ",
                "ingredients": ["ÁâõÂ•∂", "ÁáïÈ∫•", "ÈõûËõã", "Ê∞¥", "Ê∞¥Êûú", "Ëî¨Ëèú", "ËòáÊâìÈ§Ö‰πæ"],
                "actions": ["ÁÖÆ", "ÁÖé", "Âä†Ê≤π", "Âä†Ê§íÈπΩ"],
                "tools": ["Êó©È§êÊùØ", "Èçã", "ÂæÆÊ≥¢Áàê"],
                "tips": "ÂèØÂ∞á‰∏ÄËà¨ÁáïÈ∫•ÊõøÊèõÁÇ∫Âø´ÁÖÆÁáïÈ∫•ÔºåËàáÁâõÂ•∂Ê∑∑ÂêàÂæåÊîæÂÖ•ÂæÆÊ≥¢Áàê‰∏≠ÁÅ´Âä†ÁÜ±4ÂàÜÈêò„ÄÇÊú¨È§êÈªûÊê≠ÈÖçÊ∞¥Êûú„ÄÅËî¨ËèúÊàñËòáÊâìÈ§Ö‰πæÈ¢®Âë≥Êõ¥‰Ω≥„ÄÇ"
            },
            {
                "title": "Áï™ËåÑÁÇíËõã",
                "description": "Á∂ìÂÖ∏ÂÆ∂Â∏∏ËèúÔºåÈÖ∏ÁîúÈñãËÉÉÔºåÁáüÈ§äË±êÂØåÔºåÊòØÁ±≥È£ØÁöÑÁµï‰Ω≥Êê≠Ê™î„ÄÇ",
                "ingredients": ["ÈõûËõã", "Áï™ËåÑ", "Ëî•"],
                "actions": ["ÁÇí", "Âä†Ê≤π", "Âä†ÈπΩ", "Âä†Á≥ñ"],
                "tools": ["ÁÇíÈçã", "Á¢ó", "ÈçãÈèü"],
                "tips": "ÂñúÊ≠°ÊπØÊ±ÅÂ§ö‰∏ÄÈªûÂèØ‰ª•Âú®ÁÇíÁï™ËåÑÊôÇÂä†ÂÖ•Â∞ëÈáèÊ∞¥„ÄÇÂä†‰∏ÄÈªûÁ≥ñÂèØ‰ª•Âπ≥Ë°°Áï™ËåÑÁöÑÈÖ∏Âë≥ÔºåËÆìÈ¢®Âë≥Êõ¥ÊúâÂ±§Ê¨°„ÄÇ"
            },
            {
                "title": "ÂèØÊ®ÇÈõûÁøÖ",
                "description": "ÈππÁîú‰∫§ÁπîÁöÑÈõ∂Â§±ÊïóÊñôÁêÜÔºåËâ≤Êæ§Á¥Ö‰∫ÆË™ò‰∫∫ÔºåËÇâË≥™ÈÆÆÂ´©ÔºåÈÄ£ÂªöÊàøÊñ∞Êâã‰πüËÉΩËºïÈ¨ÜÈßïÈ¶≠„ÄÇ",
                "ingredients": ["ÈõûÁøÖ", "Ëñë", "Ëî•"],
                "actions": ["ÁÖé", "Ááú", "Âä†ÂèØÊ®Ç", "Âä†ÈÜ¨Ê≤π", "Âä†ÊñôÈÖí", "Âä†Ê≤π"],
                "tools": ["Âπ≥Â∫ïÈçã", "ÈçãÈèü"],
                "tips": "ÈõûÁøÖÂÖàÁÖéÈÅéÂèØ‰ª•ËÆìË°®ÁöÆÊõ¥È¶ôÈÖ•„ÄÇÊî∂Ê±ÅÊôÇË¶Å‰∏çÂÅúÁøªÂãïÔºåÈÅøÂÖçÈÜ¨Ê±ÅÁáíÁÑ¶ÈªèÈçã„ÄÇÂèØÊ®ÇÁöÑÁîúÂ∫¶Â∑≤Ë∂≥Â§†ÔºåÈÄöÂ∏∏‰∏çÈúÄÈ°çÂ§ñÂä†Á≥ñ„ÄÇ"
            },
            {
                "title": "ÂÆ∂Â∏∏ÈõûËõãÁÇíÈ£Ø",
                "description": "Âø´ÈÄüËß£Ê±∫Ââ©È£ØÁöÑÊúÄ‰Ω≥ÊñπÂºèÔºåÁ∞°ÂñÆÁæéÂë≥ÔºåÁ≤íÁ≤íÂàÜÊòéÔºåÊòØÊØèÂÄãÂÆ∂Â∫≠ÂøÖÂÇôÁöÑÂø´ÈÄüÈ§êÈªû„ÄÇ",
                "ingredients": ["ÈöîÂ§úÈ£Ø", "ÈõûËõã", "Ëî•", "ÂÜ∑ÂáçËî¨Ëèú‰∏Å"],
                "actions": ["ÁÇí", "Âä†Ê≤π", "Âä†ÈÜ¨Ê≤π", "Âä†ÈπΩ", "Âä†ÁôΩËÉ°Ê§íÁ≤â"],
                "tools": ["ÁÇíÈçã", "Á¢ó", "ÈçãÈèü"],
                "tips": "‰ΩøÁî®ÈöîÂ§úÁöÑÂÜ∑È£ØÊòØÁÇíÈ£ØÁ≤íÁ≤íÂàÜÊòéÁöÑÈóúÈçµ„ÄÇÂèØ‰æùÂÄã‰∫∫ÂñúÂ•ΩÂä†ÂÖ•ÁÅ´ËÖø„ÄÅËù¶‰ªÅÊàñËÇâÊú´Á≠âÈÖçÊñôÔºåËÆìÁÇíÈ£ØÊõ¥Ë±êÂØå„ÄÇ"
            }
        ];
        
        const codeLibrary = {
            ingredients: [
                { emoji: "üçû", name: "ÂêêÂè∏", type: "ingredient" }, { emoji: "üçì", name: "ÊûúÈÜ¨", type: "ingredient" },
                { emoji: "ü•ö", name: "ÈõûËõã", type: "ingredient" }, { emoji: "üíß", name: "È£≤Áî®Ê∞¥", type: "ingredient" },
                { emoji: "ü•¨", name: "È´òÈ∫óËèú", type: "ingredient" }, { emoji: "üßÑ", name: "Â§ßËíú", type: "ingredient" },
                { emoji: "üêî", name: "ÈõûËÇâ", type: "ingredient" }, { emoji: "üêü", name: "È≠öËÇâ", type: "ingredient" },
                { emoji: "üåæ", name: "È∫µÁ≤â", type: "ingredient" }, { emoji: "üßà", name: "ÈªÉÊ≤π", type: "ingredient" },
                { emoji: "ü•°", name: "Ê≥°ÊâìÁ≤â", type: "ingredient" }, { emoji: "‚òï", name: "ÂíñÂï°Á≤â", type: "ingredient" },
                { emoji: "üç´", name: "Â∑ßÂÖãÂäõ", type: "ingredient" }, { emoji: "ü•£", name: "È∫•Áâá", type: "ingredient" },
                { emoji: "ü•õ", name: "ÁâõÂ•∂", type: "ingredient" }, { emoji: "ü•ú", name: "Â†ÖÊûú", type: "ingredient" },
                { emoji: "üç™", name: "È§Ö‰πæÂ±ë", type: "ingredient" }, { emoji: "üçå", name: "È¶ôËïâ", type: "ingredient" },
                { emoji: "ü•£", name: "ÁáïÈ∫•", type: "ingredient" }, { emoji: "üíß", name: "Ê∞¥", type: "ingredient" },
                { emoji: "üçì", name: "Ê∞¥Êûú", type: "ingredient" }, { emoji: "ü•¨", name: "Ëî¨Ëèú", type: "ingredient" },
                { emoji: "ü•®", name: "ËòáÊâìÈ§Ö‰πæ", type: "ingredient" }, { emoji: "üçÖ", name: "Áï™ËåÑ", type: "ingredient" },
                { emoji: "üßÖ", name: "Ëî•", type: "ingredient" }, { emoji: "üçó", name: "ÈõûÁøÖ", type: "ingredient" },
                { emoji: "ü´ö", name: "Ëñë", type: "ingredient" }, { emoji: "ü•§", name: "ÂèØÊ®Ç", type: "ingredient" },
                { emoji: "üçæ", name: "ÊñôÈÖí", type: "ingredient" }, { emoji: "üçö", name: "ÈöîÂ§úÈ£Ø", type: "ingredient" },
                { emoji: "ü•¶", name: "ÂÜ∑ÂáçËî¨Ëèú‰∏Å", type: "ingredient" }
            ],
            actions: [
                { emoji: "üî™", name: "Âàá", type: "action", requires: ["ingredient"], process: (state) => `ÂàáÂ•ΩÁöÑ${state}` },
                { emoji: "üç≥", name: "ÁÇí", type: "action", requires: ["ingredient", "tool"], process: (state, tool) => `Áî®${tool}ÁÇíÈÅéÁöÑ${state}` },
                { emoji: "üî•", name: "ÁÉ§", type: "action", requires: ["ingredient", "tool"], process: (state, tool) => `Áî®${tool}ÁÉ§ÈÅéÁöÑ${state}` },
                { emoji: "‚ô®Ô∏è", name: "ÂæÆÊ≥¢", type: "action", requires: ["ingredient", "tool"], process: (state, tool) => `Áî®${tool}ÂæÆÊ≥¢ÈÅéÁöÑ${state}` },
                { emoji: "üßÇ", name: "Âä†ÈπΩ", type: "action", requires: ["ingredient"], process: (state) => `Âä†ÈπΩË™øÂë≥ÁöÑ${state}` },
                { emoji: "‚ö´", name: "Âä†ÈªëËÉ°Ê§í", type: "action", requires: ["ingredient"], process: (state) => `Âä†‰∫ÜÈªëËÉ°Ê§íÁöÑ${state}`},
                { emoji: "üíß", name: "Âä†ËäùÈ∫ªÊ≤π", type: "action", requires: ["ingredient"], process: (state) => `Âä†‰∫ÜËäùÈ∫ªÊ≤πÁöÑ${state}`},
                { emoji: "üç∂", name: "Âä†ÈÜ¨Ê≤π", type: "action", requires: ["ingredient"], process: (state) => `Âä†‰∫ÜÈÜ¨Ê≤πÁöÑ${state}`},
                { emoji: "üç¨", name: "Âä†Á≥ñ", type: "action", requires: ["ingredient"], process: (state) => `Âä†Á≥ñË™øÂë≥ÁöÑ${state}`},
                { emoji: "üíß", name: "Âä†Ê≤π", type: "action", requires: ["ingredient"], process: (state) => `Âä†Ê≤πÊΩ§È£æÁöÑ${state}`},
                { emoji: "üå∂Ô∏è", name: "Âä†Ê§íÈπΩ", type: "action", requires: ["ingredient"], process: (state) => `Âä†‰∫ÜÊ§íÈπΩÁöÑ${state}`},
                { emoji: "üî•", name: "ÁÖÆ", type: "action", requires: ["ingredient", "tool"], process: (state, tool) => `Áî®${tool}ÁÖÆÁÜüÁöÑ${state}`},
                { emoji: "üç≥", name: "ÁÖé", type: "action", requires: ["ingredient", "tool"], process: (state, tool) => `Áî®${tool}ÁÖéÈÅéÁöÑ${state}`},
                { emoji: "üç≤", name: "Ááú", type: "action", requires: ["ingredient", "tool"], process: (state, tool) => `Áî®${tool}ÁáúÁÖÆÁöÑ${state}`},
                { emoji: "ü•§", name: "Âä†ÂèØÊ®Ç", type: "action", requires: ["ingredient"], process: (state) => `Áî®ÂèØÊ®ÇÊª∑Ë£ΩÁöÑ${state}`},
                { emoji: "üçæ", name: "Âä†ÊñôÈÖí", type: "action", requires: ["ingredient"], process: (state) => `Áî®ÊñôÈÖíË™øÂë≥ÁöÑ${state}`},
                { emoji: "üå∂Ô∏è", name: "Âä†ÁôΩËÉ°Ê§íÁ≤â", type: "action", requires: ["ingredient"], process: (state) => `Êíí‰∏äÁôΩËÉ°Ê§íÁ≤âÁöÑ${state}`}
            ],
            tools: [
                { emoji: "üç≥", name: "ÁÇíÈçã", type: "tool" }, { emoji: "‚ô®Ô∏è", name: "ÂæÆÊ≥¢Áàê", type: "tool" },
                { emoji: "üçû", name: "È∫µÂåÖÊ©ü", type: "tool" }, { emoji: "ü•£", name: "Â∞èÁ¢ó", type: "tool" },
                { emoji: "‚öóÔ∏è", name: "ÂæÆÊ≥¢ÂÆπÂô®", type: "tool" }, { emoji: "‚òï", name: "Êó©È§êÊùØ", type: "tool" },
                { emoji: "üç≤", name: "Èçã", type: "tool" }, { emoji: "ü•£", name: "Á¢ó", type: "tool" },
                { emoji: "üç≥", name: "ÈçãÈèü", type: "tool" }, { emoji: "üç≥", name: "Âπ≥Â∫ïÈçã", type: "tool" }
            ]
        };

        // ÁãÄÊÖãÁÆ°ÁêÜ
        let currentQuestion = null;
        let currentGroup = 0;
        let groups = { 0: [] };
        let tempIngredients = []; // ÂÑ≤Â≠òÁµÑÂêàÂá∫ÁöÑÊñ∞È£üÊùê

        // DOMËºâÂÖ•ÂæåÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initPalette();
            showRandomQuestion();

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterOptions(btn.dataset.category);
                });
            });

            document.getElementById('changeQuestionBtn').addEventListener('click', showRandomQuestion);
            document.getElementById('newGroupBtn').addEventListener('click', addNewGroup);
            document.getElementById('runCode').addEventListener('click', executeRecipe);
            document.getElementById('copyBtn').addEventListener('click', copyAnalysisResult);
        });

        // ÂàùÂßãÂåñÊåá‰ª§Èù¢Êùø
        function initPalette() {
            const container = document.getElementById('codeOptions');
            container.innerHTML = '';
            
            const allOptions = [];
            // Â∞áÊ∞∏‰πÖÈ£üÊùêÂíåËá®ÊôÇÈ£üÊùêÂêà‰Ωµ
            const currentIngredients = [...codeLibrary.ingredients];

            const libraryWithTempIngredients = {
                ...codeLibrary,
                ingredients: currentIngredients,
                combined: tempIngredients // Êñ∞Â¢û‰∏ÄÂÄãÁµ¶ÁµÑÂêàÊåâÈàïÁî®ÁöÑÂàÜÈ°û
            };
            
            for (const categoryKey in libraryWithTempIngredients) {
                if(categoryKey === 'seasonings') continue; // Ë™øÂë≥ÊñôÂ∑≤Âêà‰ΩµÂà∞Êìç‰Ωú
                libraryWithTempIngredients[categoryKey].forEach(item => {
                    const newItem = { ...item, category: categoryKey };
                    allOptions.push(newItem);
                });
            }
            
            allOptions.sort(() => Math.random() - 0.5);
            
            allOptions.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'code-option';
                btn.dataset.category = item.category;
                // ÁµÑÂêàÂá∫‰æÜÁöÑÈ£üÊùêÔºå‰πüÊ≠∏È°ûÂà∞È£üÊùêÔºå‰ª•‰æø require Âà§Êñ∑
                if (item.isCombinedResult) {
                    btn.dataset.type = 'ingredient';
                    btn.dataset.isCombined = 'true';
                } else {
                    btn.dataset.type = item.type;
                }
                btn.id = `option-${item.name.replace(/\s/g, '-')}`;
                btn.innerHTML = `<span class="emoji">${item.emoji}</span> ${item.name}`;
                btn.addEventListener('click', () => addToCodeStack(item));
                container.appendChild(btn);
            });
            updatePaletteState(); // ÂàùÂßãÂåñÂæåÊõ¥Êñ∞‰∏ÄÊ¨°Èù¢ÊùøÁãÄÊÖã
        }

        // ÂàÜÈ°ûÁØ©ÈÅ∏
        function filterOptions(category) {
            document.querySelectorAll('.code-option').forEach(option => {
                const optionCategory = option.dataset.category;
                const isCombined = option.dataset.isCombined === 'true';

                let show = false;
                if (category === 'all') {
                    show = true;
                } else if (category === 'combined') {
                    if (isCombined) show = true;
                } else if (category === 'ingredients') {
                    if (optionCategory === 'ingredients' && !isCombined) show = true;
                } else {
                    if (optionCategory === category) show = true;
                }

                option.style.display = show ? 'flex' : 'none';
            });
        }

        // Ê∑ªÂä†Âà∞Á®ãÂºèÁ¢ºÂ†ÜÁñä
        function addToCodeStack(item) {
            document.getElementById('initialMessage')?.remove();
            
            if (!groups[currentGroup]) {
                groups[currentGroup] = [];
            }

            const newItem = { ...item, id: Date.now() + Math.random().toString(36).substr(2, 5) };
            groups[currentGroup].push(newItem);
            
            updateCodePreview();
            updatePaletteState();
        }

        // Êõ¥Êñ∞Á®ãÂºèÁ¢ºÈ†êË¶Ω
        function updateCodePreview() {
            const preview = document.getElementById('codePreview');
            preview.innerHTML = '';
            
            if (Object.values(groups).every(g => g.length === 0)) {
                preview.innerHTML = '<div class="code-line" id="initialMessage">// ÈªûÊìäÂè≥ÂÅ¥Êåá‰ª§ÈñãÂßãÁµÑÂêà...</div>';
                return;
            }
            
            for (const groupId in groups) {
                const group = groups[groupId];
                if (group.length === 0) continue;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'code-line-group';
                
                group.forEach(item => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'code-line';
                    lineDiv.dataset.type = item.type;
                    lineDiv.innerHTML = `
                        <span class="emoji">${item.emoji}</span> 
                        <span>${item.name}</span>
                        <button class="delete-btn">√ó</button>
                    `;
                    lineDiv.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFromCodeStack(item.id, groupId);
                    });
                    groupDiv.appendChild(lineDiv);
                });
                
                const currentState = getGroupState(group);
                if(currentState) {
                    const stateDiv = document.createElement('div');
                    stateDiv.className = 'code-line';
                    stateDiv.dataset.type = 'processed';
                    stateDiv.innerHTML = `<span>‚û°Ô∏è ÁãÄÊÖã: ${currentState}</span>`;
                    groupDiv.appendChild(stateDiv);

                    // Êñ∞Â¢û"ÁµÑÂêà"ÊåâÈàï
                    const combineBtn = document.createElement('button');
                    combineBtn.className = 'combine-btn';
                    combineBtn.textContent = 'ÁµÑÂêà';
                    combineBtn.onclick = () => combineToIngredient(currentState, groupId);
                    groupDiv.appendChild(combineBtn);
                }

                preview.appendChild(groupDiv);
            }
        }
        
        // Âç≥ÊôÇË®àÁÆóÂñÆÂÄãÁµÑÁöÑÁãÄÊÖã
        function getGroupState(group) {
            let state = null;
            let ingredientsInState = [];
            const toolsInState = [];

            for (const item of group) {
                if (item.type === 'ingredient') {
                    ingredientsInState.push(item.name);
                } else if (item.type === 'tool') {
                    toolsInState.push(item.name);
                } else if (item.type === 'action' && item.process && ingredientsInState.length > 0) {
                    let combinedState = ingredientsInState.join('Âíå');
                    if (item.requires.includes('tool')) {
                        const tool = toolsInState.pop() || 'ÊüêÂÄãÂ∑•ÂÖ∑';
                        state = item.process(combinedState, tool);
                    } else {
                        state = item.process(combinedState);
                    }
                    ingredientsInState = [state]; // The result becomes the new single ingredient for the next step
                } else {
                    state = ingredientsInState.join('Âíå');
                }
            }
            return state || ingredientsInState.join('Âíå') || null;
        }


        // ÂæûÂ†ÜÁñä‰∏≠ÁßªÈô§È†ÖÁõÆ
        function removeFromCodeStack(id, groupId) {
            groups[groupId] = groups[groupId].filter(item => item.id !== id);
            // Â¶ÇÊûú‰∏ÄÂÄãÁµÑÁ©∫‰∫ÜÔºåÂ∞±ÊääÂÆÉÂà™ÊéâÔºåÈô§ÈùûÊòØÊúÄÂæå‰∏ÄÂÄãÈ†êË®≠ÁµÑ
            if (groups[groupId].length === 0 && groupId != 0) {
                delete groups[groupId];
            }
            updateCodePreview();
            updatePaletteState();
        }

        // Ê∑ªÂä†Êñ∞ËôïÁêÜÁµÑ
        function addNewGroup() {
            if (groups[currentGroup] && groups[currentGroup].length === 0) {
                return;
            }
            currentGroup = Date.now();
            groups[currentGroup] = [];
            updateCodePreview(); // Êõ¥Êñ∞È†êË¶Ω‰ª•È°ØÁ§∫Êñ∞ÁµÑÁöÑÁ©∫Èñì
            updatePaletteState();
        }

        // Èö®Ê©üÈÅ∏ÊìáÈ°åÁõÆ
        function showRandomQuestion() {
            currentQuestion = recipeQuestions[Math.floor(Math.random() * recipeQuestions.length)];
            document.getElementById('recipeDescription').textContent = currentQuestion.description;
            document.getElementById('recipeTips').textContent = `Â∞èË≤ºÂ£´Ôºö${currentQuestion.tips}`;
            resetAll();
        }

        // ÈáçÁΩÆÊâÄÊúâÁãÄÊÖã
        function resetAll() {
            currentGroup = 0;
            groups = { 0: [] };
            tempIngredients = []; // Ê∏ÖÁ©∫Ëá®ÊôÇÈ£üÊùê
            initPalette(); // ÈáçÊñ∞ÂàùÂßãÂåñÈù¢Êùø
            updateCodePreview();
            document.getElementById('scoreDisplay').textContent = 'Áõ∏‰ººÂ∫¶Ë©ïÂàÜ: -';
            document.getElementById('recipeResult').textContent = 'ÁµÑÂêà‰Ω†ÁöÑÊñôÁêÜÁ®ãÂºèÁ¢ºÔºåÁÑ∂ÂæåÈªûÊìä„ÄåÂü∑Ë°åÊñôÁêÜ„Äç‰æÜÁúãÁúãÁµêÊûúÔºÅ';
            document.getElementById('aiPrompt').innerHTML = '';
            document.getElementById('copyBtn').style.display = 'none';
        }

        // Âü∑Ë°åÊñôÁêÜÂàÜÊûê
        function executeRecipe() {
            const finalStates = Object.values(groups).map(getGroupState).filter(s => s);
            const score = calculateScore();
            document.getElementById('scoreDisplay').textContent = `Áõ∏‰ººÂ∫¶Ë©ïÂàÜ: ${score}/100`;
            
            const result = generateResult(finalStates, score);
            document.getElementById('recipeResult').innerHTML = result.recipe;
            document.getElementById('aiPrompt').innerHTML = result.analysis;
            document.getElementById('copyBtn').style.display = 'block';
        }

        // **Êñ∞Â¢û**ÔºöÊô∫ÊÖßÊõ¥Êñ∞Êåá‰ª§Èù¢ÊùøÁãÄÊÖã
        function updatePaletteState() {
            const currentGroupItems = groups[currentGroup] || [];
            const hasIngredient = currentGroupItems.some(i => i.type === 'ingredient' || i.isCombinedResult);
            const hasTool = currentGroupItems.some(i => i.type === 'tool');

            document.querySelectorAll('.code-option').forEach(btn => {
                const category = btn.dataset.category;
                let disabled = false;

                if (category === 'actions') {
                    if (!hasIngredient) {
                        disabled = true; // Ê≤íÊúâÈ£üÊùêÔºå‰∏çËÉΩÊìç‰Ωú
                    } else {
                        // Ê™¢Êü•ÁâπÂÆöÊìç‰ΩúÁöÑÈúÄÊ±Ç
                        const actionName = btn.textContent.trim().split(' ').slice(1).join(' ');
                        const action = codeLibrary.actions.find(a => a.name === actionName);
                        if (action && action.requires.includes('tool') && !hasTool) {
                            disabled = true; // ÈúÄË¶ÅÂ∑•ÂÖ∑‰ΩÜÊ≤íÊúâÂ∑•ÂÖ∑
                        }
                    }
                } else if (category === 'ingredients' || category === 'combined') {
                    if (hasIngredient) {
                        disabled = true;
                    }
                }

                btn.disabled = disabled;
            });
        }
        
        // **Êñ∞Â¢û**ÔºöÂ∞áÁµÑÂêàÁµêÊûúËÆäÊàêÊñ∞È£üÊùê
        function combineToIngredient(state, groupId) {
            if (!state || tempIngredients.some(ing => ing.name === state)) return;

            const newIngredient = {
                emoji: 'üì¶',
                name: state,
                type: 'ingredient',
                isCombinedResult: true // Ê®ôË®òÁÇ∫ÁµÑÂêàÁµêÊûú
            };
            tempIngredients.push(newIngredient);

            // Ê∏ÖÁ©∫ËàäÁöÑgroup
            delete groups[groupId];

            // Â¶ÇÊûúË¢´ÁµÑÂêàÊéâÁöÑÊòØÁï∂ÂâçÊìç‰ΩúÁöÑÁµÑÔºåÂâáÂª∫Á´ã‰∏ÄÂÄãÊñ∞ÁµÑ
            if (currentGroup == groupId) {
                addNewGroup();
            }

            initPalette(); // ÈáçÂª∫Êåá‰ª§Èù¢Êùø‰ª•ÂåÖÂê´Êñ∞È£üÊùê
            updateCodePreview();
        }

        // Ë®àÁÆóÁõ∏‰ººÂ∫¶ÂàÜÊï∏
        function calculateScore() {
            let score = 0;
            const userSelections = { ingredients: new Set(), actions: new Set(), tools: new Set() };
            
            for (const groupId in groups) {
                if (!Array.isArray(groups[groupId])) continue;
                groups[groupId].forEach(item => {
                    if (item.category === 'ingredients' && !item.isCombinedResult) {
                        userSelections.ingredients.add(item.name);
                    } else if (userSelections[item.category]) {
                        userSelections[item.category].add(item.name);
                    }
                });
            }

            const answer = {
                ingredients: new Set(currentQuestion.ingredients),
                actions: new Set([...(currentQuestion.actions || []), ...(currentQuestion.seasonings || [])]),
                tools: new Set(currentQuestion.tools)
            };
            
            const weights = { ingredients: 40, actions: 40, tools: 20 }; // Ë™øÊï¥Ê¨äÈáç
            
            for (const category in userSelections) {
                const userItems = userSelections[category];
                const answerItems = answer[category];
                if (!answerItems || answerItems.size === 0) {
                    score += userItems.size === 0 ? (weights[category] || 0) : 0;
                    continue;
                }
                let correctMatches = 0;
                userItems.forEach(item => { if (answerItems.has(item)) correctMatches++; });
                score += Math.min(weights[category], (correctMatches / answerItems.size) * weights[category]);
            }
            
            return Math.min(100, Math.round(score));
        }

        // ÁîüÊàêÁµêÊûú
        function generateResult(finalStates, score) {
            let recipe = `<h2>ÊÇ®ÁöÑÊñôÁêÜÊµÅÁ®ã</h2>`;
            recipe += Object.keys(groups).map((groupId, index) => {
                if (!Array.isArray(groups[groupId]) || groups[groupId].length === 0) return '';
                return `<h3>ËôïÁêÜÁµÑ ${index + 1} ‚û°Ô∏è ${getGroupState(groups[groupId]) || 'Êú™ÂÆåÊàê'}</h3>` +
                    groups[groupId].map(item => `<div>${item.emoji} ${item.name}</div>`).join('');
            }).join('');
            
            let analysis = `<h3>‚úÖ Áõ∏‰ººÂ∫¶Ë©ïÂàÜ: ${score}/100</h3>`;
            analysis += `<p>${getOverallFeedback(score)}</p>`;
            analysis += `<h3>‚úÖ Â∑ÆÁï∞ÂàÜÊûê:</h3>`;
            analysis += `<table class="diff-table">
                <tr><th>È†ÖÁõÆ</th><th>ÊÇ®ÁöÑÈÅ∏Êìá</th><th>Ê≠£Á¢∫Á≠îÊ°à</th><th>ÂàÜÊûê</th></tr>
                ${generateDiffTableRows('È£üÊùê', 'ingredients', currentQuestion.ingredients)}
                ${generateDiffTableRows('Êìç‰ΩúËàáË™øÂë≥', 'actions', [...currentQuestion.actions, ...currentQuestion.seasonings])}
                ${generateDiffTableRows('Â∑•ÂÖ∑', 'tools', currentQuestion.tools)}
            </table>`;
            analysis += `<h3>‚úÖ ÊîπÈÄ≤Âª∫Ë≠∞:</h3><p>${generateImprovementSuggestions()}</p>`;
            analysis += `<h3>‚úÖ ÊàêÂìÅÈ†êÊ∏¨:</h3><p>${predictOutcome(finalStates)}</p>`;
            analysis += `<h3>‚úÖ ÂâµÊÑèË©ïÂÉπ:</h3><p>${getCreativeFeedback(score)}</p>`;
            
            return { recipe, analysis };
        }

        // ÁîüÊàêÂ∑ÆÁï∞Ë°®Ê†ºË°å
        function generateDiffTableRows(categoryName, categoryKey, correctItemsSet) {
            const userItems = new Set();
            for (const groupId in groups) {
                if (!Array.isArray(groups[groupId])) continue;
                groups[groupId].forEach(item => {
                    if (item.category === categoryKey && !item.isCombinedResult) {
                        userItems.add(item.name);
                    }
                });
            }
            const correctItems = new Set(correctItemsSet);
            const allItems = [...new Set([...correctItems, ...userItems])];
            
            if (allItems.length === 0 && correctItems.size === 0) {
                 return `<tr><td>${categoryName}</td><td>‚úì (ÁÑ°)</td><td>‚úì (ÁÑ°)</td><td>Ê≠£Á¢∫</td></tr>`;
            }
            
            return allItems.map(item => `
                <tr>
                    <td>${item}</td>
                    <td>${userItems.has(item) ? '‚úì' : '‚úó'}</td>
                    <td>${correctItems.has(item) ? '‚úì' : '‚úó'}</td>
                    <td>${getDiffAnalysis(item, correctItems.has(item), userItems.has(item))}</td>
                </tr>
            `).join('');
        }

        // Â∑ÆÁï∞ÂàÜÊûê
        function getDiffAnalysis(item, isCorrect, isUser) {
            if (isCorrect && isUser) return "Ê≠£Á¢∫ÈÅ∏ÊìáÔºÅ";
            if (!isCorrect && isUser) return `Â§öÈ§òÁöÑÈÅ∏ÊìáÔºåÊ≠§È£üË≠ú‰∏çÈúÄË¶Å„Äå${item}„Äç„ÄÇ`;
            if (isCorrect && !isUser) return `Áº∫Â∞ëÂøÖË¶ÅÁöÑ„Äå${item}„Äç„ÄÇ`;
            return "-";
        }

        // Êñ∞Â¢ûÔºöÁ∏ΩÈ´îË©ïÂÉπ
        function getOverallFeedback(score) {
            if (score >= 80) return "ÊÇ®ÁöÑÊñôÁêÜËàáÊ®ôÊ∫ñÁ≠îÊ°àÈùûÂ∏∏Êé•ËøëÔºåÂÆåÁæéÊéåÊè°Âü∫Êú¨ÊäÄÂ∑ßÔºÅ";
            if (score >= 50) return "ÈõñÁÑ∂Êúâ‰∫õÂ∑ÆÁï∞Ôºå‰ΩÜÈÄôÂèØËÉΩÊàêÁÇ∫ÊÇ®Áç®ÁâπÁöÑÊñôÁêÜÈ¢®Ê†ºÔºÅ";
            
            const { missingKeyIngredient, missingKeyAction } = findKeyMistakes();
            if (missingKeyIngredient) {
                return `‰∏ªË¶ÅÂ§±Ë™§ÔºöÊÇ®ÁöÑÊñôÁêÜÁº∫Â∞ë‰∫ÜÈóúÈçµÈ£üÊùê„Äå${missingKeyIngredient}„ÄçÔºåÂ∞éËá¥È¢®Âë≥ÂíåÂü∫Á§éÂÆåÂÖ®‰∏çÂêå„ÄÇ`;
            }
            if (missingKeyAction) {
                return `‰∏ªË¶ÅÂ§±Ë™§ÔºöÊÇ®ÁöÑÊñôÁêÜÁº∫Â∞ë‰∫ÜÊ†∏ÂøÉÊ≠•È©ü„Äå${missingKeyAction}„ÄçÔºåÈÄôÊòØÈÄôÈÅìËèúÁöÑÈùàÈ≠ÇÊâÄÂú®„ÄÇ`;
            }

            return "ÈÄôÊòØ‰∏ÄÂÄãÊúâË∂£ÁöÑÂòóË©¶Ôºå‰ΩÜ‰ºº‰πéÂÅèÈõ¢‰∫ÜÊåëÊà∞ÁõÆÊ®ô„ÄÇË©¶ËëóÊõ¥Ë≤ºËøëÊèêÁ§∫‰æÜÊìç‰ΩúÁúãÁúãÔºü";
        }

        // Êñ∞Â¢ûÔºöÊâæÂá∫ÈóúÈçµÈåØË™§
        function findKeyMistakes() {
            const userIngredients = new Set();
            const userActions = new Set();
            for (const groupId in groups) {
                if (!Array.isArray(groups[groupId])) continue;
                groups[groupId].forEach(item => {
                    if (item.category === 'ingredients' && !item.isCombinedResult) {
                        userIngredients.add(item.name);
                    } else if (item.category === 'actions') {
                        userActions.add(item.name);
                    }
                });
            }
            
            const neededIngredients = new Set(currentQuestion.ingredients);
            const neededActions = new Set([...(currentQuestion.actions || []), ...(currentQuestion.seasonings || [])]);

            const firstMissingIngredient = [...neededIngredients].find(i => !userIngredients.has(i));
            const firstMissingAction = [...neededActions].find(a => !userActions.has(a));

            return { missingKeyIngredient: firstMissingIngredient, missingKeyAction: firstMissingAction };
        }

        // ÁîüÊàêÊîπÈÄ≤Âª∫Ë≠∞
        function generateImprovementSuggestions() {
            let suggestions = [];
            const userActions = new Set(Object.values(groups).flat().filter(i => i.category === 'actions').map(i => i.name));
            const userIngredients = new Set(Object.values(groups).flat().filter(i => i.category === 'ingredients' && !i.isCombinedResult).map(i => i.name));
            
            const neededActions = new Set([...(currentQuestion.actions || []), ...(currentQuestion.seasonings || [])]);
            const neededIngredients = new Set(currentQuestion.ingredients);

            neededActions.forEach(item => {
                if (!userActions.has(item)) {
                    suggestions.push(`Âª∫Ë≠∞Âä†ÂÖ•Êìç‰Ωú„Äå${item}„Äç„ÄÇ`);
                }
            });
            neededIngredients.forEach(item => {
                if (!userIngredients.has(item)) {
                    suggestions.push(`Âª∫Ë≠∞Âä†ÂÖ•È£üÊùê„Äå${item}„Äç„ÄÇ`);
                }
            });

            return suggestions.length > 0 ? suggestions.join(' ') : "ÊÇ®ÁöÑÊ≠•È©üÂ∑≤Á∂ìÁõ∏Áï∂ÂÆåÂñÑÔºÅ";
        }

        // È†êÊ∏¨ÊàêÂìÅ
        function predictOutcome(finalStates) {
            if (finalStates.length === 0) return "ÁÑ°Ê≥ïÈ†êÊ∏¨ÊàêÂìÅ„ÄÇ";
            return `Ê†πÊìöÊÇ®ÁöÑÊ≠•È©üÔºåÊúÄÁµÇÊàêÂìÅÂèØËÉΩÊòØÔºö${finalStates.join(' Âíå ')} ÁöÑÊ∑∑ÂêàÁâ©„ÄÇ`;
        }

        // ÂâµÊÑèË©ïÂÉπ
        function getCreativeFeedback(score) {
            if (score > 80) return "ÊÇ®ÁöÑÊñôÁêÜËàáÊ®ôÊ∫ñÁ≠îÊ°àÈùûÂ∏∏Êé•ËøëÔºåÂÆåÁæéÊéåÊè°Âü∫Êú¨ÊäÄÂ∑ßÔºÅ";
            if (score > 50) return "ÈõñÁÑ∂Êúâ‰∫õÂ∑ÆÁï∞Ôºå‰ΩÜÈÄôÂèØËÉΩÊàêÁÇ∫ÊÇ®Áç®ÁâπÁöÑÊñôÁêÜÈ¢®Ê†ºÔºÅ";
            return "ÈÄôÊòØ‰∏ÄÂÄãÂÆåÂÖ®ÂâµÊñ∞ÁöÑÊñôÁêÜÁµÑÂêàÔºåË™™‰∏çÂÆöÊúÉÊÑèÂ§ñÂú∞ÁæéÂë≥ÔºÅ";
        }

        // Ë§áË£ΩÂàÜÊûêÁµêÊûú
        function copyAnalysisResult() {
            const textToCopy = document.getElementById('aiPrompt').innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                document.getElementById('copyBtn').textContent = 'Â∑≤Ë§áË£ΩÔºÅ';
                setTimeout(() => { document.getElementById('copyBtn').textContent = 'Ë§áË£ΩÂàÜÊûêÁµêÊûú'; }, 2000);
            });
        }
    </script>
</body>
</html>