<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食譜比對系統</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Microsoft JhengHei', 'SF Pro Text', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            background-color: #f9f5f0;
            color: #333;
            font-size: 16px;
        }
        h1 {
            color: #8b4513;
            text-align: center;
            padding: 10px 0;
            font-size: 1.5rem;
        }
        .input-section {
            margin-bottom: 15px;
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .input-title {
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .recipe-challenge {
            padding: 10px;
            background-color: #fff9e6;
            border-radius: 5px;
            border: 1px solid #d2b48c;
        }
        .recipe-description {
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #5a3921;
        }
        .recipe-tips {
            font-size: 0.9rem;
            font-style: italic;
            color: #8b6b4f;
        }
        
        /* 新增：程式碼組合介面樣式 */
        .code-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .code-preview {
            flex: 1;
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            min-height: 200px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            overflow-y: auto;
            border: 1px solid #444;
        }
        .code-line {
            margin: 8px 0;
            padding: 5px 8px;
            border-left: 4px solid;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #3a3a3a;
            border-radius: 0 4px 4px 0;
        }
        .code-line:first-child {
            margin-top: 0;
        }
        .code-palette {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .category-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .filter-btn {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #d2b48c;
            background-color: #f0e6d2;
            color: #5a3921;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn.active, .filter-btn:hover {
            background-color: #8b4513;
            color: white;
            border-color: #5a3921;
        }
        .code-options {
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            overflow-y: auto;
            max-height: 250px;
        }
        .code-option {
            background: #49483e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
        }
        .code-option:hover {
            transform: scale(1.05);
        }
        /* 按類型區分顏色 */
        .code-line[data-type="ingredient"] { border-color: #a6e22e; } /* 綠色 - 食材 */
        .code-line[data-type="action"] { border-color: #f92672; } /* 粉色 - 操作 */
        .code-line[data-type="tool"] { border-color: #66d9ef; } /* 藍色 - 工具 */
        .code-line[data-type="seasoning"] { border-color: #fd971f; } /* 橘色 - 調味料 */

        .result-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff9e6;
            border: 1px dashed #d2b48c;
            border-radius: 10px;
        }
        .recipe-sentence {
            line-height: 1.6;
            color: #5a3921;
            margin-bottom: 10px;
            white-space: pre-wrap; /* 為了顯示換行 */
        }
        .ai-prompt {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-top: 10px;
            word-break: break-word;
            white-space: pre-wrap;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            flex-basis: 200px;
            flex-grow: 0;
        }
        .run-btn {
            background-color: #4CAF50;
            color: white;
        }
        .run-btn:hover {
            background-color: #45a049;
        }
        .reset-btn {
            background-color: #d2b48c;
            color: white;
        }
        .reset-btn:hover {
            background-color: #8b4513;
        }
        .emoji {
            font-size: 1.2rem;
            margin-right: 5px;
            vertical-align: middle;
        }
        .score-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 15px 0;
            color: #8b4513;
        }
    </style>
</head>
<body>
    <h1><span class="emoji">🍳</span>食譜程式設計</h1>
    
    <div class="input-section">
        <div class="input-title">今日挑戰題目</div>
        <div class="recipe-challenge">
            <div class="recipe-description" id="recipeDescription"></div>
            <div class="recipe-tips" id="recipeTips"></div>
        </div>
    </div>
    
    <div class="code-container">
        <!-- 指令堆疊區 -->
        <div class="code-preview" id="codePreview">
            <div class="code-line" id="initialMessage">// 點擊右側指令開始組合...</div>
        </div>
        
        <!-- 自由選擇面板 -->
        <div class="code-palette">
            <div class="category-filter">
                <button class="filter-btn active" data-category="all">全部</button>
                <button class="filter-btn" data-category="ingredient">食材</button>
                <button class="filter-btn" data-category="action">操作</button>
                <button class="filter-btn" data-category="seasoning">調味</button>
                <button class="filter-btn" data-category="tool">工具</button>
            </div>
            
            <div class="code-options" id="codeOptions">
                <!-- 動態生成的選項按鈕 -->
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-btn reset-btn" id="changeQuestionBtn">換一題</button>
        <button class="action-btn run-btn" id="runCode">
            <span class="emoji">⚡</span> 執行料理
        </button>
    </div>
    
    <!-- 結果顯示區 -->
    <div class="result-container" id="resultContainer">
        <div class="score-display" id="scoreDisplay">相似度評分: -</div>
        <div class="recipe-sentence" id="recipeResult">組合你的料理程式碼，然後點擊「執行料理」來看看結果！</div>
        <div class="ai-prompt" id="aiPrompt"></div>
        <button class="action-btn copy-btn" id="copyBtn" style="display:none;">複製分析提示詞</button>
    </div>

    <script>
        const recipeQuestions = [
            {
                "title": "吐司果醬",
                "description": "挑戰：製作一份飽足感的懶人快速營養早餐，2 分鐘搞定。",
                "ingredients": ["吐司", "果醬"],
                "actions": ["烤"],
                "seasonings": [],
                "tools": ["麵包機"],
                "tips": "吐司可於超市購買，保質期較短。用餐巾紙包著可以邊走邊吃。"
            },
            {
                "title": "微波爐荷包蛋",
                "description": "挑戰：製作一道簡單易做且富含蛋白質的菜餚，120秒內即可完成。",
                "ingredients": ["雞蛋", "飲用水"],
                "actions": ["微波"],
                "seasonings": ["芝麻油", "鹽"],
                "tools": ["微波爐", "小碗"],
                "tips": "為避免加熱時蛋黃濺出，可以在碗上加蓋。用筷子在蛋黃上戳幾個洞是關鍵！"
            }
        ];
        
        const codeLibrary = {
            ingredients: [
                { emoji: "🐔", name: "雞肉" }, { emoji: "🐷", name: "豬肉" }, { emoji: "🐮", name: "牛肉" },
                { emoji: "🐟", name: "魚肉" }, { emoji: "🦐", name: "蝦" }, { emoji: "🥚", name: "雞蛋" },
                { emoji: "🥔", name: "馬鈴薯" }, { emoji: "🥬", name: "高麗菜" }, { emoji: "🧅", name: "洋蔥" },
                { emoji: "🥕", name: "紅蘿蔔" }, { emoji: "🍚", name: "米飯" }, { emoji: "🍜", name: "麵條" },
                { emoji: "🍞", name: "吐司" }, { emoji: "💧", name: "飲用水" }, { emoji: "🍓", name: "果醬" },
            ],
            actions: [
                { emoji: "🔪", name: "切塊", requires: "ingredient" }, { emoji: "🍳", name: "炒", requires: ["ingredient", "tool"] },
                { emoji: "🍳", name: "煎", requires: ["ingredient", "tool"] }, { emoji: "🔥", name: "炸", requires: ["ingredient", "tool"] },
                { emoji: "💨", name: "蒸", requires: ["ingredient", "tool"] }, { emoji: "🍲", name: "煮", requires: ["ingredient", "tool"] },
                { emoji: "🔥", name: "烤", requires: ["ingredient", "tool"] }, { emoji: "♨️", name: "微波", requires: ["ingredient", "tool"] },
                { emoji: "🥣", name: "涼拌", requires: "ingredient" }, { emoji: "🥣", name: "醃製", requires: ["ingredient", "seasoning"] }
            ],
            seasonings: [
                { emoji: "🧂", name: "鹽" }, { emoji: "⚫", name: "黑胡椒" }, { emoji: "⚪", name: "白胡椒" },
                { emoji: "🍬", name: "糖" }, { emoji: "🍶", name: "醬油" }, { emoji: "🍇", name: "醋" },
                { emoji: "🥃", name: "米酒" }, { emoji: "💧", name: "香油" }, { emoji: "💧", name: "芝麻油" },
                { emoji: "🫒", name: "橄欖油" }, { emoji: "🥫", name: "番茄醬" }, { emoji: "🌶️", name: "辣椒粉" }
            ],
            tools: [
                { emoji: "🍳", name: "炒鍋" }, { emoji: "🍳", name: "平底鍋" }, { emoji: "🍲", name: "湯鍋" },
                { emoji: "🔥", name: "烤箱" }, { emoji: "🍚", name: "電鍋" }, { emoji: "♨️", name: "微波爐" },
                { emoji: "🍞", name: "麵包機" }, { emoji: "🥣", name: "小碗" }, { emoji: "🥢", name: "筷子" }
            ]
        };

        let currentQuestion = null;
        let codeStack = [];

        document.addEventListener('DOMContentLoaded', function() {
            initPalette();
            showRandomQuestion();

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => handleFilterClick(btn));
            });

            document.getElementById('changeQuestionBtn').addEventListener('click', showRandomQuestion);
            document.getElementById('runCode').addEventListener('click', handleRunClick);
            
            document.getElementById('copyBtn').addEventListener('click', function() {
                copyToClipboard(document.getElementById('aiPrompt').textContent);
                this.textContent = '已複製！';
                setTimeout(() => {
                    this.textContent = '複製分析提示詞';
                }, 2000);
            });
        });

        function initPalette() {
            const container = document.getElementById('codeOptions');
            container.innerHTML = '';
            for (const category in codeLibrary) {
                codeLibrary[category].forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'code-option';
                    btn.dataset.category = category;
                    btn.innerHTML = `<span class="emoji">${item.emoji}</span> ${item.name}`;
                    btn.addEventListener('click', () => handleOptionClick(item, category));
                    container.appendChild(btn);
                });
            }
        }

        function handleFilterClick(clickedBtn) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
            const category = clickedBtn.dataset.category;
            
            document.querySelectorAll('.code-option').forEach(option => {
                if (category === 'all' || option.dataset.category === category) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function handleOptionClick(item, category) {
            // 移除初始訊息
            const initialMessage = document.getElementById('initialMessage');
            if (initialMessage) {
                initialMessage.remove();
            }
            
            codeStack.push({ ...item, type: category.slice(0, -1) }); // e.g., ingredients -> ingredient
            updateCodePreview();
        }

        function updateCodePreview() {
            const preview = document.getElementById('codePreview');
            preview.innerHTML = '';
            if (codeStack.length === 0) {
                 preview.innerHTML = '<div class="code-line" id="initialMessage">// 點擊右側指令開始組合...</div>';
                 return;
            }
            codeStack.forEach((line, index) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'code-line';
                lineDiv.dataset.type = line.type;
                lineDiv.innerHTML = `<span class="emoji">${line.emoji}</span> ${line.name}`;
                preview.appendChild(lineDiv);
            });
        }
        
        function showRandomQuestion() {
            const randomIndex = Math.floor(Math.random() * recipeQuestions.length);
            currentQuestion = recipeQuestions[randomIndex];
            
            document.getElementById('recipeDescription').textContent = currentQuestion.description;
            document.getElementById('recipeTips').textContent = `小貼士：${currentQuestion.tips}`;
            
            resetAll();
        }

        function resetAll() {
            codeStack = [];
            updateCodePreview();
            document.getElementById('scoreDisplay').textContent = '相似度評分: -';
            document.getElementById('recipeResult').textContent = '組合你的料理程式碼，然後點擊「執行料理」來看看結果！';
            document.getElementById('aiPrompt').textContent = '';
            document.getElementById('copyBtn').style.display = 'none';
        }

        function handleRunClick() {
            const { isValid, feedback } = validateCodeStack();
            
            if (!isValid) {
                document.getElementById('scoreDisplay').textContent = "程式碼錯誤！";
                document.getElementById('recipeResult').textContent = feedback;
                document.getElementById('aiPrompt').textContent = '';
                document.getElementById('copyBtn').style.display = 'none';
                return;
            }

            const score = calculateScore();
            document.getElementById('scoreDisplay').textContent = `相似度評分: ${score}/100`;

            const recipeText = generateRecipe();
            document.getElementById('recipeResult').textContent = recipeText;

            const aiPrompt = generateAIPrompt();
            document.getElementById('aiPrompt').textContent = aiPrompt;
            document.getElementById('copyBtn').style.display = 'block';
        }

        function validateCodeStack() {
            if (codeStack.length === 0) {
                return { isValid: false, feedback: "錯誤：料理程式碼是空的！請先加入指令。" };
            }
            
            const has = {
                ingredient: codeStack.some(l => l.type === 'ingredient'),
                action: codeStack.some(l => l.type === 'action'),
                tool: codeStack.some(l => l.type === 'tool')
            };

            if (!has.ingredient) {
                return { isValid: false, feedback: "錯誤：你沒有準備任何食材！" };
            }
            if (!has.action) {
                return { isValid: false, feedback: "錯誤：你沒有執行任何烹飪操作！" };
            }
            if (!has.tool) {
                return { isValid: false, feedback: "錯誤：你沒有使用任何廚具！" };
            }

            for (let i = 0; i < codeStack.length; i++) {
                const line = codeStack[i];
                if (line.type === 'action' && line.requires) {
                    const requirements = Array.isArray(line.requires) ? line.requires : [line.requires];
                    const stackBefore = codeStack.slice(0, i);
                    
                    for (const req of requirements) {
                        if (!stackBefore.some(l => l.type === req)) {
                            return { 
                                isValid: false, 
                                feedback: `錯誤：指令 "${line.name}" 需要先準備 "${req}" 類型的指令。`
                            };
                        }
                    }
                }
            }

            return { isValid: true, feedback: "程式碼看起來很棒！" };
        }

        function calculateScore() {
            let score = 0;
            const userSelections = {
                ingredients: new Set(codeStack.filter(l => l.type === 'ingredient').map(l => l.name)),
                actions: new Set(codeStack.filter(l => l.type === 'action').map(l => l.name)),
                seasonings: new Set(codeStack.filter(l => l.type === 'seasoning').map(l => l.name)),
                tools: new Set(codeStack.filter(l => l.type === 'tool').map(l => l.name))
            };

            const answer = {
                ingredients: new Set(currentQuestion.ingredients),
                actions: new Set(currentQuestion.actions),
                seasonings: new Set(currentQuestion.seasonings),
                tools: new Set(currentQuestion.tools)
            };

            // 分數權重
            const weights = { ingredients: 40, actions: 30, tools: 20, seasonings: 10 };

            for (const category in userSelections) {
                const userItems = userSelections[category];
                const answerItems = answer[category];
                
                if (answerItems.size === 0) {
                    // 如果答案不需要此類別 (例如調味料)
                    score += (userItems.size === 0) ? weights[category] : 0;
                    continue;
                }

                let correctMatches = 0;
                userItems.forEach(item => {
                    if (answerItems.has(item)) {
                        correctMatches++;
                    }
                });
                
                // 分數計算: (正確數 / 答案需求數) * 權重，但不超過權重
                const categoryScore = Math.min(weights[category], (correctMatches / answerItems.size) * weights[category]);
                score += categoryScore;
            }
            
            return Math.round(score);
        }

        function generateRecipe() {
            let recipe = "## 您的創意料理流程\n\n";
            codeStack.forEach((line, index) => {
                recipe += `${index + 1}. ${line.emoji} 執行指令: ${line.name}\n`;
                switch(line.type) {
                    case "ingredient":
                        recipe += `   - [準備食材] 將 ${line.name} 放到料理台上。\n`;
                        break;
                    case "seasoning":
                        recipe += `   - [添加風味] 使用 ${line.name} 進行調味。\n`;
                        break;

                    case "action":
                        recipe += `   - [執行操作] 對食材執行「${line.name}」操作。\n`;
                        break;
                    case "tool":
                        recipe += `   - [選用工具] 拿出 ${line.name} 準備使用。\n`;
                        break;
                }
            });
            return recipe;
        }

        function generateAIPrompt() {
            let prompt = `請根據以下食譜挑戰和用戶提交的「料理程式碼」，進行詳細比對分析。\n\n`;
            
            prompt += '【題目要求】\n';
            prompt += `描述：${currentQuestion.description}\n`;
            prompt += `提示：${currentQuestion.tips}\n\n`;
            
            prompt += '【正確答案參考】\n';
            prompt += `- 食材: ${currentQuestion.ingredients.join('、') || '無'}\n`;
            prompt += `- 操作: ${currentQuestion.actions.join('、') || '無'}\n`;
            prompt += `- 調味料: ${currentQuestion.seasonings.join('、') || '無'}\n`;
            prompt += `- 工具: ${currentQuestion.tools.join('、') || '無'}\n\n`;

            prompt += '【用戶的料理程式碼】\n';
            codeStack.forEach((line, index) => {
                prompt += `${index + 1}. [${line.type}] ${line.name}\n`;
            });

            prompt += '\n【比對要求】\n';
            prompt += '1. 分析主要差異點（以表格呈現，包含：比對項目、正確答案、用戶選擇、差異說明）\n';
            prompt += '2. 提供具體改進建議（如何調整指令順序或替換指令能更接近正確答案）\n';
            prompt += '3. 根據用戶的指令組合，預測最終成品的味道和口感，並給出創意點評。\n';
            prompt += '4. 如果組合非常奇特，請以鼓勵的語氣提出創新料理的可能性。\n';
            prompt += '5. 最後總結評語（簡短有力的結論）。';
            
            return prompt;
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>