<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>選擇您的儲藏空間 - 紙箱子管理</title>
    <style>
        /* box.html Specific Styles */
        body {
            font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f0f4f8; /* Light blue-gray background */
            margin: 0;
            padding: 0 20px 20px 20px; /* Light blue-gray background */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: center;
        }


        /* --- 頁面標題樣式 --- */
.page-title-header {
    background-color: #FFB74D;
    padding: 1.5rem 1rem;
    text-align: center;
    width: 100%;
    box-shadow: 0 2px 8px rgba(255, 183, 77, 0.3);
}

.page-title {
    color: #424242;
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
}

.page-container {
    width: 100%;
    max-width: 800px;
    margin: 2rem auto;
    position: relative;
}

.page-header {
    background-color: #FFB74D;
    padding: 1.5rem 1rem;
    text-align: center;
    width: 100%;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 2px 8px rgba(255, 183, 77, 0.3);
    margin-bottom: 20px;
}

.page-title {
    color: #424242;
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
}

.game-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 30px;
    position: relative;
    overflow: hidden;
}

/* --- 底部導航 --- */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    z-index: 1000;
    padding: 5px 0;
}

.bottom-nav ul {
    display: flex;
    justify-content: space-around;
    align-items: center;
    list-style: none;
    margin: 0;
    padding: 0;
}

.bottom-nav li {
    text-align: center;
}

.bottom-nav a {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 5px;
    text-decoration: none;
    color: #777;
    font-size: 0.7rem;
    transition: all 0.3s;
}

.bottom-nav a.active {
    color: #FFB74D;
    background-color: rgba(255, 183, 77, 0.1);
    border-radius: 20px;
    animation: pulse 2s infinite;
}

.bottom-nav .icon {
    font-size: 1.5rem;
    margin-bottom: 3px;
}

/* Animation keyframes */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes floatAnimation {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0px); }
}

@keyframes pulseGlow {
    0% { box-shadow: 0 0 5px rgba(255, 183, 77, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 183, 77, 0.8); }
    100% { box-shadow: 0 0 5px rgba(255, 183, 77, 0.5); }
}

@keyframes matchedPulse {
    0% { transform: scale(1.05); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1.05); }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes firework {
    0% { transform: translate(50%, 50%); width: 0; opacity: 1; }
    50% { width: 100%; opacity: 0.8; }
    100% { width: 160%; opacity: 0; }
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* Game elements */
.template-selector {
    margin-bottom: 20px;
    text-align: center;
}

.template-select {
    padding: 10px 15px;
    border-radius: 25px;
    border: 2px solid #FFB74D;
    background-color: white;
    font-family: 'Noto Sans TC', sans-serif;
    font-size: 1rem;
    color: #333;
    outline: none;
    cursor: pointer;
    transition: all 0.3s;
}

.template-select:hover, .template-select:focus {
    box-shadow: 0 0 10px rgba(255, 183, 77, 0.5);
}

.game-info {
    text-align: center;
    margin-bottom: 20px;
}

.level-info {
    display: inline-block;
    background-color: #f5f5f5;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    margin-bottom: 10px;
    color: #666;
}

.moves-counter {
    display: inline-block;
    background-color: #e3f2fd;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    margin-left: 10px;
    color: #1976d2;
}

.game-board {
    display: grid;
    gap: 10px;
    margin: 0 auto 30px;
    max-width: 600px;
    perspective: 1000px;
}

/* Vertical layout for level 1 and 2 */
.game-board.vertical-layout {
    grid-template-columns: repeat(2, 1fr) !important;
}

.card {
    position: relative;
    height: 120px;
    cursor: pointer;
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.card.flipped {
    transform: rotateY(180deg);
}

.card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.card-back {
    background: linear-gradient(135deg, #64B5F6, #42A5F5, #2196F3);
    color: transparent;
    transform: rotateY(0deg);
}

.card-front {
    background-size: cover;
    background-position: center;
    transform: rotateY(180deg);
}

.card:hover:not(.flipped):not(.matched) {
    animation: floatAnimation 2s ease-in-out infinite;
}

.card:hover:not(.flipped):not(.matched) .card-back {
    animation: pulseGlow 1.5s infinite;
}

.card.matched .card-front {
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.8);
    animation: matchedPulse 1.5s ease infinite;
}

.win-message {
    background-color: #e8f5e9;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    animation: bounce 1s infinite;
}

.win-message-title {
    color: #2e7d32;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.game-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}

.reset-btn {
    background-color: #e0e0e0;
    color: #757575;
    border: none;
    padding: 8px 12px;
    font-size: 0.9rem;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.reset-btn:hover {
    background-color: #bdbdbd;
    transform: translateY(-2px);
}

.next-level-btn {
    background-color: #4caf50;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
}

.next-level-btn:hover {
    background-color: #43a047;
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
}

.leaderboard-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    background-color: #ffb74d;
    color: white;
    border: none;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: 500;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(255, 183, 77, 0.3);
    z-index: 100;
}

.leaderboard-btn:hover {
    background-color: #ffa726;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 183, 77, 0.4);
}

/* Fireworks effects */
.fireworks-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 10;
}

.firework {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.firework::before, .firework::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    width: 5px;
    height: 5px;
    box-shadow: 
        0 0 0 4px #ff8426,
        0 0 0 8px #ffde66,
        0 0 0 12px #66ffde,
        0 0 0 16px #66a6ff,
        0 0 0 20px #a366ff,
        0 0 0 24px #ff66d9;
    animation: firework 1.5s ease-out infinite;
}

.firework:nth-child(2) {
    transform: rotate(45deg);
}

.firework:nth-child(3) {
    transform: rotate(90deg);
}

.firework:nth-child(4) {
    transform: rotate(135deg);
}

/* Leaderboard Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background-color: white;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.modal-overlay.visible .modal-content {
    transform: scale(1);
    opacity: 1;
}

.modal-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.modal-title {
    font-size: 1.5rem;
    color: #424242;
    font-weight: 700;
}

.leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.leaderboard-table th,
.leaderboard-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.leaderboard-table th {
    background-color: #f5f5f5;
    font-weight: 600;
    color: #757575;
}

.leaderboard-table tr:nth-child(even) {
    background-color: #fafafa;
}

.leaderboard-table tr.highlight {
    background-color: #fff9c4;
}

.leaderboard-table tr:hover {
    background-color: #f5f5f5;
}

.modal-footer {
    text-align: center;
    margin-top: 20px;
}

.close-modal-btn {
    background-color: #2196f3;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
}

.close-modal-btn:hover {
    background-color: #1976d2;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
}

/* Name Input Modal */
.name-input-container {
    background-color: white;
    border-radius: 15px;
    padding: 25px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
}

.modal-overlay.visible .name-input-container {
    transform: scale(1);
    opacity: 1;
}

.name-input-title {
    font-size: 1.3rem;
    color: #424242;
    margin-bottom: 20px;
    font-weight: 600;
}

.name-input {
    width: 100%;
    padding: 12px 15px;
    font-size: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 20px;
    font-family: 'Noto Sans TC', sans-serif;
    transition: border-color 0.3s;
}

.name-input:focus {
    border-color: #2196f3;
    outline: none;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
}

.submit-name-btn {
    background-color: #4caf50;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
}

.submit-name-btn:hover {
    background-color: #43a047;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
}

/* Loading Spinner */
.loading-spinner {
    display: inline-block;
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 183, 77, 0.3);
    border-radius: 50%;
    border-top-color: #FFB74D;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-container {
    text-align: center;
    padding: 30px;
}

/* Select Template Button */
.template-selector {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

.template-btn {
    background-color: #FFB74D;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(255, 183, 77, 0.3);
}

.template-btn:hover {
    background-color: #ffa726;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 183, 77, 0.4);
}

/* Footer */
.footer {
    text-align: center;
    margin-top: 30px;
    padding: 15px;
    font-size: 0.9rem;
    color: #757575;
}

.footer a {
    color: #2196f3;
    text-decoration: none;
}

.footer a:hover {
    text-decoration: underline;
}

/* Template Selection Modal */
.template-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.template-card {
    background-color: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    padding: 15px;
}

.template-card:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.template-card.active {
    border: 3px solid #4caf50;
}

.template-preview {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    margin-right: 15px;
    flex-shrink: 0;
}

.template-info {
    flex-grow: 1;
}

.template-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #424242;
    margin-bottom: 5px;
}

.template-description {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
}

/* Responsive design */
@media (max-width: 768px) {
    .page-container {
        padding: 15px;
        margin: 1rem auto;
    }
    
    .game-container {
        padding: 20px;
    }
    
    .card {
        height: 100px;
    }
    
    .leaderboard-btn {
        top: 15px;
        left: 15px;
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .template-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }
}

@media (max-width: 480px) {
    .page-title {
        font-size: 1.5rem;
    }
    
    .card {
        height: 80px;
    }
    
    .level-info, .moves-counter {
        padding: 6px 12px;
        font-size: 0.9rem;
        display: block;
        margin: 0 auto 10px;
    }
    
    .moves-counter {
        margin-left: 0;
    }
    
    .win-message-title {
        font-size: 1.2rem;
    }
    
    .next-level-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
    
    .template-grid {
        grid-template-columns: 1fr;
    }
}
.bottom-nav .icon {
    width: 40px;
    height: 40px;
    object-fit: contain;
    margin-bottom: 3px;
}

.template-selection-area {
    padding: 15px 0;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #424242;
    margin-bottom: 20px;
    text-align: center;
}

.template-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.template-card {
    background-color: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    padding: 15px;
}

        .container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            color: #2c3e50; /* Darker blue */
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        #user-selection-area {
            margin-top: 20px;
        }

        .user-card {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #f9f9f9;
        }

        .user-card.selected {
            background-color: #eff7ff;
            border: 2px solid #3498db;
        }

        .user-card img.profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 20px;
            object-fit: cover;
            border: 2px solid #ddd;
        }

        .user-card span.username {
            font-size: 1.4em;
            font-weight: 600;
            color: #34495e; /* Slightly lighter dark blue */
        }

        /* Password Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: left;
        }

        .modal h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #2c3e50;
        }

        .modal label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .modal input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .modal input[type="password"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }


        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .modal button {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .modal button.primary {
            background-color: #3498db; /* Blue */
            color: white;
        }
        .modal button.primary:hover {
            background-color: #2980b9;
        }

        .modal button.secondary {
            background-color: #ecf0f1; /* Light gray */
            color: #333;
            border: 1px solid #bdc3c7;
        }
         .modal button.secondary:hover {
            background-color: #dadedf;
        }


        #loading-message, #error-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        #loading-message { color: #2980b9; background-color: #e0f0ff; }
        #error-message { color: #c0392b; background-color: #fbe N; } /* Typo, should be #fbeae5 or similar */
        #error-message { color: #c0392b; background-color: #fdedec; }

        .password-input-area {
            display: none;
            margin-top: -10px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .password-input-area.visible {
            display: block;
        }

        .password-input-area input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .password-input-area input[type="password"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .password-input-area .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .password-input-area button {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .password-input-area button.primary {
            background-color: #3498db;
            color: white;
        }

        .password-input-area button.primary:hover {
            background-color: #2980b9;
        }

        .password-input-area button.secondary {
            background-color: #ecf0f1;
            color: #333;
            border: 1px solid #bdc3c7;
        }

        .password-input-area button.secondary:hover {
            background-color: #dadedf;
        }

        .password-input-area .error-message {
            color: #c0392b;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: none;
        }

    </style>
</head>
<body>
    <header class="page-header" role="banner">
        <h1 class="page-title" itemprop="name">倉庫紙箱管理器</h1>
    </header>
    <div class="container">
        <h1>選擇使用者</h1>
        <div id="user-selection-area">
            <!-- User cards will be dynamically inserted here -->
            <p id="initial-loading">正在載入用戶列表...</p>
        </div>
        <p id="error-message" style="display:none;"></p>

        <!-- 新增：密碼輸入區域的模板 -->
        <template id="password-input-template">
            <div class="password-input-area">
                <form class="password-form">
                    <input type="password" placeholder="請輸入密碼" required>
                    <p class="error-message"></p>
                    <div class="button-group">
                        <button type="button" class="secondary cancel-btn">取消</button>
                        <button type="submit" class="primary login-btn">登入</button>
                    </div>
                </form>
            </div>
        </template>

        <!-- 註冊按鈕區域 -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <p>還沒有帳號？</p>
            <button id="showRegisterModalBtn" class="button-style-secondary">註冊新使用者</button>
        </div>

        <!-- Registration Modal -->
        <div id="registerModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" data-modal-id="registerModal">×</span>
                <h2>註冊新使用者</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerUsername">用戶名 (至少3位):</label>
                        <input type="text" id="registerUsername" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">密碼 (至少6位):</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">確認密碼:</label>
                        <input type="password" id="registerConfirmPassword" required>
                    </div>
                    <!-- 可選的頭像上傳，初期可以先省略，讓用戶在登入後設置 -->
                    <!--
                    <div class="form-group">
                        <label for="registerProfileImageFile">頭像 (可選):</label>
                        <input type="file" id="registerProfileImageFile" accept="image/*">
                        <div class="image-upload-preview" id="registerImagePreview"><img></div>
                    </div>
                    -->
                    <p id="register-modal-error-message" style="color: #c0392b; font-size: 0.9em; margin-bottom: 10px; display:none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="secondary close-modal-btn" data-modal-id="registerModal">取消</button>
                        <button type="submit" class="primary">註冊</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">輸入密碼</h2>
            <form id="passwordForm">
                <label for="passwordInput">密碼:</label>
                <input type="password" id="passwordInput" required>
                <p id="modal-error-message" style="color: #c0392b; font-size: 0.9em; margin-top: -10px; margin-bottom: 10px; display:none;"></p>
                <div class="modal-actions">
                    <button type="button" class="secondary" id="cancelPassword">取消</button>
                    <button type="submit" class="primary">登入</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer" role="contentinfo">
        <p>© 2025 SunnyYummy. All rights reserved. </p>
    </footer>

    <!-- 底部導航 -->
    <nav class="bottom-nav" role="navigation" aria-label="主要導航">
        <ul>
            <li><a href="/" aria-label="商品頁面"><img src="/images/footicon_store.png" alt="商品" class="icon"><span>商品</span></a></li>
            <li><a href="/music.html" aria-label="音樂頁面"><img src="/images/footicon_music.png" alt="音樂" class="icon"><span>音樂</span></a></li>
            <li><a href="/news.html" aria-label="消息頁面"><img src="/images/footicon_nuews.png" alt="消息" class="icon"><span>消息</span></a></li>
            <li><a href="/scores.html" aria-label="樂譜頁面"><img src="/images/footicon_score.png" alt="樂譜" class="icon"><span>樂譜</span></a></li>
            <li><a href="/games.html" class="active" aria-label="遊戲頁面"><img src="/images/footicon_game.png" alt="遊戲" class="icon"><span>遊戲</span></a></li>
            <li><a href="/guestbook.html" aria-label="留言頁面"><img src="/images/footicon_guestbook.png" alt="留言" class="icon"><span>留言</span></a></li>
        </ul>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userSelectionArea = document.getElementById('user-selection-area');
            const initialLoadingMessage = document.getElementById('initial-loading');
            const errorMessageDiv = document.getElementById('error-message');
            const passwordInputTemplate = document.getElementById('password-input-template');

            let selectedUserId = null;
            let selectedUsername = '';
            let currentPasswordArea = null;

            const showRegisterModalBtn = document.getElementById('showRegisterModalBtn');
            const registerModal = document.getElementById('registerModal');
            const registerForm = document.getElementById('registerForm');
            const registerUsernameInput = document.getElementById('registerUsername');
            const registerPasswordInput = document.getElementById('registerPassword');
            const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword');
            const registerProfileImageFileInput = document.getElementById('registerProfileImageFile');  
            const registerImagePreviewDiv = document.getElementById('registerImagePreview');  
            const registerModalErrorMessage = document.getElementById('register-modal-error-message');
            const closeRegisterModalBtns = document.querySelectorAll('.close-btn[data-modal-id="registerModal"], button.close-modal-btn[data-modal-id="registerModal"]');

            const passwordModal = document.getElementById('passwordModal');
            const passwordForm = document.getElementById('passwordForm');
            const passwordInput = document.getElementById('passwordInput');
            const cancelPasswordBtn = document.getElementById('cancelPassword');
            const modalTitle = document.getElementById('modalTitle');
            const modalErrorMessage = document.getElementById('modal-error-message');

            // --- 事件監聽器綁定 (在 setupEventListeners 函數中添加) ---
            if (showRegisterModalBtn) {
                showRegisterModalBtn.addEventListener('click', () => {
                    registerForm.reset();
                    registerModalErrorMessage.style.display = 'none';
                    if (registerImagePreviewDiv) registerImagePreviewDiv.style.display = 'none';
                    if (registerImagePreviewDiv) registerImagePreviewDiv.querySelector('img').src = '#';
                    registerModal.style.display = 'flex';
                    registerUsernameInput.focus();
                });
            }

            if (registerForm) {
                registerForm.addEventListener('submit', handleUserRegister);
            }

            closeRegisterModalBtns.forEach(btn => {
                btn.addEventListener('click', () => registerModal.style.display = 'none');
            });
            if (registerModal) {
                registerModal.addEventListener('click', (e) => {
                    if (e.target === registerModal) {
                        registerModal.style.display = 'none';
                    }
                });
            }

            // --- 新增用戶註冊處理函數 ---
            async function handleUserRegister(event) {
                event.preventDefault();
                const username = registerUsernameInput.value.trim();
                const password = registerPasswordInput.value;
                const confirmPassword = registerConfirmPasswordInput.value;
                const profileImageFile = registerProfileImageFileInput ? registerProfileImageInput.files[0] : null;

                registerModalErrorMessage.style.display = 'none';

                if (!username || !password || !confirmPassword) {
                    registerModalErrorMessage.textContent = '所有必填項都不能為空。';
                    registerModalErrorMessage.style.display = 'block';
                    return;
                }
                if (username.length < 3) {
                    registerModalErrorMessage.textContent = '用戶名長度至少需要3位。';
                    registerModalErrorMessage.style.display = 'block';
                    return;
                }
                if (password.length < 6) {
                    registerModalErrorMessage.textContent = '密碼長度至少需要6位。';
                    registerModalErrorMessage.style.display = 'block';
                    return;
                }
                if (password !== confirmPassword) {
                    registerModalErrorMessage.textContent = '兩次輸入的密碼不一致。';
                    registerModalErrorMessage.style.display = 'block';
                    return;
                }

                const submitButton = registerForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = '註冊中...';

                // 注意：如果註冊時允許上傳頭像，處理會更複雜
                // 你需要先調用類似 /api/box/upload-analyze-then-process-image 的API上傳頭像 (可能不需要AI分析，僅上傳並返回URL)
                // 然後將獲取的 image_url 和其他註冊信息一起發送到 /api/box/users/register
                // 為了簡化，我們先假設註冊時不直接處理頭像上傳，用戶登入後再設置。

                const registrationData = {
                    username: username,
                    password: password,
                    confirmPassword: confirmPassword,
                    user_profile_image_url: null // 或 undefined
                };

                try {
                    const response = await fetch('/api/box/users/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(registrationData)
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert('註冊成功！您現在可以使用新帳號登入。');
                        registerModal.style.display = 'none';
                        fetchAndRenderUsers(); // 刷新用戶列表以包含新用戶

                        // 如果後端返回了token並且希望註冊後自動登入:
                        if (data.token && data.user) {
                            localStorage.setItem(`boxUserToken_${data.user.userId}`, data.token);
                            localStorage.setItem(`boxCurrentUserId`, data.user.userId);
                            localStorage.setItem(`boxCurrentUsername`, data.user.username);
                            localStorage.setItem(`boxCurrentUserAvatar`, data.user.profileImageUrl || '/images/default_avatar.png');
                            window.location.href = `box-my.html?userId=${data.user.userId}`;
                        }

                    } else {
                        registerModalErrorMessage.textContent = data.error || '註冊失敗，請重試。';
                        registerModalErrorMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('註冊請求失敗:', error);
                    registerModalErrorMessage.textContent = `註冊請求錯誤: ${error.message}`;
                    registerModalErrorMessage.style.display = 'block';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '註冊';
                }
            }

            // 2. 處理用戶選擇
            async function handleUserSelection(userId, username, cardElement) {
                // 如果已經有選中的卡片，移除其選中狀態和密碼輸入區
                if (currentPasswordArea) {
                    const previousCard = currentPasswordArea.previousElementSibling;
                    if (previousCard) previousCard.classList.remove('selected');
                    currentPasswordArea.remove();
                    currentPasswordArea = null;
                }

                // 如果點擊的是當前選中的卡片，則只是關閉
                if (selectedUserId === userId) {
                    selectedUserId = null;
                    selectedUsername = '';
                    return;
                }

                selectedUserId = userId;
                selectedUsername = username;

                // 檢查 LocalStorage 是否有此用戶的有效Token
                const token = localStorage.getItem(`boxUserToken_${userId}`);
                if (token) {
                    try {
                        const verifyResponse = await fetch('/api/box/auth/check', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (verifyResponse.ok) {
                            window.location.href = `box-my.html?userId=${selectedUserId}`;
                            return;
                        } else {
                            localStorage.removeItem(`boxUserToken_${userId}`);
                        }
                    } catch (e) {
                        console.error('驗證Token時出錯:', e);
                        localStorage.removeItem(`boxUserToken_${userId}`);
                    }
                }

                // 添加選中狀態
                cardElement.classList.add('selected');

                // 創建並插入密碼輸入區域
                const passwordAreaClone = passwordInputTemplate.content.cloneNode(true);
                const passwordArea = passwordAreaClone.querySelector('.password-input-area');
                const passwordForm = passwordAreaClone.querySelector('.password-form');
                const passwordInput = passwordAreaClone.querySelector('input[type="password"]');
                const errorMessage = passwordAreaClone.querySelector('.error-message');
                const cancelBtn = passwordAreaClone.querySelector('.cancel-btn');

                // 插入到卡片後面
                cardElement.after(passwordArea);
                currentPasswordArea = passwordArea;
                passwordArea.classList.add('visible');
                passwordInput.focus();

                // 處理表單提交
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const password = passwordInput.value;
                    if (!password) {
                        errorMessage.textContent = '密碼不能為空';
                        errorMessage.style.display = 'block';
                        return;
                    }

                    const submitButton = passwordForm.querySelector('.login-btn');
                    submitButton.disabled = true;
                    submitButton.textContent = '登入中...';

                    try {
                        const response = await fetch('/api/box/users/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: selectedUsername, password: password })
                        });

                        const data = await response.json();

                        if (response.ok && data.success && data.token) {
                            localStorage.setItem(`boxUserToken_${selectedUserId}`, data.token);
                            localStorage.setItem(`boxCurrentUserId`, selectedUserId);
                            localStorage.setItem(`boxCurrentUsername`, selectedUsername);
                            localStorage.setItem(`boxCurrentUserAvatar`, data.user?.profileImageUrl || '/images/default_avatar.png');
                            window.location.href = `box-my.html?userId=${selectedUserId}`;
                        } else {
                            errorMessage.textContent = data.error || '登入失敗，請檢查您的密碼';
                            errorMessage.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('登入請求失敗:', error);
                        errorMessage.textContent = `登入請求錯誤: ${error.message}`;
                        errorMessage.style.display = 'block';
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = '登入';
                    }
                });

                // 處理取消按鈕
                cancelBtn.addEventListener('click', () => {
                    cardElement.classList.remove('selected');
                    passwordArea.remove();
                    currentPasswordArea = null;
                    selectedUserId = null;
                    selectedUsername = '';
                });
            }

            // 1. 獲取並渲染用戶列表
            async function fetchAndRenderUsers() {
                try {
                    initialLoadingMessage.textContent = '正在載入用戶列表...';
                    errorMessageDiv.style.display = 'none';
                    userSelectionArea.innerHTML = '';

                    const response = await fetch('/api/box/users');
                    if (!response.ok) {
                        throw new Error(`無法獲取用戶列表: ${response.status}`);
                    }
                    const users = await response.json();

                    if (users.length === 0) {
                        userSelectionArea.innerHTML = '<p>目前沒有可用的用戶。</p>';
                        initialLoadingMessage.style.display = 'none';
                        return;
                    }

                    users.forEach(user => {
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.dataset.userId = user.user_id;
                        card.dataset.username = user.username;

                        const avatar = document.createElement('img');
                        avatar.className = 'profile-avatar';
                        avatar.src = user.user_profile_image_url || '/images/default_avatar.png';
                        avatar.alt = user.username;

                        const usernameSpan = document.createElement('span');
                        usernameSpan.className = 'username';
                        usernameSpan.textContent = user.username;

                        card.appendChild(avatar);
                        card.appendChild(usernameSpan);
                        card.addEventListener('click', () => handleUserSelection(user.user_id, user.username, card));
                        userSelectionArea.appendChild(card);
                    });
                    initialLoadingMessage.style.display = 'none';

                } catch (error) {
                    console.error('獲取用戶失敗:', error);
                    initialLoadingMessage.style.display = 'none';
                    errorMessageDiv.textContent = `錯誤: ${error.message}`;
                    errorMessageDiv.style.display = 'block';
                    userSelectionArea.innerHTML = '<p style="color:red;">載入用戶列表失敗，請稍後再試。</p>';
                }
            }

            // 初始化頁面
            fetchAndRenderUsers();
        });
    </script>
</body>
</html>