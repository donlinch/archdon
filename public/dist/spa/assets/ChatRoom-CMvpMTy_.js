import{c as Y,b7 as Z,b8 as X,h as ee,r as m,a as te,j as se,ae,H as z,G as o,J as C,n as oe,K as a,F as r,P as _,Y as x,Z as V,L as d,N as O,R as l,Q as N,D as M,ad as ne,O as re,I as P,V as le,T as ie,b9 as ce,aA as ue}from"./index-DYK3U5_v.js";import{Q as me}from"./QPage-CQePgJIi.js";import{u as de,a as ve}from"./auth-store-av6Ohcd8.js";import{u as pe}from"./use-quasar-Cu2JO6wp.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";const fe='<circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="60" cy="15" r="9" fill-opacity=".3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle>',_e=Y({name:"QSpinnerDots",props:Z,setup($){const{cSize:v,classes:i}=X($);return()=>ee("svg",{class:i.value,fill:"currentColor",width:v.value,height:v.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg",innerHTML:fe})}}),ge={class:"chat-room-container"},ye={class:"chat-header"},we={key:0,class:"header-online-users-wrapper"},be={class:"header-online-users"},ke=["onClick"],Ce=["src"],Ne={class:"header-username"},Se={class:"connection-status-wrapper"},Ie=["title"],xe={key:0,class:"online-count"},Me={key:0,class:"welcome-notice"},$e={class:"notice-content"},Te={key:1,class:"empty-chat"},Ue={key:0,class:"system-message-body"},Re={key:1,class:"announcement-message-body"},Ae=["src"],Be={class:"message-content"},Qe={class:"message-header"},We={class:"message-sender"},ze={class:"message-timestamp"},Ve={class:"message-body"},Oe={key:3,class:"message-content"},Pe={class:"message-body my-message-body"},De={class:"message-timestamp text-right"},Ee={class:"chat-input-area"},qe={key:0,class:"reconnect-overlay"},He={__name:"ChatRoom",setup($){const v=pe(),i=de(),n=m(null),w=m([]),p=m(""),h=m([]),c=m(!1),g=m(0),T=m(5);let S=null;const I=m(!1),D=m("歡迎來到寵物聊天室！在這裡，你可以與其他寵物主人交流心得，分享你的寵物趣事。請保持友善、尊重他人，並遵守社群規範。"),U=m(!1),{resolveUrl:b}=ve(),k=m(null),E=te(()=>{const e=new Map;return h.value.forEach(s=>{e.has(s.userId)||e.set(s.userId,s)}),Array.from(e.values()).slice(0,10)}),q=e=>{p.value=`${p.value}@${e.username} `},R=()=>{if(!i.isLoggedIn){v.notify({color:"negative",message:"請先登入才能進入聊天室",icon:"warning"});return}const e=i.token,s=i.userId,t=i.username,u=window.location.protocol==="https:"?"wss:":"ws:",G=window.location.host,W=`${u}//${G}/chat?token=${encodeURIComponent(e)}&userId=${encodeURIComponent(s)}&username=${encodeURIComponent(t)}`;console.log("[Chat] Attempting to connect to:",W),n.value=new WebSocket(W),n.value.onopen=()=>{console.log("[Chat] WebSocket 連接成功！"),c.value=!0,g.value=0,J()},n.value.onmessage=y=>{try{const f=JSON.parse(y.data);console.log("[Chat] Received message:",f),H(f)}catch(f){console.error("[Chat] 解析訊息失敗:",f)}},n.value.onclose=y=>{if(console.warn(`[Chat] WebSocket 連接已關閉。 Code: ${y.code}, Reason: ${y.reason}`),c.value=!1,n.value=null,g.value<T.value){g.value++;const f=Math.min(1e3*Math.pow(2,g.value),3e4);console.log(`[Chat] 將在 ${f/1e3} 秒後嘗試重新連接... (第 ${g.value} 次)`),S=setTimeout(R,f)}else console.error("[Chat] 已達到最大重連次數，停止重連。"),v.notify({color:"negative",message:"無法連接到聊天室，請檢查網路並重新整理頁面。",icon:"wifi_off",timeout:1e4,actions:[{label:"重新整理",color:"white",handler:()=>{window.location.reload()}}]})},n.value.onerror=y=>{console.error("[Chat] WebSocket 發生錯誤:",y),c.value=!1}},H=e=>{switch(e.type){case"welcome":{v.notify({color:"positive",message:e.message});break}case"system_message":case"announcement":case"chat_message":{w.value.push({...e,avatar:b(e.avatar)}),B();break}case"online_users":{h.value=e.users.map(s=>({...s,avatar:b(s.avatar)}));break}case"user_joined":{const s={...e.user,avatar:b(e.user.avatar)};h.value.some(t=>t.userId===s.userId)||h.value.push(s);break}case"user_left":{h.value=h.value.filter(s=>s.userId!==e.userId);break}case"error":{v.notify({color:"negative",message:e.message});break}default:{console.warn("Received unhandled message type:",e.type);break}}},A=()=>{n.value&&n.value.readyState===WebSocket.OPEN&&p.value.trim()&&(U.value||(I.value=!0,U.value=!0),n.value.send(JSON.stringify({type:"chat_message",content:p.value.trim()})),p.value="")},L=()=>{v.dialog({title:"發布全頻公告",message:"請在下方輸入您想發送的公告內容。",prompt:{model:"",type:"textarea"},cancel:!0,persistent:!0}).onOk(e=>{e&&e.trim()&&j(e.trim())})},j=e=>{n.value&&n.value.readyState===WebSocket.OPEN&&(n.value.send(JSON.stringify({type:"announcement",content:e})),v.notify({icon:"check_circle",color:"positive",message:"公告已成功發送！",position:"top"}))},J=async()=>{try{const s=await fetch("/api/vue-game/chat/history/1");if(!s.ok)throw new Error("Failed to fetch history");const t=await s.json();w.value=t.map(u=>({id:u.id,content:u.message,timestamp:new Date(u.created_at).getTime(),userId:u.user_id,username:u.display_name||u.username,roleName:u.role_name,avatar:b(u.user_profile_image_url)})),await B()}catch(e){console.error("獲取聊天歷史失敗:",e)}},B=()=>oe(()=>{k.value&&(k.value.scrollTop=k.value.scrollHeight)}),Q=e=>new Date(e).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}),K=e=>e.type==="announcement"?"announcement-item":e.type==="system_message"?"system-message-item":["message-item",{"my-message":Number(e.userId)===Number(i.userId)}],F=e=>{switch(e){case"系統管理員":return"#ff4d4f";case"VIP":return"#faad14";default:return"#65676b"}};return se(()=>{i.initializeAuth(),console.log("當前使用者角色:",i.roleName),R()}),ae(()=>{S&&clearTimeout(S),n.value&&n.value.readyState===WebSocket.OPEN&&(T.value=-1,n.value.close(1e3,"Component unmounting"))}),(e,s)=>(o(),z(me,{class:"chat-room-page"},{default:C(()=>[a("div",ge,[a("div",ye,[h.value.length>0?(o(),r("div",we,[a("div",be,[(o(!0),r(x,null,V(E.value,t=>(o(),r("div",{key:t.id,class:"header-user-item",onClick:u=>q(t)},[d(O,{size:"32px",class:"online-user-avatar"},{default:C(()=>[a("img",{src:t.avatar},null,8,Ce)]),_:2},1024),a("div",Ne,l(t.username),1)],8,ke))),128))])])):_("",!0),a("div",Se,[a("div",{class:"connection-emoji",title:c.value?"已連線":"未連線"},l(c.value?"✅":"❌"),9,Ie),c.value?(o(),r("div",xe," 在線 "+l(h.value.length)+" 人 ",1)):_("",!0)])]),a("div",{class:"chat-messages",ref_key:"messagesContainer",ref:k},[I.value?(o(),r("div",Me,[d(N,{name:"campaign",class:"q-mr-sm"}),a("div",$e,l(D.value),1),d(M,{flat:"",round:"",dense:"",icon:"close",onClick:s[0]||(s[0]=t=>I.value=!1)})])):_("",!0),w.value.length===0&&c.value?(o(),r("div",Te,[d(N,{name:"chat",size:"48px",color:"grey-5"}),s[2]||(s[2]=a("p",null,"歡迎來到聊天室！開始你的第一個對話吧",-1))])):_("",!0),(o(!0),r(x,null,V(w.value,t=>(o(),r("div",{key:t.id,class:ne(K(t))},[t.type==="system_message"?(o(),r("div",Ue,[d(N,{name:"smart_toy",class:"q-mr-sm"}),a("span",null,l(t.content),1)])):t.type==="announcement"?(o(),r("div",Re,[d(N,{name:"campaign",class:"q-mr-sm"}),re(" "+l(t.content),1)])):Number(t.userId)!==Number(P(i).userId)?(o(),r(x,{key:2},[d(O,{size:"32px"},{default:C(()=>[a("img",{src:t.avatar},null,8,Ae)]),_:2},1024),a("div",Be,[a("div",Qe,[a("span",We,l(t.username),1),t.roleName?(o(),r("span",{key:0,class:"message-role",style:le({color:F(t.roleName)})},l(t.roleName),5)):_("",!0),a("span",ze,l(Q(t.timestamp)),1)]),a("div",Ve,l(t.content),1)])],64)):(o(),r("div",Oe,[a("div",Pe,l(t.content),1),a("div",De,l(Q(t.timestamp)),1)]))],2))),128))],512),a("div",Ee,[d(ie,{modelValue:p.value,"onUpdate:modelValue":s[1]||(s[1]=t=>p.value=t),placeholder:"輸入訊息...",outlined:"",dense:"",class:"message-input",onKeydown:ce(ue(A,["prevent"]),["enter"]),disable:!c.value},{append:C(()=>[P(i).roleName==="系統管理員"?(o(),z(M,{key:0,round:"",dense:"",flat:"",icon:"campaign",onClick:L,disable:!c.value,title:"發布公告"},null,8,["disable"])):_("",!0),d(M,{round:"",dense:"",flat:"",icon:"send",onClick:A,disable:!p.value.trim()||!c.value},null,8,["disable"])]),_:1},8,["modelValue","onKeydown","disable"])])]),!c.value&&g.value>0?(o(),r("div",qe,[d(_e,{color:"white",size:"40px"}),s[3]||(s[3]=a("div",{class:"reconnect-text"},"聊天室連接中斷，正在嘗試重新連接...",-1))])):_("",!0)]),_:1}))}},Ge=he(He,[["__scopeId","data-v-8ad27508"]]);export{Ge as default};
