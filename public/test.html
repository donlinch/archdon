專案計畫書：YouTube 直播互動抽獎系統
版本：1.1 日期： 2024年5月21日 專案負責人： SunnyYummy
1. 專案目標與願景 (Project Goal & Vision)
本專案旨在為 SunnyYummy 的 YouTube 頻道建立一個功能強大、高互動性的直播抽獎工具。此工具需能即時抓取直播聊天室內容，根據指定關鍵字自動建立抽獎名單，並提供多種視覺化的抽獎動畫，以提升直播的趣味性和觀眾的參與感。最終的抽獎結果將被永久記錄，以便於日後查詢和管理。
v1.1 新增目標：
* 建立完整的觀眾互動回饋機制，提升參與體驗
* 構建觀眾忠誠度管理系統，培養核心粉絲群
* 強化系統安全性與視覺效果，提升專業度
2. 功能規格 (Functional Specifications)
2.1 直播監控與參與者管理
* 動態目標設定：系統管理員（直播主）能夠在不重啟服務的情況下，透過後台管理介面輸入 YouTube 直播的影片ID或網址，即時切換監控的直播聊天室。
* 關鍵字觸發：系統將監聽聊天室，當有觀眾發送包含預設關鍵字（例如：「我要抽獎」）的訊息時，自動將該觀眾的 displayName 加入抽獎參與者名單。
* 重複排除：系統會自動過濾，確保同一位觀眾即使多次發言，在單次抽獎中也只會被計入名單一次。
* 🆕 參與確認回饋：當觀眾成功加入抽獎名單時，系統會自動在聊天室發送確認訊息（如：「@用戶名 已成功參與抽獎！🎉」）。
* 🆕 重複參與提示：對已參與的觀眾給予友善提醒訊息（如：「@用戶名 您已在抽獎名單中囉！😊」），而非完全忽略。
* 手動資格管理：管理員能夠在後台介面即時查看當前所有參與者名單，並可以手動將任何不符合資格或已中獎的參與者從名單中移除。
2.2 抽獎活動管理
* 🆕 倒數計時功能：管理員可為抽獎活動設定截止時間（5分鐘、10分鐘、15分鐘、30分鐘或自訂時間），系統會在聊天室顯示倒數計時，在最後1分鐘進行提醒，增加緊迫感和參與度。
* 🆕 API 速率限制管理：管理員可在後台選擇 YouTube API 請求間隔（5秒、10秒、20秒），防止惡意請求耗盡 API 配額，確保系統穩定運行。
2.3 抽獎執行與動畫效果
* 多模式抽獎：系統需提供至少三種不同的抽獎動畫模式，供管理員在直播時自由選擇：
    1. 轉盤式 (Turntable)：所有參與者姓名平均分佈在一個圓盤上，啟動後轉盤會旋轉，最終由指針停在的位置決定中獎者。
    2. 指針式 (Pointer)：所有參與者姓名在一個橫向滾動的跑馬燈上循環移動，管理員按下停止後，由中央的指針所指的姓名為中獎者。
    3. 洞洞樂式 (Punch-Hole)：所有參與者姓名被隱藏在一個個蓋牌（卡片）後面，管理員點擊卡片後，卡片會翻開揭曉中獎者。
* (可選擴充) 多人抽獎：洞洞樂模式應支援一次設定抽出多位中獎者的功能。
* 🆕 粒子效果慶祝動畫：中獎時觸發絢麗的粒子爆炸效果，包含彩紙、煙火、星星等多種粒子類型，搭配顏色漸變和動態軌跡，營造慶祝氛圍。
2.4 資料持久化與歷史記錄
* 抽獎結果記錄：每次抽獎執行完畢後，系統必須將本次抽獎的關鍵資訊寫入 PostgreSQL 資料庫進行永久保存。
* 記錄欄位：儲存的資料應至少包含：
    * 抽獎活動對應的 video_id
    * 當時使用的 lottery_keyword
    * 中獎者的 winner_name
    * 當時的 total_participants（總參與人數）
    * 抽獎執行的時間戳 draw_timestamp
    * 🆕 活動持續時間 duration_minutes
    * 🆕 使用的動畫模式 animation_mode
    * (可選) 完整的 participants_list (以 JSONB 格式儲存)
* 歷史查詢：系統需提供一個受保護的後台 API，用於查詢歷史抽獎記錄。
2.5 用戶畫像與忠誠度管理
* 🆕 用戶參與記錄：建立 user_profiles 資料表，記錄每位觀眾的參與歷史：
    * user_channel_id（YouTube 頻道ID）
    * display_name（顯示名稱）
    * profile_image_url（頭像網址）
    * total_participations（總參與次數）
    * total_wins（總中獎次數）
    * first_participation_date（首次參與日期）
    * last_participation_date（最後參與日期）
    * participation_frequency（參與頻率評分）
* 🆕 忠實粉絲識別：系統自動標記「核心粉絲」（參與次數 ≥ 5次）、「超級粉絲」（參與次數 ≥ 20次），並在後台提供粉絲分析報表。
* 🆕 用戶標籤系統：管理員可為特定用戶新增自訂標籤（如：「活躍觀眾」、「忠實粉絲」、「新觀眾」），便於管理和互動策略制定。
2.6 資訊擷取與顯示
* 豐富的作者資訊：系統從 YouTube API 擷取的資訊需包含發言者的顯示名稱 (displayName) 和個人頭像 (profileImageUrl)。
* 即時前端顯示：後台管理介面需即時顯示：
    * 直播聊天室的完整內容（含頭像）。
    * 當前抽獎參與者名單（含人數統計）。
    * 🆕 倒數計時器（活動進行中時）。
    * 🆕 API 請求狀態與速率限制設定。
    * 🆕 用戶參與統計（新用戶、回歸用戶比例）。
    * 抽獎動畫。
3. 技術架構與設定 (Technical Architecture & Configuration)
3.1 後端 (Backend)
* 語言/框架：Node.js 搭配 Express.js。
* 即時通訊：使用 ws (WebSocket) 套件，在後端和前端管理介面之間建立即時雙向通訊。
* 資料庫：PostgreSQL，透過 pg 套件進行連接與操作。
* 🆕 快取系統：使用 node-cache 套件實現記憶體快取，儲存用戶畫像和參與狀態，提升查詢效能。
* 🆕 速率限制：使用 express-rate-limit 中介軟體保護 API 端點，防止濫用。
* 外部 API：
    * YouTube Data API v3：使用 axios 套件呼叫，用於抓取直播聊天室訊息。
    * 🆕 智能速率控制：實現動態 API 請求間隔調整，避免超出配額限制。
    * API 金鑰將儲存在 Render 的環境變數 YOUTUBE_API_KEY 中，並不在程式碼中寫死。
* 模組化設計：
    * 核心抽獎邏輯將封裝在獨立的 youtubeLottery.js 模組中。
    * 🆕 userProfile.js 模組負責用戶畫像管理。
    * 🆕 chatResponder.js 模組處理聊天室自動回覆功能。
    * server.js 作為主入口，負責整合 Express、WebSocket、資料庫連接，並初始化各模組。
* API 端點：所有管理相關的 API (如切換直播、執行抽獎、移除參與者、查詢歷史、用戶管理) 都將掛載在 /api/admin/ 路徑下，並受現有的 isAdminAuthenticated 中介軟體保護。
3.2 前端 (Frontend)
* 技術：純 HTML, CSS, JavaScript。
* 🆕 視覺庫：引入 particles.js 或 canvas-confetti 實現粒子效果。
* 🆕 動畫庫：使用 anime.js 或原生 CSS animations 增強動畫流暢度。
* 核心頁面：public/youtube-lottery-admin.html，作為所有操作的管理中樞。
* 🆕 新增頁面：
    * public/user-analytics.html - 用戶分析儀表板
    * public/lottery-history.html - 抽獎歷史詳細檢視
* 通訊：透過 WebSocket 與後端連接，接收 chat_message、update_participants、announce_winner、🆕 countdown_update、🆕 user_stats_update 等事件，並即時更新 UI。
* 互動：使用者可以透過頁面上的輸入框和按鈕，向後端 API 發送指令（如設定 Video ID、觸發抽獎、移除參與者、🆕 設定倒數計時、🆕 調整 API 速率）。
3.3 資料庫結構 (Database Schema)

sql
-- 原有的抽獎歷史表（更新欄位）
CREATE TABLE youtube_lottery_history (
    id SERIAL PRIMARY KEY,
    video_id VARCHAR(255) NOT NULL,
    lottery_keyword VARCHAR(255) NOT NULL,
    winner_name VARCHAR(255) NOT NULL,
    total_participants INTEGER NOT NULL,
    draw_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    duration_minutes INTEGER, -- 🆕 活動持續時間
    animation_mode VARCHAR(50), -- 🆕 使用的動畫模式
    participants_list JSONB
);

-- 🆕 用戶畫像表
CREATE TABLE user_profiles (
    id SERIAL PRIMARY KEY,
    user_channel_id VARCHAR(255) UNIQUE NOT NULL,
    display_name VARCHAR(255) NOT NULL,
    profile_image_url TEXT,
    total_participations INTEGER DEFAULT 0,
    total_wins INTEGER DEFAULT 0,
    first_participation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_participation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    participation_frequency DECIMAL(3,2) DEFAULT 0.00,
    user_tags TEXT[], -- 🆕 用戶標籤陣列
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 🆕 參與記錄詳細表
CREATE TABLE participation_records (
    id SERIAL PRIMARY KEY,
    user_channel_id VARCHAR(255) REFERENCES user_profiles(user_channel_id),
    video_id VARCHAR(255) NOT NULL,
    lottery_id INTEGER REFERENCES youtube_lottery_history(id),
    participated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_winner BOOLEAN DEFAULT FALSE
);

-- 🆕 建立索引提升查詢效能
CREATE INDEX idx_user_profiles_channel_id ON user_profiles(user_channel_id);
CREATE INDEX idx_participation_records_user_id ON participation_records(user_channel_id);
CREATE INDEX idx_participation_records_video_id ON participation_records(video_id);
3.4 部署與環境 (Deployment & Environment)
* 平台：Render.com。
* 環境變數：
    * DATABASE_URL：PostgreSQL 資料庫連接字串。
    * YOUTUBE_API_KEY：YouTube Data API v3 的金鑰。
    * 🆕 DEFAULT_API_RATE_LIMIT：預設 API 請求間隔（秒）。
    * 🆕 ENABLE_CHAT_RESPONSES：是否啟用聊天室自動回覆功能。
    * SESSION_SECRET 等現有專案所需的變數。
* 資料持久化：Render 的 PostgreSQL 服務用於儲存抽獎歷史和用戶畫像；Render 的持久化磁碟 (/data/uploads) 與此專案無直接關聯。參與者名單等即時狀態儲存在伺服器記憶體中。
4. 實施步驟 (Implementation Steps)
第一階段：基礎系統建立
1. 環境設定：
    * [✓] 在 Google Cloud Platform 建立專案並啟用 YouTube Data API v3。
    * [✓] 產生一組 API 金鑰。
    * [✓] 安全設定：將 API 金鑰的「應用程式限制」設為「無」，但將「API 限制」設定為僅允許 YouTube Data API v3。
    * [✓] 在 Render.com 的環境變數中新增 YOUTUBE_API_KEY 並填入金鑰。
2. 資料庫建立：
    * 使用提供的 SQL 指令，在 PostgreSQL 資料庫中建立 youtube_lottery_history、🆕 user_profiles、🆕 participation_records 表格。
第二階段：核心功能開發
1. 後端開發：
    * 安裝新套件：npm install axios node-cache express-rate-limit canvas-confetti
    * 建立 youtubeLottery.js 模組，並實現核心函式。
    * 🆕 建立 userProfile.js 模組，實現用戶畫像管理功能。
    * 🆕 建立 chatResponder.js 模組，處理自動回覆邏輯。
    * 🆕 實現 API 速率限制選擇功能。
    * 修改 server.js，整合所有新模組。
2. 前端開發：
    * 建立 public/youtube-lottery-admin.html 頁面。
    * 🆕 新增倒數計時器 UI 組件。
    * 🆕 整合粒子效果庫，實現中獎慶祝動畫。
    * 🆕 建立用戶分析儀表板頁面。
    * 🆕 新增 API 速率設定控制面板。
第三階段：增強功能實作
1. 互動回饋系統：
    * 🆕 實現參與確認和重複參與提示功能。
    * 🆕 建立聊天室訊息發送機制。
    * 🆕 設計友善的回饋訊息模板。
2. 用戶畫像系統：
    * 🆕 實現用戶參與記錄追蹤。
    * 🆕 建立忠實粉絲識別演算法。
    * 🆕 開發用戶標籤管理功能。
第四階段：測試與優化
1. 系統測試：
    * 在本地環境進行完整的功能測試。
    * 🆕 進行 API 速率限制測試。
    * 🆕 測試粒子效果在不同裝置上的效能。
    * 🆕 驗證用戶畫像資料準確性。
2. 效能優化：
    * 🆕 優化資料庫查詢效率。
    * 🆕 實施前端快取策略。
    * 🆕 調整粒子效果參數，確保流暢度。
第五階段：部署與監控
1. 生產部署：
    * 將所有程式碼變更推送到 GitHub。
    * Render 將自動部署新版本，監控部署日誌確保無誤。
    * 🆕 設定系統監控和日誌記錄。
2. 正式測試：
    * 在正式環境進行一次完整的直播抽獎模擬。
    * 🆕 測試所有新功能的穩定性。
    * 🆕 驗證用戶分析數據的準確性。
5. 風險評估與緩解策略 (Risk Assessment & Mitigation)
技術風險
* YouTube API 配額超限：
    * 緩解：實施智能速率控制，提供多檔速率選擇
    * 監控：即時追蹤 API 使用量
* 🆕 粒子效果效能問題：
    * 緩解：提供效果開關，針對低階裝置優化
    * 備案：降級為簡單 CSS 動畫
營運風險
* 🆕 聊天室垃圾訊息：
    * 緩解：實施訊息過濾和速率限制
    * 監控：異常訊息模式偵測
* 🆕 用戶隱私問題：
    * 緩解：僅收集公開的 YouTube 資訊
    * 合規：遵循 GDPR 和個資法規範
6. 成功指標 (Success Metrics)
技術指標
* 系統正常運行時間 ≥ 99.5%
* API 請求成功率 ≥ 98%
* 🆕 粒子動畫幀率 ≥ 30 FPS
* 🆕 用戶畫像資料準確率 ≥ 95%
業務指標
* 🆕 觀眾參與確認回饋滿意度 ≥ 4.5/5
* 🆕 直播互動率提升 20%
* 🆕 核心粉絲識別準確率 ≥ 90%
* 抽獎活動完成率 100%

備註：本計畫書版本 1.1 新增了六項核心功能，大幅提升了系統的互動性、安全性和分析能力。所有標示 🆕 的項目為本次更新新增內容。
