<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–™ç†æ€¥å…ˆé‹’ V3 - ç‰©å“èˆ‡é£Ÿè­œç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tier-0 { background-color: #e9ecef; } /* åŸºç¤é£Ÿæ */
        .tier-1 { background-color: #fff3cd; } /* åŠæˆå“ */
        .tier-2 { background-color: #d4edda; } /* æœ€çµ‚æ–™ç† */
        
        .item-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }

        .ascii-preview {
            font-family: monospace;
            font-size: 1.2em;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        #recipeValidator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }

        /* æ·»åŠ å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .export-btn {
            margin-bottom: 20px;
        }

        .recipe-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 5px;
            border-radius: 5px;
            height: 100%;
        }

        .recipe-card .requirements-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 10px;
        }

        .recipe-card .requirements-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .recipe-card .badge {
            margin-left: 5px;
        }

        .recipe-card .cooking-method {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            margin: 5px 0;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">æ–™ç†æ€¥å…ˆé‹’ V3 ç®¡ç†ç³»çµ±</a>
            <div class="navbar-nav">
                <a class="nav-link active" href="#" id="itemsTab">ç‰©å“ç®¡ç†</a>
                <a class="nav-link" href="#" id="recipesTab">é£Ÿè­œç®¡ç†</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- æ·»åŠ å¯¼å‡ºæŒ‰é’®å’Œæ–°å¢ç‰©å“æŒ‰é’® -->
        <div class="row mb-3">
            <div class="col d-flex justify-content-between">
                <button id="exportSqlBtn" class="btn btn-secondary export-btn">
                    åŒ¯å‡º T0/T1 SQL
                </button>
                <button id="addItemBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                    <i class="fas fa-plus"></i> æ–°å¢ç‰©å“
                </button>
            </div>
        </div>
        
        <!-- ç‰©å“ç®¡ç†å€ -->
        <div id="itemsSection">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            ç‰©å“åˆ—è¡¨
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refreshItems">
                                    åˆ·æ–°åˆ—è¡¨
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="itemsList" class="row">
                                <!-- ç‰©å“åˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ç‰©å“ Modal -->
        <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addItemModalLabel">æ–°å¢ç‰©å“</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="itemForm">
                            <div class="mb-3">
                                <label class="form-label">ç‰©å“ID</label>
                                <input type="text" class="form-control" id="itemId" required 
                                       placeholder="ä¾‹å¦‚: raw_beef">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç‰©å“åç¨±</label>
                                <input type="text" class="form-control" id="itemName" required
                                       placeholder="ä¾‹å¦‚: ç”Ÿç‰›è‚‰">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ASCIIç¬¦è™Ÿ</label>
                                <input type="text" class="form-control" id="asciiSymbol" required
                                       placeholder="ä¾‹å¦‚: [ç‰›]" maxlength="10">
                                <div class="ascii-preview mt-2" id="asciiPreview"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç‰©å“å±¤ç´š</label>
                                <select class="form-select" id="itemTier" required>
                                    <option value="0">T0 - åŸºç¤é£Ÿæ</option>
                                    <option value="1">T1 - åŠæˆå“</option>
                                    <option value="2">T2 - æœ€çµ‚æ–™ç†</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">åŸºç¤åˆ†æ•¸</label>
                                <input type="number" class="form-control" id="basePoints" 
                                       placeholder="åƒ… T2 æœ€çµ‚æ–™ç†éœ€è¦å¡«å¯«">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" id="saveItemBtn">å„²å­˜ç‰©å“</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é£Ÿè­œç®¡ç†å€ -->
        <div id="recipesSection" style="display: none;">
            <div class="row">
                <div class="col-md-12">
                    <div class="d-flex justify-content-end mb-3">
                        <button id="addRecipeBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecipeModal">
                            <i class="fas fa-plus"></i> æ–°å¢é£Ÿè­œ
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            é£Ÿè­œåˆ—è¡¨
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refreshRecipes">
                                    åˆ·æ–°åˆ—è¡¨
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="recipesList">
                                <!-- é£Ÿè­œåˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢é£Ÿè­œ Modal -->
        <div class="modal fade" id="addRecipeModal" tabindex="-1" aria-labelledby="addRecipeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addRecipeModalLabel">æ–°å¢é£Ÿè­œ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="recipeForm">
                            <div class="mb-3">
                                <label class="form-label">é£Ÿè­œID</label>
                                <input type="text" class="form-control" id="recipeId" required
                                       placeholder="ä¾‹å¦‚: cook_beef_patty">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">é£Ÿè­œåç¨±</label>
                                <input type="text" class="form-control" id="recipeName" required
                                       placeholder="ä¾‹å¦‚: ç…ç‰›è‚‰é¤…">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç”¢å‡ºç‰©å“</label>
                                <select class="form-select" id="outputItemId" required>
                                    <!-- ç”± JavaScript å‹•æ…‹å¡«å…… -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çƒ¹é£ªæ–¹æ³•</label>
                                <select class="form-select" id="cookingMethod" required>
                                    <option value="grill">çƒ¤è£½</option>
                                    <option value="pan_fry">ç…ç‚’</option>
                                    <option value="deep_fry">æ²¹ç‚¸</option>
                                    <option value="boil">æ°´ç…®</option>
                                    <option value="assembly">çµ„åˆ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">éœ€æ±‚é£Ÿæ</label>
                                <div id="requirementsList">
                                    <!-- éœ€æ±‚åˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹ç®¡ç† -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" 
                                        id="addRequirement">
                                    æ–°å¢éœ€æ±‚
                                </button>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çƒ¹é£ªæ™‚é–“ (ç§’)</label>
                                <input type="number" class="form-control" id="cookTime" 
                                       value="30" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" id="saveRecipeBtn">å„²å­˜é£Ÿè­œ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é£Ÿè­œé©—è­‰å™¨ -->
        <div id="recipeValidator">
            <h6>é£Ÿè­œé©—è­‰</h6>
            <div id="validationResult"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€è®Šæ•¸
        let currentItems = [];
        let currentRecipes = [];
        
        // ç²å–ç”¨æˆ¶ä»¤ç‰Œ
        function getUserToken() {
            const userId = localStorage.getItem('boxCurrentUserId');
            if (!userId) return null;
            const tokenKey = `boxUserToken_${userId}`;
            return localStorage.getItem(tokenKey);
        }

        // API è«‹æ±‚å·¥å…·å‡½æ•¸
        async function apiFetch(endpoint, options = {}) {
            const token = getUserToken();
            if (!token) {
                alert('æ¬Šé™ä¸è¶³æˆ–ç™»å…¥å·²è¶…æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
                window.location.href = '/cook-login.html?redirect=/cook-admin-recipes-v3.html';
                throw new Error('ä»¤ç‰Œæœªæ‰¾åˆ°ï¼Œç„¡æ³•ç™¼é€è«‹æ±‚');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            const mergedOptions = { ...defaultOptions, ...options };
            if (mergedOptions.body) {
                mergedOptions.body = JSON.stringify(mergedOptions.body);
            }

            try {
                const response = await fetch(`/cook-api${endpoint}`, mergedOptions);
                if (!response.ok) {
                    if(response.status === 401 || response.status === 403) {
                        alert('æ¬Šé™ä¸è¶³æˆ–ç™»å…¥å·²è¶…æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
                        window.location.href = '/cook-login.html?redirect=/cook-admin-recipes-v3.html';
                        throw new Error('èªè­‰å¤±æ•—');
                    }
                    const errorData = await response.json().catch(() => ({ message: 'ç„¡æ³•è§£æä¾†è‡ªä¼ºæœå™¨çš„éŒ¯èª¤è¨Šæ¯' }));
                    throw new Error(errorData.error || errorData.message || `HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Fetch Error:', error);
                throw error;
            }
        }

        // é é¢åˆ‡æ›
        document.getElementById('itemsTab').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('itemsSection').style.display = 'block';
            document.getElementById('recipesSection').style.display = 'none';
            this.classList.add('active');
            document.getElementById('recipesTab').classList.remove('active');
        });

        document.getElementById('recipesTab').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('itemsSection').style.display = 'none';
            document.getElementById('recipesSection').style.display = 'block';
            this.classList.add('active');
            document.getElementById('itemsTab').classList.remove('active');
        });

        // ASCII é è¦½
        document.getElementById('asciiSymbol').addEventListener('input', function(e) {
            document.getElementById('asciiPreview').textContent = e.target.value;
        });

        // è¼‰å…¥ç‰©å“åˆ—è¡¨
        async function loadItems() {
            try {
                const items = await apiFetch('/v3/items');
                currentItems = items;
                renderItems();
                updateItemSelects();
            } catch (error) {
                console.error('è¼‰å…¥ç‰©å“å¤±æ•—:', error);
                alert(`è¼‰å…¥ç‰©å“å¤±æ•—: ${error.message}`);
            }
        }

        // è¼‰å…¥é£Ÿè­œåˆ—è¡¨
        async function loadRecipes() {
            try {
                console.log('Fetching recipes...');
                const recipes = await apiFetch('/v3/recipes');
                console.log('Received recipes:', recipes);
                currentRecipes = recipes;
                console.log('Current recipes set to:', currentRecipes);
                renderRecipes();
            } catch (error) {
                console.error('è¼‰å…¥é£Ÿè­œå¤±æ•—:', error);
                alert(`è¼‰å…¥é£Ÿè­œå¤±æ•—: ${error.message}`);
            }
        }

        // ç‰©å“è¡¨å–®æäº¤
        document.getElementById('saveItemBtn').addEventListener('click', async function() {
            const form = document.getElementById('itemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = {
                item_id: document.getElementById('itemId').value,
                item_name: document.getElementById('itemName').value,
                ascii_symbol: document.getElementById('asciiSymbol').value,
                item_tier: parseInt(document.getElementById('itemTier').value),
                base_points: parseInt(document.getElementById('basePoints').value) || 0
            };

            try {
                await apiFetch('/v3/items', {
                    method: 'PUT', // æ”¹ç”¨ PUT æ–¹æ³•é€²è¡Œæ›´æ–°
                    body: formData
                });
                alert('ç‰©å“æ›´æ–°æˆåŠŸï¼');
                loadItems();
                form.reset();
                // é—œé–‰ Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                modal.hide();
            } catch (error) {
                alert(`éŒ¯èª¤ï¼š${error.message}`);
            }
        });

        // ç•¶ç‰©å“ Modal é–‹å•Ÿæ™‚
        document.getElementById('addItemModal').addEventListener('show.bs.modal', function (event) {
            // å¦‚æœæ˜¯é€šéæ–°å¢æŒ‰éˆ•æ‰“é–‹çš„ï¼Œé‡ç½®è¡¨å–®ä¸¦å•Ÿç”¨æ‰€æœ‰æ¬„ä½
            if (event.relatedTarget && event.relatedTarget.id === 'addItemBtn') {
                document.getElementById('itemId').disabled = false;
                document.getElementById('itemTier').disabled = false;
                document.getElementById('itemForm').reset();
                document.getElementById('asciiPreview').textContent = '';
            }
        });

        // é£Ÿè­œè¡¨å–®æäº¤
        document.getElementById('saveRecipeBtn').addEventListener('click', async function() {
            const form = document.getElementById('recipeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const requirements = Array.from(document.querySelectorAll('.requirement-row')).map(row => ({
                item_id: row.querySelector('.req-item').value,
                quantity: parseInt(row.querySelector('.req-quantity').value)
            }));

            const formData = {
                recipe_id: document.getElementById('recipeId').value,
                recipe_name: document.getElementById('recipeName').value,
                output_item_id: document.getElementById('outputItemId').value,
                cooking_method: document.getElementById('cookingMethod').value,
                requirements: requirements,
                cook_time_sec: parseInt(document.getElementById('cookTime').value)
            };

            try {
                await apiFetch('/v3/recipes', {
                    method: 'POST',
                    body: formData
                });
                alert('é£Ÿè­œå„²å­˜æˆåŠŸï¼');
                loadRecipes();
                form.reset();
                // æ¸…ç©ºéœ€æ±‚åˆ—è¡¨
                document.getElementById('requirementsList').innerHTML = '';
                // é—œé–‰ Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addRecipeModal'));
                modal.hide();
            } catch (error) {
                alert(`éŒ¯èª¤ï¼š${error.message}`);
            }
        });

        // ç•¶é£Ÿè­œ Modal é—œé–‰æ™‚é‡ç½®è¡¨å–®
        document.getElementById('addRecipeModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('recipeForm').reset();
            document.getElementById('requirementsList').innerHTML = '';
        });

        // ç•¶é¸æ“‡ç”¢å‡ºç‰©å“æ™‚ï¼Œæ ¹æ“šå…¶å±¤ç´šéæ¿¾å¯é¸æ“‡çš„éœ€æ±‚ç‰©å“
        document.getElementById('outputItemId').addEventListener('change', function() {
            const selectedItem = currentItems.find(item => item.item_id === this.value);
            if (!selectedItem) return;

            // æ¸…ç©ºç¾æœ‰éœ€æ±‚åˆ—è¡¨
            document.getElementById('requirementsList').innerHTML = '';

            // å¦‚æœæ˜¯ T2 ç‰©å“ï¼Œè‡ªå‹•è¨­ç½®çƒ¹é£ªæ–¹æ³•ç‚º assembly
            if (selectedItem.item_tier === 2) {
                document.getElementById('cookingMethod').value = 'assembly';
                document.getElementById('cookingMethod').disabled = true;
            } else {
                document.getElementById('cookingMethod').disabled = false;
            }
        });

        // æ–°å¢éœ€æ±‚è¡Œ
        document.getElementById('addRequirement').addEventListener('click', function() {
            const requirementsList = document.getElementById('requirementsList');
            const row = document.createElement('div');
            row.className = 'requirement-row input-group mb-2';
            row.innerHTML = `
                <select class="form-select req-item">
                    ${currentItems.map(item => `
                        <option value="${item.item_id}">${item.item_name}</option>
                    `).join('')}
                </select>
                <input type="number" class="form-control req-quantity" value="1" min="1">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                    Ã—
                </button>
            `;
            requirementsList.appendChild(row);
        });

        // æ¸²æŸ“ç‰©å“åˆ—è¡¨
        function renderItems() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = currentItems.map(item => `
                <div class="col-md-4 mb-3">
                    <div class="item-card tier-${item.item_tier}">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editItem('${item.item_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="checkAndDeleteItem('${item.item_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <h5>${item.item_name}</h5>
                        <div class="ascii-preview">${item.ascii_symbol}</div>
                        <div class="text-muted">ID: ${item.item_id}</div>
                        <div>å±¤ç´š: T${item.item_tier}</div>
                        ${item.item_tier === 2 ? `<div>åŸºç¤åˆ†æ•¸: ${item.base_points}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°ç‰©å“é¸æ“‡ä¸‹æ‹‰é¸å–®
        function updateItemSelects() {
            const outputSelect = document.getElementById('outputItemId');
            if (outputSelect) {
                outputSelect.innerHTML = currentItems.map(item => `
                    <option value="${item.item_id}">${item.item_name} (T${item.item_tier})</option>
                `).join('');
            }
        }

        // æ¸²æŸ“é£Ÿè­œåˆ—è¡¨
        function renderRecipes() {
            console.log('Starting renderRecipes with currentRecipes:', currentRecipes);
            console.log('Current items:', currentItems);
            const recipesList = document.getElementById('recipesList');

            // å°†é£Ÿè°±æŒ‰ T1 å’Œ T2 åˆ†ç»„
            const t1Recipes = currentRecipes.filter(recipe => {
                const outputItem = currentItems.find(item => item.id === recipe.output_item_id);
                return outputItem && outputItem.item_tier === 1;
            });

            const t2Recipes = currentRecipes.filter(recipe => {
                const outputItem = currentItems.find(item => item.id === recipe.output_item_id);
                return outputItem && outputItem.item_tier === 2;
            });

            // å†…éƒ¨æ¸²æŸ“å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå•ä¸ªé£Ÿè°±å¡ç‰‡
            const renderRecipeCard = (recipe) => {
                const outputItem = currentItems.find(item => item.id === recipe.output_item_id);
                
                const cookingMethodMap = {
                    'grill': 'çƒ¤è£½',
                    'pan_fry': 'ç…ç‚’',
                    'deep_fry': 'æ²¹ç‚¸',
                    'boil': 'æ°´ç…®',
                    'assembly': 'çµ„åˆ'
                };
                const cookingMethodDisplay = cookingMethodMap[recipe.cooking_method] || recipe.cooking_method;
                
                const tierClass = outputItem && outputItem.item_tier === 2 ? 'tier-2' : 
                                 (outputItem && outputItem.item_tier === 1 ? 'tier-1' : '');
                
                const tierLabel = outputItem && outputItem.item_tier === 2 ? '<span class="badge bg-success">T2</span>' : 
                                 (outputItem && outputItem.item_tier === 1 ? '<span class="badge bg-warning">T1</span>' : '');
                
                const requirementsHtml = recipe.requirements.map(req => {
                    const reqItem = currentItems.find(item => item.item_id === req.item_id);
                    const reqTierLabel = reqItem && reqItem.item_tier === 1 ? 
                                       '<span class="badge bg-warning">T1</span>' : 
                                       (reqItem && reqItem.item_tier === 0 ? 
                                       '<span class="badge bg-secondary">T0</span>' : '');
                    return `<li>${reqItem ? reqItem.item_name : req.item_id} Ã— ${req.quantity} ${reqTierLabel}</li>`;
                }).join('');

                return `
                    <div class="col-md-4 mb-3">
                        <div class="recipe-card ${tierClass}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="mb-0">${recipe.recipe_name} ${tierLabel}</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editRecipe('${recipe.recipe_id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="checkAndDeleteRecipe('${recipe.recipe_id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-muted small">ID: ${recipe.recipe_id}</div>
                            <div class="mt-2">
                                <strong>ç”¢å‡º:</strong> ${outputItem ? outputItem.item_name : recipe.output_item_id}
                            </div>
                            <div class="cooking-method mt-2">
                                <i class="fas fa-utensils me-1"></i>${cookingMethodDisplay}
                            </div>
                            <div class="mt-2">
                                <strong>éœ€æ±‚:</strong>
                                <ul class="requirements-list">
                                    ${requirementsHtml}
                                </ul>
                            </div>
                            <div class="text-muted small">
                                <i class="fas fa-clock me-1"></i>${recipe.cook_time_sec}ç§’
                            </div>
                        </div>
                    </div>
                `;
            };

            let finalHtml = `
                <div class="mb-4">
                    <h4>T1 é£Ÿè­œ (åŠæˆå“)</h4>
                    <hr>
                    <div class="row">
                        ${t1Recipes.length > 0 ? t1Recipes.map(renderRecipeCard).join('') : 
                          '<div class="col"><p class="text-muted">ç›®å‰æ²’æœ‰ T1 é£Ÿè­œã€‚</p></div>'}
                    </div>
                </div>
                <div>
                    <h4>T2 é£Ÿè­œ (æœ€çµ‚æ–™ç†)</h4>
                    <hr>
                    <div class="row">
                        ${t2Recipes.length > 0 ? t2Recipes.map(renderRecipeCard).join('') : 
                          '<div class="col"><p class="text-muted">ç›®å‰æ²’æœ‰ T2 é£Ÿè­œã€‚</p></div>'}
                    </div>
                </div>
            `;

            recipesList.innerHTML = finalHtml;
        }

        // ç·¨è¼¯ç‰©å“
        async function editItem(itemId) {
            const item = currentItems.find(i => i.item_id === itemId);
            if (!item) return;

            // æª¢æŸ¥æ­¤ç‰©å“æ˜¯å¦è¢«é£Ÿè­œä½¿ç”¨
            const recipesUsingItem = currentRecipes.filter(recipe => {
                return recipe.output_item_id === item.id || 
                       recipe.requirements.some(req => req.item_id === item.item_id);
            });

            // å¡«å……è¡¨å–®
            document.getElementById('itemId').value = item.item_id;
            document.getElementById('itemId').disabled = true; // ç¦æ­¢ä¿®æ”¹ item_id
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('asciiSymbol').value = item.ascii_symbol;
            document.getElementById('itemTier').value = item.item_tier;
            document.getElementById('itemTier').disabled = true; // ç¦æ­¢ä¿®æ”¹å±¤ç´š
            document.getElementById('basePoints').value = item.base_points || 0;
            document.getElementById('asciiPreview').textContent = item.ascii_symbol;

            // æ ¹æ“šç‰©å“å±¤ç´šé¡¯ç¤ºä¸åŒçš„è­¦å‘Š
            if (item.item_tier === 0) {
                const t1Recipes = recipesUsingItem.filter(r => {
                    const outItem = currentItems.find(i => i.id === r.output_item_id);
                    return outItem && outItem.item_tier === 1;
                });
                const t2Recipes = recipesUsingItem.filter(r => {
                    const outItem = currentItems.find(i => i.id === r.output_item_id);
                    return outItem && outItem.item_tier === 2;
                });
                
                if (t1Recipes.length > 0 || t2Recipes.length > 0) {
                    let warning = 'æ³¨æ„ï¼šä¿®æ”¹æ­¤åŸºç¤é£Ÿææœƒå½±éŸ¿ä»¥ä¸‹é£Ÿè­œï¼š\n\n';
                    if (t1Recipes.length > 0) {
                        warning += 'åŠæˆå“é£Ÿè­œï¼š\n- ' + t1Recipes.map(r => r.recipe_name).join('\n- ') + '\n\n';
                    }
                    if (t2Recipes.length > 0) {
                        warning += 'æœ€çµ‚æ–™ç†é£Ÿè­œï¼š\n- ' + t2Recipes.map(r => r.recipe_name).join('\n- ');
                    }
                    alert(warning + '\n\nè«‹è¬¹æ…ä¿®æ”¹ï¼');
                }
            } else if (item.item_tier === 1) {
                const t2Recipes = recipesUsingItem.filter(r => {
                    const outItem = currentItems.find(i => i.id === r.output_item_id);
                    return outItem && outItem.item_tier === 2;
                });
                
                if (t2Recipes.length > 0) {
                    alert('æ³¨æ„ï¼šä¿®æ”¹æ­¤åŠæˆå“æœƒå½±éŸ¿ä»¥ä¸‹æœ€çµ‚æ–™ç†ï¼š\n\n- ' + 
                          t2Recipes.map(r => r.recipe_name).join('\n- ') + 
                          '\n\nè«‹è¬¹æ…ä¿®æ”¹ï¼');
                }
            }

            // æ‰“é–‹ Modal
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        // ç·¨è¼¯é£Ÿè­œ
        async function editRecipe(recipeId) {
            const recipe = currentRecipes.find(r => r.recipe_id === recipeId);
            if (!recipe) return;

            // å¡«å……è¡¨å–®
            document.getElementById('recipeId').value = recipe.recipe_id;
            document.getElementById('recipeName').value = recipe.recipe_name;
            document.getElementById('outputItemId').value = recipe.output_item_id;
            document.getElementById('cookingMethod').value = recipe.cooking_method;
            document.getElementById('cookTime').value = recipe.cook_time_sec;

            // æ¸…ç©ºä¸¦é‡å»ºéœ€æ±‚åˆ—è¡¨
            const requirementsList = document.getElementById('requirementsList');
            requirementsList.innerHTML = '';
            recipe.requirements.forEach(req => {
                const row = document.createElement('div');
                row.className = 'requirement-row input-group mb-2';
                row.innerHTML = `
                    <select class="form-select req-item">
                        ${currentItems.map(item => `
                            <option value="${item.item_id}" ${req.item_id === item.item_id ? 'selected' : ''}>
                                ${item.item_name}
                            </option>
                        `).join('')}
                    </select>
                    <input type="number" class="form-control req-quantity" value="${req.quantity}" min="1">
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                        Ã—
                    </button>
                `;
                requirementsList.appendChild(row);
            });

            // æ‰“é–‹ Modal
            const modal = new bootstrap.Modal(document.getElementById('addRecipeModal'));
            modal.show();
        }

        // æª¢æŸ¥ä¸¦åˆªé™¤ç‰©å“
        async function checkAndDeleteItem(itemId) {
            const item = currentItems.find(i => i.item_id === itemId);
            if (!item) return;

            // æª¢æŸ¥æ­¤ç‰©å“æ˜¯å¦è¢«é£Ÿè­œä½¿ç”¨
            const recipesUsingItem = currentRecipes.filter(recipe => {
                return recipe.output_item_id === item.id || 
                       recipe.requirements.some(req => req.item_id === item.item_id);
            });

            if (recipesUsingItem.length > 0) {
                const recipeNames = recipesUsingItem.map(r => r.recipe_name).join('\n- ');
                alert(`ç„¡æ³•åˆªé™¤æ­¤ç‰©å“ï¼\n\næ­¤ç‰©å“æ­£åœ¨è¢«ä»¥ä¸‹é£Ÿè­œä½¿ç”¨ï¼š\n- ${recipeNames}\n\nè«‹å…ˆåˆªé™¤é€™äº›é£Ÿè­œã€‚`);
                return;
            }

            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç‰©å“ã€Œ${item.item_name}ã€å—ï¼Ÿ`)) {
                try {
                    await apiFetch(`/v3/items/${item.item_id}`, {
                        method: 'DELETE'
                    });
                    alert('ç‰©å“åˆªé™¤æˆåŠŸï¼');
                    loadItems();
                } catch (error) {
                    alert(`åˆªé™¤å¤±æ•—ï¼š${error.message}`);
                }
            }
        }

        // æª¢æŸ¥ä¸¦åˆªé™¤é£Ÿè­œ
        async function checkAndDeleteRecipe(recipeId) {
            const recipe = currentRecipes.find(r => r.recipe_id === recipeId);
            if (!recipe) return;

            if (confirm(`ç¢ºå®šè¦åˆªé™¤é£Ÿè­œã€Œ${recipe.recipe_name}ã€å—ï¼Ÿ`)) {
                try {
                    await apiFetch(`/v3/recipes/${recipe.recipe_id}`, {
                        method: 'DELETE'
                    });
                    alert('é£Ÿè­œåˆªé™¤æˆåŠŸï¼');
                    loadRecipes();
                } catch (error) {
                    alert(`åˆªé™¤å¤±æ•—ï¼š${error.message}`);
                }
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadItems();
            loadRecipes();
        });

        // åˆ·æ–°æŒ‰éˆ•äº‹ä»¶
        document.getElementById('refreshItems').addEventListener('click', loadItems);
        document.getElementById('refreshRecipes').addEventListener('click', loadRecipes);

        // æ·»åŠ å¯¼å‡º SQL åŠŸèƒ½
        document.getElementById('exportSqlBtn').addEventListener('click', async function() {
            try {
                // è·å–æ‰€æœ‰ç‰©å“å’Œé£Ÿè°±
                const items = await apiFetch('/v3/items');
                const recipes = await apiFetch('/v3/recipes');
                
                // è¿‡æ»¤å‡º T0ã€T1 å’Œ T2 çš„ç‰©å“
                const t0Items = items.filter(item => item.item_tier === 0);
                const t1Items = items.filter(item => item.item_tier === 1);
                const t2Items = items.filter(item => item.item_tier === 2);
                
                // è¿‡æ»¤å‡ºäº§å‡ºä¸º T1 çš„é£Ÿè°±
                const t1Recipes = recipes.filter(recipe => {
                    const outputItem = items.find(item => item.item_id === recipe.output_item_id);
                    return outputItem && outputItem.item_tier === 1;
                });
                
                // è¿‡æ»¤å‡ºäº§å‡ºä¸º T2 çš„é£Ÿè°±
                const t2Recipes = recipes.filter(recipe => {
                    const outputItem = items.find(item => item.item_id === recipe.output_item_id);
                    return outputItem && outputItem.item_tier === 2;
                });
                
                // ç”Ÿæˆ SQL è¯­å¥
                let sqlStatements = '-- T0 ç‰©å“ï¼ˆåŸºç¡€é£Ÿæï¼‰\n';
                sqlStatements += 'INSERT INTO cook_items_v3 (item_id, item_name, ascii_symbol, item_tier) VALUES\n';
                
                t0Items.forEach((item, index) => {
                    sqlStatements += `('${item.item_id}', '${item.item_name}', '${item.ascii_symbol}', ${item.item_tier})`;
                    if (index < t0Items.length - 1) sqlStatements += ',\n';
                    else sqlStatements += ';\n\n';
                });
                
                sqlStatements += '-- T1 ç‰©å“ï¼ˆåŠæˆå“ï¼‰\n';
                sqlStatements += 'INSERT INTO cook_items_v3 (item_id, item_name, ascii_symbol, item_tier) VALUES\n';
                
                t1Items.forEach((item, index) => {
                    sqlStatements += `('${item.item_id}', '${item.item_name}', '${item.ascii_symbol}', ${item.item_tier})`;
                    if (index < t1Items.length - 1) sqlStatements += ',\n';
                    else sqlStatements += ';\n\n';
                });
                
                sqlStatements += '-- T2 ç‰©å“ï¼ˆæœ€ç»ˆæ–™ç†ï¼‰\n';
                sqlStatements += 'INSERT INTO cook_items_v3 (item_id, item_name, ascii_symbol, item_tier, base_points) VALUES\n';
                
                t2Items.forEach((item, index) => {
                    sqlStatements += `('${item.item_id}', '${item.item_name}', '${item.ascii_symbol}', ${item.item_tier}, ${item.base_points || 0})`;
                    if (index < t2Items.length - 1) sqlStatements += ',\n';
                    else sqlStatements += ';\n\n';
                });
                
                sqlStatements += '-- T1 é£Ÿè­œ\n';
                sqlStatements += 'INSERT INTO cook_recipes_v3 (recipe_id, recipe_name, output_item_id, cooking_method, requirements, cook_time_sec) VALUES\n';
                
                t1Recipes.forEach((recipe, index) => {
                    const requirementsStr = JSON.stringify(recipe.requirements).replace(/'/g, "''");
                    sqlStatements += `('${recipe.recipe_id}', '${recipe.recipe_name}', ` +
                        `(SELECT id FROM cook_items_v3 WHERE item_id = '${recipe.output_item_id}'), ` +
                        `'${recipe.cooking_method}', '${requirementsStr}', ${recipe.cook_time_sec})`;
                    if (index < t1Recipes.length - 1) sqlStatements += ',\n';
                    else sqlStatements += ';\n\n';
                });
                
                sqlStatements += '-- T2 é£Ÿè­œ\n';
                sqlStatements += 'INSERT INTO cook_recipes_v3 (recipe_id, recipe_name, output_item_id, cooking_method, requirements, cook_time_sec) VALUES\n';
                
                t2Recipes.forEach((recipe, index) => {
                    const requirementsStr = JSON.stringify(recipe.requirements).replace(/'/g, "''");
                    sqlStatements += `('${recipe.recipe_id}', '${recipe.recipe_name}', ` +
                        `(SELECT id FROM cook_items_v3 WHERE item_id = '${recipe.output_item_id}'), ` +
                        `'${recipe.cooking_method}', '${requirementsStr}', ${recipe.cook_time_sec})`;
                    if (index < t2Recipes.length - 1) sqlStatements += ',\n';
                    else sqlStatements += ';\n';
                });
                
                // æ·»åŠ ç”Ÿæˆè§„åˆ™å’Œæç¤ºè¯è¯´æ˜
                const rulesAndTips = `
/*
-- V3 ç‰©å“å’Œé£Ÿè­œç”Ÿæˆè¦å‰‡ --

1. ç‰©å“å±‚ç´š (item_tier):
   - T0 (0): åŸºç¡€é£Ÿæï¼Œç„¡æ³•é€šéé£Ÿè­œè£½ä½œï¼Œæ˜¯æ‰€æœ‰åŠ å·¥éˆçš„èµ·é»
   - T1 (1): åŠæˆå“ï¼Œç”± T0 é£Ÿæé€šéé£Ÿè­œåŠ å·¥è€Œæˆ
   - T2 (2): æœ€çµ‚æ–™ç†ï¼Œç”± T1 åŠæˆå“å’Œ/æˆ– T0 é£Ÿæçµ„åˆè€Œæˆ

2. é£Ÿè­œè¦å‰‡:
   - T1 é£Ÿè­œ: åªèƒ½ä½¿ç”¨ T0 é£Ÿæä½œç‚ºåŸæ–™
   - T2 é£Ÿè­œ: å¯ä»¥ä½¿ç”¨ T1 åŠæˆå“å’Œ/æˆ– T0 é£Ÿæä½œç‚ºåŸæ–™
   - T2 é£Ÿè­œå¿…é ˆä½¿ç”¨ 'assembly' (çµ„åˆ) çƒ¹é£ªæ–¹æ³•

3. çƒ¹é£ªæ–¹æ³• (cooking_method):
   - pan_fry: ç…ç‚’é¡çƒ¹é£ªæ–¹æ³•
   - deep_fry: æ²¹ç‚¸é¡çƒ¹é£ªæ–¹æ³•
   - grill: çƒ¤è£½é¡çƒ¹é£ªæ–¹æ³•
   - boil: æ°´ç…®é¡çƒ¹é£ªæ–¹æ³•
   - assembly: çµ„åˆé¡è™•ç†æ–¹æ³•

4. ID å°æ‡‰é—œä¿‚èªªæ˜:
   - items è¡¨ä¸­çš„ id: è‡ªå‹•ç”Ÿæˆçš„ä¸»éµï¼Œç”¨æ–¼è¢«å…¶ä»–è¡¨åƒç…§
   - item_id: äººé¡å¯è®€çš„å”¯ä¸€æ¨™è­˜ç¬¦ï¼Œå¦‚ 'raw_beef'
   - é£Ÿè­œè¡¨ä¸­çš„ output_item_id: åƒç…§ items è¡¨çš„ id (ä¸æ˜¯ item_id)
   - é£Ÿè­œéœ€æ±‚ä¸­çš„ item_id: ä½¿ç”¨äººé¡å¯è®€çš„ item_id (ä¸æ˜¯è³‡æ–™åº« id)

5. éœ€æ±‚æ ¼å¼ (requirements):
   - JSON æ•¸çµ„æ ¼å¼: [{"item_id":"é£ŸæID","quantity":æ•¸é‡}, ...]
   - ä¾‹å¦‚: [{"item_id":"raw_beef","quantity":1},{"item_id":"salt","quantity":1}]
   - æ³¨æ„: JSON å­—ç¬¦ä¸²å¿…é ˆä½¿ç”¨å–®å¼•è™ŸåŒ…è£¹ï¼Œå…§éƒ¨ä½¿ç”¨é›™å¼•è™Ÿ
   - item_id ä½¿ç”¨äººé¡å¯è®€çš„æ¨™è­˜ç¬¦ï¼ˆå¦‚ 'raw_beef'ï¼‰

6. å‘½åè¦å‰‡:
   - item_id: ä½¿ç”¨è‹±æ–‡å°å¯«å’Œä¸‹åŠƒç·šï¼Œä¾‹å¦‚ raw_beef, fried_potatoes
   - recipe_id: é€šå¸¸ä½¿ç”¨å‹•è©é–‹é ­ï¼Œä¾‹å¦‚ make_beef_patty, fry_potatoes
   - ç¢ºä¿ item_id å’Œ recipe_id åœ¨æ•¸æ“šåº«ä¸­å”¯ä¸€ï¼Œé¿å…é‡è¤‡

7. SQL èªæ³•ä½¿ç”¨èªªæ˜:
   - æ’å…¥ç‰©å“æ™‚ï¼Œç¢ºä¿ item_id ä¸é‡è¤‡
   - æ’å…¥é£Ÿè­œæ™‚ï¼Œç¢ºä¿ recipe_id ä¸é‡è¤‡
   - é£Ÿè­œåƒç…§ç‰©å“æ™‚ï¼Œä½¿ç”¨å­æŸ¥è©¢: (SELECT id FROM cook_items_v3 WHERE item_id = 'ç‰©å“ID')
   - é£Ÿè­œéœ€æ±‚ä¸­ä½¿ç”¨äººé¡å¯è®€çš„ item_id: '[{"item_id":"raw_beef","quantity":1}]'
   - å¦‚é‡åˆ°é‡è¤‡éµéŒ¯èª¤ï¼Œå¯ä»¥:
     a) ä½¿ç”¨ä¸åŒçš„ID (ä¾‹å¦‚æ·»åŠ å¾Œç¶´ _v2, _new)
     b) å…ˆåˆªé™¤èˆŠè¨˜éŒ„: DELETE FROM cook_recipes_v3 WHERE recipe_id = 'recipe_id';
     c) æˆ–æ›´æ–°ç¾æœ‰è¨˜éŒ„: UPDATE cook_items_v3 SET ... WHERE item_id = 'item_id';

-- ç¯„ä¾‹ --
1. æ·»åŠ  T0 é£Ÿæ:
   INSERT INTO cook_items_v3 (item_id, item_name, ascii_symbol, item_tier) 
   VALUES ('raw_beef', 'ç”Ÿç‰›è‚‰', 'ğŸ„', 0);

2. æ·»åŠ  T1 åŠæˆå“:
   INSERT INTO cook_items_v3 (item_id, item_name, ascii_symbol, item_tier) 
   VALUES ('grilled_beef', 'çƒ¤ç‰›è‚‰', 'ğŸ¥©', 1);

3. æ·»åŠ  T1 é£Ÿè­œ (æ³¨æ„ output_item_id ä½¿ç”¨å­æŸ¥è©¢):
   INSERT INTO cook_recipes_v3 (recipe_id, recipe_name, output_item_id, cooking_method, requirements, cook_time_sec)
   VALUES ('grill_beef', 'çƒ¤ç‰›è‚‰', 
          (SELECT id FROM cook_items_v3 WHERE item_id = 'grilled_beef'),
          'grill', 
          '[{"item_id":"raw_beef","quantity":1}]', 
          30);

4. æ·»åŠ  T2 æœ€çµ‚æ–™ç†:
   INSERT INTO cook_items_v3 (item_id, item_name, ascii_symbol, item_tier, base_points) 
   VALUES ('beef_burger', 'ç‰›è‚‰æ¼¢å ¡', 'ğŸ”', 2, 120);

5. æ·»åŠ  T2 é£Ÿè­œ (æ³¨æ„éœ€æ±‚ä¸­ä½¿ç”¨ item_id):
   INSERT INTO cook_recipes_v3 (recipe_id, recipe_name, output_item_id, cooking_method, requirements, cook_time_sec)
   VALUES ('make_beef_burger', 'è£½ä½œç‰›è‚‰æ¼¢å ¡', 
          (SELECT id FROM cook_items_v3 WHERE item_id = 'beef_burger'),
          'assembly', 
          '[{"item_id":"grilled_beef","quantity":1},{"item_id":"baked_bread","quantity":1}]', 
          15);

6. å¸¸è¦‹éŒ¯èª¤è™•ç†:
   -- æª¢æŸ¥ç‰©å“æ˜¯å¦å­˜åœ¨
   SELECT * FROM cook_items_v3 WHERE item_id = 'beef_burger';
   
   -- æª¢æŸ¥é£Ÿè­œçš„ output_item_id æ˜¯å¦æ­£ç¢º
   SELECT r.*, i.item_id, i.item_name 
   FROM cook_recipes_v3 r 
   JOIN cook_items_v3 i ON r.output_item_id = i.id 
   WHERE r.recipe_id = 'make_beef_burger';
   
   -- æª¢æŸ¥é£Ÿè­œéœ€æ±‚ä¸­çš„ item_id æ˜¯å¦å­˜åœ¨
   SELECT * FROM cook_items_v3 WHERE item_id IN ('grilled_beef', 'baked_bread');
*/
`;
                
                // å°†è§„åˆ™è¯´æ˜æ·»åŠ åˆ° SQL è¯­å¥å‰é¢
                sqlStatements = rulesAndTips + sqlStatements;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                await navigator.clipboard.writeText(sqlStatements);
                alert('SQL èªå¥å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼åŒ…å« T0ã€T1 å’Œ T2 çš„ç‰©å“å’Œé£Ÿè­œã€‚');
                
                // åœ¨æ§åˆ¶å°ä¹Ÿè¾“å‡ºä¸€ä»½ï¼Œä»¥é˜²å‰ªè´´æ¿è®¿é—®è¢«é˜»æ­¢
                console.log('åŒ¯å‡ºçš„ SQL èªå¥ï¼ˆå«è¦å‰‡èªªæ˜ï¼‰ï¼š');
                console.log(sqlStatements);
                
            } catch (error) {
                console.error('åŒ¯å‡ºå¤±æ•—:', error);
                alert(`åŒ¯å‡ºå¤±æ•—: ${error.message}`);
            }
        });
    </script>
</body>
</html> 