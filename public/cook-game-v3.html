<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>料理急先鋒 V3 - 遊戲</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#333333">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #32a852;
      --secondary-color: #4CAF50;
      --accent-color: #FF9800;
      --text-color: #f0f0f0;
      --bg-color: #222222;
      --border-color: #444444;
      --success-color: #4CAF50;
      --error-color: #F44336;
      --card-bg-color: rgba(0, 0, 0, 0.5);
      --station-bg: #161b22;
      --station-border: #30363d;
      --station-hover: #30363d;
      --inventory-bg: #010409;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background: #1a1a1a;
      color: #fff;
      font-family: 'Courier New', monospace;
      -webkit-user-select: none; /* Safari */
      -ms-user-select: none; /* IE 10+ and Edge */
      user-select: none; /* Standard syntax */
    }
    
    .game-container {
      width: 100%;
      max-width: 480px; /* 手機版面最大寬度 */
      min-height: 100vh;
      margin: 0 auto;
      background: #0d1117; /* 深色背景 */
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      position: relative;
    }
    
    .loading-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loader {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 5px solid var(--border-color);
      border-top-color: var(--accent-color);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      font-size: 1.2em;
      color: var(--accent-color);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .game-ui {
      display: flex;
      flex-direction: column;
      height: 100%;
      flex-grow: 1;
      visibility: visible;
    }
    
    .game-header {
      height: 50px;
      background-color: rgba(0, 0, 0, 0.7);
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      align-items: center;
      padding: 0 15px;
      border-bottom: 1px solid var(--border-color);
      z-index: 10;
      flex-shrink: 0;
    }
    
    .game-score {
      font-size: 1.2em;
      color: var(--secondary-color);
      text-align: center;
      grid-column: 2;
    }
    
    .game-timer {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 90px;
      height: 35px;
      background-color: #32a852;
      border-radius: 8px;
      padding: 4px;
      border: none;
      justify-self: end;
      grid-column: 3;
    }

    .game-timer-inner {
      width: 100%;
      height: 100%;
      background-color: #3e2723;
      color: #a5d6a7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4em;
      font-family: 'DS-Digital', monospace;
      border-radius: 4px;
    }
    
    .game-main {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    
    .orders-container {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .order-card {
      background-color: var(--station-bg);
      border: 1px solid var(--station-border);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .order-name {
      font-size: 1.1em;
      font-weight: bold;
      color: #c9d1d9;
    }

    .order-ingredients {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
    }

    .order-ingredient-item {
      display: flex;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 4px 8px;
      border: 1px solid var(--station-border);
    }

    .order-ingredient-icon {
      font-size: 1.2em;
      margin-right: 4px;
    }
    
    .order-timer-container {
      width: 100%;
    }

    .order-timer-text {
        font-size: 0.9em;
        color: #8b949e;
        margin-bottom: 4px;
        text-align: right;
    }
    
    .order-timer {
      width: 100%;
      height: 6px;
      background-color: var(--station-border);
      border-radius: 3px;
      overflow: hidden;
    }

    .order-timer-fill {
      height: 100%;
      background-color: var(--success-color);
      border-radius: 3px;
      transition: width 0.5s linear;
    }

    .work-area {
        display: grid;
        grid-template-areas:
            "stations"
            "assembly";
        grid-template-rows: auto auto;
        gap: 15px;
        margin-top: auto; /* 將工作區推到 game-main 底部 */
    }

    .stations-container {
      grid-area: stations;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    
    .station {
      background-color: var(--station-bg);
      border: 2px solid var(--station-border);
      border-radius: 8px;
      padding: 10px 5px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .station.highlight {
        border-color: var(--accent-color);
        box-shadow: 0 0 10px var(--accent-color);
    }
    
    .station-icon {
        font-size: 1.8em;
    }

    .station-label {
        margin-top: 5px;
        color: #8b949e;
        font-size: 0.8em;
    }
    
    .progress-bar-container {
        position: absolute;
        bottom: 5px;
        left: 10%;
        width: 80%;
        height: 8px;
        background-color: rgba(0,0,0,0.5);
        border-radius: 4px;
        overflow: hidden;
        display: none; /* 預設隱藏 */
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background-color: var(--accent-color);
        border-radius: 4px;
        transition: width 0.1s linear;
    }

    .assembly-plate {
        grid-area: assembly;
        background-color: var(--station-bg);
        border: 1px solid var(--station-border);
        border-radius: 8px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .plate-slots-container {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
    }
    .plate-slot {
        width: 50px;
        height: 50px;
        background: var(--inventory-bg);
        border: 2px dashed var(--station-border);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8em;
        transition: all 0.2s ease;
    }
    .plate-slot.filled {
        border-style: solid;
        border-color: var(--secondary-color);
    }
    .plate-operator {
        font-size: 20px;
        font-weight: bold;
        color: #8b949e;
    }
    .plate-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0 20px;
        height: 50px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1em;
    }
    .plate-button:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .player-area {
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(13, 17, 23, 0.8);
      backdrop-filter: blur(5px);
      padding: 10px;
      border-top: 1px solid var(--station-border);
      flex-shrink: 0;
    }

    .player-inventory {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
    }

    .inventory-slot {
      aspect-ratio: 1;
      background: var(--inventory-bg);
      border: 2px solid var(--station-border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .inventory-slot.active {
      border-color: var(--accent-color);
      transform: scale(1.1);
      box-shadow: 0 0 10px var(--accent-color);
    }

    .inventory-slot.selected-for-assembly {
        border-color: var(--accent-color);
        box-shadow: 0 0 10px var(--accent-color);
    }

    .item-quantity {
        position: absolute;
        bottom: 2px;
        right: 4px;
        font-size: 0.8em;
        font-weight: bold;
        color: var(--text-color);
        background-color: rgba(0,0,0,0.7);
        padding: 0 4px;
        border-radius: 4px;
    }
    
    .dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .dialog-content {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .dialog-title {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: var(--secondary-color);
    }
    
    .dialog-text {
      margin-bottom: 20px;
    }
    
    .dialog-button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      margin: 0 10px;
    }
    
    .toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 20px;
      z-index: 1001;
      opacity: 0;
      transition: top 0.5s ease, opacity 0.3s ease;
      text-align: center;
    }
    
    .toast.show {
      top: 60px;
      opacity: 1;
    }
    
    .toast.success {
      border-left: 4px solid var(--success-color);
    }
    
    .toast.error {
      border-left: 4px solid var(--error-color);
    }

    /* V3 新增樣式 */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        z-index: 1000;
        display: none; /* 預設隱藏 */
    }

    .selection-menu {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 400px;
        background-color: var(--bg-color);
        border: 2px solid var(--accent-color);
        border-radius: 12px;
        z-index: 1001;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        display: none; /* 預設隱藏 */
    }

    .selection-menu-title {
        font-size: 1.3em;
        color: var(--accent-color);
        text-align: center;
        margin-bottom: 20px;
    }

    .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px;
    }

    .selection-item {
        background-color: var(--station-bg);
        border: 1px solid var(--station-border);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .selection-item:hover {
        background-color: var(--station-hover);
        transform: translateY(-3px);
    }
    .selection-item-icon {
        font-size: 2em;
        margin-bottom: 8px;
    }
    .selection-item-name {
        font-size: 0.9em;
        text-align: center;
    }

    /* 新增：分類過濾按鈕樣式 */
    .category-filter-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .category-filter-btn {
      padding: 5px 10px;
      background-color: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-filter-btn:hover {
      background-color: var(--border-color);
    }

    .category-filter-btn.active {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
    }

    /* 新增：加工方法選擇菜單樣式 */
    .processing-methods-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--card-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      z-index: 1001;
    }

    .processing-methods-container h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--text-color);
    }

    .processing-methods-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }

    .processing-method-item {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .processing-method-item:hover {
      background-color: var(--border-color);
      transform: translateY(-2px);
    }

    .method-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .method-name {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .method-result {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.9em;
      color: var(--text-muted-color);
    }

    .result-icon {
      font-size: 20px;
      margin-bottom: 3px;
    }

    /* 物品雙擊效果 */
    .inventory-slot {
      transition: transform 0.1s ease;
    }

    .inventory-slot:active {
      transform: scale(0.95);
    }

    /* 開發模式指示器 */
    .dev-mode-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
    }

    .game-container {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 20px;
      padding: 20px;
      height: calc(100vh - 40px);
    }

    .inventory-section {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }

    .cooking-section {
      display: grid;
      grid-template-rows: 3fr 1fr;
      gap: 15px;
    }

    .cooking-stations {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 15px;
      padding: 15px;
      background: #e9ecef;
      border-radius: 10px;
    }

    .assembly-plate {
      background: #dee2e6;
      border-radius: 10px;
      padding: 15px;
      min-height: 150px;
    }

    .orders-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      overflow-y: auto;
    }

    .cooking-station {
      background: white;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      border: 2px solid #ced4da;
      min-height: 120px;
    }

    .ingredient-category {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .ingredient {
      display: inline-block;
      background: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 5px 10px;
      margin: 3px;
      cursor: move;
    }

    .order-card {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #dee2e6;
    }

    .timer {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 24px;
      z-index: 1000;
    }

    .draggable-item {
      cursor: move;
      user-select: none;
    }

    .droppable-highlight {
      border: 2px dashed #007bff !important;
    }

    .cooking-progress {
      display: none;
      width: 100%;
      height: 5px;
      background: #e9ecef;
      border-radius: 2px;
      margin-top: 5px;
    }

    .cooking-progress-bar {
      width: 0%;
      height: 100%;
      background: #28a745;
      border-radius: 2px;
      transition: width 0.1s linear;
    }

    .score {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 24px;
      z-index: 1000;
    }

    /* 遊戲計時器 */
    .game-timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 1.2em;
    }

    /* 分數顯示 */
    .score-display {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 1.2em;
    }

    /* 遊戲主容器樣式 */
    .game-container {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 20px;
      padding: 20px;
      height: 100vh;
    }

    /* 物品和食材區域樣式 */
    .items-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
    }

    /* 烹飪區域樣式 */
    .cooking-area {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    /* 訂單區域樣式 */
    .orders-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
    }

    /* 模擬器相關樣式 */
    .sim-item {
      width: 80px;
      height: 80px;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: white;
      cursor: grab;
      position: relative;
      user-select: none;
      margin: 5px;
    }

    .sim-item:active {
      cursor: grabbing;
    }

    .sim-item .ascii-symbol {
      font-size: 24px;
      line-height: 1;
    }

    .sim-item .item-name {
      font-size: 12px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
      padding: 0 4px;
    }

    .crafting-slot {
      position: relative;
      width: 100px;
      height: 100px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      margin: 5px;
      transition: all 0.3s;
    }

    .crafting-slot.drag-over {
      border-color: #3498db;
      background-color: rgba(52, 152, 219, 0.1);
    }

    .cooking-stations {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .cooking-station {
      flex: 1;
      min-width: 200px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }

    .station-title {
      font-size: 1.2em;
      margin-bottom: 10px;
      text-align: center;
    }

    .tier-0 { background-color: #e9ecef; }
    .tier-1 { background-color: #fff3cd; }
    .tier-2 { background-color: #d4edda; }

    .category-filter {
      margin-bottom: 10px;
    }

  </style>
</head>
<body>
  <!-- 遊戲容器 -->
  <div class="game-container" id="gameContainer">
    <!-- 遊戲載入畫面 -->
    <div class="loading-screen" id="loadingScreen">
      <div class="loader"></div>
      <div class="loading-text">遊戲載入中...</div>
    </div>

    <!-- 錯誤訊息容器 -->
    <div id="error-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px;">
      <h2 style="color: #ff5252;">遊戲初始化失敗</h2>
      <p id="error-message" style="margin: 20px 0; font-size: 18px; max-width: 80%;"></p>
      <button onclick="location.reload()" style="padding: 10px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">重新加載</button>
    </div>

    <!-- 遊戲UI -->
    <div class="game-ui" id="gameUI" style="visibility: hidden;">
      <div class="game-header">
        <div id="userStatus" style="display: flex; align-items: center; justify-self: start;">
          <!-- User Status Indicator will be here -->
        </div>
        <div class="game-score" id="gameScore">分數: 0</div>
        <div class="game-timer">
            <div id="gameTimerInner" class="game-timer-inner">03:00</div>
        </div>
      </div>
        
      <div class="game-main">
          <div class="orders-container" id="ordersContainer">
            <!-- 訂單卡片將由JavaScript動態生成 -->
          </div>

          <div class="work-area">
              <div class="stations-container" id="stationsContainer">
                  <!-- V3 工作站將由JS動態生成 -->
              </div>
              <div class="assembly-plate" id="assemblyPlate">
                  <div class="plate-slots-container" id="assemblySlots">
                      <!-- 組合槽將由JS動態生成 -->
                  </div>
                  <button id="assembleBtn" class="plate-button">組合</button>
              </div>
          </div>
      </div>
        
      <div class="player-area">
          <div class="player-inventory" id="playerInventory">
            <!-- 8個庫存槽將由JavaScript動態生成 -->
          </div>
      </div>
      </div>
      
      <!-- 遊戲結束對話框 -->
      <div class="dialog" id="gameOverDialog" style="display: none;">
        <div class="dialog-content">
          <div class="dialog-title">遊戲結束</div>
          <div class="final-score-container" style="text-align: center; margin-bottom: 20px;">
              <div class="final-score-label" style="font-size: 1.2em; color: #ccc;">最終分數</div>
              <div class="final-score" id="finalScore" style="font-size: 3em; font-weight: bold; color: var(--accent-color);">0</div>
          </div>
          <button class="dialog-button" id="returnToLobbyBtn">返回大廳</button>
        </div>
      </div>
      
      <!-- 提示通知 -->
      <div class="toast" id="toast"></div>
    </div>

    <!-- V3 新增: 彈出選擇菜單 -->
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="selection-menu" id="ingredientMenu">
        <div class="selection-menu-title">選擇基礎食材</div>
        <div class="selection-grid" id="ingredientGrid">
            <!-- 食材將由 JS 動態生成 -->
        </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 驗證邏輯 (保留)
      const checkAuthentication = () => {
          const cookGameToken = localStorage.getItem('cookGameToken');
          if (!cookGameToken) {
              const currentUrl = window.location.href;
              window.location.href = `/member-login.html?redirect=${encodeURIComponent(currentUrl)}`;
              return null;
          }
          return cookGameToken;
      };

      const token = checkAuthentication();
      if (!token) {
          return;
      }
      
      // DOM 元素
      const loadingScreen = document.getElementById('loadingScreen');
      const gameUI = document.getElementById('gameUI');
      const gameTimerInner = document.getElementById('gameTimerInner');
      const gameScore = document.getElementById('gameScore');
      const ordersContainer = document.getElementById('ordersContainer');
      const stationsContainer = document.getElementById('stationsContainer');
      const playerInventory = document.getElementById('playerInventory');
      const assemblySlotsContainer = document.getElementById('assemblySlots');
      const assembleBtn = document.getElementById('assembleBtn');
      const gameOverDialog = document.getElementById('gameOverDialog');
      const finalScore = document.getElementById('finalScore');
      const returnToLobbyBtn = document.getElementById('returnToLobbyBtn');
      const toast = document.getElementById('toast');
      const modalBackdrop = document.getElementById('modalBackdrop');
      const ingredientMenu = document.getElementById('ingredientMenu');
      const ingredientGrid = document.getElementById('ingredientGrid');

      // V3 遊戲狀態
      let gameState = {
        inventory: Array(8).fill(null),
        assembly: [],
        assemblySelection: [],
        activeSlot: 0,
        score: 0,
        time: 180, // 3分鐘
        orders: [],
        isProcessing: false, // 防止重複操作
        selectedInventoryIndex: -1, // 用於組合台
      };

      // V3 遊戲資料 (後端獲取)
      let items_v3 = [];
      let recipes_v3 = [];

      // V3 遊戲狀態
      let lastClickedSlot = -1;
      let lastClickTime = 0;

      // ===================================
      // Helper Functions
      // ===================================
      function showToast(message, type = 'info') {
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
      }

      function getItemName(itemId) {
        const item = items_v3.find(i => i.item_id === itemId);
        return item ? item.item_name : '未知物品';
      }

      function openIngredientMenu() {
        ingredientGrid.innerHTML = '';
        const baseIngredients = items_v3.filter(item => item.item_tier === 0);
        
        baseIngredients.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'selection-item';
            itemDiv.innerHTML = `
                <div class="selection-item-icon">${item.ascii_symbol}</div>
                <div class="selection-item-name">${item.item_name}</div>
            `;
            itemDiv.onclick = () => selectIngredient(item.item_id);
            ingredientGrid.appendChild(itemDiv);
        });

        modalBackdrop.style.display = 'block';
        ingredientMenu.style.display = 'block';
        modalBackdrop.onclick = closeIngredientMenu;
      }

      function closeIngredientMenu() {
          modalBackdrop.style.display = 'none';
          ingredientMenu.style.display = 'none';
      }

      function selectIngredient(itemId) {
          if (gameState.inventory[gameState.activeSlot] === null) {
              gameState.inventory[gameState.activeSlot] = { item_id: itemId };
              updateInventory();
              closeIngredientMenu();
              const itemName = getItemName(itemId);
              showToast(`拿取了 ${itemName}`, 'success');
          } else {
              showToast('這個位置已經有東西了!', 'error');
          }
      }

      function processActiveItem() {
          const activeItem = gameState.inventory[gameState.activeSlot];
          if (!activeItem) return;

          const recipe = recipes_v3.find(r => 
              r.requirements.length === 1 && 
              r.requirements[0].item_id_str === activeItem.item_id &&
              items_v3.find(i => i.item_id === r.output_item_id_str)?.item_tier === 1
          );

          if (!recipe) {
              showToast('這個物品無法在這裡加工。');
              return;
          }

          const stationElement = document.querySelector(`[data-station-id="processing_station"]`);
          const progressBarContainer = stationElement.querySelector('.progress-bar-container');
          const progressBar = stationElement.querySelector('.progress-bar');

          gameState.isProcessing = true;
          progressBarContainer.style.display = 'block';
          
          let progress = 0;
          const processTime = (recipe.cook_time_sec || 2) * 1000;
          const interval = setInterval(() => {
              progress += 10;
              progressBar.style.width = `${(progress / processTime) * 100}%`;
              if (progress >= processTime) {
                  clearInterval(interval);
                  progressBarContainer.style.display = 'none';
                  progressBar.style.width = '0%';
                  gameState.isProcessing = false;
                  
                  gameState.inventory[gameState.activeSlot] = { item_id: recipe.output_item_id_str };
                  updateInventory();
                  const newItemName = getItemName(recipe.output_item_id_str);
                  showToast(`完成了 ${newItemName}!`, 'success');
              }
          }, 10);
      }

      function serveOrder(itemId) {
        const orderIndex = gameState.orders.findIndex(o => o.dish_id === itemId);
        if (orderIndex === -1) {
            showToast('這不是客人點的菜！');
            return;
        }

        const servedOrder = gameState.orders[orderIndex];
        const dish = items_v3.find(i => i.item_id === servedOrder.dish_id);
        
        gameState.score += dish.base_points;
        updateScore();
        showToast(`成功出餐 ${dish.item_name}！`, 'success');

        gameState.inventory[gameState.activeSlot] = null;
        updateInventory();

        gameState.orders.splice(orderIndex, 1);
        updateOrders();
      }

      // ===================================
      // 事件處理函數
      // ===================================
      function onInventorySlotClick(index) {
        const currentTime = Date.now();
        
        // 檢查是否為雙擊同一個物品欄位
        if (index === lastClickedSlot && currentTime - lastClickTime < 300) {
            // 雙擊移除物品
            if (gameState.inventory[index]) {
                const itemName = getItemName(gameState.inventory[index].item_id);
                gameState.inventory[index] = null;
                showToast(`移除了 ${itemName}`, 'success');
                updateInventory();
            }
            // 重置雙擊檢測
            lastClickedSlot = -1;
            lastClickTime = 0;
            return;
        }
        
        // 記錄本次點擊
        lastClickedSlot = index;
        lastClickTime = currentTime;
        
        // 切換 activeSlot
        gameState.activeSlot = index;

        // 切換組合選擇
        const selectionIndex = gameState.assemblySelection.indexOf(index);
        if (selectionIndex > -1) {
            // 如果已選中，則取消選擇
            gameState.assemblySelection.splice(selectionIndex, 1);
        } else {
            // 如果未選中，且物品不為空，則加入選擇
            if (gameState.inventory[index]) {
                gameState.assemblySelection.push(index);
            }
        }
        
        updateInventory();
      }

      function onStationClick(stationId) {
          if (gameState.isProcessing) return;
          console.log(`[偵錯日誌] 點擊了工作站: ${stationId}`);

          const activeItem = gameState.inventory[gameState.activeSlot];

          switch (stationId) {
              case 'ingredient_station':
                  if (!activeItem) {
                      openIngredientMenu();
                  } else {
                      showToast('手上已經有東西了，請先放下或處理掉。');
                  }
                  break;
              
              case 'processing_station':
                  if (activeItem) {
                      processActiveItem();
                  } else {
                      showToast('請先從庫存選擇一個物品來加工。');
                  }
                  break;

              case 'final_assembly':
                  if (activeItem) {
                      serveOrder(activeItem.item_id);
                  } else {
                      showToast('請選擇一個完成的料理來出餐。');
                  }
                  break;

              case 'trash_can':
                  if (activeItem) {
                      const itemName = getItemName(activeItem.item_id);
                      gameState.inventory[gameState.activeSlot] = null;
                      updateInventory();
                      showToast(`丟掉了 ${itemName}`, 'success');
                  }
                  break;
          }
      }

      function onAssembleClick() {
        if (gameState.isProcessing) return;
        if (gameState.assemblySelection.length === 0) {
            showToast('請先選擇要組合的物品！');
            return;
        }

        const selectedItemIds = gameState.assemblySelection.map(i => gameState.inventory[i].item_id).sort();

        const recipe = recipes_v3.find(r => {
            if (r.cooking_method !== 'assembly' || !r.requirements) return false;
            const requiredItems = r.requirements.map(req => req.item_id_str).sort();
            return JSON.stringify(selectedItemIds) === JSON.stringify(requiredItems);
        });

        if (!recipe) {
            showToast('這不是一個有效的組合！');
            return;
        }
        
        // 組合成功
        const outputItemName = getItemName(recipe.output_item_id_str);
        showToast(`組合成功！得到了 ${outputItemName}`, 'success');

        // 清空選擇的物品
        gameState.assemblySelection.forEach(i => {
            gameState.inventory[i] = null;
        });

        // 將產出物放入當前 active slot
        gameState.inventory[gameState.activeSlot] = { item_id: recipe.output_item_id_str };
        
        // 清空組合區
        gameState.assemblySelection = [];

        updateInventory();
      }

      // 初始化遊戲界面
      function initializeGameUI() {
        console.log('[偵錯日誌] 初始化物品欄');
        initializeInventory();
        
        console.log('[偵錯日誌] 初始化工作站');
        initializeStations();
        
        console.log('[偵錯日誌] 初始化組合盤');
        initializeAssemblyPlate();
        
        // 顯示遊戲界面
        gameUI.style.visibility = 'visible';
        
        // 延遲產生初始訂單
        setTimeout(() => {
          console.log('[偵錯日誌] 產生初始訂單');
          generateOrder();
          generateOrder();
        }, 500);
      }

      function showLoading(message) {
        loadingScreen.style.display = 'flex';
        document.querySelector('.loading-text').textContent = message;
      }

      function hideLoading() {
        loadingScreen.style.display = 'none';
      }

      // 啟動遊戲初始化流程
      initializeGame();

      // ===================================
      // 初始化遊戲核心函數
      // ===================================
      function initializeGame() {
        console.log('[偵錯日誌] 開始初始化遊戲...');
        
        // 顯示載入中
        showLoading('載入遊戲資料中...');
        
        // 設定初始倒數計時器
        setupGameTimer();
        
        // 載入遊戲資料 (物品和食譜)
        fetchGameData()
          .then(() => {
            console.log('[偵錯日誌] 遊戲資料載入成功!');
            hideLoading();
            initializeGameUI();
            
            // 啟動遊戲計時器
            startGameTimer();
          })
          .catch(error => {
            console.error('遊戲初始化失敗:', error);
            document.getElementById('error-message').textContent = '遊戲資料載入失敗，請稍後再試或聯繫管理員。';
            document.getElementById('error-container').style.display = 'flex';
          });
      }

      // 設置遊戲計時器顯示
      function setupGameTimer() {
        updateTimerDisplay(gameState.time);
      }

      // 更新計時器顯示
      function updateTimerDisplay(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        gameTimerInner.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
      }

      // 啟動遊戲計時器
      function startGameTimer() {
        const gameInterval = setInterval(() => {
          gameState.time--;
          updateTimerDisplay(gameState.time);
          
          // 遊戲時間結束
          if (gameState.time <= 0) {
            clearInterval(gameInterval);
            endGame();
          }
          
          // 定時生成新訂單
          if (gameState.time > 0 && gameState.time % 30 === 0) {
            generateOrder();
          }
        }, 1000);
      }

      // 結束遊戲
      function endGame() {
        finalScore.textContent = gameState.score;
        gameOverDialog.style.display = 'flex';
      }

      // 從後端獲取遊戲資料
      async function fetchGameData() {
        try {
          const response = await fetch('/cook-api/v3/game-data', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`API 回應錯誤: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 處理後端資料
          items_v3 = data.items || [];
          recipes_v3 = data.recipes || [];
          
          console.log('[偵錯日誌] 物品數量:', items_v3.length);
          console.log('[偵錯日誌] 食譜數量:', recipes_v3.length);
          
        } catch (error) {
          console.error('獲取遊戲資料失敗:', error);
          throw error;
        }
      }

      // 初始化物品欄
      function initializeInventory() {
        playerInventory.innerHTML = '';
        
        for (let i = 0; i < 8; i++) {
          const slot = document.createElement('div');
          slot.className = 'inventory-slot';
          slot.dataset.slotIndex = i;
          
          // 設定點擊事件
          slot.addEventListener('click', () => onInventorySlotClick(i));
          
          playerInventory.appendChild(slot);
        }
        
        updateInventory();
      }

      // 更新物品欄顯示
      function updateInventory() {
        const slots = document.querySelectorAll('.inventory-slot');
        
        slots.forEach((slot, index) => {
          // 清除之前的內容
          slot.innerHTML = '';
          slot.classList.remove('active');
          slot.classList.remove('selected-for-assembly');
          
          // 更新當前槽位狀態
          const item = gameState.inventory[index];
          
          if (item) {
            const itemData = items_v3.find(i => i.item_id === item.item_id);
            if (itemData) {
              slot.textContent = itemData.ascii_symbol;
              
              // 如果有數量，顯示數量
              if (item.quantity && item.quantity > 1) {
                const quantitySpan = document.createElement('div');
                quantitySpan.className = 'item-quantity';
                quantitySpan.textContent = item.quantity;
                slot.appendChild(quantitySpan);
              }
            }
          }
          
          // 標記激活的槽位
          if (index === gameState.activeSlot) {
            slot.classList.add('active');
          }
          
          // 標記被選中用於組合的槽位
          if (gameState.assemblySelection.includes(index)) {
            slot.classList.add('selected-for-assembly');
          }
        });
      }

      // 初始化工作站
      function initializeStations() {
        stationsContainer.innerHTML = '';
        
        const stations = [
          { id: 'ingredient_station', name: '食材區', icon: '🥗' },
          { id: 'processing_station', name: '加工區', icon: '🍳' },
          { id: 'final_assembly', name: '出餐區', icon: '🧑‍🍳' },
          { id: 'trash_can', name: '垃圾桶', icon: '🗑️' }
        ];
        
        stations.forEach(station => {
          const stationDiv = document.createElement('div');
          stationDiv.className = 'station';
          stationDiv.dataset.stationId = station.id;
          
          stationDiv.innerHTML = `
            <div class="station-icon">${station.icon}</div>
            <div class="station-label">${station.name}</div>
            <div class="progress-bar-container">
              <div class="progress-bar"></div>
            </div>
          `;
          
          stationDiv.addEventListener('click', () => onStationClick(station.id));
          
          stationsContainer.appendChild(stationDiv);
        });
      }

      // 初始化組合盤
      function initializeAssemblyPlate() {
        assemblySlotsContainer.innerHTML = '';
        
        // 建立3個組合槽位
        for (let i = 0; i < 3; i++) {
          if (i > 0) {
            const operator = document.createElement('div');
            operator.className = 'plate-operator';
            operator.textContent = '+';
            assemblySlotsContainer.appendChild(operator);
          }
          
          const slot = document.createElement('div');
          slot.className = 'plate-slot';
          slot.dataset.plateIndex = i;
          assemblySlotsContainer.appendChild(slot);
        }
        
        // 設定組合按鈕事件
        assembleBtn.addEventListener('click', onAssembleClick);
      }

      // 更新組合盤顯示
      function updateAssemblyPlate() {
        // 未實現，將在後續版本添加
      }

      // 生成隨機訂單
      function generateOrder() {
        // 確保不超過最大訂單數
        if (gameState.orders.length >= 3) return;
        
        // 從T2物品中隨機選擇一個作為訂單
        const finalDishes = items_v3.filter(item => item.item_tier === 2);
        if (!finalDishes.length) return;
        
        const randomDish = finalDishes[Math.floor(Math.random() * finalDishes.length)];
        
        // 創建新訂單
        const newOrder = {
          id: Date.now(),
          dish_id: randomDish.item_id,
          dish_name: randomDish.item_name,
          points: randomDish.base_points,
          timeLeft: 120, // 120秒完成時間
          ingredients: [] // 需要顯示的原料
        };
        
        // 查找製作此料理所需的食譜
        const recipe = recipes_v3.find(r => r.output_item_id_str === randomDish.item_id);
        if (recipe && recipe.requirements) {
          // 添加需要的原料
          newOrder.ingredients = recipe.requirements.map(req => {
            const ingredientItem = items_v3.find(i => i.item_id === req.item_id_str);
            return {
              id: req.item_id_str,
              name: ingredientItem ? ingredientItem.item_name : '未知物品',
              icon: ingredientItem ? ingredientItem.ascii_symbol : '❓',
              quantity: req.quantity
            };
          });
        }
        
        // 添加到訂單列表
        gameState.orders.push(newOrder);
        
        // 更新訂單顯示
        updateOrders();
        
        // 顯示提示
        showToast(`收到新訂單：${newOrder.dish_name}!`, 'info');
      }

      // 更新訂單顯示
      function updateOrders() {
        ordersContainer.innerHTML = '';
        
        if (gameState.orders.length === 0) {
          ordersContainer.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">暫無訂單</div>';
          return;
        }
        
        gameState.orders.forEach(order => {
          const orderCard = document.createElement('div');
          orderCard.className = 'order-card';
          
          let ingredientsHTML = '';
          order.ingredients.forEach(ing => {
            ingredientsHTML += `
              <div class="order-ingredient-item">
                <span class="order-ingredient-icon">${ing.icon}</span>
                ${ing.name} x${ing.quantity}
              </div>
            `;
          });
          
          // 計算時間百分比
          const timePercentage = Math.min(100, (order.timeLeft / 120) * 100);
          
          orderCard.innerHTML = `
            <div class="order-name">${order.dish_name}</div>
            <div class="order-ingredients">${ingredientsHTML}</div>
            <div class="order-timer-container">
              <div class="order-timer-text">剩餘時間: ${order.timeLeft}秒</div>
              <div class="order-timer">
                <div class="order-timer-fill" style="width: ${timePercentage}%"></div>
              </div>
            </div>
          `;
          
          ordersContainer.appendChild(orderCard);
        });
      }

      // 更新分數顯示
      function updateScore() {
        gameScore.textContent = `分數: ${gameState.score}`;
      }

      // 返回大廳事件
      returnToLobbyBtn.addEventListener('click', () => {
        window.location.href = 'cook-lobby.html';
      });

    });
  </script>
</body>
</html>