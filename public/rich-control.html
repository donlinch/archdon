<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大富翁遊戲控制器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .controller-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        h1 {
            text-align: center;
            color: #5b9df0;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .control-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #eaeaea;
            border-radius: 8px;
        }

        .control-section h2 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1.2rem;
        }

        .player-select {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .player-btn {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .player-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .player1 {
            background-color: #8ab5f3;
        }

        .player1.selected {
            background-color: #5b9df0;
            box-shadow: 0 0 0 4px rgba(91, 157, 240, 0.3);
        }

        .player2 {
            background-color: #b79de2;
        }

        .player2.selected {
            background-color: #9270ca;
            box-shadow: 0 0 0 4px rgba(146, 112, 202, 0.3);
        }

        .player3 {
            background-color: #ff8a85;
        }

        .player3.selected {
            background-color: #ff544d;
            box-shadow: 0 0 0 4px rgba(255, 84, 77, 0.3);
        }

        .direction-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .direction-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .direction-btn:hover {
            transform: scale(1.05);
        }

        .forward {
            background-color: #0cd8b6;
        }

        .forward:hover {
            background-color: #09b699;
        }

        .backward {
            background-color: #ff544d;
        }

        .backward:hover {
            background-color: #e64840;
        }

        .steps-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .steps-input label {
            font-weight: bold;
            color: #333;
        }

        .steps-input input {
            width: 4rem;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 1rem;
        }

        .connection-status {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        .game-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }

        .game-info-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .game-info-content {
            color: #555;
        }

        .position-jump {
            margin-top: 1rem;
        }

        .position-jump select {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .position-jump button {
            padding: 0.5rem 1rem;
            background-color: #5b9df0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .position-jump button:hover {
            background-color: #4a8cdf;
        }

        .action-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            background-color: #9270ca;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
            width: 100%;
        }

        .action-btn:hover {
            background-color: #7d5fb3;
        }

        .connection-status { /* Ensure styles for connected/disconnected/connecting exist */
            text-align: center; margin-bottom: 1rem; padding: 0.5rem;
            border-radius: 4px; font-weight: bold; transition: background-color 0.3s, color 0.3s;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
    </style>
</head>
<body>
    <div class="controller-container">
        <h1>大富翁遊戲控制器</h1>

        <div id="connection-status" class="connection-status disconnected">
            未連接遊戲
        </div>

        <!-- ... (keep player select, move control, jump, actions sections) ... -->
         <div class="control-section">
            <h2>玩家選擇</h2>
            <div class="player-select">
                <button id="player1-btn" class="player-btn player1 selected">P1</button>
                <button id="player2-btn" class="player-btn player2">P2</button>
                <button id="player3-btn" class="player-btn player3">P3</button>
            </div>
        </div>
        <div class="control-section">
            <h2>移動控制</h2>
            
            <div class="direction-buttons">
                <button id="forward-btn" class="direction-btn forward">前進</button>
                <button id="backward-btn" class="direction-btn backward">後退</button>
            </div>
        </div>
        <div class="control-section">
            <h2>直接跳轉</h2>
            <div class="position-jump">
                <select id="position-select">
                    <!-- Options added by JS -->
                </select>
                <button id="jump-btn">跳轉</button>
            </div>
        </div>
        <div class="control-section">
            <h2>特殊操作</h2>
            <button id="show-info-btn" class="action-btn">顯示資訊</button>
            <button id="hide-info-btn" class="action-btn">隱藏資訊</button>
            <button id="reset-btn" class="action-btn">重置遊戲</button>
        </div>


        <div id="game-info" class="game-info">
            <div class="game-info-title">遊戲狀態</div>
            <div id="game-info-content" class="game-info-content">
                等待連接遊戲...
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const player1Btn = document.getElementById('player1-btn');
            const player2Btn = document.getElementById('player2-btn');
            const player3Btn = document.getElementById('player3-btn');
            const forwardBtn = document.getElementById('forward-btn');
            const backwardBtn = document.getElementById('backward-btn');
             const positionSelect = document.getElementById('position-select');
            const jumpBtn = document.getElementById('jump-btn');
            const showInfoBtn = document.getElementById('show-info-btn');
            const hideInfoBtn = document.getElementById('hide-info-btn');
            const resetBtn = document.getElementById('reset-btn');
            const connectionStatusDiv = document.getElementById('connection-status');
            const gameInfoContentDiv = document.getElementById('game-info-content');
            const allControlButtons = document.querySelectorAll('.controller-container button, .controller-container input, .controller-container select');


            // --- State ---
            let selectedPlayer = 1; // Local controller state
            let gameIsConnected = false;

            // --- WebSocket Variables ---
            let ws = null;
            const wsUrl = `wss://${window.location.host}?clientType=controller`; // Use wss://

            // --- Remove BroadcastChannel ---
            // const channel = new BroadcastChannel('rich_game_channel');

             // --- Disable/Enable Controls ---
            function setControlsEnabled(enabled) {
                allControlButtons.forEach(el => el.disabled = !enabled);
                gameIsConnected = enabled; // Update connection state
                updateConnectionStatusUI(); // Update UI based on actual connection status
            }

            // --- Update Connection Status UI ---
            function updateConnectionStatusUI() {
                 if (ws && ws.readyState === WebSocket.OPEN && gameIsConnected) {
                    connectionStatusDiv.className = 'connection-status connected';
                    connectionStatusDiv.textContent = '已連接遊戲';
                 } else if (ws && ws.readyState === WebSocket.CONNECTING) {
                     connectionStatusDiv.className = 'connection-status connecting';
                     connectionStatusDiv.textContent = '連接中...';
                 } else {
                    connectionStatusDiv.className = 'connection-status disconnected';
                    connectionStatusDiv.textContent = '未連接遊戲';
                 }
             }


            // --- WebSocket Connection Logic ---
            function connectWebSocket() {
                 console.log(`Attempting to connect WebSocket to ${wsUrl}`);
                 setControlsEnabled(false); // Disable controls while connecting
                 connectionStatusDiv.className = 'connection-status connecting';
                 connectionStatusDiv.textContent = '連接中...';
                 ws = new WebSocket(wsUrl);

                 ws.onopen = () => {
                    console.log('WebSocket connection established (Controller)');
                    // Don't enable controls yet, wait for game status confirmation
                    // Request initial game state
                    sendCommand('getGameState');
                 };

                 ws.onmessage = (event) => {
                    console.log('WebSocket message received (Controller):', event.data);
                     try {
                         const message = JSON.parse(event.data);
                         handleServerMessage(message);
                     } catch (error) {
                         console.error('Failed to parse WebSocket message:', error);
                     }
                 };

                 ws.onerror = (error) => {
                     console.error('WebSocket error (Controller):', error);
                     setControlsEnabled(false);
                     updateConnectionStatusUI();
                 };

                 ws.onclose = (event) => {
                     console.log(`WebSocket connection closed (Controller): Code=${event.code}, Reason=${event.reason}`);
                     ws = null;
                     setControlsEnabled(false);
                     updateConnectionStatusUI();
                     gameInfoContentDiv.textContent = '與伺服器斷線，5秒後嘗試重連...';
                     setTimeout(connectWebSocket, 5000); // Reconnect
                 };
             }


             // --- Handle Messages from Server ---
            function handleServerMessage(message) {
                switch (message.type) {
                    case 'gameStateUpdate':
                        console.log("Received game state update:", message.data);
                        updateGameInfo(message.data);
                        // If we just connected and received state, enable controls
                        if (!gameIsConnected) {
                            setControlsEnabled(true);
                        }
                        break;
                     case 'gameStatus':
                         console.log("Received game status:", message.status);
                         gameIsConnected = (message.status === 'connected');
                         setControlsEnabled(gameIsConnected); // Enable/disable based on game connection
                         updateConnectionStatusUI();
                         if (gameIsConnected) {
                             gameInfoContentDiv.textContent = '遊戲已連接，等待狀態更新...';
                              // Request state again if needed
                             sendCommand('getGameState');
                         } else {
                             gameInfoContentDiv.textContent = '遊戲已斷線。';
                         }
                         break;
                    case 'error':
                        console.error('Received error from server:', message.message);
                        gameInfoContentDiv.textContent = `錯誤: ${message.message}`;
                        // Decide if controls should be disabled based on error
                        break;
                     // Add other message types if the server sends confirmations, etc.
                     default:
                         console.log("Received unhandled message type:", message.type);
                 }
             }

             // --- Update Controller UI based on Game State ---
            function updateGameInfo(gameState) {
                 if (!gameState) {
                     gameInfoContentDiv.textContent = '無法獲取遊戲狀態。';
                     return;
                 }
                 // Update selected player button visually based on game state
                 selectPlayerUI(gameState.selectedPlayer || 1);

                 // Update game info display
                 let infoText = `當前玩家: P${gameState.selectedPlayer}\n`;
                 infoText += `玩家位置: P1=${gameState.playerPathIndices[0]}, P2=${gameState.playerPathIndices[1]}, P3=${gameState.playerPathIndices[2]}\n`;
                 infoText += `高亮格子: ${gameState.highlightedCell !== null ? gameState.highlightedCell : '無'}\n`;
                 infoText += `移動中: ${gameState.isMoving ? '是' : '否'}`;
                 gameInfoContentDiv.textContent = infoText;

                  // Update position select options if needed (e.g., if pathCells length changes)
                  updatePositionSelect(gameState.pathCells ? gameState.pathCells.length : 28); // Default 28 if no pathCells


                 // Maybe disable movement buttons if game state indicates isMoving
                 forwardBtn.disabled = gameState.isMoving || !gameIsConnected;
                 backwardBtn.disabled = gameState.isMoving || !gameIsConnected;
                 jumpBtn.disabled = gameState.isMoving || !gameIsConnected;
                 resetBtn.disabled = gameState.isMoving || !gameIsConnected; // Prevent reset while moving
             }

              // Update position select dropdown
             let positionSelectPopulated = false;
             function updatePositionSelect(cellCount) {
                 if (positionSelectPopulated && positionSelect.options.length === cellCount) return; // Avoid unnecessary updates
                 positionSelect.innerHTML = ''; // Clear existing
                 for (let i = 0; i < cellCount; i++) {
                     const opt = document.createElement('option');
                     opt.value = i;
                     opt.textContent = `位置 ${i}`;
                     positionSelect.appendChild(opt);
                 }
                 positionSelectPopulated = true;
             }


            // --- Send Command via WebSocket ---
            function sendCommand(command, params = {}) {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    console.error('WebSocket not connected, cannot send command.');
                    gameInfoContentDiv.textContent = '錯誤：未連接到伺服器。';
                    setControlsEnabled(false); // Ensure controls are disabled if WS disconnects
                    updateConnectionStatusUI();
                    return;
                }
                const message = {
                    type: 'controlCommand', // Send as a command type
                    command,
                    params
                };
                console.log('Sending command via WebSocket:', message);
                ws.send(JSON.stringify(message));
            }

            // --- UI Actions ---
            function selectPlayerUI(playerNum) {
                 selectedPlayer = playerNum; // Update local state for sending commands
                 player1Btn.classList.toggle('selected', playerNum === 1);
                 player2Btn.classList.toggle('selected', playerNum === 2);
                 player3Btn.classList.toggle('selected', playerNum === 3);
                 // Note: We don't send a 'selectPlayer' command here anymore,
                 // because the *game's* state dictates the selected player display.
                 // We just update the local `selectedPlayer` variable for *sending* commands.
                 console.log(`Controller UI updated for Player ${playerNum}`);
             }

            function movePlayer(direction) {
                console.log(`Sending move command: P${selectedPlayer}, ${direction}, 1 step`); // <-- 日誌也改成 1 step
                sendCommand('movePlayer', {
                    player: selectedPlayer, // Use the locally selected player for the command
                    direction,
                    steps: 1
                });
            }

            function jumpToPosition() {
                const position = parseInt(positionSelect.value);
                 if (!isNaN(position)) {
                    console.log(`Sending jump command: P${selectedPlayer} to position ${position}`);
                     sendCommand('jumpToPosition', {
                         player: selectedPlayer,
                         position
                     });
                 } else {
                     console.error("Invalid position selected for jump:", positionSelect.value);
                 }
            }

            // --- Event Listeners ---
            player1Btn.addEventListener('click', () => selectPlayerUI(1)); // Only update local UI selection
            player2Btn.addEventListener('click', () => selectPlayerUI(2));
            player3Btn.addEventListener('click', () => selectPlayerUI(3));
            forwardBtn.addEventListener('click', () => movePlayer('forward'));
            backwardBtn.addEventListener('click', () => movePlayer('backward'));
            jumpBtn.addEventListener('click', jumpToPosition);
            showInfoBtn.addEventListener('click', () => sendCommand('showInfo'));
            hideInfoBtn.addEventListener('click', () => sendCommand('hideInfo'));
            resetBtn.addEventListener('click', () => {
                if (confirm('確定要重置遊戲嗎？')) {
                     console.log("Sending reset command");
                     sendCommand('resetGame');
                 }
            });

            // Initial Setup
            updatePositionSelect(28); // Initial population with default size
            setControlsEnabled(false); // Start disabled
            connectWebSocket(); // Start connection attempt

        }); // End DOMContentLoaded
    </script>

</body>
</html>