<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大富翁遊戲控制器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .controller-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        h1 {
            text-align: center;
            color: #5b9df0;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .control-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #eaeaea;
            border-radius: 8px;
        }

        .control-section h2 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1.2rem;
        }

        .player-select {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .player-btn {
            width: 4.5rem; /* 微調尺寸以容納邊框 */
            height: 4.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            border: 3px solid transparent; /* ★★★ 新增：預設透明邊框佔位 ★★★ */
            cursor: pointer;
            transition: transform 0.2s, border-color 0.3s ease-in-out; /* ★ 修改：加入 border-color 過渡 ★ */
            box-sizing: border-box; /* ★★★ 新增：確保邊框計入尺寸內 ★★★ */
            background-clip: padding-box; /* 讓背景不超出內邊距，邊框更明顯 */
        }
        .player-btn:hover {
            transform: scale(1.05);
            /* 移除 hover 的 box-shadow，避免干擾 */
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); */
        }
       /* --- 修改選中狀態 --- */
       .player1 { background-color: #5b9df0; /* P1 - Geek Blue */ }
        .player1.selected {
            /* background-color: #4a8cdf; */ /* 背景色可選是否加深 */
            border-color: #5b9df0; /* ★★★ 使用邊框顏色 ★★★ */
            /* box-shadow: 0 0 0 4px rgba(91, 157, 240, 0.4); */ /* 移除 box-shadow */
            transform: scale(1.08); /* 可以稍微放大選中效果 */
        }

        .player2 { background-color: #9270ca; /* P2 - Golden Purple */ }
        .player2.selected {
            /* background-color: #7d5fb3; */
            border-color: #9270ca; /* ★★★ 使用邊框顏色 ★★★ */
            /* box-shadow: 0 0 0 4px rgba(146, 112, 202, 0.4); */
             transform: scale(1.08);
        }

        .player3 { background-color: #ff544d; /* P3 - Sunset Orange */ }
        .player3.selected {
            /* background-color: #e64840; */
            border-color: #ff544d; /* ★★★ 使用邊框顏色 ★★★ */
            /* box-shadow: 0 0 0 4px rgba(255, 84, 77, 0.4); */
             transform: scale(1.08);
        }

        /* --- 新增玩家名稱樣式 --- */
        .player-item {
            display: flex;
            flex-direction: column; /* 垂直排列按鈕和名稱 */
            align-items: center; /* 水平居中 */
            gap: 0.5rem; /* 按鈕和名稱之間的間距 */
        }

        .player-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #555;
            text-align: center;
            min-height: 1.2em; /* 確保即使沒名字也有高度 */
        }

        /* --- 調整 Player Select 容器 --- */
        .player-select {
            display: flex;
            gap: 1.5rem; /* 可以調整玩家之間的間距 */
            justify-content: center;
            margin-bottom: 1rem;
            align-items: flex-start; /* 讓 item 從頂部對齊 */
        }


        .direction-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .direction-btn {
            padding: 1.2rem 2.5rem;  /* 增加內邊距 */
    font-size: 1.3rem;      /* 增大字體 */
    font-weight: bold;
    color: white;
    border: none;
    border-radius: 30px;    /* 更圓的邊角 */
    cursor: pointer;
    transition: all 0.2s;
        }

        .direction-btn:hover {
            transform: scale(1.05);
        }

        .forward {
            background-color: #0cd8b6;
        }

        .forward:hover {
            background-color: #09b699;
        }

        .backward {
            background-color: #ff544d;
        }

        .backward:hover {
            background-color: #e64840;
        }

        .steps-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .steps-input label {
            font-weight: bold;
            color: #333;
        }

        .steps-input input {
            width: 4rem;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 1rem;
        }

        .connection-status {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        .game-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }

        .game-info-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .game-info-content {
            color: #555;
        }

        .position-jump {
            margin-top: 1rem;
        }

        .position-jump select {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .position-jump button {
            padding: 0.5rem 1rem;
            background-color: #5b9df0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .position-jump button:hover {
            background-color: #4a8cdf;
        }

        .action-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            background-color: #9270ca;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
            width: 100%;
        }

        .action-btn:hover {
            background-color: #7d5fb3;
        }

        .connection-status { /* Ensure styles for connected/disconnected/connecting exist */
            text-align: center; margin-bottom: 1rem; padding: 0.5rem;
            border-radius: 4px; font-weight: bold; transition: background-color 0.3s, color 0.3s;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }





 /* 移動控制按鈕容器 (使用 Flexbox) */
 .direction-buttons-large {
            display: flex;
            gap: 1rem; /* 按鈕間距 */
            justify-content: center; /* 水平居中 (如果需要) */
            margin-top: 1rem; /* 與標題的間距 */
        }

        /* 更大的方塊按鈕樣式 */
        .direction-btn-large {
            flex: 1; /* 讓兩個按鈕平分寬度 */
            padding: 1.5rem 1rem; /* 增加內邊距，讓按鈕變大 */
            font-size: 1.2rem; /* 放大字體 */
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px; /* 方塊圓角 */
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .direction-btn-large:hover {
            transform: scale(1.03); /* 稍微縮小 hover 效果 */
            filter: brightness(90%); /* 懸停時稍微變暗 */
        }
        .forward-large { background-color: #0cd8b6; } /* 保持顏色 */
        .backward-large { background-color: #ff544d; } /* 保持顏色 */

        /* 格子資訊按鈕容器 (使用 Flexbox) */
        .info-buttons-small {
            display: flex;
            gap: 0.8rem; /* 按鈕間距 */
            justify-content: center; /* 居中顯示 */
            margin-top: 1rem; /* 與標題的間距 */
        }

        /* 較小的並排按鈕樣式 */
        .info-btn-small {
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            /* background-color: #9270ca; */ /* 保持原紫色或自訂 */
            /* color: white; */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 200px;
            margin-top: 0; /* 移除原 action-btn 的 margin-top */
        }
        .show-info-small { background-color: #9270ca; color: white; } /* 顯示按鈕顏色 */
        .hide-info-small { background-color: #6c757d; color: white; } /* 關閉按鈕顏色 */

        .info-btn-small:hover {
            filter: brightness(90%);
        }

        /* 移除舊 .action-btn 的特定樣式 (如果不再需要) */
        /* 例如 width: 100%; margin-top: 1rem; */
        /* 如果其他地方還用 .action-btn，保留，只覆蓋需要的 */

         /* 移除 .direction-buttons 和 .direction-btn 的舊樣式 (如果不再用) */
         /* 或者保留，以防萬一，新樣式會覆蓋 */






    </style>
</head>
<body>
    <div class="controller-container">
        <h1>大富翁遊戲控制器</h1>

        <div id="connection-status" class="connection-status disconnected">
            未連接遊戲
        </div>

       
        <!-- ★★★ 修改：應用新的 CSS class ★★★ -->
    <!-- ★★★ 修改：玩家選擇區塊結構 ★★★ -->
    <div class="control-section">
        <h2>玩家選擇</h2>
        <div class="player-select">
            <!-- 玩家 1 -->
            <div class="player-item">
                <button id="player1-btn" class="player-btn player1 selected">P1</button>
                <div class="player-name" id="player1-name">P1</div>  
            </div>
            <!-- 玩家 2 -->
            <div class="player-item">
                <button id="player2-btn" class="player-btn player2">P2</button>
                <div class="player-name" id="player2-name">P2</div>  
            </div>
            <!-- 玩家 3 -->
            <div class="player-item">
                <button id="player3-btn" class="player-btn player3">P3</button>
                <div class="player-name" id="player3-name">P3</div>  
            </div>
        </div>
    </div>
    <!-- ★★★ 修改結束 ★★★ -->
<!-- ★★★ 缺少結束 ★★★ -->


            <h2>移動控制</h2>
            <div class="direction-buttons-large"> <!-- ★ 使用新的容器 class ★ -->
                <button id="forward-btn" class="direction-btn-large forward-large">前進</button> <!-- ★ 使用新的按鈕 class ★ -->
                <button id="backward-btn" class="direction-btn-large backward-large">後退</button> <!-- ★ 使用新的按鈕 class ★ -->
            </div>
        </div>

         <div class="control-section">
            <!-- <h2>格子資訊</h2> --> <!-- 可以移除 H2 -->
            <div class="info-buttons-small"> <!-- ★ 使用新的容器 class ★ -->
                <button id="show-player-info-btn" class="info-btn-small show-info-small">顯示</button> <!-- ★ 使用新的按鈕 class ★ -->
                <button id="hide-player-info-btn" class="info-btn-small hide-info-small">關閉</button> <!-- ★ 使用新的按鈕 class ★ -->
            </div>
        </div>
        <!-- ★★★ 修改結束 ★★★ -->


 



    </div>
    <script> document.addEventListener('DOMContentLoaded', () => {
        const player1Btn = document.getElementById('player1-btn');
        const player2Btn = document.getElementById('player2-btn');
        const player3Btn = document.getElementById('player3-btn');
        // --- ★★★ 新增：獲取名稱元素 ★★★ ---
        const player1NameEl = document.getElementById('player1-name');
        const player2NameEl = document.getElementById('player2-name');
        const player3NameEl = document.getElementById('player3-name');
        // --- ★★★ 新增結束 ★★★ ---
        const forwardBtn = document.getElementById('forward-btn');
        const backwardBtn = document.getElementById('backward-btn');
        const showPlayerInfoBtn = document.getElementById('show-player-info-btn');
        const hidePlayerInfoBtn = document.getElementById('hide-player-info-btn');
        const connectionStatusDiv = document.getElementById('connection-status');

        let selectedPlayer = 1;
        let ws = null;
        let gameIsConnected = false;
        // ★★★ 確保選取所有按鈕，以便禁用/啟用 ★★★
        const allControlButtons = document.querySelectorAll('.controller-container button');


        // 修改 rich-control.html 中的 WebSocket 處理邏輯
function connectWebSocket() {
  const wsUrl = `wss://${window.location.host}?clientType=controller`;
  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    console.log("Controller WebSocket Connected");
    // 連接成功後，先顯示為連接中狀態
    connectionStatusDiv.className = 'connection-status connecting';
    connectionStatusDiv.textContent = '等待遊戲連接...';
    // 立即請求遊戲狀態
    sendCommand('getGameState');
  };

  ws.onmessage = (event) => {
    try {
      const message = JSON.parse(event.data);
      console.log("Message from game:", message); // 調試日誌

      if (message.type === 'gameStateUpdate') {
        // 收到遊戲狀態更新，表示遊戲已連接
        gameIsConnected = true;
        updateGameInfo(message.data); // 更新按鈕狀態
        if (message.data.players) {
          updatePlayerUI(message.data.players);
        }
        // 更新連接狀態 UI
        updateConnectionStatusUI(true);
        // 啟用控制按鈕
        setControlsEnabled(true);
      } else if (message.type === 'error') {
        console.error("Error message from server:", message.message);
      } else if (message.type === 'gameStatus') {
        console.log("Received gameStatus:", message.status);
        // 根據伺服器明確的狀態更新 UI
        const isConnected = message.status === 'connected';
        gameIsConnected = isConnected; // 更新全局連接狀態
        updateConnectionStatusUI(isConnected);
        setControlsEnabled(isConnected);
      }
    } catch (e) {
      console.error("Failed to parse message or update UI:", e);
    }
  };

  ws.onclose = () => {
    console.log("Controller WebSocket Closed");
    gameIsConnected = false;
    setControlsEnabled(false);
    updateConnectionStatusUI(false);
    ws = null;
    // 延遲重連
    setTimeout(connectWebSocket, 5000);
  };

  ws.onerror = (error) => {
    console.error("Controller WebSocket Error:", error);
    // onclose 通常會在錯誤後觸發，啟動重連邏輯
  }
}

// 修改控制按鈕啟用/禁用邏輯
function setControlsEnabled(enabled) {
  allControlButtons.forEach(el => {
    // 允許玩家選擇按鈕始終可用
    if (!el.classList.contains('player-btn')) {
      el.disabled = !enabled;
    }
  });
  gameIsConnected = enabled; // 確保狀態變量保持一致
}

// 修改更新遊戲信息函數，確保按鈕狀態正確
function updateGameInfo(data) {
  if (!data) return;
  
  // 選擇由遊戲狀態指示的玩家
  selectPlayerUI(data.selectedPlayer || 1, false); // 不發送命令回去

  // 只有在遊戲報告移動中或未連接時禁用按鈕
  const disableActions = data.isMoving || !gameIsConnected;
  
  // 統一更新所有控制按鈕
  if (forwardBtn) forwardBtn.disabled = disableActions;
  if (backwardBtn) backwardBtn.disabled = disableActions;
  if (showPlayerInfoBtn) showPlayerInfoBtn.disabled = disableActions;
  if (hidePlayerInfoBtn) hidePlayerInfoBtn.disabled = disableActions;

  // 確保連接狀態反映實際情況
  updateConnectionStatusUI(gameIsConnected);
}
        function setControlsEnabled(enabled) {
          allControlButtons.forEach(el => {
               // Don't disable player selection buttons, allow switching anytime
               if (!el.classList.contains('player-btn')) {
                   el.disabled = !enabled;
               }
           });
          // We track gameIsConnected separately now based on messages
        }

        // Modified to accept an explicit connection status
        function updateConnectionStatusUI(isConnected = gameIsConnected) {
          if (isConnected) {
            connectionStatusDiv.className = 'connection-status connected';
            connectionStatusDiv.textContent = '已連接遊戲';
          } else {
            connectionStatusDiv.className = 'connection-status disconnected';
            connectionStatusDiv.textContent = ws ? '等待遊戲連接...' : '未連接遊戲'; // More informative
          }
        }

        function sendCommand(command, params = {}) {
          if (!ws || ws.readyState !== WebSocket.OPEN) {
               console.warn("Cannot send command, WebSocket not open:", command);
               // Optionally inform the user
               // connectionStatusDiv.textContent = '指令傳送失敗: 未連接';
               return;
          }
          const message = { type: 'controlCommand', command, params };
          console.log("Sending command:", message); // Log sent commands
          ws.send(JSON.stringify(message));
        }

        // Updates button disabled states based on game state
        function updateGameInfo(data) {
          if (!data) return;
          // Select the player indicated by the game state
          selectPlayerUI(data.selectedPlayer || 1, false); // Don't send command back

          // Disable movement/action buttons if game reports moving or is disconnected
           const disableActions = data.isMoving || !gameIsConnected;
           // console.log(`Updating button states: isMoving=${data.isMoving}, gameIsConnected=${gameIsConnected}, disableActions=${disableActions}`);

           if (forwardBtn) forwardBtn.disabled = disableActions;
           if (backwardBtn) backwardBtn.disabled = disableActions;
           if (showPlayerInfoBtn) showPlayerInfoBtn.disabled = disableActions;
           if (hidePlayerInfoBtn) hidePlayerInfoBtn.disabled = disableActions;

           // Ensure connection status reflects reality
           updateConnectionStatusUI(gameIsConnected);
        }


        // --- ★★★ 修改：更新頭像和名稱 (重命名函數) ★★★ ---
        function updatePlayerUI(playersData) {
          const buttons = [player1Btn, player2Btn, player3Btn];
          const nameElements = [player1NameEl, player2NameEl, player3NameEl]; // Name elements array

          buttons.forEach((btn, i) => {
            const num = i + 1;
            const nameElement = nameElements[i]; // Get the corresponding name element

            // Default player data if not provided
             const playerData = playersData[num] || { avatarUrl: null, name: null };

            // --- 更新頭像 ---
            const avatar = (playerData.avatarUrl || '').trim();
            const currentAvatar = (btn.dataset.avatarUrl || '').trim();

            if (avatar !== currentAvatar || !btn.innerHTML.includes('img')) { // Update if different or if currently text
              if (avatar) {
                btn.innerHTML = `<img src="${avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" alt="P${num}頭像" onerror="this.parentElement.innerHTML='P${num}';">`; // Added onerror fallback
                btn.dataset.avatarUrl = avatar;
              } else {
                btn.innerHTML = `P${num}`; // Fallback to P# if no avatar
                delete btn.dataset.avatarUrl;
              }
            }

            // --- 更新名稱 ---
            if (nameElement) { // Check if the element exists
                const playerName = playerData.name || `玩家 ${num}`; // Use name or fallback
                nameElement.textContent = playerName;
            }
          });
        }
        // --- ★★★ 修改結束 ★★★ ---


        function selectPlayerUI(num, send = true) {
          selectedPlayer = num;
          // Toggle 'selected' class for border effect
          player1Btn.classList.toggle('selected', num === 1);
          player2Btn.classList.toggle('selected', num === 2);
          player3Btn.classList.toggle('selected', num === 3);
          if (send) {
               console.log(`UI selected player ${num}, sending command...`);
               sendCommand('selectPlayer', { player: num });
           }
        }

        function movePlayer(direction) {
          // Ensure controls are enabled before sending move command
           if (forwardBtn.disabled) {
               console.warn("Attempted to move while controls are disabled.");
               return;
           }
          console.log(`Move button clicked: ${direction}`);
          sendCommand('movePlayer', { player: selectedPlayer, direction: direction, steps: 1 });
        }

        // --- 事件監聽器 (保持不變，除了移動按鈕調用) ---
        showPlayerInfoBtn.addEventListener('click', () => {
          sendCommand('showPlayerInfo', { player: selectedPlayer });
        });

        hidePlayerInfoBtn.addEventListener('click', () => {
          sendCommand('hidePlayerInfo'); // No player needed for hide usually
        });

        player1Btn.addEventListener('click', () => selectPlayerUI(1, true));
        player2Btn.addEventListener('click', () => selectPlayerUI(2, true));
        player3Btn.addEventListener('click', () => selectPlayerUI(3, true));

        // --- ★★★ 修改：確保調用 movePlayer ★★★ ---
        forwardBtn.addEventListener('click', () => movePlayer('forward'));
        backwardBtn.addEventListener('click', () => movePlayer('backward'));
        // --- ★★★ 修改結束 ★★★ ---

        connectWebSocket(); // Start connection attempt
      });
        </script>
        

</body>
</html>