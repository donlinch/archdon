<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員管理後台</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #f4f6f9;
            --text-color: #212529;
            --border-color: #dee2e6;
            --border-radius: 0.3rem;
            --box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            color: var(--dark-color);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .admin-header a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }

        .main-content, .sidebar {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        /* 表格樣式 */
        #user-table {
            width: 100%;
            border-collapse: collapse;
        }
        #user-table th, #user-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        #user-table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        #user-table tbody tr:hover {
            background-color: #f1f1f1;
        }
        #user-table td img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        
        /* 表單樣式 */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }
        
        /* Modal 彈窗樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 800px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .modal-close:hover { color: #333; }
        
        .section {
            margin-bottom: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .item-tag {
            background-color: var(--light-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .item-tag .remove-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #loading-overlay {
            display: none;
            position: fixed;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #roles-list .role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        #roles-list .role-item:last-child {
            border-bottom: none;
        }
        #roles-list .role-actions button {
            margin-left: 5px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .badge-item {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: center;
            background-color: var(--light-color);
        }
        
        .badge-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 50%;
        }
        
        .badge-item .badge-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .badge-item .badge-description {
            font-size: 0.8em;
            color: var(--secondary-color);
        }
        
        #modal-user-badges {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        
        #modal-user-badges .item-tag {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        
        #modal-user-badges .item-tag img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 5px;
            border-radius: 50%;
        }

        .title-item {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: center;
            background-color: var(--light-color);
        }

        .title-item .title-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #6a1b9a; /* Purple color for titles */
        }

        .title-item .title-description {
            font-size: 0.8em;
            color: var(--secondary-color);
        }

        #modal-user-titles {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        #modal-user-titles .item-tag {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background-color: #f8f0ff; /* Light purple background */
            border: 1px solid #d8c0f0;
        }

        #modal-user-titles .item-tag span {
            color: #6a1b9a;
            font-weight: 500;
        }

        .user-info-section {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 15px;
        }
        
        .user-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            align-items: start;
        }
        
        .user-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .user-details p {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" style="display: flex;">正在驗證管理員身份...</div>

    <div id="admin-container" class="container" style="display: none;">
        <header class="admin-header">
            <h1>會員管理後台</h1>
            <a href="/index.html">返回網站首頁</a>
        </header>

        <div class="admin-grid">
            <div class="main-content">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h2 class="h4">會員管理</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <!-- 移除「為無角色用戶分配默認角色」按鈕 -->
                    </div>
                </div>
                <input type="text" id="user-search" placeholder="搜尋用戶名稱..." class="form-group" style="width: 300px; padding: 10px;">
                <table id="user-table">
                    <thead>
                        <tr>
                            <th>帳號</th>
                            <th>顯示名稱</th>
                            <th>角色</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <!-- 用戶數據將動態插入此處 -->
                    </tbody>
                </table>
            </div>
            <aside class="sidebar">
                <h2>全局設定</h2>
                <div class="section">
                    <h3>角色管理</h3>
                    <form id="role-form">
                        <input type="hidden" id="role-id">
                        <div class="form-group">
                            <label for="role-name">角色名稱</label>
                            <input type="text" id="role-name" required>
                        </div>
                        <div class="form-group">
                            <label for="role-description">描述</label>
                            <input type="text" id="role-description">
                        </div>
                        <button type="submit" class="btn btn-primary">保存角色</button>
                        <button type="button" id="cancel-edit-role-btn" class="btn btn-secondary" style="display: none;">取消編輯</button>
                    </form>
                    <hr>
                    <h4>現有角色列表</h4>
                    <div id="roles-list"></div>
                </div>
                <div class="section">
                    <h3>創建新徽章</h3>
                    <form id="create-badge-form">
                        <div class="form-group">
                            <label for="badge-name">徽章名稱</label>
                            <input type="text" id="badge-name" required>
                        </div>
                        <div class="form-group">
                            <label for="badge-description">描述</label>
                            <input type="text" id="badge-description">
                        </div>
                        <div class="form-group">
                            <label for="badge-image">徽章圖片</label>
                            <input type="file" id="badge-image" accept="image/*">
                            <div id="badge-preview" style="margin-top: 10px; max-width: 100px; max-height: 100px; overflow: hidden;"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">創建徽章</button>
                    </form>
                </div>
                <div class="section">
                    <h3>創建新頭銜</h3>
                    <form id="create-title-form">
                         <div class="form-group">
                            <label for="title-name">頭銜名稱</label>
                            <input type="text" id="title-name" required>
                        </div>
                        <div class="form-group">
                            <label for="title-description">描述</label>
                            <input type="text" id="title-description">
                        </div>
                        <div class="form-group">
                            <label for="title-image">頭銜圖片 (選填)</label>
                            <input type="file" id="title-image" accept="image/*">
                            <div id="title-preview" style="margin-top: 10px; max-width: 100px; max-height: 100px; overflow: hidden;"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">創建頭銜</button>
                    </form>
                </div>
                <div class="section">
                    <h3>現有頭銜列表</h3>
                    <div id="titles-list" class="item-grid"></div>
                </div>
                <div class="section">
                    <h3>現有徽章列表</h3>
                    <div id="badges-list" class="item-grid"></div>
                </div>
            </aside>
        </div>
    </div>

    <!-- 用戶管理 Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="modal-username">管理用戶</h2>
            
            <div class="section user-info-section">
                <h3>用戶資料</h3>
                <div class="user-info-grid">
                    <div class="user-avatar">
                        <img id="modal-user-avatar" src="/images/a01girlmove.gif" alt="用戶頭像">
                    </div>
                    <div class="user-details">
                        <p><strong>用戶ID:</strong> <span id="modal-user-id"></span></p>
                        <p><strong>帳號:</strong> <span id="modal-user-account"></span></p>
                        <p><strong>顯示名稱:</strong> <span id="modal-user-display-name"></span></p>
                        <p><strong>Email:</strong> <span id="modal-user-email"></span></p>
                        <p><strong>註冊時間:</strong> <span id="modal-user-created-at"></span></p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>角色管理</h3>
                <div class="item-list" id="modal-user-roles"></div>
                <form id="assign-role-form" class="form-group" style="margin-top: 15px;">
                    <select id="role-select"></select>
                    <button type="submit" class="btn btn-primary">授予角色</button>
                </form>
            </div>
            
            <div class="section">
                <h3>徽章管理</h3>
                <div class="item-list" id="modal-user-badges"></div>
                <form id="assign-badge-form" class="form-group" style="margin-top: 15px;">
                    <select id="badge-select"></select>
                    <button type="submit" class="btn btn-primary">授予徽章</button>
                </form>
            </div>

            <div class="section">
                <h3>頭銜管理</h3>
                <div class="item-list" id="modal-user-titles"></div>
                <form id="assign-title-form" class="form-group" style="margin-top: 15px;">
                    <select id="title-select"></select>
                    <button type="submit" class="btn btn-primary">授予頭銜</button>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const adminContainer = document.getElementById('admin-container');
        const userTableBody = document.getElementById('user-table-body');
        const userSearchInput = document.getElementById('user-search');

        // Modal elements
        const userModal = document.getElementById('user-modal');
        const modalCloseBtn = userModal.querySelector('.modal-close');
        
        let allUsers = [];
        let allRoles = [];
        let allBadges = [];
        let allTitles = [];
        let currentEditingUserId = null;
        let authToken = null;

        const roleForm = document.getElementById('role-form');
        const rolesList = document.getElementById('roles-list');
        const cancelEditRoleBtn = document.getElementById('cancel-edit-role-btn');

        // --- API & Auth ---
        
        async function apiFetch(url, options = {}) {
            loadingOverlay.style.display = 'flex';
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            const mergedOptions = { ...defaultOptions, ...options };
            if (options.body && typeof options.body !== 'string') {
                mergedOptions.body = JSON.stringify(options.body);
            }

            try {
                const response = await fetch(url, mergedOptions);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Request failed' }));
                    throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                }
                if (response.status === 204) return null;
                return await response.json();
            } catch (error) {
                alert(`API Error: ${error.message}`);
                throw error;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function checkAdminAuth() {
            const adminUserId = localStorage.getItem('boxCurrentUserId');
            authToken = localStorage.getItem(`boxUserToken_${adminUserId}`);
            if (!authToken) {
                loadingOverlay.innerHTML = '請先登入管理員帳號。';
                window.location.href = 'box.html';
                return;
            }

            try {
                await apiFetch('/api/box/admin/auth/check');
                adminContainer.style.display = 'block';
                loadingOverlay.style.display = 'none';
                initializeApp();
            } catch (error) {
                loadingOverlay.innerHTML = '管理員身份驗證失敗，請重新登入。';
                console.error("Admin auth failed:", error);
                // Optional: redirect to login
                // window.location.href = 'box.html';
            }
        }

        // --- Page Initialization ---

        async function initializeApp() {
            try {
                [allUsers, allRoles, allBadges, allTitles] = await Promise.all([
                    apiFetch('/api/box/admin/users'),
                    apiFetch('/api/box/admin/roles'),
                    apiFetch('/api/box/admin/badges'),
                    apiFetch('/api/box/admin/titles') 
                ]);
                
                renderUserTable(allUsers);
                renderRolesList(allRoles);
                renderBadgesList(allBadges);
                renderTitlesList(allTitles);
                populateGlobalSelectors();
                setupEventListeners();
                
            } catch (error) {
                console.error("Initialization failed:", error);
                alert("無法載入後台初始數據。");
            }
        }
        
        function populateGlobalSelectors() {
            populateSelect(document.getElementById('role-select'), allRoles, 'role_id', 'role_name');
            populateSelect(document.getElementById('badge-select'), allBadges, 'badge_id', 'badge_name');
            populateSelect(document.getElementById('title-select'), allTitles, 'title_id', 'title_name');
        }
        
        function populateSelect(selectElement, items, valueKey, textKey) {
             selectElement.innerHTML = '';
             items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                selectElement.appendChild(option);
            });
        }

        // --- User Table ---

        function renderUserTable(users) {
            userTableBody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <img src="${user.user_profile_image_url || '/images/a01girlmove.gif'}" alt="${user.username}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        ${user.username}
                    </td>
                    <td>${user.display_name || user.username}</td>
                    <td id="user-roles-${user.user_id}">載入中...</td>
                    <td><button class="btn btn-primary manage-btn" data-user-id="${user.user_id}">管理</button></td>
                `;
                userTableBody.appendChild(tr);
                
                // 獲取用戶角色
                fetchUserRoles(user.user_id);
            });
        }
        
        async function fetchUserRoles(userId) {
            try {
                const userRoles = await apiFetch(`/api/box/users/${userId}/roles`);
                const rolesCell = document.getElementById(`user-roles-${userId}`);
                if (rolesCell) {
                    if (userRoles.length > 0) {
                        rolesCell.textContent = userRoles.map(role => role.role_name).join(', ');
                    } else {
                        rolesCell.textContent = '無';
                    }
                }
            } catch (error) {
                console.error(`Failed to load roles for user ${userId}:`, error);
                const rolesCell = document.getElementById(`user-roles-${userId}`);
                if (rolesCell) {
                    rolesCell.textContent = '載入失敗';
                }
            }
        }
        
        userSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => user.username.toLowerCase().includes(searchTerm));
            renderUserTable(filteredUsers);
        });

        // --- Modal Management ---

        async function openUserModal(userId) {
            currentEditingUserId = userId;
            
            // Show loading state
            document.getElementById('modal-username').textContent = '載入中...';
            document.getElementById('modal-user-id').textContent = '';
            document.getElementById('modal-user-account').textContent = '';
            document.getElementById('modal-user-display-name').textContent = '';
            document.getElementById('modal-user-email').textContent = '';
            document.getElementById('modal-user-created-at').textContent = '';
            document.getElementById('modal-user-avatar').src = '/images/a01girlmove.gif';
            
            document.getElementById('modal-user-roles').innerHTML = '<div style="text-align: center;">載入中...</div>';
            document.getElementById('modal-user-badges').innerHTML = '<div style="text-align: center;">載入中...</div>';
            document.getElementById('modal-user-titles').innerHTML = '<div style="text-align: center;">載入中...</div>';
            
            userModal.style.display = 'block';

            try {
                // 獲取詳細的用戶資料
                const userDetails = await apiFetch(`/api/box/admin/users/${userId}/details`);
                
                // 更新基本資料
                document.getElementById('modal-username').textContent = `管理用戶: ${userDetails.username}`;
                document.getElementById('modal-user-id').textContent = userDetails.user_id;
                document.getElementById('modal-user-account').textContent = userDetails.username;
                document.getElementById('modal-user-display-name').textContent = userDetails.display_name || userDetails.username;
                document.getElementById('modal-user-email').textContent = userDetails.email || 'N/A';
                document.getElementById('modal-user-created-at').textContent = userDetails.created_at ? new Date(userDetails.created_at).toLocaleString() : 'N/A';
                
                // 更新頭像
                if (userDetails.user_profile_image_url) {
                    document.getElementById('modal-user-avatar').src = userDetails.user_profile_image_url;
                }

                // 獲取用戶的角色、徽章和頭銜
                const [userRoles, userBadges, userTitles] = await Promise.all([
                   apiFetch(`/api/box/users/${userId}/roles`),
                   apiFetch(`/api/box/users/${userId}/badges`),
                   apiFetch(`/api/box/users/${userId}/titles`)
                ]);

                // 為徽章和頭銜添加完整資訊
                const userBadgesWithDetails = userBadges.map(userBadge => {
                    const fullBadge = allBadges.find(b => b.badge_id === userBadge.badge_id) || userBadge;
                    return { ...userBadge, ...fullBadge };
                });

                const userTitlesWithDetails = userTitles.map(userTitle => {
                    const fullTitle = allTitles.find(t => t.title_id === userTitle.title_id) || userTitle;
                    return { ...userTitle, ...fullTitle };
                });

                // 渲染列表
                renderItemList('modal-user-roles', userRoles, 'role_id', 'role_name');
                renderItemList('modal-user-badges', userBadgesWithDetails, 'badge_id', 'badge_name');
                renderItemList('modal-user-titles', userTitlesWithDetails, 'title_id', 'title_name');
                
            } catch (error) {
                console.error(`Failed to load data for user ${userId}`, error);
                document.getElementById('modal-username').textContent = '載入失敗';
                document.getElementById('modal-user-roles').innerHTML = '<div style="color: red;">載入失敗</div>';
                document.getElementById('modal-user-badges').innerHTML = '<div style="color: red;">載入失敗</div>';
                document.getElementById('modal-user-titles').innerHTML = '<div style="color: red;">載入失敗</div>';
            }
        }

        function renderItemList(containerId, items, idKey, nameKey) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (items.length === 0) {
                container.textContent = '無';
                return;
            }
            
            // Special handling for badges to show images
            if (containerId === 'modal-user-badges') {
                items.forEach(item => {
                    const tag = document.createElement('div');
                    tag.className = 'item-tag';
                    tag.innerHTML = `
                        <img src="${item.badge_image_url || '/images/a01girlmove.gif'}" alt="${item[nameKey]}">
                        <span>${item[nameKey]}</span>
                        <button class="remove-btn" data-item-id="${item[idKey]}" data-type="${containerId.split('-')[2]}">&times;</button>
                    `;
                    container.appendChild(tag);
                });
                return;
            }
            
            // Special handling for titles
            if (containerId === 'modal-user-titles') {
                items.forEach(item => {
                    const tag = document.createElement('div');
                    tag.className = 'item-tag';
                    
                    // Add image if available
                    let imageHtml = '';
                    if (item.title_image_url) {
                        imageHtml = `<img src="${item.title_image_url}" alt="${item[nameKey]}" style="width: 50px; height: 50px; object-fit: contain; margin-bottom: 5px; border-radius: 50%;">`;
                    }
                    
                    tag.innerHTML = `
                        ${imageHtml}
                        <span>${item[nameKey]}</span>
                        <button class="remove-btn" data-item-id="${item[idKey]}" data-type="${containerId.split('-')[2]}">&times;</button>
                    `;
                    container.appendChild(tag);
                });
                return;
            }
            
            // Default rendering for other items
            items.forEach(item => {
                const tag = document.createElement('div');
                tag.className = 'item-tag';
                tag.innerHTML = `
                    <span>${item[nameKey]}</span>
                    <button class="remove-btn" data-item-id="${item[idKey]}" data-type="${containerId.split('-')[2]}">&times;</button>
                `;
                container.appendChild(tag);
            });
        }
        
        modalCloseBtn.addEventListener('click', () => userModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === userModal) {
                userModal.style.display = 'none';
            }
        });
        
        // --- Event Listeners Setup ---
        
        function setupEventListeners() {
            // Manage user button delegation
            userTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('manage-btn')) {
                    const userId = parseInt(e.target.dataset.userId, 10);
                    openUserModal(userId);
                }
            });
            
            // Badge image preview
            document.getElementById('badge-image').addEventListener('change', function(e) {
                const previewContainer = document.getElementById('badge-preview');
                previewContainer.innerHTML = '';
                
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100px';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Title image preview
            document.getElementById('title-image').addEventListener('change', function(e) {
                const previewContainer = document.getElementById('title-preview');
                previewContainer.innerHTML = '';
                
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100px';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Forms for creating global items
            document.getElementById('create-badge-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('badge-name').value;
                const description = document.getElementById('badge-description').value;
                const imageFile = document.getElementById('badge-image').files[0];
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('badgeName', name);
                formData.append('badgeDescription', description);
                
                // Only append image if one was selected
                if (imageFile) {
                    formData.append('badgeImage', imageFile);
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    // Use fetch directly instead of apiFetch for FormData
                    const response = await fetch('/api/box/admin/badges/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Upload failed' }));
                        throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    alert('徽章已創建！');
                    e.target.reset();
                    document.getElementById('badge-preview').innerHTML = '';
                    
                    // Refresh global list
                    allBadges = await apiFetch('/api/box/admin/badges');
                    renderBadgesList(allBadges);
                    populateSelect(document.getElementById('badge-select'), allBadges, 'badge_id', 'badge_name');
                } catch (error) {
                    alert(`創建徽章失敗: ${error.message}`);
                    console.error('Badge creation error:', error);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            });

            document.getElementById('create-title-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('title-name').value;
                const description = document.getElementById('title-description').value;
                const imageFile = document.getElementById('title-image').files[0];
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('titleName', name);
                formData.append('titleDescription', description);
                
                // Only append image if one was selected
                if (imageFile) {
                    formData.append('titleImage', imageFile);
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    // Use fetch directly instead of apiFetch for FormData
                    const response = await fetch('/api/box/admin/titles/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Upload failed' }));
                        throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    alert('頭銜已創建！');
                    e.target.reset();
                    document.getElementById('title-preview').innerHTML = '';
                    
                    // Refresh global list
                    allTitles = await apiFetch('/api/box/admin/titles');
                    renderTitlesList(allTitles);
                    populateSelect(document.getElementById('title-select'), allTitles, 'title_id', 'title_name');
                } catch (error) {
                    alert(`創建頭銜失敗: ${error.message}`);
                    console.error('Title creation error:', error);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            });
            
            // Forms for assigning items to users
            document.getElementById('assign-role-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const roleId = document.getElementById('role-select').value;
                await apiFetch(`/api/box/admin/users/${currentEditingUserId}/roles`, {
                    method: 'POST',
                    body: { roleId }
                });
                alert('角色已授予！');
                openUserModal(currentEditingUserId); // Refresh modal
            });
            
            document.getElementById('assign-badge-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const badgeId = document.getElementById('badge-select').value;
                await apiFetch(`/api/box/admin/users/${currentEditingUserId}/badges`, {
                    method: 'POST',
                    body: { badgeId }
                });
                alert('徽章已授予！');
                openUserModal(currentEditingUserId); // Refresh modal
            });
            
            document.getElementById('assign-title-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const titleId = document.getElementById('title-select').value;
                 await apiFetch(`/api/box/admin/users/${currentEditingUserId}/titles`, {
                    method: 'POST',
                    body: { titleId }
                });
                alert('頭銜已授予！');
                openUserModal(currentEditingUserId); // Refresh modal
            });

            // Modal item removal delegation
            userModal.addEventListener('click', async (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const button = e.target;
                    const itemId = button.dataset.itemId;
                    const itemType = button.dataset.type; // 'roles', 'badges', or 'titles'
                    
                    if (!confirm(`您確定要移除這個 ${itemType.slice(0, -1)} 嗎?`)) {
                        return;
                    }

                    try {
                        await apiFetch(`/api/box/admin/users/${currentEditingUserId}/${itemType}/${itemId}`, {
                            method: 'DELETE'
                        });
                        alert('項目已移除。');
                        openUserModal(currentEditingUserId); // Refresh modal to show changes
                    } catch (error) {
                        console.error(`Failed to remove item:`, error);
                        alert(`移除失敗: ${error.message}`);
                    }
                }
            });

            // Role form submission
            roleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const roleId = document.getElementById('role-id').value;
                const roleName = document.getElementById('role-name').value;
                const roleDescription = document.getElementById('role-description').value;

                const payload = { role_name: roleName, role_description: roleDescription };

                try {
                    if (roleId) {
                        // Update existing role
                        await apiFetch(`/api/box/admin/roles/${roleId}`, { method: 'PUT', body: payload });
                        alert('角色已更新！');
                    } else {
                        // Create new role
                        await apiFetch('/api/box/admin/roles', { method: 'POST', body: payload });
                        alert('角色已創建！');
                    }
                    
                    allRoles = await apiFetch('/api/box/admin/roles');
                    renderRolesList(allRoles);
                    populateSelect(document.getElementById('role-select'), allRoles, 'role_id', 'role_name');
                    resetRoleForm();

                } catch (error) {
                    console.error('保存角色失敗:', error);
                }
            });

            // Cancel role edit
            cancelEditRoleBtn.addEventListener('click', resetRoleForm);

            // Role list actions (Edit/Delete)
            rolesList.addEventListener('click', async (e) => {
                const target = e.target;
                const roleId = target.dataset.roleId;

                if (target.classList.contains('edit-role-btn')) {
                    const role = allRoles.find(r => r.role_id == roleId);
                    if (role) {
                        setupRoleFormForEdit(role);
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                }

                if (target.classList.contains('delete-role-btn')) {
                    if (confirm(`您確定要刪除這個角色嗎？此操作無法復原。`)) {
                        try {
                            await apiFetch(`/api/box/admin/roles/${roleId}`, { method: 'DELETE' });
                            alert('角色已刪除。');
                            allRoles = await apiFetch('/api/box/admin/roles');
                            renderRolesList(allRoles);
                            populateSelect(document.getElementById('role-select'), allRoles, 'role_id', 'role_name');
                        } catch (error) {
                             console.error('刪除角色失敗:', error);
                        }
                    }
                }
            });
        }
        
        // --- Role Management UI ---
        function renderRolesList(roles) {
            rolesList.innerHTML = '';
            roles.forEach(role => {
                const div = document.createElement('div');
                div.className = 'role-item';
                div.innerHTML = `
                    <span><strong>${role.role_name}</strong>: ${role.role_description || ''}</span>
                    <div class="role-actions">
                        <button class="btn btn-secondary edit-role-btn" data-role-id="${role.role_id}">編輯</button>
                        <button class="btn btn-danger delete-role-btn" data-role-id="${role.role_id}">刪除</button>
                    </div>
                `;
                rolesList.appendChild(div);
            });
        }

        function setupRoleFormForEdit(role) {
            document.getElementById('role-id').value = role.role_id;
            document.getElementById('role-name').value = role.role_name;
            document.getElementById('role-description').value = role.role_description || '';
            cancelEditRoleBtn.style.display = 'inline-block';
            roleForm.querySelector('button[type="submit"]').textContent = '更新角色';
        }

        function resetRoleForm() {
            roleForm.reset();
            document.getElementById('role-id').value = '';
            cancelEditRoleBtn.style.display = 'none';
            roleForm.querySelector('button[type="submit"]').textContent = '保存角色';
        }
        
        function renderBadgesList(badges) {
            const badgesList = document.getElementById('badges-list');
            badgesList.innerHTML = '';
            
            badges.forEach(badge => {
                const badgeItem = document.createElement('div');
                badgeItem.className = 'badge-item';
                badgeItem.innerHTML = `
                    <img src="${badge.badge_image_url || '/images/a01girlmove.gif'}" alt="${badge.badge_name}">
                    <div class="badge-name">${badge.badge_name}</div>
                    <div class="badge-description">${badge.badge_description || ''}</div>
                `;
                badgesList.appendChild(badgeItem);
            });
        }
        
        function renderTitlesList(titles) {
            const titlesList = document.getElementById('titles-list');
            titlesList.innerHTML = '';
            
            titles.forEach(title => {
                const titleItem = document.createElement('div');
                titleItem.className = 'title-item';
                
                // Add image if available
                let imageHtml = '';
                if (title.title_image_url) {
                    imageHtml = `<img src="${title.title_image_url}" alt="${title.title_name}" style="width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; border-radius: 50%;">`;
                }
                
                titleItem.innerHTML = `
                    ${imageHtml}
                    <div class="title-name">${title.title_name}</div>
                    <div class="title-description">${title.title_description || ''}</div>
                `;
                titlesList.appendChild(titleItem);
            });
        }
        
        // --- Start the App ---
        checkAdminAuth();
    });
    </script>
</body>
</html>
