<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員管理後台</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        /* 動畫效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 129, 161, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 129, 161, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 129, 161, 0); }
        }

        :root {
            --primary-color: #2196F3; /* 專業的藍色 */
            --secondary-color: #607D8B; /* 沉穩的灰藍色 */
            --accent-color: #1976D2; /* 深藍色，用於強調 */
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --light-color: #F5F5F5; /* 淺灰色背景 */
            --dark-color: #333333; /* 深灰色文字 */
            --background-color: #FFFFFF; /* 純白背景 */
            --surface-color: #FFFFFF;
            --border-color: #E0E0E0;
            --border-radius: 4px;
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --box-shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            margin: 0;
            padding: 20px;
            font-size: 14px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1, h2, h3, h4 {
            color: var(--dark-color);
            font-weight: 700;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            margin-bottom: 25px;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--dark-color);
            text-shadow: none;
        }
        
        .admin-header a {
            text-decoration: none;
            color: var(--accent-color);
            font-weight: 500;
            transition: color 0.3s;
        }
        .admin-header a:hover {
            color: var(--primary-color);
        }

        /* 頁籤樣式 */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
        }
        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--secondary-color);
            font-size: 1em;
            font-weight: 500;
            position: relative;
            transition: color 0.3s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--accent-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .tab-btn.active, .tab-btn:hover {
            color: var(--primary-color);
        }
        .tab-btn.active::after {
            transform: scaleX(1);
        }

        .tab-pane {
            display: none;
            animation: slideInUp 0.5s ease-out forwards;
        }
        .tab-pane.active {
            display: block;
        }
        
        .content-card {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            transition: box-shadow 0.3s;
        }
        .content-card:hover {
            box-shadow: var(--box-shadow-hover);
            transform: none;
        }

        .pane-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        /* 表格樣式 */
        #user-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        #user-table th {
            padding: 12px 16px;
            text-align: left;
            background-color: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
            border: none;
        }
        #user-table th:first-child { border-radius: var(--border-radius) 0 0 var(--border-radius); }
        #user-table th:last-child { border-radius: 0 var(--border-radius) var(--border-radius) 0; }
        
        #user-table td {
            padding: 12px 16px;
            background: var(--surface-color);
            vertical-align: middle;
            border: none;
            border-bottom: 1px solid var(--border-color);
        }
        #user-table td:first-child { border-left: 1px solid var(--border-color); border-radius: var(--border-radius) 0 0 var(--border-radius); }
        #user-table td:last-child { border-right: 1px solid var(--border-color); border-radius: 0 var(--border-radius) var(--border-radius) 0; }

        #user-table tbody tr {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: var(--border-radius);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #user-table tbody tr:hover {
            transform: scale(1.02);
            box-shadow: var(--box-shadow);
            z-index: 10;
            position: relative;
        }
        #user-table td img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 12px;
            border: none;
        }
        #user-table td img:hover {
            transform: scale(1.1);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .btn:active::before {
            width: 200px;
            height: 200px;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: var(--box-shadow); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        
        /* 表單樣式 */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark-color);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--surface-color);
            color: var(--dark-color);
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px var(--secondary-color);
        }
        
        /* Modal 彈窗樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(92, 60, 69, 0.5);
            backdrop-filter: blur(5px);
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--surface-color);
            margin: 4% auto;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 800px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 2em;
            font-weight: bold;
            color: var(--secondary-color);
            cursor: pointer;
            transition: transform 0.3s, color 0.3s;
        }
        .modal-close:hover {
            transform: rotate(90deg);
            color: var(--danger-color);
        }
        
        .section {
            margin-bottom: 25px;
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
        }
        .section:first-child {
            border-top: none;
            padding-top: 0;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .item-tag {
            background-color: var(--light-color);
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        .item-tag:hover {
            transform: none;
            background-color: #EEEEEE;
        }
        .item-tag .remove-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .item-tag .remove-btn:hover { opacity: 1; }
        
        #loading-overlay {
            display: none;
            position: fixed;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        #loading-overlay::before {
            content: '';
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        #loading-overlay p {
            font-size: 1.2em;
            color: var(--dark-color);
            font-weight: 500;
        }

        #roles-list .role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        #roles-list .role-item:last-child { border-bottom: none; }
        #roles-list .role-item:hover { background-color: var(--light-color); }
        #roles-list .role-actions button { margin-left: 8px; }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .badge-item, .title-item {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            background: var(--surface-color);
            box-shadow: var(--box-shadow);
            transition: all 0.2s ease;
        }
        .badge-item:hover, .title-item:hover {
            transform: none;
            box-shadow: var(--box-shadow-hover);
        }
        
        .item-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: var(--border-radius);
        }
        .badge-item:hover .item-actions,
        .title-item:hover .item-actions {
            opacity: 1;
        }
        .item-actions .btn {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 8px;
            min-width: auto;
        }

        .badge-item img, .title-item img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: var(--light-color);
            padding: 4px;
        }
        
        .badge-item .badge-name, .title-item .title-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .title-item .title-name { color: #6a1b9a; }
        
        .badge-item .badge-description, .title-item .title-description {
            font-size: 0.8em;
            color: var(--dark-color);
            opacity: 0.8;
        }
        
        #modal-user-badges, #modal-user-titles, #modal-user-roles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        #modal-user-badges .item-tag, #modal-user-titles .item-tag {
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        #modal-user-titles .item-tag { background-color: #f8f0ff; border: 1px solid #d8c0f0; }
        #modal-user-titles .item-tag span { color: #6a1b9a; font-weight: 500; }
        
        #modal-user-badges .item-tag img, #modal-user-titles .item-tag img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 5px;
            border-radius: 50%;
        }

        .user-info-section {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        
        .user-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 25px;
            align-items: center;
        }
        
        .user-avatar img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(255, 128, 161, 0.3);
            animation: pulse 2s infinite;
        }
        
        .user-details p { margin: 8px 0; }
        .user-details p strong { color: var(--primary-color); }
        
        @media (max-width: 992px) {
            .pane-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .admin-header { flex-direction: column; gap: 15px; }
            .admin-tabs { gap: 0; justify-content: space-around; }
            .tab-btn { padding: 10px 15px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" style="display: flex;">
        <p>正在驗證您的管理員身份...</p>
    </div>

    <div id="admin-container" class="container" style="display: none;">
        

        <nav class="admin-tabs">
            <button class="tab-btn active" data-tab="users">會員管理</button>
            <button class="tab-btn" data-tab="roles">角色管理</button>
            <button class="tab-btn" data-tab="badges">徽章管理</button>
            <button class="tab-btn" data-tab="titles">頭銜管理</button>
        </nav>

        <main class="admin-content">
            <!-- 會員管理頁籤 -->
            <div id="users-tab" class="tab-pane active">
                <div class="content-card">
                    <h2 class="h4">會員列表</h2>
                    <div class="form-group" style="width: 300px;">
                         <input type="text" id="user-search" placeholder="搜尋用戶名稱...">
                    </div>
                    <table id="user-table">
                        <thead>
                            <tr>
                                <th>帳號</th>
                                <th>顯示名稱</th>
                                <th>角色</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <!-- 用戶數據將動態插入此處 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 角色管理頁籤 -->
            <div id="roles-tab" class="tab-pane">
                <div class="pane-grid">
                    <div class="content-card">
                        <h3>新增 / 編輯角色</h3>
                        <form id="role-form">
                            <input type="hidden" id="role-id">
                            <div class="form-group">
                                <label for="role-name">角色名稱</label>
                                <input type="text" id="role-name" required>
                            </div>
                            <div class="form-group">
                                <label for="role-description">描述</label>
                                <input type="text" id="role-description">
                            </div>
                            <button type="submit" class="btn btn-primary">保存角色</button>
                            <button type="button" id="cancel-edit-role-btn" class="btn btn-secondary" style="display: none;">取消編輯</button>
                        </form>
                    </div>
                    <div class="content-card">
                        <h3>現有角色列表</h4>
                        <div id="roles-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- 徽章管理頁籤 -->
            <div id="badges-tab" class="tab-pane">
                 <div class="pane-grid">
                    <div class="content-card">
                        <h3>創建新徽章</h3>
                        <form id="create-badge-form">
                            <input type="hidden" id="badge-id">
                            <div class="form-group">
                                <label for="badge-name">徽章名稱</label>
                                <input type="text" id="badge-name" required>
                            </div>
                            <div class="form-group">
                                <label for="badge-description">描述</label>
                                <input type="text" id="badge-description">
                            </div>
                            <div class="form-group">
                                <label for="badge-image">徽章圖片</label>
                                <input type="file" id="badge-image" accept="image/*">
                                <div id="badge-preview" style="margin-top: 10px; max-width: 100px; max-height: 100px; overflow: hidden;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">創建徽章</button>
                            <button type="button" id="cancel-edit-badge-btn" class="btn btn-secondary" style="display: none;">取消編輯</button>
                        </form>
                    </div>
                     <div class="content-card">
                        <h3>現有徽章列表</h3>
                        <div id="badges-list" class="item-grid"></div>
                    </div>
                </div>
            </div>
            
            <!-- 頭銜管理頁籤 -->
            <div id="titles-tab" class="tab-pane">
                <div class="pane-grid">
                    <div class="content-card">
                        <h3>創建新頭銜</h3>
                        <form id="create-title-form">
                            <input type="hidden" id="title-id">
                             <div class="form-group">
                                <label for="title-name">頭銜名稱</label>
                                <input type="text" id="title-name" required>
                            </div>
                            <div class="form-group">
                                <label for="title-description">描述</label>
                                <input type="text" id="title-description">
                            </div>
                            <div class="form-group">
                                <label for="title-image">頭銜圖片 (選填)</label>
                                <input type="file" id="title-image" accept="image/*">
                                <div id="title-preview" style="margin-top: 10px; max-width: 100px; max-height: 100px; overflow: hidden;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">創建頭銜</button>
                            <button type="button" id="cancel-edit-title-btn" class="btn btn-secondary" style="display: none;">取消編輯</button>
                        </form>
                    </div>
                    <div class="content-card">
                        <h3>現有頭銜列表</h3>
                        <div id="titles-list" class="item-grid"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 用戶管理 Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="modal-username">管理用戶</h2>
            
            <div class="section user-info-section">
                <h3>用戶資料</h3>
                <div class="user-info-grid">
                    <div class="user-avatar">
                        <img id="modal-user-avatar" src="/images/a01girlmove.gif" alt="用戶頭像">
                    </div>
                    <div class="user-details">
                        <p><strong>用戶ID:</strong> <span id="modal-user-id"></span></p>
                        <p><strong>帳號:</strong> <span id="modal-user-account"></span></p>
                        <p><strong>顯示名稱:</strong> <span id="modal-user-display-name"></span></p>
                        <p><strong>Email:</strong> <span id="modal-user-email"></span></p>
                        <p><strong>註冊時間:</strong> <span id="modal-user-created-at"></span></p>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 15px;">
                    <button id="delete-user-btn" class="btn btn-danger">刪除會員</button>
                </div>
            </div>

            <div class="section">
                <h3>角色管理</h3>
                <div class="item-list" id="modal-user-roles"></div>
                <form id="assign-role-form" class="form-group" style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                    <select id="role-select" style="flex-grow: 1;"></select>
                    <button type="submit" class="btn btn-primary">授予角色</button>
                </form>
            </div>
            
            <div class="section">
                <h3>徽章管理</h3>
                <div class="item-list" id="modal-user-badges"></div>
                <form id="assign-badge-form" class="form-group" style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                    <select id="badge-select" style="flex-grow: 1;"></select>
                    <button type="submit" class="btn btn-primary">授予徽章</button>
                </form>
            </div>

            <div class="section">
                <h3>頭銜管理</h3>
                <div class="item-list" id="modal-user-titles"></div>
                <form id="assign-title-form" class="form-group" style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                    <select id="title-select" style="flex-grow: 1;"></select>
                    <button type="submit" class="btn btn-primary">授予頭銜</button>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = loadingOverlay.querySelector('p');
        const adminContainer = document.getElementById('admin-container');
        const userTableBody = document.getElementById('user-table-body');
        const userSearchInput = document.getElementById('user-search');
        
        // Tab elements
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // Modal elements
        const userModal = document.getElementById('user-modal');
        const modalCloseBtn = userModal.querySelector('.modal-close');
        
        let allUsers = [];
        let allRoles = [];
        let allBadges = [];
        let allTitles = [];
        let currentEditingUserId = null;
        let authToken = null;
        
        // Element references from new structure
        const roleForm = document.querySelector('#roles-tab #role-form');
        const rolesList = document.querySelector('#roles-tab #roles-list');
        const cancelEditRoleBtn = document.querySelector('#roles-tab #cancel-edit-role-btn');
        const createBadgeForm = document.querySelector('#badges-tab #create-badge-form');
        const createTitleForm = document.querySelector('#titles-tab #create-title-form');
        const badgesListContainer = document.querySelector('#badges-tab #badges-list');
        const titlesListContainer = document.querySelector('#titles-tab #titles-list');
        const cancelEditBadgeBtn = document.getElementById('cancel-edit-badge-btn');
        const cancelEditTitleBtn = document.getElementById('cancel-edit-title-btn');


        // --- API & Auth ---
        
        async function apiFetch(url, options = {}) {
            loadingOverlay.style.display = 'flex';
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            const mergedOptions = { ...defaultOptions, ...options };
            if (options.body && typeof options.body !== 'string') {
                mergedOptions.body = JSON.stringify(options.body);
            }

            try {
                const response = await fetch(url, mergedOptions);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Request failed' }));
                    throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                }
                if (response.status === 204) return null;
                return await response.json();
            } catch (error) {
                alert(`API 錯誤: ${error.message}`);
                throw error;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function checkAdminAuth() {
            const adminUserId = localStorage.getItem('boxCurrentUserId');
            authToken = localStorage.getItem(`boxUserToken_${adminUserId}`);
            if (!authToken) {
                loadingText.textContent = '請先登入管理員帳號。';
                setTimeout(() => window.location.href = 'box.html', 2000);
                return;
            }

            try {
                await apiFetch('/api/box/admin/auth/check');
                adminContainer.style.display = 'block';
                loadingOverlay.style.display = 'none';
                initializeApp();
            } catch (error) {
                loadingText.textContent = '管理員身份驗證失敗，請重新登入。';
                console.error("Admin auth failed:", error);
                setTimeout(() => window.location.href = 'box.html', 2000);
            }
        }

        // --- Page Initialization ---

        async function initializeApp() {
            try {
                loadingText.textContent = '正在載入後台資料...';
                [allUsers, allRoles, allBadges, allTitles] = await Promise.all([
                    apiFetch('/api/box/admin/users'),
                    apiFetch('/api/box/admin/roles'),
                    apiFetch('/api/box/admin/badges'),
                    apiFetch('/api/box/admin/titles') 
                ]);
                
                renderUserTable(allUsers);
                renderRolesList(allRoles);
                renderBadgesList(allBadges);
                renderTitlesList(allTitles);
                populateGlobalSelectors();
                setupEventListeners();
                
            } catch (error) {
                console.error("Initialization failed:", error);
                alert("無法載入後台初始數據。");
            }
        }
        
        function populateGlobalSelectors() {
            populateSelect(document.getElementById('role-select'), allRoles, 'role_id', 'role_name');
            populateSelect(document.getElementById('badge-select'), allBadges, 'badge_id', 'badge_name');
            populateSelect(document.getElementById('title-select'), allTitles, 'title_id', 'title_name');
        }
        
        function populateSelect(selectElement, items, valueKey, textKey) {
             selectElement.innerHTML = '<option value="">請選擇...</option>';
             items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                selectElement.appendChild(option);
            });
        }

        // --- User Table ---

        function renderUserTable(users) {
            userTableBody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <img src="${user.user_profile_image_url || '/images/a01girlmove.gif'}" alt="${user.username}">
                        ${user.username}
                    </td>
                    <td>${user.display_name || user.username}</td>
                    <td id="user-roles-${user.user_id}">載入中...</td>
                    <td><button class="btn btn-primary manage-btn" data-user-id="${user.user_id}">管理</button></td>
                `;
                userTableBody.appendChild(tr);
                fetchUserRoles(user.user_id);
            });
        }
        
        async function fetchUserRoles(userId) {
            try {
                const userRoles = await apiFetch(`/api/box/users/${userId}/roles`);
                const rolesCell = document.getElementById(`user-roles-${userId}`);
                if (rolesCell) {
                    if (userRoles.length > 0) {
                        rolesCell.textContent = userRoles.map(role => role.role_name).join(', ');
                    } else {
                        rolesCell.textContent = '無';
                    }
                }
            } catch (error) {
                console.error(`Failed to load roles for user ${userId}:`, error);
                const rolesCell = document.getElementById(`user-roles-${userId}`);
                if (rolesCell) {
                    rolesCell.textContent = '載入失敗';
                }
            }
        }
        
        userSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => user.username.toLowerCase().includes(searchTerm));
            renderUserTable(filteredUsers);
        });

        // --- Modal Management ---

        async function openUserModal(userId) {
            currentEditingUserId = userId;
            
            document.getElementById('modal-username').textContent = '載入中...';
            document.getElementById('modal-user-id').textContent = '';
            document.getElementById('modal-user-account').textContent = '';
            document.getElementById('modal-user-display-name').textContent = '';
            document.getElementById('modal-user-email').textContent = '';
            document.getElementById('modal-user-created-at').textContent = '';
            document.getElementById('modal-user-avatar').src = '/images/a01girlmove.gif';
            
            document.getElementById('modal-user-roles').innerHTML = '載入中...';
            document.getElementById('modal-user-badges').innerHTML = '載入中...';
            document.getElementById('modal-user-titles').innerHTML = '載入中...';
            
            userModal.style.display = 'block';

            try {
                const userDetails = await apiFetch(`/api/box/admin/users/${userId}/details`);
                
                document.getElementById('modal-username').textContent = `管理用戶: ${userDetails.username}`;
                document.getElementById('modal-user-id').textContent = userDetails.user_id;
                document.getElementById('modal-user-account').textContent = userDetails.username;
                document.getElementById('modal-user-display-name').textContent = userDetails.display_name || userDetails.username;
                document.getElementById('modal-user-email').textContent = userDetails.email || 'N/A';
                document.getElementById('modal-user-created-at').textContent = userDetails.created_at ? new Date(userDetails.created_at).toLocaleString() : 'N/A';
                if (userDetails.user_profile_image_url) {
                    document.getElementById('modal-user-avatar').src = userDetails.user_profile_image_url;
                }

                const [userRoles, userBadges, userTitles] = await Promise.all([
                   apiFetch(`/api/box/users/${userId}/roles`),
                   apiFetch(`/api/box/users/${userId}/badges`),
                   apiFetch(`/api/box/users/${userId}/titles`)
                ]);

                const userBadgesWithDetails = userBadges.map(userBadge => {
                    return { ...userBadge, ...allBadges.find(b => b.badge_id === userBadge.badge_id) };
                });
                const userTitlesWithDetails = userTitles.map(userTitle => {
                    return { ...userTitle, ...allTitles.find(t => t.title_id === userTitle.title_id) };
                });

                renderItemList('modal-user-roles', userRoles, 'role_id', 'role_name');
                renderItemList('modal-user-badges', userBadgesWithDetails, 'badge_id', 'badge_name');
                renderItemList('modal-user-titles', userTitlesWithDetails, 'title_id', 'title_name');
                
            } catch (error) {
                console.error(`Failed to load data for user ${userId}`, error);
                document.getElementById('modal-username').textContent = '載入失敗';
            }
        }

        function renderItemList(containerId, items, idKey, nameKey) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (items.length === 0) {
                container.textContent = '無';
                return;
            }
            
            items.forEach(item => {
                const tag = document.createElement('div');
                tag.className = 'item-tag';
                let content = `<span>${item[nameKey]}</span>`;

                if (containerId.includes('badges') && item.badge_image_url) {
                    content = `<img src="${item.badge_image_url}" alt="${item[nameKey]}">` + content;
                }
                if (containerId.includes('titles') && item.title_image_url) {
                    content = `<img src="${item.title_image_url}" alt="${item[nameKey]}">` + content;
                }
                
                tag.innerHTML = `${content}<button class="remove-btn" data-item-id="${item[idKey]}" data-type="${containerId.split('-')[2]}">&times;</button>`;
                container.appendChild(tag);
            });
        }
        
        modalCloseBtn.addEventListener('click', () => userModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === userModal) userModal.style.display = 'none';
        });
        
        // --- Event Listeners Setup ---
        
        function setupEventListeners() {
            // Tab switching
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    tabPanes.forEach(pane => {
                        pane.classList.toggle('active', pane.id === `${btn.dataset.tab}-tab`);
                    });
                });
            });

            userTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('manage-btn')) {
                    openUserModal(parseInt(e.target.dataset.userId, 10));
                }
            });
            
            // Image previews
            document.getElementById('badge-image').addEventListener('change', (e) => previewImage(e.target, 'badge-preview'));
            document.getElementById('title-image').addEventListener('change', (e) => previewImage(e.target, 'title-preview'));
            
            function previewImage(input, previewId) {
                const previewContainer = document.getElementById(previewId);
                previewContainer.innerHTML = '';
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.cssText = 'max-width: 100%; max-height: 100px; border-radius: 8px;';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            // Create/Update forms
            createBadgeForm.addEventListener('submit', handleBadgeFormSubmit);
            createTitleForm.addEventListener('submit', handleTitleFormSubmit);

            async function handleBadgeFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const badgeId = document.getElementById('badge-id').value;
                const itemName = '徽章';
                
                const formData = new FormData();
                formData.append('badgeName', document.getElementById('badge-name').value);
                formData.append('badgeDescription', document.getElementById('badge-description').value);
                const imageFile = document.getElementById('badge-image').files[0];
                if (imageFile) {
                    formData.append('badgeImage', imageFile);
                }

                const method = badgeId ? 'PUT' : 'POST';
                // The create endpoint is specific, so we adjust the URL
                const url = badgeId ? `/api/box/admin/badges/${badgeId}` : '/api/box/admin/badges/upload';

                try {
                    loadingOverlay.style.display = 'flex';
                    // Use fetch directly for FormData
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                     if (!response.ok) {
                        const err = await response.json().catch(() => ({error: `HTTP ${response.status}`}));
                        throw new Error(err.error);
                    }

                    alert(`${itemName}已${badgeId ? '更新' : '創建'}！`);
                    resetBadgeForm();
                    
                    allBadges = await apiFetch('/api/box/admin/badges');
                    renderBadgesList(allBadges);
                    populateSelect(document.getElementById('badge-select'), allBadges, 'badge_id', 'badge_name');

                } catch (error) {
                    alert(`處理${itemName}失敗: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            async function handleTitleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const titleId = document.getElementById('title-id').value;
                const itemName = '頭銜';

                const formData = new FormData();
                formData.append('titleName', document.getElementById('title-name').value);
                formData.append('titleDescription', document.getElementById('title-description').value);
                const imageFile = document.getElementById('title-image').files[0];
                if (imageFile) {
                    formData.append('titleImage', imageFile);
                }

                const method = titleId ? 'PUT' : 'POST';
                const url = titleId ? `/api/box/admin/titles/${titleId}` : '/api/box/admin/titles/upload';

                try {
                    loadingOverlay.style.display = 'flex';
                     const response = await fetch(url, {
                        method: method,
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                     if (!response.ok) {
                        const err = await response.json().catch(() => ({error: `HTTP ${response.status}`}));
                        throw new Error(err.error);
                    }

                    alert(`${itemName}已${titleId ? '更新' : '創建'}！`);
                    resetTitleForm();

                    allTitles = await apiFetch('/api/box/admin/titles');
                    renderTitlesList(allTitles);
                    populateSelect(document.getElementById('title-select'), allTitles, 'title_id', 'title_name');
                } catch (error) {
                    alert(`處理${itemName}失敗: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            cancelEditBadgeBtn.addEventListener('click', resetBadgeForm);
            cancelEditTitleBtn.addEventListener('click', resetTitleForm);

            // Item list actions (edit/delete)
            badgesListContainer.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-badge-btn');
                const deleteBtn = e.target.closest('.delete-badge-btn');
                
                if (editBtn) {
                    const badgeId = editBtn.dataset.badgeId;
                    const badge = allBadges.find(b => b.badge_id == badgeId);
                    if (badge) setupBadgeFormForEdit(badge);
                }
                
                if (deleteBtn) {
                    const badgeId = deleteBtn.dataset.badgeId;
                    if (confirm('您確定要刪除這個徽章嗎？')) {
                        await apiFetch(`/api/box/admin/badges/${badgeId}`, { method: 'DELETE' });
                        alert('徽章已刪除');
                        allBadges = await apiFetch('/api/box/admin/badges');
                        renderBadgesList(allBadges);
                        populateSelect(document.getElementById('badge-select'), allBadges, 'badge_id', 'badge_name');
                    }
                }
            });

            titlesListContainer.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-title-btn');
                const deleteBtn = e.target.closest('.delete-title-btn');
                
                if (editBtn) {
                    const titleId = editBtn.dataset.titleId;
                    const title = allTitles.find(t => t.title_id == titleId);
                    if (title) setupTitleFormForEdit(title);
                }
                
                if (deleteBtn) {
                    const titleId = deleteBtn.dataset.titleId;
                    if (confirm('您確定要刪除這個頭銜嗎？')) {
                        await apiFetch(`/api/box/admin/titles/${titleId}`, { method: 'DELETE' });
                        alert('頭銜已刪除');
                        allTitles = await apiFetch('/api/box/admin/titles');
                        renderTitlesList(allTitles);
                        populateSelect(document.getElementById('title-select'), allTitles, 'title_id', 'title_name');
                    }
                }
            });

            // Forms for creating global items
            createBadgeForm.addEventListener('submit', handleBadgeFormSubmit);
            createTitleForm.addEventListener('submit', handleTitleFormSubmit);

            async function handleCreateItem(e) {
                e.preventDefault();
                const form = e.target;
                const isBadge = form.id === 'create-badge-form';
                const endpoint = isBadge ? '/api/box/admin/badges/upload' : '/api/box/admin/titles/upload';
                const itemName = isBadge ? '徽章' : '頭銜';

                const formData = new FormData(form); // Use FormData directly
                if (isBadge) {
                    formData.append('badgeName', form.querySelector('#badge-name').value);
                    formData.append('badgeDescription', form.querySelector('#badge-description').value);
                    formData.append('badgeImage', form.querySelector('#badge-image').files[0]);
                } else {
                    formData.append('titleName', form.querySelector('#title-name').value);
                    formData.append('titleDescription', form.querySelector('#title-description').value);
                    formData.append('titleImage', form.querySelector('#title-image').files[0]);
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                    if (!response.ok) {
                        const err = await response.json().catch(() => ({error: `HTTP ${response.status}`}));
                        throw new Error(err.error);
                    }
                    
                    alert(`${itemName}已創建！`);
                    form.reset();
                    document.getElementById(isBadge ? 'badge-preview' : 'title-preview').innerHTML = '';
                    
                    if (isBadge) {
                        allBadges = await apiFetch('/api/box/admin/badges');
                        renderBadgesList(allBadges);
                        populateSelect(document.getElementById('badge-select'), allBadges, 'badge_id', 'badge_name');
                    } else {
                        allTitles = await apiFetch('/api/box/admin/titles');
                        renderTitlesList(allTitles);
                        populateSelect(document.getElementById('title-select'), allTitles, 'title_id', 'title_name');
                    }
                } catch (error) {
                    alert(`創建${itemName}失敗: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            // Assign forms
            document.getElementById('assign-role-form').addEventListener('submit', (e) => handleAssign(e, 'roles'));
            document.getElementById('assign-badge-form').addEventListener('submit', (e) => handleAssign(e, 'badges'));
            document.getElementById('assign-title-form').addEventListener('submit', (e) => handleAssign(e, 'titles'));

            async function handleAssign(e, type) {
                e.preventDefault();
                const selectId = type.slice(0, -1) + '-select';
                const selectedId = document.getElementById(selectId).value;
                const bodyKey = type.slice(0, -1) + 'Id';

                if (!selectedId) {
                    alert('請選擇一個項目！');
                    return;
                }
                
                await apiFetch(`/api/box/admin/users/${currentEditingUserId}/${type}`, {
                    method: 'POST',
                    body: { [bodyKey]: selectedId }
                });
                alert('項目已授予！');
                openUserModal(currentEditingUserId);
            }

            // Modal item removal
            userModal.addEventListener('click', async (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const { itemId, type } = e.target.dataset;
                    if (!confirm(`您確定要移除這個 ${type.slice(0, -1)} 嗎?`)) return;

                    await apiFetch(`/api/box/admin/users/${currentEditingUserId}/${type}/${itemId}`, { method: 'DELETE' });
                    alert('項目已移除。');
                    openUserModal(currentEditingUserId);
                }
            });

            // Role form submission
            roleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const roleId = document.getElementById('role-id').value;
                const payload = { 
                    role_name: document.getElementById('role-name').value,
                    role_description: document.getElementById('role-description').value
                };

                const method = roleId ? 'PUT' : 'POST';
                const url = roleId ? `/api/box/admin/roles/${roleId}` : '/api/box/admin/roles';
                
                await apiFetch(url, { method, body: payload });
                alert(`角色已${roleId ? '更新' : '創建'}！`);
                
                allRoles = await apiFetch('/api/box/admin/roles');
                renderRolesList(allRoles);
                populateSelect(document.getElementById('role-select'), allRoles, 'role_id', 'role_name');
                resetRoleForm();
            });

            cancelEditRoleBtn.addEventListener('click', resetRoleForm);

            // Role list actions
            rolesList.addEventListener('click', async (e) => {
                const { roleId } = e.target.dataset;
                if (e.target.classList.contains('edit-role-btn')) {
                    const role = allRoles.find(r => r.role_id == roleId);
                    if (role) setupRoleFormForEdit(role);
                }
                if (e.target.classList.contains('delete-role-btn')) {
                    if (confirm(`您確定要刪除這個角色嗎？`)) {
                        await apiFetch(`/api/box/admin/roles/${roleId}`, { method: 'DELETE' });
                        alert('角色已刪除。');
                        allRoles = await apiFetch('/api/box/admin/roles');
                        renderRolesList(allRoles);
                        populateSelect(document.getElementById('role-select'), allRoles, 'role_id', 'role_name');
                    }
                }
            });

            // Delete user button
            document.getElementById('delete-user-btn').addEventListener('click', async () => {
                if (!currentEditingUserId) return;
                const username = document.getElementById('modal-user-account').textContent;
                if (!confirm(`您確定要刪除會員 "${username}" 嗎？此操作無法復原！`)) return;
                
                const confirmText = prompt(`請輸入會員帳號 "${username}" 以確認刪除：`);
                if (confirmText !== username) {
                    alert('帳號輸入不正確，已取消刪除。');
                    return;
                }
                
                await apiFetch(`/api/box/admin/users/${currentEditingUserId}`, { method: 'DELETE' });
                alert('會員已成功刪除。');
                userModal.style.display = 'none';
                allUsers = await apiFetch('/api/box/admin/users');
                renderUserTable(allUsers);
            });
        }
        
        // --- UI Helper Functions ---
        function renderRolesList(roles) {
            rolesList.innerHTML = '';
            roles.forEach(role => {
                const div = document.createElement('div');
                div.className = 'role-item';
                div.innerHTML = `
                    <span><strong>${role.role_name}</strong>: ${role.role_description || ''}</span>
                    <div class="role-actions">
                        <button class="btn btn-secondary edit-role-btn" data-role-id="${role.role_id}">編輯</button>
                        <button class="btn btn-danger delete-role-btn" data-role-id="${role.role_id}">刪除</button>
                    </div>
                `;
                rolesList.appendChild(div);
            });
        }

        function setupRoleFormForEdit(role) {
            document.getElementById('role-id').value = role.role_id;
            document.getElementById('role-name').value = role.role_name;
            document.getElementById('role-description').value = role.role_description || '';
            cancelEditRoleBtn.style.display = 'inline-block';
            roleForm.querySelector('button[type="submit"]').textContent = '更新角色';
        }

        function resetRoleForm() {
            roleForm.reset();
            document.getElementById('role-id').value = '';
            cancelEditRoleBtn.style.display = 'none';
            roleForm.querySelector('button[type="submit"]').textContent = '保存角色';
        }
        
        function renderBadgesList(badges) {
            badgesListContainer.innerHTML = '';
            badges.forEach(badge => {
                const item = document.createElement('div');
                item.className = 'badge-item';
                item.innerHTML = `
                    <div class="item-actions">
                        <button class="btn btn-secondary edit-badge-btn" data-badge-id="${badge.badge_id}">編</button>
                        <button class="btn btn-danger delete-badge-btn" data-badge-id="${badge.badge_id}">刪</button>
                    </div>
                    <img src="${badge.badge_image_url || '/images/a01girlmove.gif'}" alt="${badge.badge_name}">
                    <div class="badge-name">${badge.badge_name}</div>
                    <div class="badge-description">${badge.badge_description || ''}</div>
                `;
                badgesListContainer.appendChild(item);
            });
        }
        
        function setupBadgeFormForEdit(badge) {
            document.getElementById('badge-id').value = badge.badge_id;
            document.getElementById('badge-name').value = badge.badge_name;
            document.getElementById('badge-description').value = badge.badge_description || '';
            
            const preview = document.getElementById('badge-preview');
            preview.innerHTML = '';
            if (badge.badge_image_url) {
                const img = document.createElement('img');
                img.src = badge.badge_image_url;
                img.style.cssText = 'max-width: 100%; max-height: 100px; border-radius: 8px;';
                preview.appendChild(img);
            }

            cancelEditBadgeBtn.style.display = 'inline-block';
            createBadgeForm.querySelector('button[type="submit"]').textContent = '更新徽章';
        }

        function resetBadgeForm() {
            createBadgeForm.reset();
            document.getElementById('badge-id').value = '';
            document.getElementById('badge-preview').innerHTML = '';
            cancelEditBadgeBtn.style.display = 'none';
            createBadgeForm.querySelector('button[type="submit"]').textContent = '創建徽章';
        }

        function renderTitlesList(titles) {
            titlesListContainer.innerHTML = '';
            titles.forEach(title => {
                const item = document.createElement('div');
                item.className = 'title-item';
                let imgHtml = title.title_image_url ? `<img src="${title.title_image_url}" alt="${title.title_name}">` : '';
                item.innerHTML = `
                     <div class="item-actions">
                        <button class="btn btn-secondary edit-title-btn" data-title-id="${title.title_id}">編</button>
                        <button class="btn btn-danger delete-title-btn" data-title-id="${title.title_id}">刪</button>
                    </div>
                    ${imgHtml}
                    <div class="title-name">${title.title_name}</div>
                    <div class="title-description">${title.title_description || ''}</div>
                `;
                titlesListContainer.appendChild(item);
            });
        }
        
        function setupTitleFormForEdit(title) {
            document.getElementById('title-id').value = title.title_id;
            document.getElementById('title-name').value = title.title_name;
            document.getElementById('title-description').value = title.title_description || '';

            const preview = document.getElementById('title-preview');
            preview.innerHTML = '';
            if (title.title_image_url) {
                const img = document.createElement('img');
                img.src = title.title_image_url;
                img.style.cssText = 'max-width: 100%; max-height: 100px; border-radius: 8px;';
                preview.appendChild(img);
            }

            cancelEditTitleBtn.style.display = 'inline-block';
            createTitleForm.querySelector('button[type="submit"]').textContent = '更新頭銜';
        }

        function resetTitleForm() {
            createTitleForm.reset();
            document.getElementById('title-id').value = '';
            document.getElementById('title-preview').innerHTML = '';
            cancelEditTitleBtn.style.display = 'none';
            createTitleForm.querySelector('button[type="submit"]').textContent = '創建頭銜';
        }
        
        // --- Start the App ---
        checkAdminAuth();
    });
    </script>
</body>
</html>
