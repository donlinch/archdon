<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>留言板</h1>

        <!-- 留言表單 -->
        <div>
            <label for="author_name">你的名稱：</label>
            <input type="text" id="author_name" v-model="newMessage.author_name" placeholder="請輸入你的名稱">
            
            <label for="message_title">留言標題：</label>
            <input type="text" id="message_title" v-model="newMessage.title" placeholder="請輸入標題">
            
            <label for="message_content">留言內容：</label>
            <textarea id="message_content" v-model="newMessage.content" placeholder="請輸入留言內容"></textarea>
            
            <button @click="submitMessage">提交留言</button>
        </div>

        <!-- 留言列表 -->
        <div v-if="messages.length > 0">
            <h2>所有留言</h2>
            <div v-for="message in messages" :key="message.id" class="message-item">
                <div class="message-title" @click="showMessageDetail(message.id)">
                    <strong>{{ message.title }}</strong> - {{ message.author_name }} ({{ message.created_at }})
                </div>
                <div v-if="message.showReplies" class="message-replies">
                    <div v-for="reply in message.replies" :key="reply.id" class="message-reply">
                        <p><strong>{{ reply.author_name }}:</strong> {{ reply.content }}</p>
                    </div>
                    <textarea v-model="newReply.content" placeholder="回覆留言"></textarea>
                    <button @click="replyMessage(message.id)">回覆留言</button>
                </div>
            </div>
        </div>

        <!-- 分頁功能 -->
        <div class="pagination">
            <button @click="changePage(currentPage - 1)" :disabled="currentPage === 1">上一頁</button>
            <span>第 {{ currentPage }} 頁 / 共 {{ totalPages }} 頁</span>
            <button @click="changePage(currentPage + 1)" :disabled="currentPage === totalPages">下一頁</button>
        </div>

        <!-- 留言詳情模態 -->
        <div v-if="showModal" class="modal">
            <div class="modal-content">
                <h2>{{ currentMessage.title }}</h2>
                <p><strong>作者：</strong>{{ currentMessage.author_name }}</p>
                <p><strong>時間：</strong>{{ currentMessage.created_at }}</p>
                <p>{{ currentMessage.content }}</p>
                <button @click="toggleReplies">{{ showRepliesText }}</button>
                <button @click="closeModal">關閉</button>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                messages: [],
                newMessage: {
                    author_name: '',
                    title: '',
                    content: ''
                },
                newReply: {
                    content: ''
                },
                showModal: false,
                currentMessage: {},
                showRepliesText: '查看回覆',
                currentPage: 1,
                totalPages: 1
            },
            mounted() {
                this.fetchMessages();
            },
            methods: {
                fetchMessages() {
                    axios.get('/api/guestbook', { 
                        params: { 
                            page: this.currentPage, 
                            limit: 10, 
                            sort: 'latest' 
                        } 
                    })
                        .then(response => {
                            this.messages = response.data.messages;
                            this.totalPages = response.data.totalPages;
                            this.messages.forEach(message => {
                                message.showReplies = false;
                                message.replies = [];
                            });
                        })
                        .catch(error => {
                            console.error("獲取留言時出錯:", error);
                        });
                },
                submitMessage() {
                    if (!this.newMessage.author_name || !this.newMessage.title || !this.newMessage.content) {
                        alert('所有欄位都必須填寫');
                        return;
                    }

                    axios.post('/api/guestbook', this.newMessage)
                        .then(response => {
                            this.messages.push(response.data);
                            this.newMessage = { author_name: '', title: '', content: '' };
                        })
                        .catch(error => {
                            console.error("發表留言時出錯:", error);
                        });
                },
                showMessageDetail(id) {
                    axios.get(`/api/guestbook/message/${id}`)
                        .then(response => {
                            this.currentMessage = response.data.message;
                            this.currentMessage.replies = response.data.replies;
                            this.showModal = true;
                        })
                        .catch(error => {
                            console.error("獲取留言詳情時出錯:", error);
                        });
                },
                toggleReplies() {
                    this.currentMessage.showReplies = !this.currentMessage.showReplies;
                    this.showRepliesText = this.currentMessage.showReplies ? '隱藏回覆' : '查看回覆';
                },
                closeModal() {
                    this.showModal = false;
                    this.currentMessage = {};
                },
                replyMessage(messageId) {
                    if (!this.newReply.content) {
                        alert('回覆內容不能為空');
                        return;
                    }

                    axios.post('/api/guestbook/replies', {
                        message_id: messageId,
                        content: this.newReply.content,
                        author_name: '管理員'  // 此處可以設置為當前登入用戶的名稱
                    })
                    .then(response => {
                        this.messages.forEach(msg => {
                            if (msg.id === messageId) {
                                msg.replies.push(response.data);
                            }
                        });
                        this.newReply.content = '';
                    })
                    .catch(error => {
                        console.error("回覆留言時出錯:", error);
                    });
                },
                changePage(page) {
                    if (page < 1 || page > this.totalPages) return;
                    this.currentPage = page;
                    this.fetchMessages();
                }
            }
        });
    </script>
</body>
</html>
