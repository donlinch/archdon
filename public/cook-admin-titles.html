<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>稱號管理 - 料理急先鋒</title>
  <style>
    :root {
      --primary-color: #e74c3c;
      --secondary-color: #f39c12;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
      --success-color: #2ecc71;
      --error-color: #e74c3c;
      --gray-color: #95a5a6;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --border-radius: 4px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f5f5f5;
      color: var(--dark-color);
      line-height: 1.6;
    }
    
    .admin-container {
      display: flex;
      min-height: 100vh;
    }
    
    .admin-sidebar {
      width: 250px;
      background-color: var(--dark-color);
      color: var(--light-color);
      padding: 20px;
    }
    
    .admin-sidebar h2 {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .admin-sidebar nav {
      display: flex;
      flex-direction: column;
    }
    
    .admin-sidebar nav a {
      color: var(--light-color);
      text-decoration: none;
      padding: 10px 15px;
      margin-bottom: 5px;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }
    
    .admin-sidebar nav a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .admin-sidebar nav a.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .admin-sidebar .user-profile {
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .admin-sidebar .user-profile img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary-color);
    }
    .admin-sidebar .user-profile .user-info {
      line-height: 1.2;
      color: var(--light-color);
    }
    .admin-sidebar .user-profile .user-info strong {
      font-size: 16px;
      display: block;
      margin-bottom: 4px;
    }
    .admin-sidebar .user-profile .user-info span {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .admin-content {
      flex: 1;
      padding: 20px;
    }
    
    .admin-content h1 {
      font-size: 24px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .action-bar {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .primary-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .primary-btn:hover {
      background-color: #c0392b;
    }
    
    .titles-list {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f8f8f8;
      font-weight: 600;
    }
    
    tbody tr:hover {
      background-color: #f9f9f9;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--gray-color);
    }
    
    .no-data {
      text-align: center;
      padding: 20px;
      color: var(--gray-color);
    }
    
    .title-name-display {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .title-icon {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }
    
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status.active {
      background-color: rgba(46, 204, 113, 0.2);
      color: #27ae60;
    }
    
    .status.inactive {
      background-color: rgba(149, 165, 166, 0.2);
      color: #7f8c8d;
    }
    
    .actions {
      display: flex;
      gap: 8px;
    }
    
    .edit-btn {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .edit-btn:hover {
      background-color: #d35400;
    }
    
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .delete-btn:hover {
      background-color: #c0392b;
    }
    
    /* 稀有度樣式 */
    .rarity-common {
      border-left: 4px solid #95a5a6;
    }
    
    .rarity-uncommon {
      border-left: 4px solid #3498db;
    }
    
    .rarity-rare {
      border-left: 4px solid #9b59b6;
    }
    
    .rarity-epic {
      border-left: 4px solid #f1c40f;
    }
    
    .rarity-legendary {
      border-left: 4px solid #e74c3c;
    }
    
    /* 模態框 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      width: 90%;
      max-width: 600px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      animation: modal-in 0.3s ease;
    }
    
    @keyframes modal-in {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
      font-size: 20px;
      font-weight: 600;
    }
    
    .close {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: var(--gray-color);
      transition: var(--transition);
    }
    
    .close:hover {
      color: var(--dark-color);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark-color);
    }
    
    .form-group small {
      display: block;
      color: var(--gray-color);
      font-size: 12px;
      margin-top: 5px;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 15px;
    }
    
    .form-group textarea {
      height: 100px;
      resize: vertical;
    }
    
    .form-group input[type="color"] {
      width: 50px;
      height: 40px;
      border: none;
      cursor: pointer;
    }
    
    .form-group input[type="text"]#title-color-code {
      width: calc(100% - 60px);
      display: inline-block;
      margin-left: 10px;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .cancel-btn {
      background-color: var(--light-color);
      color: var(--dark-color);
      border: none;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .cancel-btn:hover {
      background-color: #ddd;
    }
    
    /* 通知 */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: var(--success-color);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      z-index: 1100;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 350px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background-color: var(--error-color);
    }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
      .admin-container {
        flex-direction: column;
      }
      
      .admin-sidebar {
        width: 100%;
        padding: 15px;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
      
      .actions {
        flex-direction: column;
      }
      
      .action-bar {
        flex-wrap: wrap;
      }
    }
  </style>
  <!-- 添加思源黑體 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="admin-container">
    <div class="admin-sidebar">
      <div class="user-profile">
        <img src="image/a01girlmove.gif" alt="Avatar" id="user-avatar">
        <div class="user-info">
            <strong id="user-username">載入中...</strong>
            <span>等級: <span id="user-level">--</span></span>
        </div>
      </div>
      <h2>管理後台</h2>
      <nav>
        <a href="/cook-admin.html">總覽</a>
         <a href="/cook-admin-recipes.html">食譜管理</a>
        <a href="/cook-admin-titles.html" class="active">稱號管理</a>
        <a href="/cook-admin-quests.html">任務管理</a>
        <a href="/cook-lobby.html">返回遊戲</a>
      </nav>
    </div>
    
    <div class="admin-content">
      <h1>稱號管理</h1>
      
      <div class="action-bar">
        <button id="add-title-btn" class="primary-btn">新增稱號</button>
        <button id="create-database-btn" class="primary-btn">初始化稱號資料表</button>
      </div>
      
      <div class="titles-list">
        <table id="titles-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>稱號名稱</th>
              <th>稀有度</th>
              <th>解鎖條件</th>
              <th>解鎖值</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 由JavaScript動態生成 -->
            <tr>
              <td colspan="7" class="loading">載入中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- 編輯稱號對話框 -->
  <div id="title-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">編輯稱號</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="title-form">
          <input type="hidden" id="title-id">
          
          <div class="form-group">
            <label for="title-id-str">稱號ID</label>
            <input type="text" id="title-id-str" required>
            <small>唯一識別符，如 "master_chef"</small>
          </div>
          
          <div class="form-group">
            <label for="title-name">稱號名稱</label>
            <input type="text" id="title-name" required>
            <small>顯示給玩家的名稱</small>
          </div>
          
          <div class="form-group">
            <label for="title-description">稱號描述</label>
            <textarea id="title-description"></textarea>
          </div>
          
          <div class="form-group">
            <label for="title-rarity">稀有度</label>
            <select id="title-rarity" required>
              <option value="common">普通</option>
              <option value="uncommon">不普通</option>
              <option value="rare">稀有</option>
              <option value="epic">史詩</option>
              <option value="legendary">傳說</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="title-unlock-condition">解鎖條件</label>
            <select id="title-unlock-condition" required>
              <option value="level">等級達到</option>
              <option value="points">積分達到</option>
              <option value="games_played">遊戲場次達到</option>
              <option value="orders_completed">完成訂單數達到</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="title-unlock-value">解鎖值</label>
            <input type="number" id="title-unlock-value" min="1" required>
            <small>達到此數值時解鎖稱號</small>
          </div>
          
          <div class="form-group">
            <label for="title-color">文字顏色</label>
            <input type="color" id="title-color" value="#ffffff">
            <input type="text" id="title-color-code" placeholder="#FFFFFF">
          </div>
          
          <div class="form-group">
            <label for="title-icon">圖標URL</label>
            <input type="text" id="title-icon-url">
            <small>可選，稱號的小圖標</small>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="title-active" checked>
              啟用此稱號
            </label>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="primary-btn">保存</button>
            <button type="button" class="cancel-btn">取消</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // 載入所有稱號
    async function loadTitles() {
      try {
        const token = localStorage.getItem('cookGameToken');
        
        const response = await fetch('/admin/titles', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        // 移除權限檢查，直接處理回應
        if (!response.ok) {
          if (response.status === 404) {
            showNotification('稱號資料表可能尚未建立，請點擊"初始化稱號資料表"按鈕', 'error');
          } else {
            throw new Error('獲取稱號列表失敗');
          }
          return;
        }
        
        const titles = await response.json();
        displayTitles(titles);
      } catch (error) {
        console.error('載入稱號失敗:', error);
        showNotification('載入稱號列表失敗：' + error.message, 'error');
      }
    }
    
    // 顯示稱號列表
    function displayTitles(titles) {
      const tbody = document.querySelector('#titles-table tbody');
      tbody.innerHTML = '';
      
      if (titles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" class="no-data">沒有稱號數據</td>';
        tbody.appendChild(row);
        return;
      }
      
      titles.forEach(title => {
        const row = document.createElement('tr');
        
        // 根據稀有度添加類名
        row.className = `rarity-${title.rarity}`;
        
        row.innerHTML = `
          <td>${title.title_id}</td>
          <td>
            <div class="title-name-display">
              ${title.icon_url ? `<img src="${title.icon_url}" alt="" class="title-icon">` : ''}
              <span style="color: ${title.color_code || '#ffffff'}">${title.title_name}</span>
            </div>
          </td>
          <td>${getRarityText(title.rarity)}</td>
          <td>${getConditionText(title.unlock_condition)}</td>
          <td>${title.unlock_value}</td>
          <td>${title.is_active ? '<span class="status active">啟用</span>' : '<span class="status inactive">停用</span>'}</td>
          <td class="actions">
            <button class="edit-btn" data-id="${title.id}">編輯</button>
            <button class="delete-btn" data-id="${title.id}">刪除</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // 添加編輯按鈕事件監聽
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editTitle(btn.dataset.id));
      });
      
      // 添加刪除按鈕事件監聽
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteTitle(btn.dataset.id));
      });
    }
    
    // 獲取稱號稀有度文字
    function getRarityText(rarity) {
      const rarityMap = {
        'common': '普通',
        'uncommon': '不普通',
        'rare': '稀有',
        'epic': '史詩',
        'legendary': '傳說'
      };
      
      return rarityMap[rarity] || rarity;
    }
    
    // 獲取解鎖條件文字
    function getConditionText(condition) {
      const conditionMap = {
        'level': '等級達到',
        'points': '積分達到',
        'games_played': '遊戲場次達到',
        'orders_completed': '完成訂單數達到'
      };
      
      return conditionMap[condition] || condition;
    }
    
    // 編輯稱號
    async function editTitle(id) {
      try {
        const token = localStorage.getItem('cookGameToken');
        if (!token) {
          window.location.href = '/cook-login.html?redirect=/cook-admin-titles.html';
          return;
        }
        
        const response = await fetch(`/admin/titles/${id}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.status === 401 || response.status === 403) {
          showNotification('無權訪問', 'error');
          return;
        }
        
        if (!response.ok) {
          throw new Error('獲取稱號詳情失敗');
        }
        
        const title = await response.json();
        
        // 填充表單
        document.getElementById('title-id').value = title.id;
        document.getElementById('title-id-str').value = title.title_id;
        document.getElementById('title-name').value = title.title_name;
        document.getElementById('title-description').value = title.title_description || '';
        document.getElementById('title-rarity').value = title.rarity;
        document.getElementById('title-unlock-condition').value = title.unlock_condition;
        document.getElementById('title-unlock-value').value = title.unlock_value;
        document.getElementById('title-color').value = title.color_code || '#ffffff';
        document.getElementById('title-color-code').value = title.color_code || '#ffffff';
        document.getElementById('title-icon-url').value = title.icon_url || '';
        document.getElementById('title-active').checked = title.is_active;
        
        // 更新模態框標題
        document.getElementById('modal-title').textContent = '編輯稱號';
        
        // 顯示模態框
        document.getElementById('title-modal').style.display = 'block';
      } catch (error) {
        console.error('載入稱號詳情失敗:', error);
        showNotification('載入稱號詳情失敗', 'error');
      }
    }
    
    // 新增稱號
    function addTitle() {
      const token = localStorage.getItem('cookGameToken');
      if (!token) {
        window.location.href = '/cook-login.html?redirect=/cook-admin-titles.html';
        return;
      }
      
      // 重置表單
      document.getElementById('title-form').reset();
      document.getElementById('title-id').value = '';
      document.getElementById('title-color').value = '#ffffff';
      document.getElementById('title-color-code').value = '#ffffff';
      
      // 更新模態框標題
      document.getElementById('modal-title').textContent = '新增稱號';
      
      // 顯示模態框
      document.getElementById('title-modal').style.display = 'block';
    }
    
    // 保存稱號
    async function saveTitle(event) {
      event.preventDefault();
      
      const token = localStorage.getItem('cookGameToken');
      if (!token) {
        window.location.href = '/cook-login.html?redirect=/cook-admin-titles.html';
        return;
      }
      
      const titleId = document.getElementById('title-id').value;
      const titleData = {
        title_id: document.getElementById('title-id-str').value,
        title_name: document.getElementById('title-name').value,
        title_description: document.getElementById('title-description').value,
        rarity: document.getElementById('title-rarity').value,
        unlock_condition: document.getElementById('title-unlock-condition').value,
        unlock_value: parseInt(document.getElementById('title-unlock-value').value),
        color_code: document.getElementById('title-color-code').value,
        icon_url: document.getElementById('title-icon-url').value,
        is_active: document.getElementById('title-active').checked
      };
      
      if (titleId) {
        titleData.id = titleId;
      }
      
      try {
        const response = await fetch('/admin/titles', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(titleData)
        });
        
        if (response.status === 401) {
          window.location.href = '/cook-login.html?redirect=/cook-admin-titles.html';
          return;
        }
        
        if (response.status === 403) {
          showNotification('您沒有權限執行此操作', 'error');
          return;
        }
        
        if (!response.ok) {
          throw new Error('保存稱號失敗');
        }
        
        // 關閉模態框
        document.getElementById('title-modal').style.display = 'none';
        
        // 重新載入稱號列表
        loadTitles();
        
        showNotification('稱號已成功保存');
      } catch (error) {
        console.error('保存稱號失敗:', error);
        showNotification('保存稱號失敗: ' + error.message, 'error');
      }
    }
    
    // 刪除稱號
    async function deleteTitle(id) {
      const token = localStorage.getItem('cookGameToken');
      if (!token) {
        window.location.href = '/cook-login.html?redirect=/cook-admin-titles.html';
        return;
      }
      
      if (!confirm('確定要刪除這個稱號嗎？此操作不可恢復。')) {
        return;
      }
      
      try {
        const response = await fetch(`/admin/titles/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.status === 401) {
          window.location.href = '/cook-login.html?redirect=/cook-admin-titles.html';
          return;
        }
        
        if (response.status === 403) {
          showNotification('您沒有權限執行此操作', 'error');
          return;
        }
        
        if (!response.ok) {
          throw new Error('刪除稱號失敗');
        }
        
        // 重新載入稱號列表
        loadTitles();
        
        showNotification('稱號已成功刪除');
      } catch (error) {
        console.error('刪除稱號失敗:', error);
        showNotification('刪除稱號失敗: ' + error.message, 'error');
      }
    }
    
    // 初始化稱號資料表
    async function initializeTitlesTable() {
      const token = localStorage.getItem('cookGameToken');
      if (!confirm('這將創建稱號資料表並添加一些預設稱號。確定要繼續嗎？')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/initialize-titles', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.details || '初始化稱號資料表失敗');
        }
        
        const result = await response.json();
        showNotification('稱號資料表初始化成功！已創建 ' + result.titlesCreated + ' 個預設稱號。');
        
        // 重新載入稱號列表
        loadTitles();
      } catch (error) {
        console.error('初始化稱號資料表失敗:', error);
        showNotification('初始化稱號資料表失敗: ' + error.message, 'error');
      }
    }
    
    // 顯示通知
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
    
    // 載入使用者個人資料
    async function loadUserProfile() {
      const token = localStorage.getItem('cookGameToken');

      try {
        const response = await fetch('/player/profile', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) {
            throw new Error('無法獲取用戶資料');
        }
        const profile = await response.json();

        // 移除權限檢查，直接顯示用戶資料
        document.getElementById('user-avatar').src = profile.avatar_url || 'image/a01girlmove.gif';
        document.getElementById('user-username').textContent = profile.username;
        document.getElementById('user-level').textContent = profile.level;
      } catch (error) {
          console.error('加載用戶資料失敗:', error);
          document.getElementById('user-username').textContent = '用戶資料錯誤';
      }
    }
    
    // 顏色選擇器同步
    document.getElementById('title-color').addEventListener('input', function() {
      document.getElementById('title-color-code').value = this.value;
    });
    
    document.getElementById('title-color-code').addEventListener('input', function() {
      document.getElementById('title-color').value = this.value;
    });
    
    // 註冊事件監聽器
    document.getElementById('add-title-btn').addEventListener('click', addTitle);
    document.getElementById('create-database-btn').addEventListener('click', initializeTitlesTable);
    document.getElementById('title-form').addEventListener('submit', saveTitle);
    document.querySelector('.close').addEventListener('click', () => {
      document.getElementById('title-modal').style.display = 'none';
    });
    document.querySelector('.cancel-btn').addEventListener('click', () => {
      document.getElementById('title-modal').style.display = 'none';
    });
    
    // 點擊模態框外部關閉
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('title-modal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // 自動檢查並獲取遊戲Token
    async function ensureGameTokenAndLoadData() {
        let token = localStorage.getItem('cookGameToken');

        // 如果沒有遊戲 token，嘗試使用主系統登入資訊進行快速登入
        if (!token) {
            const savedUserName = localStorage.getItem('boxCurrentUsername');

            if (savedUserName) {
                console.log('偵測到主系統登入，嘗試為管理員進行快速遊戲登入...');
                try {
                    const response = await fetch('/cook-api/auth/quick-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: savedUserName,
                            deviceId: 'admin_panel_quick_login'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        localStorage.setItem('cookGameToken', data.token);
                        token = data.token; // 更新 token 供本次使用
                        showToast('管理員身份驗證成功！', 'success');
                    } else {
                        showToast('管理員快速登入失敗，請手動登入。', 'error');
                        window.location.href = `/cook-login.html?redirect=${window.location.pathname}`;
                        return;
                    }
                } catch (error) {
                    console.error('管理員快速登入時發生錯誤:', error);
                    showToast('自動登入失敗，將引導至登入頁面。', 'error');
                    window.location.href = `/cook-login.html?redirect=${window.location.pathname}`;
                    return;
                }
            } else {
                // 如果連主系統都沒登入，就跳轉到登入頁
                window.location.href = `/cook-login.html?redirect=${window.location.pathname}`;
                return;
            }
        }

        // 確認有 token 後，才載入頁面資料
        if (token) {
            loadTitles();
            loadUserProfile();
        }
    }
    
    // 頁面載入時獲取稱號列表
    document.addEventListener('DOMContentLoaded', () => {
      ensureGameTokenAndLoadData();
    });
  </script>
</body>
</html>