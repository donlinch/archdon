<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡ç† - æ–™ç†æ€¥å…ˆé‹’å¾Œå°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #2c3e50;
            --surface-color: #34495e;
            --text-color: #ecf0f1;
            --text-muted-color: #bdc3c7;
            --border-color: #4a6278;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --success-color: #27ae60;
        }

        [data-theme="light"] {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #f4f6f8;
            --surface-color: #ffffff;
            --text-color: #2c3e50;
            --text-muted-color: #7f8c8d;
            --border-color: #dfe4ea;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background-color: var(--surface-color);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .sidebar .logo {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-muted-color);
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar nav a i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }
        
        .sidebar nav a.active, .sidebar nav a:hover {
            background-color: var(--primary-color);
            color: #fff;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 15px 30px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .page-content {
            padding: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        .content-wrapper {
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        
        .content-section {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 22px;
        }

        .section-header .filters, .section-header .actions {
            display: flex;
            gap: 10px;
        }
        
        .section-header input {
            min-width: 250px;
        }
        
        .grid-container {
            display: grid;
            gap: 15px;
        }

        .recipe-grid {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }

        .item-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }
        
        .recipe-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
        }
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .recipe-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(0,0,0,0.2);
        }
        .recipe-card-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .recipe-card-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .recipe-info-row {
            display: flex;
            gap: 10px;
        }
        .recipe-info-row strong {
            color: var(--primary-color);
            flex-shrink: 0;
        }
        .recipe-info-row span {
            word-break: break-all;
        }
        
        .item-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-align: center;
        }
        .item-card .item-symbol-large {
            font-size: 36px;
            line-height: 1;
        }
        .item-card .item-name {
            font-weight: bold;
        }
        .item-card .item-id-tag {
            font-size: 12px;
            color: var(--text-muted-color);
            background-color: var(--surface-color);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .simulator-main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }
        #simulatorPlayerInventoryPanel, #simulatorCraftingPanel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #simPlayerInventory {
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            padding: 10px;
            height: 450px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
            background-color: var(--background-color);
        }
        #simCraftingArea {
            display: flex;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            background-color: var(--background-color);
            border-radius: 8px;
            min-height: 100px;
            flex-wrap: wrap;
        }
        .crafting-slot {
            width: 85px;
            height: 85px;
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .crafting-slot.drag-over {
            background-color: var(--primary-color);
            border-color: var(--secondary-color);
        }
        .crafting-slot .sim-item {
            cursor: pointer;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            padding: 4px;
            box-sizing: border-box;
            text-align: center;
        }
        .crafting-slot .sim-item span:first-child {
            font-size: 24px;
        }
        
        #simActions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        #simCookingStations {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .station-btn {
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .sim-item {
             background-color: var(--surface-color);
        }

        .admin-sidebar nav a.active {
            background-color: var(--primary-color);
            color: white;
        }

        .admin-sidebar .user-profile {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .admin-sidebar .user-profile img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        .admin-sidebar .user-profile .user-info {
            line-height: 1.2;
            color: var(--light-color);
        }
        .admin-sidebar .user-profile .user-info strong {
            font-size: 16px;
            display: block;
            margin-bottom: 4px;
        }
        .admin-sidebar .user-profile .user-info span {
            font-size: 14px;
            opacity: 0.8;
        }

        .admin-content {
            flex: 1;
            padding: 20px;
        }

        .simulator-panel {
            display: flex;
            flex-direction: column;
            width: 400px;
            flex-shrink: 0;
        }
        .simulator-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 20px;
            overflow: hidden;
        }
        .player-inventory, .cooking-stations {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .player-inventory h4, .cooking-stations h4, .simulator-output h4 {
            margin: 0;
            color: var(--primary-color);
        }
        #simPlayerInventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            min-height: 100px;
            overflow-y: auto;
        }
        .sim-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: var(--background-color);
            border-radius: 4px;
            cursor: grab;
            border: 1px solid var(--border-color);
        }
        .sim-item:active {
            cursor: grabbing;
        }
        .stations-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .station {
            padding: 20px 10px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .station.drag-over {
            background-color: var(--primary-color);
            border-color: var(--secondary-color);
        }
        .simulator-output {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        .output-log {
            background-color: var(--background-color);
            padding: 10px;
            border-radius: 4px;
            min-height: 50px;
            font-family: 'Courier New', Courier, monospace;
        }
        .output-log .success { color: var(--success-color); }
        .output-log .error { color: var(--danger-color); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="admin-sidebar">
          <div class="user-profile">
            <img src="image/a01girlmove.gif" alt="Avatar" id="user-avatar">
            <div class="user-info">
              <strong id="user-username">è¼‰å…¥ä¸­...</strong>
              <span>ç­‰ç´š: <span id="user-level">--</span></span>
            </div>
          </div>
          <h2>ç®¡ç†å¾Œå°</h2>
          <nav>
            <a href="/cook-admin.html">ç¸½è¦½</a>
            <a href="/cook-admin-items.html">ç‰©å“ç®¡ç†</a>
            <a href="/cook-admin-recipes.html" class="active">é£Ÿè­œç®¡ç†</a>
            <a href="/cook-admin-titles.html">ç¨±è™Ÿç®¡ç†</a>
            <a href="/cook-admin-quests.html">ä»»å‹™ç®¡ç†</a>
            <a href="/cook-lobby.html">è¿”å›éŠæˆ²</a>
          </nav>
        </div>
    </aside>

    <div class="main-content">
        <header>
            <h1>é£Ÿè­œç®¡ç†</h1>
            <div id="userInfo" style="display: none;">
                <span id="username"></span>
                <button id="logoutBtn" class="btn btn-danger btn-sm">ç™»å‡º</button>
            </div>
        </header>

        <div class="page-content">
            <div class="content-wrapper">
                
                <section class="content-section" id="recipes_section">
                    <div class="section-header">
                        <h2>ğŸ“– é£Ÿè­œåˆ—è¡¨</h2>
                        <div class="filters">
                            <input type="text" id="recipeSearch" class="item-search-input" placeholder="æœç´¢é£Ÿè­œåç¨±...">
                            <button id="addRecipeBtn" class="btn btn-primary"><i class="fas fa-plus"></i> æ–°å¢é£Ÿè­œ</button>
                </div>
                        <div class="actions">
                            <button id="analyzeRecipesBtn" class="btn btn-warning"><i class="fas fa-magic"></i> åˆ†æç¼ºæ¼é£Ÿè­œ</button>
                            <button id="updateSymbolsBtn" class="btn btn-secondary" title="è‡ªå‹•åŒ¹é…ç‰©å“åœ–æ¨™"><i class="fas fa-sync"></i> æ›´æ–°åœ–ç¤º</button>
                            <button id="updateMethodsBtn" class="btn btn-secondary" title="è‡ªå‹•ä¿®æ­£çƒ¹é£ªæ–¹æ³•"><i class="fas fa-wand-magic-sparkles"></i> æ›´æ–°çƒ¹é£ªæ³•</button>
                </div>
            </div>
                    <div id="recipesGrid" class="grid-container recipe-grid">
                        <!-- Recipe cards will be populated by JS -->
                    </div>
                </section>
        
                <section class="content-section" id="ingredients_section">
                    <div class="section-header">
                        <h2>ğŸ¥¬ åŸºç¤é£Ÿæ</h2>
                         <input type="text" id="itemSearch" class="item-search-input" placeholder="æœç´¢åŸºç¤é£Ÿæ...">
                </div>
                    <div id="rawItemsGrid" class="grid-container item-grid">
                        <!-- Raw item cards will be populated by JS -->
                </div>
                </section>
        
                <section class="content-section" id="processed_section">
                    <div class="section-header">
                        <h2>ğŸ” åŠ å·¥å“/æ–™ç†</h2>
                        <input type="text" id="processedItemSearch" class="item-search-input" placeholder="æœç´¢åŠ å·¥å“/æ–™ç†...">
            </div>
                    <div id="processedItemsGrid" class="grid-container item-grid">
                        <!-- Processed item cards will be populated by JS -->
                    </div>
                </section>
        
                <section class="content-section" id="simulator_section">
                     <div class="section-header">
                        <h2>ğŸ³ çƒ¹é£ªæ¨¡æ“¬å™¨</h2>
                    </div>
                     <div class="simulator-main-layout">
                        <div id="simulatorPlayerInventoryPanel">
                             <h4>ç©å®¶ç‰©å“æ¬„ (å¯æ‹–æ›³)</h4>
                             <div id="simPlayerInventory"></div>
                </div>
                        <div id="simulatorCraftingPanel">
                            <h4>çƒ¹é£ªçµ„åˆå€ (å¾å·¦å´æ‹–æ›³ç‰©å“è‡³æ­¤ï¼Œé»æ“Šç‰©å“å¯ç§»é™¤)</h4>
                            <div id="simCraftingArea">
                                <!-- Crafting slots will be generated by JS -->
                            </div>
                            <div id="simActions">
                                <h4>é¸æ“‡çƒ¹é£ªæ³•ä¸¦é»æ“ŠåŸ·è¡Œ</h4>
                                <div id="simCookingStations">
                                    <!-- Station buttons will be generated by JS -->
                                </div>
                                <button id="clearCraftingBtn" class="btn btn-danger">æ¸…ç©ºçµ„åˆå€</button>
                            </div>
                            <h4>æ¨¡æ“¬çµæœ</h4>
                            <div id="simOutput" class="output-log">å°‡ç‰©å“æ”¾å…¥çµ„åˆå€ï¼Œç„¶å¾Œé¸æ“‡çƒ¹é£ªæ³•...</div>
                        </div>
                     </div>
                </section>

            </div>
        </div>
    </div>
    
    <div id="suggestionsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>æ™ºæ…§é£Ÿè­œå»ºè­°</h2>
                <span class="close-button">&times;</span>
            </div>
            <div id="suggestionsContainer">
                <p>é»æ“Šã€Œä¸€éµæ–°å¢ã€å°‡æœƒæŠŠå»ºè­°çš„é£Ÿè­œåŠ å…¥è³‡æ–™åº«ã€‚</p>
                <div class="table-container" style="max-height: 60vh;">
                    <table>
                        <thead>
                            <tr>
                                <th>å»ºè­°ç”¢å‡º</th>
                                <th>å»ºè­°éœ€æ±‚</th>
                                <th>å»ºè­°æ–¹æ³•</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="suggestionsTableBody"></tbody>
                    </table>
                </div>
                 <div id="suggestionsLoading" style="display: none; text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åˆ†æä¸­...
            </div>
            </div>
        </div>
    </div>
    
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°å¢é£Ÿè­œ (V2)</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="recipeForm">
                <div class="form-group">
                    <label for="recipeId">é£Ÿè­œID (è‹±æ–‡ï¼Œå”¯ä¸€)</label>
                    <input type="text" id="recipeId" required>
                </div>
                <div class="form-group">
                    <label for="recipeName">é£Ÿè­œåç¨±</label>
                    <input type="text" id="recipeName" required>
                </div>
                <div class="form-group">
                    <label for="cookingMethod">çƒ¹é£ªæ–¹æ³•</label>
                    <select id="cookingMethod" required>
                        <option value="" disabled selected>é¸æ“‡çƒ¹é£ªæ–¹æ³•...</option>
                        <option value="grill">çƒ¤ (Grill/Bake)</option>
                        <option value="pan_fry">ç… (Pan-fry)</option>
                        <option value="deep_fry">ç‚¸ (Deep-fry)</option>
                        <option value="boil">ç…® (Boil)</option>
                        <option value="assembly">çµ„åˆ (Assembly)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>éœ€æ±‚ (Ingredients & Requirements)</label>
                    <div id="requirementsContainer"></div>
                    <button type="button" id="addRequirementField" class="btn btn-secondary">å¢åŠ éœ€æ±‚</button>
                </div>
                 <div class="form-group">
                    <label>ç”¢å‡ºç‰© (Results)</label>
                    <div id="resultsContainer"></div>
                    <button type="button" id="addResultField" class="btn btn-secondary">å¢åŠ ç”¢å‡ºç‰©</button>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="saveRecipeBtn" class="btn btn-success">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="newItemModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>æ–°å¢ç‰©å“</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="newItemForm">
                <div class="form-group">
                    <label for="newItemId">ç‰©å“ID (è‹±æ–‡ï¼Œå”¯ä¸€)</label>
                    <input type="text" id="newItemId" required>
                </div>
                <div class="form-group">
                    <label for="newItemName">ç‰©å“åç¨±</label>
                    <input type="text" id="newItemName" required>
                </div>
                <div class="form-group">
                    <label for="newItemSymbol">ASCII ç¬¦è™Ÿ</label>
                    <input type="text" id="newItemSymbol" required>
                </div>
                <div class="form-group">
                    <label for="newItemType">ç‰©å“é¡å‹</label>
                    <select id="newItemType" required>
                        <option value="raw_ingredient">åŸºç¤é£Ÿæ</option>
                        <option value="processed_food">åŠ å·¥å“</option>
                        <option value="intermediate_good">åŠæˆå“</option>
                        <option value="final_dish">æœ€çµ‚æ–™ç†</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="newItemPoints">åŸºç¤åˆ†æ•¸ (åƒ…æœ€çµ‚æ–™ç†æœ‰æ•ˆ)</label>
                    <input type="number" id="newItemPoints" value="0" min="0">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">å‰µå»ºç‰©å“</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Globals
    let allRecipes = [];
    let allItems = [];
    let allCookingMethods = [];
    let targetSelectForNewItem = null;

    // Element Refs
    const recipeModal = document.getElementById('recipeModal');
    const newItemModal = document.getElementById('newItemModal');
    const recipeForm = document.getElementById('recipeForm');
    const newItemForm = document.getElementById('newItemForm');
    const modalTitle = document.getElementById('modalTitle');
    const closeButtons = document.querySelectorAll('.close-button');
    const addRecipeBtn = document.getElementById('addRecipeBtn');
    const updateSymbolsBtn = document.getElementById('updateSymbolsBtn');
    const updateMethodsBtn = document.getElementById('updateMethodsBtn');
    
    const recipesTableBody = document.getElementById('recipesTableBody');
    const itemListContainer = document.getElementById('itemList');
    const processedItemListContainer = document.getElementById('processedItemList');
    const simPlayerInventory = document.getElementById('simPlayerInventory');
    const simCookingStations = document.getElementById('simCookingStations');
    const simOutput = document.getElementById('simOutput');
    
    const recipeSearch = document.getElementById('recipeSearch');
    const itemSearch = document.getElementById('itemSearch');
    const processedItemSearch = document.getElementById('processedItemSearch');
    
    const saveRecipeBtn = document.getElementById('saveRecipeBtn');

    const API_BASE_URL = '/cook-api';

    // --- çµ±ä¸€çš„ä»¤ç‰Œç²å–å‡½æ•¸ ---
    function getUserToken() {
        const userId = localStorage.getItem('boxCurrentUserId');
        if (!userId) return null;
        const tokenKey = `boxUserToken_${userId}`;
        return localStorage.getItem(tokenKey);
    }
    
    // --- Toast Notifications ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 500);
        }, 3000);
    }

    // --- API Fetch Utility (å·²ä¿®æ­£) ---
    async function apiFetch(endpoint, options = {}) {
        const token = getUserToken();
        if (!token) {
            showToast('æ¬Šé™ä¸è¶³æˆ–ç™»å…¥å·²è¶…æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚', 'error');
            setTimeout(() => window.location.href = '/cook-login.html?redirect=/cook-admin-recipes.html', 2000);
            throw new Error('ä»¤ç‰Œæœªæ‰¾åˆ°ï¼Œç„¡æ³•ç™¼é€è«‹æ±‚');
        }

        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        };
        const mergedOptions = { ...defaultOptions, ...options };
        if (mergedOptions.body) {
            mergedOptions.body = JSON.stringify(mergedOptions.body);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, mergedOptions);
            if (!response.ok) {
                if(response.status === 401 || response.status === 403) {
                   showToast('æ¬Šé™ä¸è¶³æˆ–ç™»å…¥å·²è¶…æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚', 'error');
                   setTimeout(() => window.location.href = '/cook-login.html?redirect=/cook-admin-recipes.html', 2000);
                }
                const errorData = await response.json().catch(() => ({ message: 'ç„¡æ³•è§£æä¾†è‡ªä¼ºæœå™¨çš„éŒ¯èª¤è¨Šæ¯' }));
                throw new Error(errorData.error || errorData.message || `HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('API Fetch Error:', error);
            showToast(error.message, 'error');
            throw error;
        }
    }
    
    // --- Data Loading ---
    async function loadInitialData() {
        setLoadingState(true);
        try {
            // ä¸å†ç²å– cooking-methods
            const [itemsData, recipesData] = await Promise.all([
                apiFetch('/admin/all-items'),
                apiFetch('/admin/recipes-v2')
            ]);
            
            allItems = itemsData;
            allRecipes = recipesData;
            
            renderItems(); // æ¸²æŸ“åŸºç¤é£Ÿæ
            renderProcessedItems(); // æ¸²æŸ“åŠ å·¥å“
            renderRecipes();
            initializeSimulator(); // åˆå§‹åŒ–æ¨¡æ“¬å™¨
            
        } catch (error) {
            console.error('Failed to load initial data', error);
        } finally {
            setLoadingState(false);
        }
    }

    function setLoadingState(isLoading) {
        document.querySelectorAll('.loading-overlay').forEach(el => {
            el.style.display = isLoading ? 'flex' : 'none';
        });
    }

    // --- Rendering ---
    function renderItems() {
        const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
        const rawIngredients = allItems.filter(item => 
            item.item_type === 'raw_ingredient' &&
            (item.item_name.toLowerCase().includes(searchTerm) || (item.item_id && item.item_id.toLowerCase().includes(searchTerm)))
        );

        const grid = document.getElementById('rawItemsGrid');
        grid.innerHTML = rawIngredients.map(item => `
            <div class="item-card" data-item-id="${item.item_id}">
                <span class="item-symbol-large">${item.ascii_symbol || '?'}</span>
                <span class="item-name">${item.item_name}</span>
                <span class="item-id-tag">${item.item_id || 'N/A'}</span>
            </div>
        `).join('');
    }

    function renderProcessedItems() {
        const searchTerm = document.getElementById('processedItemSearch').value.toLowerCase();
        const processedItems = allItems.filter(item => 
            item.item_type !== 'raw_ingredient' &&
            (item.item_name.toLowerCase().includes(searchTerm) || (item.item_id && item.item_id.toLowerCase().includes(searchTerm)))
        );

        const grid = document.getElementById('processedItemsGrid');
        grid.innerHTML = processedItems.map(item => `
            <div class="item-card" data-item-id="${item.id}">
                <span class="item-symbol-large">${item.ascii_symbol || '?'}</span>
                <span class="item-name">${item.item_name}</span>
                <span class="item-id-tag">${item.item_type || 'N/A'}</span>
                        </div>
        `).join('');
    }

    function renderRecipes() {
        const searchTerm = document.getElementById('recipeSearch').value.toLowerCase();
        const filteredRecipes = allRecipes.filter(recipe => {
            const nameMatch = recipe.recipe_name.toLowerCase().includes(searchTerm);
            return nameMatch;
        });

        const recipesGrid = document.getElementById('recipesGrid');
        recipesGrid.innerHTML = filteredRecipes.map(recipe => {
            const requirementsText = recipe.requirements && recipe.requirements.length > 0 ? 
                recipe.requirements.map(r => `${r.item_name}(${r.quantity})`).join(', ') 
                : 'ç„¡';

            return `
            <div class="recipe-card" data-recipe-id="${recipe.recipe_id}">
                <div class="recipe-card-header">
                    <h3>${recipe.recipe_name}</h3>
                    <div class="actions">
                        <button class="btn btn-sm btn-primary edit-btn" data-id="${recipe.recipe_id}" title="ç·¨è¼¯"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${recipe.recipe_id}" title="åˆªé™¤"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="recipe-card-body">
                    <div class="recipe-info-row">
                        <strong>ç”¢å‡º:</strong>
                        <span>${recipe.output_item_name || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="recipe-info-row">
                        <strong>éœ€æ±‚:</strong>
                        <span>${requirementsText}</span>
                    </div>
                    <div class="recipe-info-row">
                        <strong>æ–¹æ³•:</strong>
                        <span>${recipe.cooking_method || 'æœªçŸ¥'}</span>
                    </div>
                </div>
            </div>
            `;
        }).join('');

        // Re-attach event listeners
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const recipeId = this.getAttribute('data-id');
                editRecipe(recipeId);
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const recipeId = this.getAttribute('data-id');
                deleteRecipe(recipeId);
            });
        });
    }
    
    function populateItemSelects(selectElement) {
        // æŒ‰é¡å‹å°ç‰©å“é€²è¡Œåˆ†çµ„
        const groupedItems = allItems.reduce((acc, item) => {
            if (!acc[item.item_type]) {
                acc[item.item_type] = [];
            }
            acc[item.item_type].push(item);
            return acc;
        }, {});

        // å®šç¾©é¡å‹çš„é¡¯ç¤ºåç¨±å’Œé †åº
        const typeOrder = {
            raw_ingredient: { name: 'åŸºç¤é£Ÿæ', order: 1 },
            cooked_item: { name: 'åŠ å·¥å“', order: 2 },
            semi_finished: { name: 'åŠæˆå“', order: 3 },
            assembled_dish: { name: 'æœ€çµ‚æ–™ç†', order: 4 }
        };

        // ç”Ÿæˆé¸é …HTML
        let optionsHtml = '<option value="" disabled selected>é¸æ“‡ç‰©å“...</option>';
        
        // æŒ‰é †åºæ·»åŠ åˆ†çµ„
        Object.entries(typeOrder)
            .sort((a, b) => a[1].order - b[1].order)
            .forEach(([type, info]) => {
                if (groupedItems[type] && groupedItems[type].length > 0) {
                    optionsHtml += `<optgroup label="${info.name}">`;
                    groupedItems[type]
                        .sort((a, b) => a.item_name.localeCompare(b.item_name))
                        .forEach(item => {
                            optionsHtml += `<option value="${item.id}">${item.item_name} ${item.ascii_symbol ? `(${item.ascii_symbol})` : ''}</option>`;
                        });
                    optionsHtml += '</optgroup>';
                }
            });

        selectElement.innerHTML = optionsHtml;
    }

    function populateRequirementSelects(selectElement) {
        const options = allCookingMethods.map(req => `<option value="${req}">${req}</option>`).join('');
        selectElement.innerHTML = '<option value="" disabled selected>é¸æ“‡æ‰‹æ³•...</option>' + options;
    }

    // --- Modal Logic ---
    function openRecipeModal(recipe = null) {
        recipeForm.reset();
        requirementsContainer.innerHTML = '';
        resultsContainer.innerHTML = '';
        
        if (recipe) {
            modalTitle.textContent = 'ç·¨è¼¯é£Ÿè­œ';
            document.getElementById('recipeId').value = recipe.id;
            document.getElementById('recipeId').readOnly = true;
            document.getElementById('recipeName').value = recipe.recipe_name;
            
            // è¨­ç½®çƒ¹é£ªæ–¹æ³•
            if (recipe.cooking_method) {
                document.getElementById('cookingMethod').value = recipe.cooking_method;
            } else {
                document.getElementById('cookingMethod').value = 'assembly'; // é»˜èªç‚ºçµ„åˆ
            }
            
            if (recipe.requirements && recipe.requirements.length > 0) {
                recipe.requirements.forEach(req => addRequirementField(req));
            } else {
                addRequirementField();
            }
            
            addResultField({
                item_id: recipe.output_item_id,
                item_name: recipe.output_item_name,
                quantity: 1
            });
        } else {
            modalTitle.textContent = 'æ–°å¢é£Ÿè­œ';
            document.getElementById('recipeId').value = '';
            document.getElementById('recipeId').readOnly = false;
            document.getElementById('recipeName').value = '';
            addRequirementField();
            addResultField();
        }
        recipeModal.style.display = 'flex';
    }

    function closeRecipeModal() {
        recipeModal.style.display = 'none';
    }
    
    function openNewItemModal(targetSelectId) {
        newItemForm.reset();
        targetSelectForNewItem = targetSelectId;
        newItemModal.style.display = 'flex';
    }
    
    function closeNewItemModal() {
        newItemModal.style.display = 'none';
    }

    function addRequirementField(data = null) {
        const div = document.createElement('div');
        div.className = 'ingredient-item';
        div.innerHTML = `
            <select class="req-id-select flex-grow-1" required></select>
            <input type="number" class="req-quantity-input" min="1" value="${data?.quantity || 1}" required>
            <button type="button" class="btn btn-danger remove-ingredient-btn">&times;</button>
        `;
        requirementsContainer.appendChild(div);

        const idSelect = div.querySelector('.req-id-select');
        populateItemSelects(idSelect);
        
        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œè¨­ç½®é¸ä¸­çš„å€¼
        if (data?.item_id) {
            idSelect.value = data.item_id;
            // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰çš„é¸é …ï¼Œæ·»åŠ ä¸€å€‹è‡¨æ™‚é¸é …
            if (!idSelect.value) {
                const tempOption = document.createElement('option');
                tempOption.value = data.item_id;
                tempOption.textContent = data.item_name || `ID: ${data.item_id}`;
                idSelect.appendChild(tempOption);
                idSelect.value = data.item_id;
            }
        }

        div.querySelector('.remove-ingredient-btn').onclick = () => div.remove();
    }

    function addResultField(data = null) {
        const div = document.createElement('div');
        div.className = 'ingredient-item';
        div.innerHTML = `
            <select class="res-id-select flex-grow-1" required></select>
            <input type="number" class="res-quantity-input" min="1" value="1" disabled>
            <button type="button" class="btn btn-danger remove-ingredient-btn">&times;</button>
        `;
        resultsContainer.appendChild(div);
        
        const idSelect = div.querySelector('.res-id-select');
        populateItemSelects(idSelect);
        
        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œè¨­ç½®é¸ä¸­çš„å€¼
        if (data?.item_id) {
            idSelect.value = data.item_id;
            // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰çš„é¸é …ï¼Œæ·»åŠ ä¸€å€‹è‡¨æ™‚é¸é …
            if (!idSelect.value) {
                const tempOption = document.createElement('option');
                tempOption.value = data.item_id;
                tempOption.textContent = data.item_name || `ID: ${data.item_id}`;
                idSelect.appendChild(tempOption);
            idSelect.value = data.item_id;
        }
        }

        div.querySelector('.remove-ingredient-btn').onclick = () => div.remove();
    }

    // --- Event Handlers ---
    addRecipeBtn.addEventListener('click', () => openRecipeModal());
    document.getElementById('analyzeRecipesBtn').addEventListener('click', async () => {
        openSuggestionsModal();
        try {
            const result = await apiFetch('/admin/suggest-missing-recipes', { method: 'POST' });
            populateSuggestions(result.suggestions);
        } catch (error) {
            console.error('åˆ†æé£Ÿè­œå¤±æ•—', error);
            showToast('åˆ†æé£Ÿè­œå¤±æ•—', 'error');
            document.getElementById('suggestionsLoading').textContent = 'åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤ã€‚';
        }
    });
    updateSymbolsBtn.addEventListener('click', async () => {
        if (!confirm('ç¢ºå®šè¦è‡ªå‹•æ›´æ–°æ‰€æœ‰æœªçŸ¥åœ–æ¨™å—ï¼Ÿé€™å°‡æœƒæ ¹æ“šç‰©å“åç¨±åŒ¹é…è¡¨æƒ…ç¬¦è™Ÿã€‚')) {
            return;
        }
        setLoadingState(true);
        try {
            const result = await apiFetch('/admin/update-item-symbols', { method: 'POST' });
            showToast(result.message, 'success');
            // é‡æ–°åŠ è¼‰æ•¸æ“šä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„åœ–æ¨™
            await loadInitialData();
        } catch (error) {
            console.error('æ›´æ–°åœ–æ¨™å¤±æ•—', error);
            showToast('æ›´æ–°åœ–æ¨™å¤±æ•—', 'error');
        } finally {
            setLoadingState(false);
        }
    });
    updateMethodsBtn.addEventListener('click', async () => {
        if (!confirm('ç¢ºå®šè¦è‡ªå‹•ä¿®æ­£çƒ¹é£ªæ–¹æ³•å—ï¼Ÿæ­¤æ“ä½œå°‡æœƒæ ¹æ“šé£Ÿè­œåç¨±é—œéµå­—ï¼Œæ›´æ–°ç›®å‰æ˜¯ã€Œçµ„åˆã€çš„é£Ÿè­œã€‚')) {
            return;
        }
        setLoadingState(true);
        try {
            const result = await apiFetch('/admin/update-cooking-methods', { method: 'POST' });
            showToast(result.message, 'success');
            await loadInitialData();
        } catch (error) {
            console.error('æ›´æ–°çƒ¹é£ªæ–¹æ³•å¤±æ•—', error);
            showToast('æ›´æ–°çƒ¹é£ªæ–¹æ³•å¤±æ•—', 'error');
        } finally {
            setLoadingState(false);
        }
    });
    closeButtons.forEach(btn => btn.addEventListener('click', () => {
        closeRecipeModal();
        closeNewItemModal();
        closeSuggestionsModal();
    }));
    window.addEventListener('click', (event) => {
        if (event.target == recipeModal) closeRecipeModal();
        if (event.target == newItemModal) closeNewItemModal();
        if (event.target == document.getElementById('suggestionsModal')) closeSuggestionsModal();
    });

    recipeSearch.addEventListener('input', renderRecipes);
    itemSearch.addEventListener('input', renderItems);
    processedItemSearch.addEventListener('input', renderProcessedItems);
    
    document.getElementById('addRequirementField').addEventListener('click', () => addRequirementField());
    document.getElementById('addResultField').addEventListener('click', () => addResultField());
    
    document.querySelectorAll('.add-new-item-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const selectId = e.currentTarget.dataset.targetSelect;
            openNewItemModal(selectId);
        });
    });

    // --- Form Submissions ---
    recipeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const recipeId = document.getElementById('recipeId').value;
        const isEditing = document.getElementById('recipeId').readOnly;

        const requirements = Array.from(document.querySelectorAll('#requirementsContainer .ingredient-item')).map(div => {
            const select = div.querySelector('.req-id-select');
            const id = select.value;
            const quantity = parseInt(div.querySelector('.req-quantity-input').value);
            const selectedOption = select.options[select.selectedIndex];
            return { 
                item_id: id, 
                item_name: selectedOption ? selectedOption.textContent.split('(')[0].trim() : null,
                quantity 
            };
        });

        // ç²å–ç”¢å‡ºç‰©
        const outputItemSelect = document.querySelector('#resultsContainer .res-id-select');
        if (!outputItemSelect || !outputItemSelect.value) {
            showToast('è«‹é¸æ“‡ç”¢å‡ºç‰©', 'error');
            return;
        }
        
        const selectedOption = outputItemSelect.options[outputItemSelect.selectedIndex];
        const outputItemName = selectedOption ? selectedOption.textContent.split('(')[0].trim() : null;
        
        const payload = {
            recipe_id: recipeId,
            recipe_name: document.getElementById('recipeName').value,
            output_item_id: outputItemSelect.value,
            output_item_name: outputItemName,
            cooking_method: document.getElementById('cookingMethod').value,
            cook_time_sec: 30,
            requirements: requirements
        };

        try {
            await apiFetch('/admin/recipes-v2', { 
                method: 'POST', 
                body: payload 
            });
            
            showToast(`é£Ÿè­œå·²æˆåŠŸ${isEditing ? 'æ›´æ–°' : 'å‰µå»º'}ï¼`, 'success');
            closeRecipeModal();
            loadInitialData();
        } catch (error) {
            console.error('å„²å­˜é£Ÿè­œå¤±æ•—', error);
            showToast(`å„²å­˜é£Ÿè­œå¤±æ•—: ${error.message}`, 'error');
        }
    });
    
    newItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            item_id: document.getElementById('newItemId').value,
            item_name: document.getElementById('newItemName').value,
            ascii_symbol: document.getElementById('newItemSymbol').value,
            item_type: document.getElementById('newItemType').value,
            base_points: parseInt(document.getElementById('newItemPoints').value),
        };

        try {
            const newItem = await apiFetch('/admin/items', { method: 'POST', body: payload });
            showToast(`ç‰©å“ "${newItem.item_name}" å·²æˆåŠŸå‰µå»º!`, 'success');
            
            // Add to local cache and re-render/re-populate
            allItems.push(newItem);
            renderItems();
            populateItemSelects();
            
            // Set the value of the select that triggered this
            if (targetSelectForNewItem) {
                document.getElementById(targetSelectForNewItem).value = newItem.item_id;
            }

            closeNewItemModal();
        } catch (error) {
            console.error('Create item failed', error);
        }
    });

    // æ·»åŠ ç·¨è¼¯é£Ÿè­œåŠŸèƒ½
    function editRecipe(recipeId) {
        const recipe = allRecipes.find(r => r.recipe_id == recipeId);
        if (!recipe) {
            showToast('æ‰¾ä¸åˆ°è©²é£Ÿè­œ', 'error');
            return;
        }

        // é‡ç½®è¡¨å–®
        recipeForm.reset();
        document.getElementById('requirementsContainer').innerHTML = '';
        document.getElementById('resultsContainer').innerHTML = '';
        
        // å¡«å……è¡¨å–®æ•¸æ“š
        modalTitle.textContent = 'ç·¨è¼¯é£Ÿè­œ';
        document.getElementById('recipeId').value = recipe.recipe_id;
        document.getElementById('recipeId').readOnly = true;
        document.getElementById('recipeName').value = recipe.recipe_name;
        
        // è¨­ç½®çƒ¹é£ªæ–¹æ³•
        if (recipe.cooking_method) {
            document.getElementById('cookingMethod').value = recipe.cooking_method;
        } else {
            document.getElementById('cookingMethod').value = 'assembly'; // é»˜èªç‚ºçµ„åˆ
        }
        
        // æ·»åŠ éœ€æ±‚é …
        if (recipe.requirements && recipe.requirements.length > 0) {
            recipe.requirements.forEach(req => addRequirementField(req));
        } else {
            addRequirementField();
        }
        
        // æ·»åŠ ç”¢å‡ºç‰©ï¼ŒåŒ…å«ç‰©å“åç¨±
        addResultField({
            item_id: recipe.output_item_id,
            item_name: recipe.output_item_name,
            quantity: 1
        });
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        recipeModal.style.display = 'flex';
    }

    // æ·»åŠ åˆªé™¤é£Ÿè­œåŠŸèƒ½
    function deleteRecipe(recipeId) {
        const recipe = allRecipes.find(r => r.id == recipeId);
        if (!recipe) {
            showToast('æ‰¾ä¸åˆ°è©²é£Ÿè­œ', 'error');
            return;
        }

        if (confirm(`ç¢ºå®šè¦åˆªé™¤é£Ÿè­œ "${recipe.recipe_name}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
            apiFetch(`/admin/recipes-v2/${recipeId}`, { method: 'DELETE' })
                .then(() => {
                    showToast('é£Ÿè­œåˆªé™¤æˆåŠŸ', 'success');
                    allRecipes = allRecipes.filter(r => r.id != recipeId);
                    renderRecipes();
                })
                .catch(error => {
                    console.error('åˆªé™¤é£Ÿè­œå¤±æ•—', error);
                    showToast('åˆªé™¤é£Ÿè­œå¤±æ•—', 'error');
                });
        }
    }

    // --- æ›´æ–°ä½¿ç”¨è€…è³‡è¨Š ---
    function updateUserStatus() {
        const savedUserId = localStorage.getItem('boxCurrentUserId');
        const savedUserAvatarUrl = localStorage.getItem('boxCurrentUserAvatar');
        const savedUserName = localStorage.getItem('boxCurrentDisplayName') || localStorage.getItem('boxCurrentUsername');
      
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-username');
      
        if (savedUserId && savedUserName) {
            userAvatar.src = savedUserAvatarUrl || 'images/a01girlmove.gif';
            userName.textContent = savedUserName;
        } else {
            userAvatar.src = 'images/a01girlmove.gif';
            userName.textContent = 'æœªç™»å…¥';
        }
    }

    // --- é é¢åˆå§‹åŒ–èˆ‡æ¬Šé™æª¢æŸ¥ ---
    function initializePage() {
        updateUserStatus();

        const userId = localStorage.getItem('boxCurrentUserId');
        // ç§»é™¤å‰ç«¯è§’è‰²æª¢æŸ¥ï¼Œç”±å¾Œç«¯APIè² è²¬æ¬Šé™é©—è­‰

        if (!userId || !getUserToken()) {
            showToast('è«‹å…ˆç™»å…¥', 'error');
            setTimeout(() => {
                window.location.href = '/cook-login.html?redirect=' + window.location.pathname;
            }, 1500);
            return;
        }
        
        loadInitialData();
    }

    // --- Simulator Logic ---
    function initializeSimulator() {
        // 1. Render player inventory (all items are available in simulator)
        const simPlayerInventory = document.getElementById('simPlayerInventory');
        simPlayerInventory.innerHTML = allItems.map(item => createSimItemElement(item)).join('');
        
        // 2. Create crafting slots
        const craftingArea = document.getElementById('simCraftingArea');
        craftingArea.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            const slot = document.createElement('div');
            slot.className = 'crafting-slot';
            craftingArea.appendChild(slot);
        }

        // 3. Render cooking stations as buttons
        const simCookingStations = document.getElementById('simCookingStations');
        const cookingMethods = [
            { id: 'grill', name: 'çƒ¤çˆ', icon: 'ğŸ”¥' },
            { id: 'pan_fry', name: 'å¹³åº•é‹', icon: 'ğŸ³' },
            { id: 'deep_fry', name: 'æ²¹ç‚¸é‹', icon: 'ğŸ’¥' },
            { id: 'boil', name: 'æ¹¯é‹', icon: 'ğŸ²' },
            { id: 'assembly', name: 'çµ„åˆå°', icon: 'ğŸ‘' }
        ];
        simCookingStations.innerHTML = cookingMethods.map(method => `
            <button class="btn btn-secondary station-btn" data-method="${method.id}">
                ${method.icon} ${method.name}
            </button>
        `).join('');

        setupSimulatorInteractions();
    }
    
    function createSimItemElement(item) {
        return `
            <div class="sim-item" draggable="true" data-item-id="${item.id}" data-item-name="${item.item_name}" title="${item.item_name}">
                <span>${item.ascii_symbol || '?'}</span>
                <span>${item.item_name}</span>
            </div>
        `;
    }

    function setupSimulatorInteractions() {
        const playerInventory = document.getElementById('simPlayerInventory');
        const craftingArea = document.getElementById('simCraftingArea');
        const stationsContainer = document.getElementById('simCookingStations');
        const clearBtn = document.getElementById('clearCraftingBtn');

        // Event delegation for dragging from inventory
        playerInventory.addEventListener('dragstart', e => {
            if (e.target.classList.contains('sim-item')) {
                e.dataTransfer.setData('text/plain', e.target.dataset.itemId);
            }
        });

        // Event delegation for drop zone
        craftingArea.addEventListener('dragover', e => {
            e.preventDefault();
            const slot = e.target.closest('.crafting-slot');
            if (slot) {
                slot.classList.add('drag-over');
            }
        });
        
        craftingArea.addEventListener('dragleave', e => {
            const slot = e.target.closest('.crafting-slot');
            if (slot) {
                slot.classList.remove('drag-over');
            }
        });

        craftingArea.addEventListener('drop', e => {
            e.preventDefault();
            const slot = e.target.closest('.crafting-slot');
            if (!slot) return;
            
            slot.classList.remove('drag-over');

            // Allow drop only on empty slots
            if (slot.children.length > 0) return;

            const itemId = e.dataTransfer.getData('text/plain');
            const itemData = allItems.find(i => i.id == itemId);

            if (itemData) {
                const itemEl = document.createElement('div');
                itemEl.className = 'sim-item';
                itemEl.dataset.itemId = itemData.id;
                itemEl.title = `é»æ“Šç§»é™¤ - ${itemData.item_name}`;
                itemEl.innerHTML = `<span>${itemData.ascii_symbol || '?'}</span><span>${itemData.item_name}</span>`;
                slot.appendChild(itemEl);
            }
        });
        
        // Event delegation for removing items from crafting area
        craftingArea.addEventListener('click', e => {
            const item = e.target.closest('.sim-item');
            if (item) {
                item.remove();
            }
        });

        // Event delegation for station buttons
        stationsContainer.addEventListener('click', e => {
            const stationBtn = e.target.closest('.station-btn');
            if (stationBtn) {
                simulateCooking(stationBtn.dataset.method);
            }
        });
        
        // Clear button
        clearBtn.addEventListener('click', () => {
             craftingArea.querySelectorAll('.sim-item').forEach(item => item.remove());
             document.getElementById('simOutput').textContent = 'çµ„åˆå€å·²æ¸…ç©ºã€‚';
        });
    }

    async function simulateCooking(cookingMethod) {
        const craftingArea = document.getElementById('simCraftingArea');
        const itemElements = craftingArea.querySelectorAll('.sim-item');

        if (itemElements.length === 0) {
            showToast('è«‹å…ˆå°‡ç‰©å“æ”¾å…¥çµ„åˆå€', 'error');
            return;
        }

        const itemIds = Array.from(itemElements).map(el => el.dataset.itemId);
        const itemNames = Array.from(itemElements).map(el => {
            const id = el.dataset.itemId;
            const item = allItems.find(i => i.id == id);
            return item ? item.item_name : 'æœªçŸ¥ç‰©å“';
        }).join(', ');

        const simOutput = document.getElementById('simOutput');
        simOutput.innerHTML = `æ­£åœ¨ä½¿ç”¨ [${cookingMethod}] çƒ¹é£ª [${itemNames}]...`;
        
        try {
            const result = await apiFetch('/admin/simulate-cooking', {
                method: 'POST',
                body: { itemIds: itemIds.map(id => parseInt(id)), cookingMethod }
            });
            
            if (result.success) {
                // Clear crafting area on success
                itemElements.forEach(item => item.remove());

                // Add new item to inventory
                const newSimItemHTML = createSimItemElement(result.outputItem);
                const simPlayerInventory = document.getElementById('simPlayerInventory');
                simPlayerInventory.insertAdjacentHTML('beforeend', newSimItemHTML);
                
                // Add item to allItems cache if it's new
                if (!allItems.some(item => item.id === result.outputItem.id)) {
                    allItems.push(result.outputItem);
                }

                simOutput.innerHTML = `<div class="success">âœ… æˆåŠŸ! ç²å¾—: ${result.outputItem.item_name}</div>`;
            } else {
                simOutput.innerHTML = `<div class="error">âŒ å¤±æ•—: ${result.error}</div>`;
            }
        } catch (error) {
            simOutput.innerHTML = `<div class="error">âŒ æ¨¡æ“¬æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
        }
    }

    // --- Suggestions Modal ---
    function openSuggestionsModal() {
        document.getElementById('suggestionsModal').style.display = 'flex';
        document.getElementById('suggestionsTableBody').innerHTML = '';
        document.getElementById('suggestionsLoading').style.display = 'block';
    }

    function closeSuggestionsModal() {
        document.getElementById('suggestionsModal').style.display = 'none';
    }

    function populateSuggestions(suggestions) {
        const tableBody = document.getElementById('suggestionsTableBody');
        document.getElementById('suggestionsLoading').style.display = 'none';

        if (suggestions.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">å¤ªæ£’äº†ï¼æ²’æœ‰ç™¼ç¾ä»»ä½•æ–·è£‚çš„é£Ÿè­œéˆã€‚</td></tr>';
            return;
        }

        tableBody.innerHTML = suggestions.map((suggestion, index) => {
            const requirementsText = suggestion.requirements.map(r => `${r.item_name}(${r.quantity})`).join(', ');
            return `
                <tr data-suggestion-index="${index}">
                    <td>${suggestion.output_item_name}</td>
                    <td>${requirementsText}</td>
                    <td>${suggestion.cooking_method}</td>
                    <td>
                        <button class="btn btn-sm btn-success add-suggestion-btn">ä¸€éµæ–°å¢</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.querySelectorAll('.add-suggestion-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const row = e.target.closest('tr');
                const index = parseInt(row.dataset.suggestionIndex);
                const recipeToAdd = suggestions[index];
                
                // æ§‹é€ ä¸€å€‹ç¬¦åˆæ–°å¢APIçš„payload
                const payload = {
                    recipe_id: recipeToAdd.recipe_id,  // ä½¿ç”¨å»ºè­°é£Ÿè­œä¸­çš„ recipe_id
                    recipe_name: recipeToAdd.recipe_name,
                    output_item_id: recipeToAdd.output_item_id,
                    output_item_name: recipeToAdd.output_item_name,
                    cooking_method: recipeToAdd.cooking_method,
                    requirements: recipeToAdd.requirements.map(r => ({ 
                        item_id: r.item_id, 
                        item_name: r.item_name,
                        quantity: r.quantity 
                    }))
                };

                try {
                    await apiFetch('/admin/recipes-v2', { method: 'POST', body: payload });
                    showToast(`é£Ÿè­œ "${recipeToAdd.recipe_name}" æ–°å¢æˆåŠŸ!`, 'success');
                    row.remove(); // å¾å»ºè­°åˆ—è¡¨ä¸­ç§»é™¤
                    await loadInitialData(); // é‡æ–°åŠ è¼‰é£Ÿè­œåˆ—è¡¨
                } catch (error) {
                    showToast(`æ–°å¢é£Ÿè­œå¤±æ•—: ${error.message}`, 'error');
                }
            });
        });
    }

    initializePage();
});
</script>

</body>
</html>
