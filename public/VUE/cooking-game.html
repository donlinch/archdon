<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>料理急先鋒 V3 - 完整版</title>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- 引入動畫效果庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- 引入拖拽庫 -->
    <script src="https://cdn.jsdelivr.net/npm/vue3-draggable-next@1.0.12/dist/vue3-draggable-next.global.js"></script>
    <!-- 自定義樣式 -->
    <link rel="stylesheet" href="./css/cooking-game.css">
    <!-- 修改拖曳庫的默認設置 -->
    <script>
        // 在頁面加載完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            // 覆蓋默認的拖曳設置，移除延遲
            if (typeof window.VueDraggableNext !== 'undefined') {
                // 移除移動端的延遲
                if (window.VueDraggableNext.default && window.VueDraggableNext.default.options) {
                    window.VueDraggableNext.default.options.touchStartThreshold = 0;
                    window.VueDraggableNext.default.options.delay = 0;
                    console.log('已修改拖曳設置，移除延遲');
                }
            }
            
            // 更強力的解決方案：直接攔截所有卡片的觸控事件
            setTimeout(() => {
                const allCards = document.querySelectorAll('.item-card');
                allCards.forEach(card => {
                    // 防止觸控事件冒泡，避免觸發頁面滑動
                    card.addEventListener('touchstart', function(e) {
                        e.preventDefault(); // 阻止默認行為
                        e.stopPropagation(); // 阻止冒泡
                        
                        // 模擬拖曳開始
                        const dragEvent = new DragEvent('dragstart', {
                            bubbles: true,
                            cancelable: true,
                            dataTransfer: new DataTransfer()
                        });
                        
                        // 將物品數據存儲到拖曳事件中
                        const itemData = card.__vue__?.item || {};
                        dragEvent.dataTransfer.setData('application/json', JSON.stringify(itemData));
                        
                        // 觸發拖曳事件
                        card.dispatchEvent(dragEvent);
                        card.classList.add('dragging');
                    }, { passive: false });
                    
                    // 處理觸控移動
                    card.addEventListener('touchmove', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // 獲取觸控位置
                        const touch = e.touches[0];
                        const x = touch.clientX;
                        const y = touch.clientY;
                        
                        // 將卡片移動到觸控位置
                        card.style.position = 'fixed';
                        card.style.left = (x - card.offsetWidth / 2) + 'px';
                        card.style.top = (y - card.offsetHeight / 2) + 'px';
                        card.style.zIndex = '1000';
                        card.style.pointerEvents = 'none';
                        
                        // 檢測是否在有效的放置區域上方
                        const elementsAtPoint = document.elementsFromPoint(x, y);
                        const dropTarget = elementsAtPoint.find(el => 
                            el.classList.contains('cooking-station') || 
                            el.classList.contains('target-slot') ||
                            el.classList.contains('trash-bin')
                        );
                        
                        // 移除所有區域的dragover狀態
                        document.querySelectorAll('.dragover').forEach(el => {
                            el.classList.remove('dragover');
                        });
                        
                        // 如果找到目標，添加dragover狀態
                        if (dropTarget) {
                            dropTarget.classList.add('dragover');
                        }
                    }, { passive: false });
                    
                    // 處理觸控結束
                    card.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // 獲取最後的觸控位置
                        const touch = e.changedTouches[0];
                        const x = touch.clientX;
                        const y = touch.clientY;
                        
                        // 重置卡片樣式
                        card.style.position = '';
                        card.style.left = '';
                        card.style.top = '';
                        card.style.zIndex = '';
                        card.style.pointerEvents = '';
                        card.classList.remove('dragging');
                        
                        // 檢測是否在有效的放置區域上方
                        const elementsAtPoint = document.elementsFromPoint(x, y);
                        const dropTarget = elementsAtPoint.find(el => 
                            el.classList.contains('cooking-station') || 
                            el.classList.contains('target-slot') ||
                            el.classList.contains('trash-bin')
                        );
                        
                        // 如果找到目標，觸發drop事件
                        if (dropTarget) {
                            const dropEvent = new DragEvent('drop', {
                                bubbles: true,
                                cancelable: true,
                                dataTransfer: new DataTransfer()
                            });
                            
                            // 將物品數據存儲到拖曳事件中
                            const itemData = card.__vue__?.item || {};
                            dropEvent.dataTransfer.setData('application/json', JSON.stringify(itemData));
                            
                            dropTarget.dispatchEvent(dropEvent);
                            dropTarget.classList.remove('dragover');
                        }
                        
                        // 移除所有區域的dragover狀態
                        document.querySelectorAll('.dragover').forEach(el => {
                            el.classList.remove('dragover');
                        });
                    }, { passive: false });
                });
                
                console.log('已設置強力觸控拖曳，共處理 ' + allCards.length + ' 個卡片');
            }, 1000); // 延遲1秒，確保Vue已經渲染完成
        });
    </script>
</head>
<body>
    <!-- User Status Indicator -->
    <div id="userStatus" class="user-status">
        <img id="userStatusAvatar" src="/images/a01girlmove.gif" alt="User">
        <span id="userStatusName" class="username">未登入</span>
    </div>

    <div id="cooking-game">
        <!-- Vue 應用將在此掛載 -->
    </div>
    
    <!-- 確保使用 type="module" 屬性 -->
    <script type="module" src="./js/cooking-game.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // User status elements
            const userStatusAvatar = document.getElementById('userStatusAvatar');
            const userStatusName = document.getElementById('userStatusName');
            const userStatus = document.getElementById('userStatus');

            // 檢查是否有已保存的登入信息
            const savedUserId = localStorage.getItem('boxCurrentUserId');
            const savedUserToken = localStorage.getItem(`boxUserToken_${savedUserId}`);
            const savedUserAvatarUrl = localStorage.getItem('boxCurrentUserAvatar');
            const savedUserName = localStorage.getItem('boxCurrentUsername');
            const savedDisplayName = localStorage.getItem('boxCurrentDisplayName') || savedUserName;

            // Update the user status indicator
            if (savedUserId && savedUserToken && savedUserName) {
                userStatusAvatar.src = savedUserAvatarUrl || '/images/a01girlmove.gif';
                userStatusName.textContent = savedDisplayName;
                
                // Add click event to navigate to user editor page
                userStatus.addEventListener('click', () => {
                    window.location.href = `/member-editor.html?userId=${savedUserId}`;
                });
            } else {
                userStatusAvatar.src = '/images/a01girlmove.gif';
                userStatusName.textContent = '未登入';
                userStatus.addEventListener('click', () => {
                    // 變更為導向會員登入頁
                    window.location.href = `/member-login.html?redirect=${encodeURIComponent(window.location.href)}`;
                });
            }
        });
    </script>
</body>
</html>