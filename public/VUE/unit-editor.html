<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片元件編輯器</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/unit-editor.css">
</head>
<body>
    <div id="app">
        <div class="main-container">
            <!-- ===== Left Pane ===== -->
            <div class="editor-pane">
                 <h1 class="main-title">圖片元件編輯器</h1>
                 <a href="unit-viewer.html" style="display: block; text-align: center; margin-bottom: 20px;">前往預覽器</a>

                <!-- Panel 1: Load Spritesheet -->
                <div class="panel">
                    <h3 class="panel-title">1. 載入精靈圖</h3>
                    <div class="panel-content">
                        <div class="image-input">
                            <input type="text" v-model="imageUrl" placeholder="貼上圖片 URL">
                            <button @click="previewImage" class="btn">載入</button>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Select Category -->
                <div class="panel">
                    <h3 class="panel-title">2. 選擇元件分類 &amp; 命名</h3>
                    <div class="panel-content">
                        <div class="category-selector">
                             <button 
                                v-for="cat in categories" 
                                :key="cat" 
                                class="btn category-btn"
                                :class="{ 'active': componentCategory === cat }"
                                @click="setCategory(cat)">
                                {{ cat }}
                            </button>
                        </div>
                        <div class="control-item" style="margin-top: 15px;">
                            <label for="component-name" style="margin-right: 10px;">元件名稱:</label>
                            <input type="text" id="component-name" v-model="componentName" placeholder="例如：英雄角色、生命藥水...">
                        </div>
                        <div class="control-item" style="margin-top: 10px;">
                            <label for="component-subcategory" style="margin-right: 10px;">子分類:</label>
                            <input type="text" id="component-subcategory" v-model="componentSubcategory" placeholder="選填，例如：裝備、道具...">
                        </div>
                        <div class="control-item" style="margin-top: 10px;">
                            <label for="display-scale" style="margin-right: 10px;">顯示比例:</label>
                            <input type="number" id="display-scale" v-model.number="displayScale" min="1" max="500" placeholder="100" style="width: 80px;">
                            <span style="margin-left: 5px;">%</span>
                        </div>
                    </div>
                </div>

                <!-- Panel 3: Select & Create Component -->
                <div class="panel" v-if="previewImageUrl">
                    <h3 class="panel-title">3. 圈選 & 建立元件</h3>
                    <div class="panel-content">
                        <div class="controls">
                            <div class="control-item">
                                <label>縮放:</label>
                                <select v-model="scale">
                                    <option value="4">4X</option>
                                    <option value="2">2X</option>
                                    <option value="1">1X</option>
                                    <option value="0.5">0.5X (-2X)</option>
                                    <option value="0.25">0.25X (-4X)</option>
                                </select>
                            </div>
                            <div class="coordinates control-item">
                                <span>X: {{ mouseX }}</span>
                                <span>Y: {{ mouseY }}</span>
                            </div>
                        </div>
                        
                        <!-- 網格預覽區域，固定顯示 -->
                        <div class="grid-preview-container">
                            <h5>網格預覽</h5>
                            <div class="grid-preview" ref="gridPreview">
                                <!-- 2x2 網格底圖 -->
                                <div class="grid-cells">
                                    <div class="grid-cell" v-for="i in 4" :key="i"></div>
                                </div>
                                <!-- 元件預覽 -->
                                <div class="preview-component" :style="getGridPreviewStyle()"></div>
                            </div>
                        </div>

                        <div class="image-preview">
                            <div class="selection-area" ref="selectionArea" :style="getSelectionAreaStyle()">
                                <img :src="previewImageUrl"
                                     @error="handleImageError"
                                     alt="預覽圖片"
                                     ref="previewImage"
                                     @load="initializeSelection"
                                     @mousedown="startSelection"
                                     @mousemove="updateSelection"
                                     @mouseup="endSelection"
                                     @mouseleave="endSelection"
                                     :style="getPreviewImageStyle()"
                                     draggable="false">
                                <div class="selection-box"
                                     v-show="isSelecting || hasSelection"
                                     :style="selectionStyle"></div>
                                <div v-for="(style, index) in addedFrameStyles" 
                                     :key="'added-frame-' + index"
                                     class="added-frame-box"
                                     :style="style"></div>
                            </div>
                        </div>

                        <div v-if="hasSelection">
                            <div class="selection-info">
                                已選取: {{ Math.round(selectionWidth) }}x{{ Math.round(selectionHeight) }}px
                            </div>
                            <div class="component-preview" v-if="componentImageData">
                                <canvas ref="componentCanvas"
                                        :width="selectionWidth"
                                        :height="selectionHeight"></canvas>
                                <div class="component-preview-overlay">
                                    <div class="anchor-marker" :style="getAnchorMarkerStyle()"></div>
                                </div>
                            </div>
                            
                            <div class="selection-controls">
                                <button @click="saveComponent" class="btn btn-primary">建立靜態元件</button>
                                <button @click="addFrameToAnimation" class="btn btn-secondary">加入動畫幀 ({{ multiSelectionFrames.length }})</button>
                                <button @click="clearSelection" class="btn btn-secondary">取消選取</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel 3.5: Animation Creator -->
                <div class="panel animation-creator" v-if="multiSelectionFrames.length > 0">
                    <h3 class="panel-title">動畫建立器</h3>
                    <div class="panel-content">
                        <!-- Frames Preview -->
                        <div class="frame-list">
                            <div v-for="(frame, index) in multiSelectionFrames" :key="index" class="frame-item">
                                <img :src="frame.imageData" :alt="'Frame ' + (index + 1)">
                                <span class="frame-index">{{ index + 1 }}</span>
                            </div>
                        </div>

                        <!-- Animation Settings -->
                        <div class="animation-controls">
                            <div class="control-item">
                                <label for="anim-speed">速度 (ms/幀):</label>
                                <input type="number" id="anim-speed" v-model.number="animationSpeed" min="16">
                            </div>
                            <div class="control-item">
                                <label for="anim-loop">循環播放:</label>
                                <input type="checkbox" id="anim-loop" v-model="animationLoop">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="selection-controls">
                            <button @click="saveAnimationComponent" class="btn btn-primary">建立動畫元件</button>
                            <button @click="clearAnimationFrames" class="btn btn-danger">全部清除</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Resizer Handle ===== -->
            <div class="resizer" @mousedown="startResize"></div>

            <!-- ===== Right Pane (Inspector) ===== -->
            <div class="inspector-pane" ref="inspectorPane">
                <!-- Panel 4: Component Library -->
                <div class="panel" v-if="savedComponents.length > 0">
                    <h3 class="panel-title">
                        4. 元件庫
                        <button @click="exportToFile" class="btn btn-primary btn-sm" style="float: right; margin-left: 5px;">儲存到檔案</button>
                        <button @click="copyAllState" class="btn btn-secondary btn-sm" style="float: right;">一鍵複製</button>
                    </h3>
                    <div class="panel-content">
                        <!-- Category Filter Buttons -->
                        <div class="category-filter-bar">
                            <button 
                                class="btn filter-btn" 
                                :class="{ 'active': activeCategoryFilter === 'all' }"
                                @click="activeCategoryFilter = 'all'">
                                全部
                            </button>
                            <button 
                                v-for="cat in categories" 
                                :key="cat" 
                                class="btn filter-btn"
                                :class="{ 'active': activeCategoryFilter === cat }"
                                @click="activeCategoryFilter = cat">
                                {{ cat }}
                            </button>
                        </div>

                        <div v-for="category in categories" :key="category" class="category-group" v-if="activeCategoryFilter === 'all' || activeCategoryFilter === category">
                            <h4 class="category-title">{{ category }}</h4>
                            <div v-if="categorizedComponents[category] && Object.keys(categorizedComponents[category]).length > 0">
                                <div v-for="(components, name) in categorizedComponents[category]" :key="name" class="name-group" style="margin-bottom: 10px;">
                                    <h5 class="name-group-title" style="margin: 10px 0 5px; padding-left: 5px; font-weight: 500; color: var(--text-secondary);">{{ name }} ({{ components.length }})</h5>
                                    <div class="components-list">
                                        <div
                                            v-for="component in components"
                                            :key="component.originalIndex"
                                            class="component-item"
                                            :class="{ 'selected': selectedComponentIndex === component.originalIndex }"
                                            @click="selectComponent(component.originalIndex)">
                                            
                                            <!-- Static Image for non-animation components -->
                                            <!-- GIF 檔案直接使用原始 URL -->
                                            <img v-if="component.type === 'static' && component.fileType === 'gif'"
                                                 :src="component.spritesheetUrl"
                                                 :alt="component.name">
                                                 
                                            <!-- 其他靜態元件使用 imageData -->
                                            <img v-else-if="component.type === 'static'"
                                                 :src="component.imageData"
                                                 :alt="component.name">
                                            
                                            <!-- Canvas for animation components -->
                                            <canvas v-if="component.type === 'animation'"
                                                    :ref="'anim-canvas-' + component.originalIndex"
                                                    :width="component.width"
                                                    :height="component.height">
                                            </canvas>

                                            <!-- Subcategory display -->
                                            <div v-if="component.subcategory" class="component-subcategory">
                                                {{ component.subcategory }}
                                            </div>

                                            <button class="delete-btn" @click.stop="deleteComponent(component.originalIndex)">×</button>
                                            <button class="edit-btn" @click.stop="openEditModal(component.originalIndex)">✎</button>
                                            <button class="copy-btn" @click.stop="copyComponentData(component.originalIndex)">
                                                <span v-if="copiedFeedback[component.originalIndex]">已複製!</span>
                                                <span v-else>📋</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="empty-category-placeholder" v-else>
                                (此分類暫無元件)
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="panel" v-else>
                     <div class="panel-content" style="text-align: center;">
                        元件庫是空的。
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Edit Component Modal ===== -->
        <div class="modal-overlay" v-if="isEditing" @click.self="closeEditModal">
            <div class="modal-content" v-if="editingComponent">
                <div class="modal-header">
                    <h3>編輯元件</h3>
                </div>
                <div class="modal-body">
                    <!-- Edit Name -->
                    <div class="form-group">
                        <label for="edit-name">名稱</label>
                        <input type="text" id="edit-name" v-model="editingComponent.name">
                    </div>
                    <!-- Edit Category -->
                    <div class="form-group">
                        <label for="edit-category">分類</label>
                        <select id="edit-category" v-model="editingComponent.category">
                            <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                    </div>
                    
                    <!-- Edit Subcategory (new) -->
                    <div class="form-group">
                        <label for="edit-subcategory">子分類</label>
                        <input type="text" id="edit-subcategory" v-model="editingComponent.subcategory" placeholder="選填，例如：裝備、道具...">
                    </div>
                    
                    <!-- Edit Display Scale -->
                    <div class="form-group">
                        <label for="edit-display-scale">顯示比例 (%)</label>
                        <input type="number" id="edit-display-scale" v-model.number="editingComponent.displayScale" min="1" max="500" placeholder="100">
                    </div>

                    <!-- Edit Animation Properties (only for animation components) -->
                    <div v-if="editingComponent.type === 'animation'">
                        <div class="form-group">
                            <label for="edit-anim-speed">動畫速度 (ms/幀)</label>
                            <input type="number" id="edit-anim-speed" v-model.number="editingComponent.animation.speed" min="16">
                        </div>
                        <div class="form-group">
                            <label for="edit-anim-loop">循環播放</label>
                            <input type="checkbox" id="edit-anim-loop" v-model="editingComponent.animation.loop">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="saveComponentChanges" class="btn btn-primary">儲存變更</button>
                    <button @click="closeEditModal" class="btn btn-secondary">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/unit-editor.js"></script>
</body>
</html>