<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂúñÁâáÂÖÉ‰ª∂Á∑®ËºØÂô®</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/unit-editor.css">
</head>
<body>
    <div id="app">
        <div class="main-container">
            <!-- ===== Left Pane ===== -->
            <div class="editor-pane">
                 <h1 class="main-title">ÂúñÁâáÂÖÉ‰ª∂Á∑®ËºØÂô®</h1>
                 <a href="unit-viewer.html" style="display: block; text-align: center; margin-bottom: 20px;">ÂâçÂæÄÈ†êË¶ΩÂô®</a>

                <!-- Panel 1: Load Spritesheet -->
                <div class="panel">
                    <h3 class="panel-title">1. ËºâÂÖ•Á≤æÈùàÂúñ</h3>
                    <div class="panel-content">
                        <div class="image-input">
                            <input type="text" v-model="imageUrl" placeholder="Ë≤º‰∏äÂúñÁâá URL">
                            <button @click="previewImage" class="btn">ËºâÂÖ•</button>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Select Category -->
                <div class="panel">
                    <h3 class="panel-title">2. ÈÅ∏ÊìáÂÖÉ‰ª∂ÂàÜÈ°û &amp; ÂëΩÂêç</h3>
                    <div class="panel-content">
                        <div class="category-selector">
                             <button 
                                v-for="cat in categories" 
                                :key="cat" 
                                class="btn category-btn"
                                :class="{ 'active': componentCategory === cat }"
                                @click="setCategory(cat)">
                                {{ cat }}
                            </button>
                        </div>
                        <div class="control-item" style="margin-top: 15px;">
                            <label for="component-name" style="margin-right: 10px;">ÂÖÉ‰ª∂ÂêçÁ®±:</label>
                            <input type="text" id="component-name" v-model="componentName" placeholder="‰æãÂ¶ÇÔºöËã±ÈõÑËßíËâ≤„ÄÅÁîüÂëΩËó•Ê∞¥...">
                        </div>
                        <div class="control-item" style="margin-top: 10px;">
                            <label for="component-subcategory" style="margin-right: 10px;">Â≠êÂàÜÈ°û:</label>
                            <input type="text" id="component-subcategory" v-model="componentSubcategory" placeholder="ÈÅ∏Â°´Ôºå‰æãÂ¶ÇÔºöË£ùÂÇô„ÄÅÈÅìÂÖ∑...">
                        </div>
                        <div class="control-item" style="margin-top: 10px;">
                            <label for="display-scale" style="margin-right: 10px;">È°ØÁ§∫ÊØî‰æã:</label>
                            <input type="number" id="display-scale" v-model.number="displayScale" min="1" max="500" placeholder="100" style="width: 80px;">
                            <span style="margin-left: 5px;">%</span>
                        </div>
                    </div>
                </div>

                <!-- Panel 3: Select & Create Component -->
                <div class="panel" v-if="previewImageUrl">
                    <h3 class="panel-title">3. ÂúàÈÅ∏ & Âª∫Á´ãÂÖÉ‰ª∂</h3>
                    <div class="panel-content">
                        <div class="controls">
                            <div class="control-item">
                                <label>Á∏ÆÊîæ:</label>
                                <select v-model="scale">
                                    <option value="4">4X</option>
                                    <option value="2">2X</option>
                                    <option value="1">1X</option>
                                    <option value="0.5">0.5X (-2X)</option>
                                    <option value="0.25">0.25X (-4X)</option>
                                </select>
                            </div>
                            <div class="coordinates control-item">
                                <span>X: {{ mouseX }}</span>
                                <span>Y: {{ mouseY }}</span>
                            </div>
                        </div>
                        
                        <!-- Á∂≤Ê†ºÈ†êË¶ΩÂçÄÂüüÔºåÂõ∫ÂÆöÈ°ØÁ§∫ -->
                        <div class="grid-preview-container">
                            <h5>Á∂≤Ê†ºÈ†êË¶Ω</h5>
                            <div class="grid-preview" ref="gridPreview">
                                <!-- 2x2 Á∂≤Ê†ºÂ∫ïÂúñ -->
                                <div class="grid-cells">
                                    <div class="grid-cell" v-for="i in 4" :key="i"></div>
                                </div>
                                <!-- ÂÖÉ‰ª∂È†êË¶Ω -->
                                <div class="preview-component" :style="getGridPreviewStyle()"></div>
                            </div>
                        </div>

                        <div class="image-preview">
                            <div class="selection-area" ref="selectionArea" :style="getSelectionAreaStyle()">
                                <img :src="previewImageUrl"
                                     @error="handleImageError"
                                     alt="È†êË¶ΩÂúñÁâá"
                                     ref="previewImage"
                                     @load="initializeSelection"
                                     @mousedown="startSelection"
                                     @mousemove="updateSelection"
                                     @mouseup="endSelection"
                                     @mouseleave="endSelection"
                                     :style="getPreviewImageStyle()"
                                     draggable="false">
                                <div class="selection-box"
                                     v-show="isSelecting || hasSelection"
                                     :style="selectionStyle"></div>
                                <div v-for="(style, index) in addedFrameStyles" 
                                     :key="'added-frame-' + index"
                                     class="added-frame-box"
                                     :style="style"></div>
                            </div>
                        </div>

                        <div v-if="hasSelection">
                            <div class="selection-info">
                                Â∑≤ÈÅ∏Âèñ: {{ Math.round(selectionWidth) }}x{{ Math.round(selectionHeight) }}px
                            </div>
                            <div class="component-preview" v-if="componentImageData">
                                <canvas ref="componentCanvas"
                                        :width="selectionWidth"
                                        :height="selectionHeight"></canvas>
                                <div class="component-preview-overlay">
                                    <div class="anchor-marker" :style="getAnchorMarkerStyle()"></div>
                                </div>
                            </div>
                            
                            <div class="selection-controls">
                                <button @click="saveComponent" class="btn btn-primary">Âª∫Á´ãÈùúÊÖãÂÖÉ‰ª∂</button>
                                <button @click="addFrameToAnimation" class="btn btn-secondary">Âä†ÂÖ•ÂãïÁï´ÂπÄ ({{ multiSelectionFrames.length }})</button>
                                <button @click="clearSelection" class="btn btn-secondary">ÂèñÊ∂àÈÅ∏Âèñ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel 3.5: Animation Creator -->
                <div class="panel animation-creator" v-if="multiSelectionFrames.length > 0">
                    <h3 class="panel-title">ÂãïÁï´Âª∫Á´ãÂô®</h3>
                    <div class="panel-content">
                        <!-- Frames Preview -->
                        <div class="frame-list">
                            <div v-for="(frame, index) in multiSelectionFrames" :key="index" class="frame-item">
                                <img :src="frame.imageData" :alt="'Frame ' + (index + 1)">
                                <span class="frame-index">{{ index + 1 }}</span>
                            </div>
                        </div>

                        <!-- Animation Settings -->
                        <div class="animation-controls">
                            <div class="control-item">
                                <label for="anim-speed">ÈÄüÂ∫¶ (ms/ÂπÄ):</label>
                                <input type="number" id="anim-speed" v-model.number="animationSpeed" min="16">
                            </div>
                            <div class="control-item">
                                <label for="anim-loop">Âæ™Áí∞Êí≠Êîæ:</label>
                                <input type="checkbox" id="anim-loop" v-model="animationLoop">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="selection-controls">
                            <button @click="saveAnimationComponent" class="btn btn-primary">Âª∫Á´ãÂãïÁï´ÂÖÉ‰ª∂</button>
                            <button @click="clearAnimationFrames" class="btn btn-danger">ÂÖ®ÈÉ®Ê∏ÖÈô§</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Resizer Handle ===== -->
            <div class="resizer" @mousedown="startResize"></div>

            <!-- ===== Right Pane (Inspector) ===== -->
            <div class="inspector-pane" ref="inspectorPane">
                <!-- Panel 4: Component Library -->
                <div class="panel" v-if="savedComponents.length > 0">
                    <h3 class="panel-title">
                        4. ÂÖÉ‰ª∂Â∫´
                        <button @click="exportToFile" class="btn btn-primary btn-sm" style="float: right; margin-left: 5px;">ÂÑ≤Â≠òÂà∞Ê™îÊ°à</button>
                        <button @click="copyAllState" class="btn btn-secondary btn-sm" style="float: right;">‰∏ÄÈçµË§áË£Ω</button>
                    </h3>
                    <div class="panel-content">
                        <!-- Category Filter Buttons -->
                        <div class="category-filter-bar">
                            <button 
                                class="btn filter-btn" 
                                :class="{ 'active': activeCategoryFilter === 'all' }"
                                @click="activeCategoryFilter = 'all'">
                                ÂÖ®ÈÉ®
                            </button>
                            <button 
                                v-for="cat in categories" 
                                :key="cat" 
                                class="btn filter-btn"
                                :class="{ 'active': activeCategoryFilter === cat }"
                                @click="activeCategoryFilter = cat">
                                {{ cat }}
                            </button>
                        </div>

                        <div v-for="category in categories" :key="category" class="category-group" v-if="activeCategoryFilter === 'all' || activeCategoryFilter === category">
                            <h4 class="category-title">{{ category }}</h4>
                            <div v-if="categorizedComponents[category] && Object.keys(categorizedComponents[category]).length > 0">
                                <div v-for="(components, name) in categorizedComponents[category]" :key="name" class="name-group" style="margin-bottom: 10px;">
                                    <h5 class="name-group-title" style="margin: 10px 0 5px; padding-left: 5px; font-weight: 500; color: var(--text-secondary);">{{ name }} ({{ components.length }})</h5>
                                    <div class="components-list">
                                        <div
                                            v-for="component in components"
                                            :key="component.originalIndex"
                                            class="component-item"
                                            :class="{ 'selected': selectedComponentIndex === component.originalIndex }"
                                            @click="selectComponent(component.originalIndex)">
                                            
                                            <!-- Static Image for non-animation components -->
                                            <!-- GIF Ê™îÊ°àÁõ¥Êé•‰ΩøÁî®ÂéüÂßã URL -->
                                            <img v-if="component.type === 'static' && component.fileType === 'gif'"
                                                 :src="component.spritesheetUrl"
                                                 :alt="component.name">
                                                 
                                            <!-- ÂÖ∂‰ªñÈùúÊÖãÂÖÉ‰ª∂‰ΩøÁî® imageData -->
                                            <img v-else-if="component.type === 'static'"
                                                 :src="component.imageData"
                                                 :alt="component.name">
                                            
                                            <!-- Canvas for animation components -->
                                            <canvas v-if="component.type === 'animation'"
                                                    :ref="'anim-canvas-' + component.originalIndex"
                                                    :width="component.width"
                                                    :height="component.height">
                                            </canvas>

                                            <!-- Subcategory display -->
                                            <div v-if="component.subcategory" class="component-subcategory">
                                                {{ component.subcategory }}
                                            </div>

                                            <button class="delete-btn" @click.stop="deleteComponent(component.originalIndex)">√ó</button>
                                            <button class="edit-btn" @click.stop="openEditModal(component.originalIndex)">‚úé</button>
                                            <button class="copy-btn" @click.stop="copyComponentData(component.originalIndex)">
                                                <span v-if="copiedFeedback[component.originalIndex]">Â∑≤Ë§áË£Ω!</span>
                                                <span v-else>üìã</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="empty-category-placeholder" v-else>
                                (Ê≠§ÂàÜÈ°ûÊö´ÁÑ°ÂÖÉ‰ª∂)
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="panel" v-else>
                     <div class="panel-content" style="text-align: center;">
                        ÂÖÉ‰ª∂Â∫´ÊòØÁ©∫ÁöÑ„ÄÇ
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Edit Component Modal ===== -->
        <div class="modal-overlay" v-if="isEditing" @click.self="closeEditModal">
            <div class="modal-content" v-if="editingComponent">
                <div class="modal-header">
                    <h3>Á∑®ËºØÂÖÉ‰ª∂</h3>
                </div>
                <div class="modal-body">
                    <!-- Edit Name -->
                    <div class="form-group">
                        <label for="edit-name">ÂêçÁ®±</label>
                        <input type="text" id="edit-name" v-model="editingComponent.name">
                    </div>
                    <!-- Edit Category -->
                    <div class="form-group">
                        <label for="edit-category">ÂàÜÈ°û</label>
                        <select id="edit-category" v-model="editingComponent.category">
                            <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                    </div>
                    
                    <!-- Edit Subcategory (new) -->
                    <div class="form-group">
                        <label for="edit-subcategory">Â≠êÂàÜÈ°û</label>
                        <input type="text" id="edit-subcategory" v-model="editingComponent.subcategory" placeholder="ÈÅ∏Â°´Ôºå‰æãÂ¶ÇÔºöË£ùÂÇô„ÄÅÈÅìÂÖ∑...">
                    </div>
                    
                    <!-- Edit Display Scale -->
                    <div class="form-group">
                        <label for="edit-display-scale">È°ØÁ§∫ÊØî‰æã (%)</label>
                        <input type="number" id="edit-display-scale" v-model.number="editingComponent.displayScale" min="1" max="500" placeholder="100">
                    </div>

                    <!-- Edit Animation Properties (only for animation components) -->
                    <div v-if="editingComponent.type === 'animation'">
                        <div class="form-group">
                            <label for="edit-anim-speed">ÂãïÁï´ÈÄüÂ∫¶ (ms/ÂπÄ)</label>
                            <input type="number" id="edit-anim-speed" v-model.number="editingComponent.animation.speed" min="16">
                        </div>
                        <div class="form-group">
                            <label for="edit-anim-loop">Âæ™Áí∞Êí≠Êîæ</label>
                            <input type="checkbox" id="edit-anim-loop" v-model="editingComponent.animation.loop">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="saveComponentChanges" class="btn btn-primary">ÂÑ≤Â≠òËÆäÊõ¥</button>
                    <button @click="closeEditModal" class="btn btn-secondary">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/unit-editor.js"></script>
</body>
</html>