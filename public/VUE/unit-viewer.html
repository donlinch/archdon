<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元件預覽器</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/unit-viewer.css">
</head>
<body>
    <div id="app">
        <div class="viewer-container">
            <!-- Left Pane: Grid -->
            <div class="editor-pane">
                 
                 <div class="grid-container" ref="gridContainer" 
                      :style="gridContainerStyle"
                      @dragover.prevent="onDragOver"
                      @drop.prevent="onDrop">
                    <div
                        class="grid-cell"
                        v-for="i in gridCellCount"
                        :key="'cell-' + i"
                        :class="{ 'hover-preview': hoverCellIndex === (i - 1) }"
                        @dragenter.prevent="onDragEnter(i - 1)"
                        @dragleave.prevent="onDragLeave(i - 1)">
                    </div>
                    
                    <!-- Render placed components -->
                    <template v-for="component in placedComponents">
                        <!-- Placed GIF Component -->
                        <img v-if="getOriginalComponent(component.componentId).type === 'static' && getOriginalComponent(component.componentId).fileType === 'gif'"
                             :key="'gif-' + component.id"
                             :src="getOriginalComponent(component.componentId).spritesheetUrl"
                             :style="getPlacedComponentStyle(component)"
                             class="placed-component"
                             :class="{ 'is-dragging': component.isDragging }"
                             draggable="true"
                             @dragstart="onDragStart($event, component.id, 'grid')">
                        
                        <!-- Static Placed Component (non-GIF) -->
                        <div v-else-if="getOriginalComponent(component.componentId).type === 'static'"
                             :key="'static-' + component.id"
                             class="placed-component"
                             :style="getPlacedComponentStyle(component)"
                             :class="{ 'is-dragging': component.isDragging }"
                             draggable="true"
                             @dragstart="onDragStart($event, component.id, 'grid')">
                        </div>
                        <!-- Animated Placed Component -->
                        <canvas v-else
                                :key="'anim-' + component.id"
                                class="placed-component"
                                :style="{ left: component.positionX + 'px', top: component.positionY + 'px', zIndex: component.zIndex }"
                                :class="{ 'is-dragging': component.isDragging }"
                                :ref="'anim-canvas-grid-' + component.id"
                                :width="component.width"
                                :height="component.height"
                                draggable="true"
                                @dragstart="onDragStart($event, component.id, 'grid')">
                        </canvas>
                    </template>
                </div>
            </div>

            <!-- Resizer Handle -->
            <div class="resizer" @mousedown="startResize"></div>

            <!-- Right Pane: Component Library -->
            <div class="inspector-pane" ref="inspectorPane">
                <div class="component-library-header">
                    <h3>元件庫</h3>
                    <div class="filters">
                        <input type="text" v-model="searchQuery" placeholder="搜尋元件名稱..." class="search-input">
                        <select v-model="activeCategoryFilter">
                            <option value="all">所有分類</option>
                            <option v-for="category in categories" :key="category" :value="category">{{ category }}</option>
                        </select>
                    </div>
                </div>

                <div v-if="Object.keys(categorizedComponents).length === 0" class="empty-state">
                    <p>沒有符合條件的元件。</p>
                </div>
                <!-- Component Library Panel -->
                <div class="panel" v-if="savedComponents.length > 0">
                    <div class="panel-content">
                        <!-- Category Filter Buttons -->
                        <div class="category-filter-bar">
                            <button 
                                class="btn filter-btn" 
                                :class="{ 'active': activeCategoryFilter === 'all' }"
                                @click="activeCategoryFilter = 'all'">
                                全部
                            </button>
                            <button 
                                v-for="cat in categories" 
                                :key="cat" 
                                class="btn filter-btn"
                                :class="{ 'active': activeCategoryFilter === cat }"
                                @click="activeCategoryFilter = cat">
                                {{ cat }}
                            </button>
                        </div>

                        <!-- Categories -->
                        <div v-for="category in categories" :key="category" class="category-group" v-if="activeCategoryFilter === 'all' || activeCategoryFilter === category">
                            <h4 class="category-title">{{ category }}</h4>
                            <div v-if="categorizedComponents[category] && Object.keys(categorizedComponents[category]).length > 0">
                                <div v-for="(components, name) in categorizedComponents[category]" :key="name" class="name-group" style="margin-bottom: 10px;">
                                    <h5 class="name-group-title" style="margin: 10px 0 5px; padding-left: 5px; font-weight: 500; color: var(--text-secondary);">{{ name }} ({{ components.length }})</h5>
                                    <div class="components-list">
                                        <!-- Component Item -->
                                        <div
                                            v-for="component in components"
                                            :key="component.originalIndex"
                                            class="component-item"
                                            :class="{ 'dragging': draggingComponentIndex === component.originalIndex }">
                                            
                                            <div class="library-item-content" :draggable="true" @dragstart="onDragStart($event, component.originalIndex, 'library')">
                                            
                                                <div class="copy-button" @click="copyComponentJson(component)" title="複製元件JSON">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                                </div>

                                                <!-- GIF 檔案直接使用原始 URL -->
                                                <img v-if="component.type === 'static' && component.fileType === 'gif'"
                                                     :src="component.spritesheetUrl"
                                                     :alt="component.name"
                                                     class="component-preview">
                                                
                                                <!-- 其他靜態元件使用 imageData -->
                                                <img v-else-if="component.type === 'static' && component.imageData"
                                                     :src="component.imageData"
                                                     :alt="component.name"
                                                     class="component-preview">
                                            
                                                <canvas v-if="component.type === 'animation'"
                                                        :ref="'anim-canvas-library-' + component.originalIndex"
                                                        :width="component.width"
                                                        :height="component.height"
                                                        draggable="true"
                                                        @dragstart="onDragStart($event, component.originalIndex, 'library')"
                                                        @dragend="onDragEnd">
                                                </canvas>

                                                <!-- Subcategory display -->
                                                <div v-if="component.subcategory" class="component-subcategory">
                                                    {{ component.subcategory }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="empty-category-placeholder" v-else>
                                (此分類暫無元件)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder for when no components exist -->
                <div class="panel" v-else>
                     <div class="panel-content" style="text-align: center;">
                        元件庫是空的。請先在編輯器中建立一些元件。
                    </div>
                </div>
            </div>
        </div>
        <div v-if="copyNotification.show" class="copy-notification">{{ copyNotification.message }}</div>
    </div>

    <script src="js/unit-viewer.js"></script>
</body>
</html> 