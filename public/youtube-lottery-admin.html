<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Áõ¥Êí≠ÊäΩÁçéÁÆ°ÁêÜÂæåÂè∞</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #16213e;
            --secondary-color: #0f3460;
            --accent-color: #e94560;
            --text-color: #dcdcdc;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 350px;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header header header"
                "settings-panel animation-panel participants-panel"
                "footer footer footer";
            gap: 20px;
            width: 100%;
            max-width: 1600px;
            height: 90vh;
        }

        .panel {
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }

        h1, h2 {
            color: var(--accent-color);
            text-align: center;
            margin-top: 0;
        }

        #header { grid-area: header; text-align: center; padding-bottom: 10px; }
        #settings-panel { grid-area: settings-panel; }
        #animation-panel { grid-area: animation-panel; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        #participants-panel { grid-area: participants-panel; }
        #footer { grid-area: footer; }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-color);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            color: var(--text-color);
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #f06a81;
        }
        
        button.secondary {
             background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #1a4a8a;
        }


        #participants-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .participant {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--secondary-color);
            cursor: pointer;
            position: relative;
        }
        
        .participant:hover {
            background-color: var(--secondary-color);
        }

        .participant.selected {
            background-color: rgba(233, 69, 96, 0.2);
        }

        .participant .delete-btn {
            position: absolute;
            right: 10px;
            padding: 5px 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }

        .participant.selected .delete-btn {
            display: block;
        }

        .participant .delete-btn:hover {
            background-color: #d63031;
        }

        .participant img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        #participants-count {
            margin-top: 15px;
            text-align: center;
            font-size: 1.2em;
        }
        
        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--secondary-color);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            margin-top: 10px;
        }
        
        #ws-status {
            font-weight: bold;
        }
        .status-connected { color: #50fa7b; }
        .status-disconnected { color: #ff5555; }

        /* --- User Status Indicator (adapted for dark theme) --- */
        .user-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            background-color: rgba(30, 41, 59, 0.9); /* A slightly lighter shade from the theme */
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--secondary-color);
        }

        .user-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            background-color: var(--secondary-color);
        }

        .user-status img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-color);
            object-fit: cover;
        }

        .user-status .username {
            margin-left: 8px;
            font-weight: 600;
            color: var(--text-color);
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 767px) {
            .user-status {
                padding: 3px;
            }
            
            .user-status .username {
                display: none;
            }
        }

        /* Animation Styles */
        #winner-display {
            display: none !important; /* Ê†πÊìöË¶ÅÊ±ÇÔºå‰∏çÂÜç‰ΩøÁî®ÂΩàÂá∫ÂºèÂç°Áâá */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        #winner-display.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        #winner-display img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        #winner-display h2 {
            margin: 10px 0;
            color: #ff4757;
        }

        #winner-display h3 {
            font-size: 1.5em;
            color: #333;
        }

        .close-winner {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #draw-animation-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: scale(0.8); }
          to { opacity: 1; transform: scale(1); }
        }

        #animation-container {
            width: 100%;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        #wheel-canvas {
            margin: 0 auto;
            display: block;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        #pointer-animation {
            width: 100%;
            height: 150px;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pointer-winner-display {
            position: absolute;
            color: white;
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 15px var(--accent-color), 0 0 10px rgba(0,0,0,0.8);
            z-index: 5;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        #pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 20px solid var(--accent-color);
            z-index: 3;
            filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5));
        }

        #participants-reel {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            display: flex;
            will-change: transform;
        }

        .reel-participant-card {
            width: 120px;
            height: 120px;
            margin: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            text-align: center;
            flex-shrink: 0;
            padding: 5px;
            box-sizing: border-box;
            color: var(--text-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .reel-participant-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 8px;
        }

        .reel-participant-card span {
            font-size: 0.9em;
            font-weight: bold;
            word-break: break-all;
        }

        #default-animation {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        #participants-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        #participants-list li {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .winner-highlight {
            color: #ff4757;
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 0 0 5px rgba(255,71,87,0.3);
            background: rgba(255,71,87,0.1);
        }

        /* Remove animation duration input */
        #animation-duration {
            display: none;
        }

        /* Animated Button from Uiverse.io by gharsh11032000 - Adapted for this project */
        .animated-button {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 16px 36px;
            border: 2px solid var(--accent-color);
            border-radius: 100px;
            font-weight: 600;
            color: var(--accent-color);
            background-color: transparent;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
        }

        .animated-button svg {
            position: absolute;
            width: 24px;
            fill: var(--accent-color);
            z-index: 9;
            transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .animated-button .arr-1 {
            right: 16px;
        }

        .animated-button .arr-2 {
            left: -25%;
        }

        .animated-button .circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .animated-button .text {
            position: relative;
            z-index: 1;
            transform: translateX(0px); /* Adjusted for better centering */
            transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .animated-button:hover {
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.2);
            color: var(--bg-color);
            border-radius: 12px;
        }

        .animated-button:hover .arr-1 {
            right: -25%;
        }

        .animated-button:hover .arr-2 {
            left: 16px;
        }

        .animated-button:hover .text {
            transform: translateX(0px); /* Adjusted for better centering */
        }

        .animated-button:hover svg {
            fill: var(--bg-color);
        }

        .animated-button:active {
            scale: 0.95;
            box-shadow: 0 0 0 4px var(--accent-color);
        }

        .animated-button:hover .circle {
            width: 220px;
            height: 220px;
            opacity: 1;
        }

        /* Punch-hole (Ê¥ûÊ¥ûÊ®Ç) animation styles */
        #punch-hole-animation {
            width: 100%;
            height: 500px;
            position: relative;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            padding: 20px;
            box-sizing: border-box;
            perspective: 1000px;
            overflow: hidden;
        }

        .punch-card {
            width: 120px;
            height: 150px;
            position: relative;
            transition: all 0.6s ease;
            transform-style: preserve-3d;
            cursor: pointer;
            margin: 5px;
            justify-self: center;
        }

        .punch-card.shuffling {
            position: absolute;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .punch-card.face-down {
            transform: rotateY(180deg);
        }

        .punch-card.selected {
            transform: rotateY(0deg) !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            cursor: default;
            z-index: 10;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .punch-card.winner {
            box-shadow: 0 0 25px gold;
            animation: winner-pulse 1s infinite alternate;
            transform: rotateY(0deg) scale(1.5) !important;
            z-index: 20;
        }

        .punch-card-front, .punch-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .punch-card-front {
            background: var(--accent-color);
            padding: 10px;
            text-align: center;
            transform: rotateY(0deg);
        }

        .punch-card-back {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: 2px solid var(--accent-color);
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .punch-card-front img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            margin-bottom: 8px;
        }

        .punch-card-front span {
            font-size: 14px;
            font-weight: bold;
            color: white;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .punch-card-back::before {
            content: "";
            background-image: url('/images/android-chrome-192x192.png');
            background-size: 80px 80px;
            background-position: center;
            background-repeat: no-repeat;
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            z-index: 1;
            opacity: 0.4; /* Ë™øÊöóLogoÔºåËÆìÊï∏Â≠óÊõ¥Ê∏ÖÊô∞ */
        }

        .card-number {
            position: relative;
            z-index: 2;
            font-size: 3.5em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 0 12px rgba(0, 0, 0, 0.75);
            opacity: 0;
            transform: scale(0.5);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        .punch-card.face-down .card-number {
            opacity: 1;
            transform: scale(1);
            transition-delay: 0.4s; /* Âª∂ÈÅ≤Âá∫ÁèæÔºåÁ≠âÂæÖÁøªÁâåÂãïÁï´ */
        }

        @keyframes winner-pulse {
            from { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
        }

        #punch-hole-winner-display {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 10px var(--accent-color);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s ease;
            z-index: 10;
        }

        #punch-hole-winner-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        .punch-instruction {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--text-color);
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Toggle Switch from Uiverse.io by teymr */
        #checkbox {
            display: none;
        }

        .switch {
            position: relative;
            width: 70px;
            height: 70px;
            background-color: rgb(99, 99, 99);
            border-radius: 50%;
            z-index: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgb(126, 126, 126);
            box-shadow: 0px 0px 3px rgb(2, 2, 2) inset;
            transition: 0.5s;
        }

        .switch svg {
            width: 1.2em;
        }

        .switch svg path {
            fill: rgb(48, 48, 48);
        }

        #checkbox:checked + .switch {
            box-shadow:
                0px 0px 1px rgb(151, 243, 255) inset,
                0px 0px 2px rgb(151, 243, 255) inset,
                0px 0px 10px rgb(151, 243, 255) inset,
                0px 0px 40px rgb(151, 243, 255),
                0px 0px 100px rgb(151, 243, 255),
                0px 0px 5px rgb(151, 243, 255);
            border: 2px solid rgb(255, 255, 255);
            background-color: rgb(146, 180, 184);
        }

        #checkbox:checked + .switch svg {
            filter: drop-shadow(0px 0px 5px rgb(151, 243, 255));
        }

        #checkbox:checked + .switch svg path {
            fill: rgb(255, 255, 255);
        }

        #checkbox:active + .switch {
            transform: translate(0em, 0.1em);
            box-shadow:
                0px 0px 0.1px rgb(151, 243, 255) inset,
                0px 0px 0.2px rgb(151, 243, 255) inset,
                0px 0px 1px rgb(151, 243, 255) inset,
                0px 0px 10px rgb(151, 243, 255),
                0px 0px 50px rgb(151, 243, 255);
            border: 2px solid rgb(255, 255, 255);
            background-color: rgb(146, 180, 184);
        }

        #checkbox:active + .switch svg path {
            box-shadow: 0.2em 0.2em 0.3em rgba(0, 0, 0, 0.3);
            transform: translate(0em, 0.1em);
        }

        .toggle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .toggle-label {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-color);
            text-align: center;
        }

        .toggle-status {
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--accent-color);
        }

        #loading-overlay {
            display: flex;
            position: fixed;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(26, 26, 46, 0.95); /* from --bg-color */
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        #loading-overlay::before {
            content: '';
            width: 60px;
            height: 60px;
            border: 3px solid var(--secondary-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        #loading-overlay p {
            font-size: 1.2em;
            color: var(--text-color);
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* From Uiverse.io by Botwe-Felix5820 - Adapted */
        .history-button {
            height: 2.8em;
            width: auto;
            padding: 0 1.2em;
            background: transparent;
            -webkit-animation: jello-horizontal 0.9s both;
            animation: jello-horizontal 0.9s both;
            border: 2px solid #016dd9;
            outline: none;
            color: #016dd9;
            cursor: pointer;
            font-size: 17px;
            font-weight: normal; /* Override general button style */
            border-radius: 0; /* Override general button style */
            align-self: flex-start; /* Align to the start of the panel */
        }

        .history-button:hover {
            background: #016dd9;
            color: #ffffff;
            animation: squeeze3124 0.9s both;
        }

        @-webkit-keyframes jello-horizontal {
            0% { -webkit-transform: scale3d(1, 1, 1); transform: scale3d(1, 1, 1); }
            30% { -webkit-transform: scale3d(1.25, 0.75, 1); transform: scale3d(1.25, 0.75, 1); }
            40% { -webkit-transform: scale3d(0.75, 1.25, 1); transform: scale3d(0.75, 1.25, 1); }
            50% { -webkit-transform: scale3d(1.15, 0.85, 1); transform: scale3d(1.15, 0.85, 1); }
            65% { -webkit-transform: scale3d(0.95, 1.05, 1); transform: scale3d(0.95, 1.05, 1); }
            75% { -webkit-transform: scale3d(1.05, 0.95, 1); transform: scale3d(1.05, 0.95, 1); }
            100% { -webkit-transform: scale3d(1, 1, 1); transform: scale3d(1, 1, 1); }
        }

        @keyframes jello-horizontal {
            0% { -webkit-transform: scale3d(1, 1, 1); transform: scale3d(1, 1, 1); }
            30% { -webkit-transform: scale3d(1.25, 0.75, 1); transform: scale3d(1.25, 0.75, 1); }
            40% { -webkit-transform: scale3d(0.75, 1.25, 1); transform: scale3d(0.75, 1.25, 1); }
            50% { -webkit-transform: scale3d(1.15, 0.85, 1); transform: scale3d(1.15, 0.85, 1); }
            65% { -webkit-transform: scale3d(0.95, 1.05, 1); transform: scale3d(0.95, 1.05, 1); }
            75% { -webkit-transform: scale3d(1.05, 0.95, 1); transform: scale3d(1.05, 0.95, 1); }
            100% { -webkit-transform: scale3d(1, 1, 1); transform: scale3d(1, 1, 1); }
        }

        @keyframes squeeze3124 {
            0% {
                -webkit-transform: scale3d(1, 1, 1);
                transform: scale3d(1, 1, 1);
            }

            30% {
                -webkit-transform: scale3d(1.25, 0.75, 1);
                transform: scale3d(1.25, 0.75, 1);
            }

            40% {
                -webkit-transform: scale3d(0.75, 1.25, 1);
                transform: scale3d(0.75, 1.25, 1);
            }

            50% {
                -webkit-transform: scale3d(1.15, 0.85, 1);
                transform: scale3d(1.15, 0.85, 1);
            }

            65% {
                -webkit-transform: scale3d(0.95, 1.05, 1);
                transform: scale3d(0.95, 1.05, 1);
            }

            75% {
                -webkit-transform: scale3d(1.05, 0.95, 1);
                transform: scale3d(1.05, 0.95, 1);
            }

            100% {
                -webkit-transform: scale3d(1, 1, 1);
                transform: scale3d(1, 1, 1);
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <p>Ê≠£Âú®È©óË≠âÊÇ®ÁöÑË∫´‰ªΩ...</p>
    </div>

    <!-- User Status Indicator -->
    <div id="userStatus" class="user-status" style="display: none;">
        <img id="userStatusAvatar" src="/images/a01girlmove.gif" alt="User">
        <span id="userStatusName" class="username">Êú™ÁôªÂÖ•</span>
    </div>

   

    <div class="container" style="display: none;">
        <div id="settings-panel" class="panel">
            
            <div class="form-group">
                <label for="video-id">YouTube Video ID <span id="monitoring-video-id" style="font-weight: normal; font-size: 0.9em; color: var(--accent-color);"></span></label>
                <input type="text" id="video-id" placeholder="‰æãÂ¶ÇÔºödQw4w9WgXcQ">
            </div>
            <div class="form-group">
                <label for="lottery-keyword">ÊäΩÁçéÈóúÈçµÂ≠ó</label>
                <input type="text" id="lottery-keyword" placeholder="‰æãÂ¶ÇÔºöÊàëË¶ÅÊäΩÁçé">
            </div>
            <div class="form-group">
                <label for="api-rate-limit">API Ë´ãÊ±ÇÈñìÈöî (Áßí)</label>
                <select id="api-rate-limit">
                    <option value="5">5Áßí</option>
                    <option value="10" selected>10Áßí</option>
                    <option value="20">20Áßí</option>
                </select>
            </div>
            <div class="toggle-container">
                <div class="toggle-status">Á≥ªÁµ±ÁãÄÊÖã: ÂÅúÊ≠¢‰∏≠</div>
                <input type="checkbox" id="checkbox">
                <label class="switch" for="checkbox">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path d="M288 256C288 273.7 273.7 288 256 288C238.3 288 224 273.7 224 256C224 238.3 238.3 224 256 224C273.7 224 288 238.3 288 256zM0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256zM256 464C370.9 464 464 370.9 464 256C464 141.1 370.9 48 256 48C141.1 48 48 141.1 48 256C48 370.9 141.1 464 256 464z"></path>
                    </svg>
                </label>
                
            </div>
            <hr style="border-color: var(--secondary-color); margin: 20px 0;">
             <h2>ÊäΩÁçéÊéßÂà∂</h2>
            <div class="form-group">
                <label for="animation-mode">ÊäΩÁçéÂãïÁï´</label>
                 <select id="animation-mode">
                    <option value="turntable" selected>ËΩâÁõ§Âºè</option>
                    <option value="pointer">ÊåáÈáùÂºè</option>
                    <option value="punch-hole">Ê¥ûÊ¥ûÊ®Ç</option>
                </select>
            </div>
            <div class="form-group">
                <label for="animation-duration">ÂãïÁï´ÊôÇÈï∑ (ÂàÜÈêò)</label>
                <input type="number" id="animation-duration" value="0" min="0">
            </div>
             <button id="draw-winner-btn" class="animated-button">
                <svg viewBox="0 0 24 24" class="arr-2" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path>
                </svg>
                <span class="text">Á´ãÂç≥ÊäΩÁçé</span>
                <span class="circle"></span>
                <svg viewBox="0 0 24 24" class="arr-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path>
                </svg>
            </button>
        </div>

        <div id="animation-panel" class="panel">
            <canvas id="confetti-canvas"></canvas>
            <div id="animation-container">
                <canvas id="wheel-canvas" width="500" height="500" style="display: none;"></canvas>
                <div id="pointer-animation" style="display: none;">
                    <div id="pointer-winner-display" style="display: none;"></div>
                    <div id="pointer"></div>
                    <div id="participants-reel"></div>
                </div>
                <div id="punch-hole-animation" style="display: none;">
                    <div id="punch-hole-winner-display"></div>
                    <div class="punch-instruction">Ë´ãÈªûÊìä„ÄåÊâì‰∫ÇÂç°Áâá„ÄçÈñãÂßãÊäΩÁçé</div>
                </div>
                <div id="default-animation" style="text-align: center; padding: 20px;">
                    Ë´ãÂÖàË®≠ÂÆöÁõ¥Êí≠‰∏¶ÈñãÂßãÁõ£Êéß
                </div>
            </div>
            <div id="winner-display">
                <span class="close-winner">&times;</span>
                <img id="winner-avatar" alt="Winner Avatar">
                <h2>üéâ ÊÅ≠Âñú‰∏≠Áçé üéâ</h2>
                <h3 id="winner-name"></h3>
            </div>
        </div>

        <div id="participants-panel" class="panel">
           
            <button id="view-history-btn" class="history-button" style="margin-bottom: 10px;">Êü•ÁúãÊäΩÁçéÁ¥ÄÈåÑ</button>
            <div id="participants-list">
                <!-- Participants will be dynamically added here -->
            </div>
            <div id="participants-count">
                ÁõÆÂâçÂèÉËàá‰∫∫Êï∏Ôºö0 ‰∫∫
            </div>
        </div>

        

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = loadingOverlay.querySelector('p');
            const container = document.querySelector('.container');
            const userStatus = document.getElementById('userStatus');
            const userStatusAvatar = document.getElementById('userStatusAvatar');
            const userStatusName = document.getElementById('userStatusName');

            let authToken = null;

            async function apiFetch(url, options = {}) {
                // no loading indicator changes in here, handled by caller
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                };
                const mergedOptions = { ...defaultOptions, ...options };
                if (options.body && typeof options.body !== 'string') {
                    mergedOptions.body = JSON.stringify(options.body);
                }

                try {
                    const response = await fetch(url, mergedOptions);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Ë´ãÊ±ÇÂ§±Êïó' }));
                        throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                    }
                    if (response.status === 204) return null;
                    return await response.json();
                } catch (error) {
                    alert(`API ÈåØË™§: ${error.message}`);
                    throw error;
                }
            }

            async function checkAccess() {
                const userId = localStorage.getItem('boxCurrentUserId');
                authToken = localStorage.getItem(`boxUserToken_${userId}`);

                if (!userId || !authToken) {
                    loadingText.textContent = 'ÊÇ®Â∞öÊú™ÁôªÂÖ•ÔºåÂ∞áÁÇ∫ÊÇ®Â∞éÂêëÁôªÂÖ•È†ÅÈù¢...';
                    setTimeout(() => {
                        window.location.href = `/member-login.html?redirect=${encodeURIComponent(window.location.href)}`;
                    }, 2000);
                    return;
                }

                try {
                    loadingText.textContent = 'Ê≠£Âú®È©óË≠âÊÇ®ÁöÑÊ¨äÈôê...';
                    const userRoles = await apiFetch(`/api/box/users/${userId}/roles`);
                    
                    const hasAccess = userRoles.some(role => role.role_id > 1);

                    if (hasAccess) {
                        loadingOverlay.style.display = 'none';
                        container.style.display = 'grid';
                        userStatus.style.display = 'flex';
                        
                        const savedUserAvatarUrl = localStorage.getItem('boxCurrentUserAvatar');
                        const savedUserName = localStorage.getItem('boxCurrentUsername');
                        const savedDisplayName = localStorage.getItem('boxCurrentDisplayName') || savedUserName;
                        
                        userStatusAvatar.src = savedUserAvatarUrl || '/images/a01girlmove.gif';
                        userStatusName.textContent = savedDisplayName;
                        userStatus.addEventListener('click', () => {
                            window.location.href = `/member-editor.html?userId=${userId}`;
                        });
                        
                        initializeApp();
                    } else {
                        loadingText.textContent = 'ÊÇ®ÁöÑÊ¨äÈôê‰∏çË∂≥ÔºåÂ∞áÁÇ∫ÊÇ®Â∞éÂêëÈÅäÊà≤È†ÅÈù¢...';
                        setTimeout(() => {
                            window.location.href = '/games.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error("Authorization check failed:", error);
                    loadingText.textContent = `Ê¨äÈôêÈ©óË≠âÂ§±Êïó„ÄÇÂ∞áÁÇ∫ÊÇ®Â∞éÂêëÈÅäÊà≤È†ÅÈù¢...`;
                    setTimeout(() => {
                        window.location.href = '/games.html';
                    }, 3000);
                }
            }
            
            function initializeApp() {
                const videoIdEl = document.getElementById('video-id');
                const keywordEl = document.getElementById('lottery-keyword');
                const apiRateInput = document.getElementById('api-rate-limit');
                const setVideoBtn = null; // ÂéüÊåâÈàïÂ∑≤ÁßªÈô§
                const stopMonitoringBtn = null; // ÂéüÊåâÈàïÂ∑≤ÁßªÈô§
                const monitoringVideoIdEl = document.getElementById('monitoring-video-id');
                const participantsListEl = document.getElementById('participants-list');
                const participantsCountEl = document.getElementById('participants-count');
                const drawWinnerBtn = document.getElementById('draw-winner-btn');
                const animationModeEl = document.getElementById('animation-mode');
                const durationEl = document.getElementById('animation-duration');
                const animationContainer = document.getElementById('animation-container');
                const defaultAnimation = document.getElementById('default-animation');
                const winnerDisplayEl = document.getElementById('winner-display');
                const winnerAvatarEl = document.getElementById('winner-avatar');
                const winnerNameEl = document.getElementById('winner-name');
                const confettiCanvas = document.getElementById('confetti-canvas');
                const viewHistoryBtn = document.getElementById('view-history-btn');
                const wheelCanvas = document.getElementById('wheel-canvas');
                const wheelCtx = wheelCanvas.getContext('2d');
                const pointerAnimationEl = document.getElementById('pointer-animation');
                const participantsReelEl = document.getElementById('participants-reel');
                const punchHoleAnimationEl = document.getElementById('punch-hole-animation');
                const punchHoleWinnerDisplayEl = document.getElementById('punch-hole-winner-display');
                const monitoringToggle = document.getElementById('checkbox');
                const toggleStatusEl = document.querySelector('.toggle-status');

                const myConfetti = confetti.create(confettiCanvas, {
                    resize: true,
                    useWorker: true
                });

                let currentRotation = 0;
                let isSpinning = false;
                let angularVelocity = 0;
                const FRICTION = 0.995; // Êë©Êì¶Âäõ‰øÇÊï∏ÔºåÁ¢∫‰øùËº™Áõ§ÊúÄÁµÇÊúÉÂÅú‰∏ã
                let selectedWinner = null;
                let updateTimer = null;
                let participants = []; // Âú®Ë®òÊÜ∂È´î‰∏≠‰øùÂ≠òÂèÉËàáËÄÖÂàóË°®ÔºåÈÅøÂÖçÈáçË§áËÆÄÂèñ
                let winnerText = ''; // Áî®ÊñºÂú®Áï´Â∏É‰∏≠ÂøÉÈ°ØÁ§∫‰∏≠ÁçéËÄÖÂêçÂ≠ó

                // Pointer animation state
                let isReelSpinning = false;
                let reelVelocity = 0;
                let reelPosition = 0;
                let reelAnimationId = null;
                const REEL_FRICTION = 0.988; // Êë©Êì¶Âäõ, Êï∏ÂÄºË∂äÂ∞èÂÅúË∂äÂø´
                const IDLE_SPEED = 60; // ÂæÖÊ©üÊôÇÁöÑÊªæÂãïÈÄüÂ∫¶ (Â∑≤ÊèêÈ´ò)
                let idleAnimationId = null;
                let pointerWinnerDecided = false;
                let punchHoleReady = false;
                let punchHoleWinnerSelected = false;
                let punchHoleWinner = null;
                let isPunchHoleShuffled = false;

                async function saveWinnerToHistory(winner) {
                    if (!winner) return;

                    const winnerData = {
                        video_id: videoIdEl.value.trim(),
                        lottery_keyword: keywordEl.value.trim(),
                        winner_channel_id: winner.channelId,
                        winner_name: winner.displayName,
                        winner_avatar_url: winner.profileImageUrl,
                        winner_comment: winner.commentText || 'N/A', 
                        total_participants: participants.length,
                        animation_mode: animationModeEl.value
                    };

                    try {
                        const response = await fetch('/api/admin/lottery/history', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(winnerData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: 'Ë´ãÊ±ÇÂ§±Êïó' }));
                            throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('ÊäΩÁçéÁ¥ÄÈåÑÂ∑≤ÂÑ≤Â≠ò:', result);
                    } catch (error) {
                        console.error('ÂÑ≤Â≠òÊäΩÁçéÁ¥ÄÈåÑÊôÇÁôºÁîüÈåØË™§:', error);
                        alert(`ÂÑ≤Â≠òÊäΩÁçéÁ¥ÄÈåÑÂ§±Êïó: ${error.message}`);
                    }
                }

                function drawWheel() {
                    if (!wheelCanvas || !defaultAnimation) return;

                    const totalParticipants = participants.length;
                        
                    if (totalParticipants === 0) {
                        wheelCanvas.style.display = 'none';
                        defaultAnimation.style.display = 'block';
                        defaultAnimation.textContent = 'Áõ£Êéß‰∏≠...Á≠âÂæÖÂèÉËàáËÄÖÂä†ÂÖ•';
                        return;
                    }

                    wheelCanvas.style.display = 'block';
                    defaultAnimation.style.display = 'none';

                    const centerX = wheelCanvas.width / 2;
                    const centerY = wheelCanvas.height / 2;
                    const radius = Math.min(centerX, centerY) - 20;

                    wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

                    wheelCtx.save();
                    wheelCtx.translate(centerX, centerY);
                    
                    // ÁÇ∫‰∫ÜÁ∞°ÂåñËßíÂ∫¶Ë®àÁÆóÔºåÊàëÂÄëËÆìÊåáÈáùÊåáÂêë 3 ÈªûÈêòÊñπÂêëÔºå‰∏¶ÊóãËΩâËº™Áõ§
                    wheelCtx.rotate(currentRotation);

                    const sliceAngle = (2 * Math.PI) / totalParticipants;
                    participants.forEach((p, index) => {
                        const startAngle = index * sliceAngle;
                        const endAngle = startAngle + sliceAngle;

                        // Draw slice
                        wheelCtx.beginPath();
                        wheelCtx.moveTo(0, 0);
                        wheelCtx.arc(0, 0, radius, startAngle, endAngle);
                        wheelCtx.closePath();
                        wheelCtx.fillStyle = `hsl(${(360 / totalParticipants) * index}, 70%, 60%)`;
                        wheelCtx.fill();
                        wheelCtx.stroke();

                        // Draw text
                        wheelCtx.save();
                        wheelCtx.rotate(startAngle + sliceAngle / 2);
                        wheelCtx.textAlign = 'right';
                        wheelCtx.fillStyle = 'white';
                        wheelCtx.font = '14px Arial';
                        const displayName = p.displayName.length > 10 ? p.displayName.substring(0, 10) + '...' : p.displayName;
                        wheelCtx.fillText(displayName, radius - 10, 5);
                        wheelCtx.restore();
                    });

                    wheelCtx.restore();

                    // Â∞áÊåáÈáùÁï´Âú® 12 ÈªûÈêòÊñπÂêëÔºàÈ†ÇÈÉ®ÔºâÔºå‰øùÊåÅÈùúÊ≠¢
                    wheelCtx.save();
                    wheelCtx.translate(centerX, centerY - radius - 20); // ÁßªÂà∞Ëº™Áõ§Ê≠£‰∏äÊñπ
                    wheelCtx.fillStyle = '#ff4757';
                    
                    wheelCtx.beginPath();
                    wheelCtx.moveTo(0, 20); // ÊåáÈáùÂ∞ñÁ´ØÊåáÂêëËº™Áõ§ÈÇäÁ∑£
                    wheelCtx.lineTo(-10, 0);
                    wheelCtx.lineTo(10, 0);
                    wheelCtx.closePath();
                    wheelCtx.fill();
                    wheelCtx.restore();

                    // Â¶ÇÊûúËº™Áõ§Â∑≤ÂÅúÊ≠¢‰∏îÊúâ‰∏≠ÁçéËÄÖÔºåÂú®‰∏≠ÈñìÈ°ØÁ§∫ÂêçÂ≠ó
                    if (!isSpinning && winnerText) {
                        wheelCtx.save();
                        wheelCtx.font = 'bold 40px ' + getComputedStyle(document.body).fontFamily;
                        wheelCtx.fillStyle = 'rgba(255, 255, 255, 1)';
                        wheelCtx.textAlign = 'center';
                        wheelCtx.textBaseline = 'middle';
                        wheelCtx.shadowColor = 'black';
                        wheelCtx.shadowBlur = 10;
                        wheelCtx.shadowOffsetX = 2;
                        wheelCtx.shadowOffsetY = 2;
                        const displayName = winnerText.length > 10 ? winnerText.substring(0, 10) + '...' : winnerText;
                        wheelCtx.fillText(displayName, centerX, centerY);
                        wheelCtx.restore();
                    }
                }
                
                function startSpin() {
                    if (isSpinning) return;
                    if (participants.length < 2) {
                        alert('ÈúÄË¶ÅËá≥Â∞ëÂÖ©‰ΩçÂèÉËàáËÄÖÊâçËÉΩÈñãÂßãËΩâÁõ§ÊäΩÁçéÔºÅ');
                        return;
                    }
                    winnerText = ''; // Ê∏ÖÈô§‰∏ä‰∏Ä‰Ωç‰∏≠ÁçéËÄÖÂêçÂ≠ó
                    isSpinning = true;
                    // Áµ¶‰∫à‰∏ÄÂÄãÈö®Ê©üÁöÑÂàùÂßãÈÄüÂ∫¶ (ÂºßÂ∫¶/ÂπÄ)
                    angularVelocity = (Math.random() * 0.2) + 0.4;
                    requestAnimationFrame(animate);
                }

                function animate() {
                    if (!isSpinning) return;

                    currentRotation += angularVelocity;
                    angularVelocity *= FRICTION; // ÊáâÁî®Êë©Êì¶Âäõ‰ΩøÂÖ∂Ê∏õÈÄü

                    drawWheel();

                    // Áï∂ÈÄüÂ∫¶Â∞èÊñº‰∏ÄÂÄãÈñæÂÄºÊôÇÔºåÂÅúÊ≠¢ÂãïÁï´
                    if (angularVelocity < 0.001) {
                        isSpinning = false;
                        angularVelocity = 0;
                        drawWheel(); // Áï´ÊúÄÂæå‰∏ÄÂπÄÁ¢∫‰øù‰ΩçÁΩÆÁ≤æÁ¢∫
                        determineWinnerFromAngle();
                    } else {
                        requestAnimationFrame(animate);
                    }
                }
                
                function determineWinnerFromAngle() {
                    const totalParticipants = participants.length;
                    if (totalParticipants === 0) return;

                    const sliceAngle = (2 * Math.PI) / totalParticipants;
                    
                    // ÊåáÈáùÂú® 12 ÈªûÈêòÊñπÂêë (3*PI/2)ÔºåÊàëÂÄë‰ª•Ê≠§ÁÇ∫Âü∫Ê∫ñË®àÁÆó
                    const pointerAngle = 3 * Math.PI / 2;
                    const finalAngle = currentRotation % (2 * Math.PI);
                    const targetAngle = (2 * Math.PI - finalAngle + pointerAngle) % (2 * Math.PI);
                    const winnerIndex = Math.floor(targetAngle / sliceAngle);

                    const winner = participants[winnerIndex];
                    if (winner) {
                        selectedWinner = winner;
                        winnerText = winner.displayName; // Ë®≠ÂÆöË¶ÅÈ°ØÁ§∫ÁöÑÊñáÂ≠ó
                        highlightWinner(winner);
                        // showWinner(winner); // ‰∏çÂÜçÂΩàÂá∫Âç°Áâá
                        myConfetti({
                            particleCount: 150,
                            spread: 90,
                            origin: { y: 0.6 }
                        });
                        drawWheel(); // ÈáçÊñ∞Áπ™Ë£Ω‰ª•Á´ãÂç≥È°ØÁ§∫ÂêçÂ≠ó
                        saveWinnerToHistory(winner);
                    }
                }

                function highlightWinner(winner) {
                    const participantsList = participantsListEl.querySelectorAll('li');
                    participantsList.forEach(li => {
                        li.classList.remove('winner-highlight');
                        if (li.querySelector('span').textContent.includes(winner.displayName)) {
                            li.classList.add('winner-highlight');
                            li.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }

                function buildParticipantsReel() {
                    if (!participantsReelEl) return;
                    participantsReelEl.innerHTML = '';
                    participantsReelEl.style.transition = 'none';
                    participantsReelEl.style.transform = 'translateX(0px)';

                    if (participants.length === 0) {
                        stopReelIdleAnimation();
                        return;
                    }

                    // ÁÇ∫‰∫ÜË£ΩÈÄ†ÁÑ°ÈôêÊªæÂãïÁöÑÊÑüË¶∫ÔºåÊàëÂÄëË§áË£ΩÂèÉËàáËÄÖÂàóË°®
                    const reelParticipants = [];
                    const repeatCount = Math.max(5, Math.ceil(40 / participants.length));
                    for(let i = 0; i < repeatCount; i++) {
                        reelParticipants.push(...participants);
                    }
                    
                    reelParticipants.forEach(p => {
                        const card = document.createElement('div');
                        card.className = 'reel-participant-card';
                        card.dataset.channelId = p.channelId;
                        card.innerHTML = `
                            <img src="${p.profileImageUrl}" alt="${p.displayName}">
                            <span>${p.displayName.substring(0, 12)}</span>
                        `;
                        participantsReelEl.appendChild(card);
                    });

                    startReelIdleAnimation();
                }

                function startReelIdleAnimation() {
                    stopReelIdleAnimation(); // Á¢∫‰øùÂè™Êúâ‰∏ÄÂÄãÂãïÁï´Âú®Ë∑ë

                    let lastTime = null;
                    function idleAnimate(time) {
                        if (!lastTime) {
                            lastTime = time;
                            idleAnimationId = requestAnimationFrame(idleAnimate);
                            return;
                        }
                        const deltaTime = time - lastTime;
                        lastTime = time;

                        reelPosition -= IDLE_SPEED * (deltaTime / 16); // Ê®ôÊ∫ñÂåñÂà∞ 60fps
                        
                        const cardWidth = 120 + 20; // card width + margin
                        const loopWidth = cardWidth * participants.length;
                        if (reelPosition < -loopWidth) {
                            reelPosition += loopWidth;
                        }
                        participantsReelEl.style.transform = `translateX(${reelPosition}px)`;

                        idleAnimationId = requestAnimationFrame(idleAnimate);
                    }
                    idleAnimationId = requestAnimationFrame(idleAnimate);
                }

                function stopReelIdleAnimation() {
                    if (idleAnimationId) {
                        cancelAnimationFrame(idleAnimationId);
                        idleAnimationId = null;
                    }
                }

                function startPointerLottery() {
                    if (isReelSpinning) return;
                    if (participants.length < 2) {
                        alert('ÈúÄË¶ÅËá≥Â∞ëÂÖ©‰ΩçÂèÉËàáËÄÖÊâçËÉΩÈñãÂßãÊäΩÁçéÔºÅ');
                        return;
                    }
                    stopReelIdleAnimation();
                    isReelSpinning = true;
                    // Áµ¶‰∫à‰∏ÄÂÄãÈö®Ê©üÁöÑÂàùÂßãÈÄüÂ∫¶ (ÂÉèÁ¥†/ÂπÄ)ÔºåÂ¢ûÂä†ÈÄüÂ∫¶‰ª•Áç≤ÂæóÊãâÈú∏Ê©üÁöÑÊÑüË¶∫
                    reelVelocity = (Math.random() * 20) + 55;
                    
                    if (reelAnimationId) {
                        cancelAnimationFrame(reelAnimationId);
                    }
                    animateReel();
                }

                function animateReel() {
                    reelPosition -= reelVelocity;
                    reelVelocity *= REEL_FRICTION; // ÊáâÁî®Êë©Êì¶Âäõ

                    const cardWidth = 120 + 20;
                    const totalReelWidth = cardWidth * participants.length * Math.floor(participantsReelEl.children.length / participants.length);
                    const loopWidth = cardWidth * participants.length;

                    // ÁÇ∫‰∫ÜÂæ™Áí∞ÊïàÊûúÔºåÈáçÁΩÆ‰ΩçÁΩÆ
                    if(reelPosition < -loopWidth * 2) {
                        reelPosition += loopWidth;
                    }

                    participantsReelEl.style.transform = `translateX(${reelPosition}px)`;

                    if (reelVelocity < 0.05) {
                        isReelSpinning = false;
                        cancelAnimationFrame(reelAnimationId);
                        reelAnimationId = null;
                        determinePointerWinner();
                    } else {
                        reelAnimationId = requestAnimationFrame(animateReel);
                    }
                }
                
                function determinePointerWinner() {
                    const pointerLine = pointerAnimationEl.getBoundingClientRect().left + (pointerAnimationEl.offsetWidth / 2);
                    const cards = participantsReelEl.querySelectorAll('.reel-participant-card');
                    
                    let winnerCard = null;
                    let minDistance = Infinity;

                    cards.forEach(card => {
                        const cardRect = card.getBoundingClientRect();
                        const cardCenter = cardRect.left + (cardRect.width / 2);
                        const distance = Math.abs(pointerLine - cardCenter);
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            winnerCard = card;
                        }
                    });

                    if (winnerCard) {
                        const winnerChannelId = winnerCard.dataset.channelId;
                        const winner = participants.find(p => p.channelId === winnerChannelId);
                        if(winner){
                            pointerWinnerDecided = true;
                            selectedWinner = winner;
                            highlightWinner(winner);
                            myConfetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }});
                            
                            // Âπ≥ÊªëÂú∞Â∞á‰∏≠ÁçéËÄÖÂç°ÁâáÂ∞çÈΩäÂà∞ÊåáÈáù
                            const cardRect = winnerCard.getBoundingClientRect();
                            const cardCenter = cardRect.left + (cardRect.width / 2);
                            const offset = pointerLine - cardCenter;
                            
                            const currentTransform = new DOMMatrix(getComputedStyle(participantsReelEl).transform);
                            const currentX = currentTransform.m41;
                            
                            participantsReelEl.style.transition = 'transform 0.6s cubic-bezier(0.25, 1, 0.5, 1)';
                            participantsReelEl.style.transform = `translateX(${currentX + offset}px)`;

                            // Âú®‰∏≠ÈñìÈ°ØÁ§∫‰∏≠ÁçéËÄÖÂêçÂ≠ó
                            const winnerDisplay = document.getElementById('pointer-winner-display');
                            if (winnerDisplay) {
                                winnerDisplay.textContent = winner.displayName;
                                winnerDisplay.style.display = 'block';
                            }
                            
                            // Êõ¥ÊîπÊåâÈàïÊñáÂ≠óÔºåÊèêÁ§∫ÂèØ‰ª•ÈáçË®≠
                            const buttonText = drawWinnerBtn.querySelector('.text');
                            if (buttonText) buttonText.textContent = 'ÈáçË®≠/ÂÜçÊäΩ‰∏ÄÊ¨°';

                        } else {
                            startReelIdleAnimation();
                        }
                    } else {
                        startReelIdleAnimation();
                    }
                }

                function resetPointerAnimation() {
                    pointerWinnerDecided = false;
                    
                    const winnerDisplay = document.getElementById('pointer-winner-display');
                    if (winnerDisplay) {
                        winnerDisplay.style.display = 'none';
                    }

                    const buttonText = drawWinnerBtn.querySelector('.text');
                    if (buttonText) buttonText.textContent = 'Á´ãÂç≥ÊäΩÁçé';

                    const participantsList = participantsListEl.querySelectorAll('li');
                    participantsList.forEach(li => {
                        li.classList.remove('winner-highlight');
                    });
                    
                    // ÈáçË®≠Êç≤Ëª∏ÁöÑ transform transition
                    participantsReelEl.style.transition = 'none';

                    startReelIdleAnimation();
                }

                async function fetchParticipants() {
                    try {
                        const response = await fetch('/api/admin/lottery/participants');
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'ÁÑ°Ê≥ïÁç≤ÂèñÂèÉËàáËÄÖ');
                        }
                        
                        if (data.participants) {
                            updateParticipantsList(data.participants);
                            if (data.participants.length === 0) {
                                if (defaultAnimation) {
                                    defaultAnimation.textContent = 'Áõ£Êéß‰∏≠...Á≠âÂæÖÂèÉËàáËÄÖÂä†ÂÖ•';
                                }
                            }
                        } else {
                            throw new Error('ÂèÉËàáËÄÖË≥áÊñôÊ†ºÂºèÈåØË™§');
                        }
                    } catch (error) {
                        console.error('Error fetching participants:', error);
                        if (defaultAnimation) {
                            defaultAnimation.textContent = 'Êõ¥Êñ∞ÂèÉËàáËÄÖÂêçÂñÆÂ§±Êïó';
                        }
                    }
                }

                function startAutoUpdate() {
                    if (updateTimer) {
                        clearInterval(updateTimer);
                    }
                    
                    fetchParticipants();
                    
                    const interval = parseInt(apiRateInput.value, 10) * 1000;
                    updateTimer = setInterval(fetchParticipants, interval);

                    // Êõ¥Êñ∞ÁãÄÊÖãÈ°ØÁ§∫
                    toggleStatusEl.textContent = 'Á≥ªÁµ±ÁãÄÊÖã: Áõ£Êéß‰∏≠';
                    toggleStatusEl.style.color = '#50fa7b'; // Á∂†Ëâ≤
                }

                function stopAutoUpdate() {
                    if (updateTimer) {
                        clearInterval(updateTimer);
                        updateTimer = null;
                    }

                    // Êõ¥Êñ∞ÁãÄÊÖãÈ°ØÁ§∫
                    toggleStatusEl.textContent = 'Á≥ªÁµ±ÁãÄÊÖã: ÂÅúÊ≠¢‰∏≠';
                    toggleStatusEl.style.color = '#ff5555'; // Á¥ÖËâ≤
                }

                function updateParticipantsList(participantsData) {
                    if (!participantsListEl || !participantsCountEl) return;

                    participants = participantsData; // Êõ¥Êñ∞ÂÖ®Â±ÄÂèÉËàáËÄÖÈô£Âàó
                    participantsListEl.innerHTML = '';
                    participantsCountEl.textContent = `ÁõÆÂâçÂèÉËàá‰∫∫Êï∏Ôºö${participants.length} ‰∫∫`;

                    participants.forEach((participant, index) => {
                        const li = document.createElement('li');
                        li.className = 'participant';
                        // Â∞á channelId Â≠òÂÑ≤Âú® data Â±¨ÊÄß‰∏≠
                        li.dataset.channelId = participant.channelId;
                        li.innerHTML = `
                            <img src="${participant.profileImageUrl}" alt="${participant.displayName}" class="participant-avatar">
                            <span>${participant.displayName}</span>
                            <button class="delete-btn">Âà™Èô§</button>
                        `;

                        // ÈªûÊìäÂèÉËàáËÄÖÂàóË°®È†ÖÁõÆÊôÇÁöÑËôïÁêÜ
                        li.addEventListener('click', (e) => {
                            // Â¶ÇÊûúÈªûÊìäÁöÑÊòØÂà™Èô§ÊåâÈàïÔºå‰∏çÂàáÊèõÈÅ∏‰∏≠ÁãÄÊÖã
                            if (e.target.classList.contains('delete-btn')) {
                                return;
                            }
                            li.classList.toggle('selected');
                        });

                        // Âà™Èô§ÊåâÈàïÁöÑÈªûÊìäËôïÁêÜ
                        const deleteBtn = li.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ÂèÉËàáËÄÖ "${participant.displayName}" ÂóéÔºü`)) {
                                try {
                                    // ‰ΩøÁî® data-channel-id ‰æÜÁç≤ÂèñÊ≠£Á¢∫ÁöÑ channelId
                                    const channelId = li.dataset.channelId;
                                    const response = await fetch('/api/admin/lottery/remove-participant', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ channelId })
                                    });

                                    const result = await response.json();
                                    if (!response.ok) throw new Error(result.error || 'Âà™Èô§Â§±Êïó');

                                    // Âà™Èô§ÊàêÂäüÂæåÔºåÈáçÊñ∞Âæû‰º∫ÊúçÂô®Áç≤ÂèñÊúÄÊñ∞ÁöÑÂèÉËàáËÄÖÂàóË°®
                                    // ÈÄôÊ®£ÂèØ‰ª•Á¢∫‰øùÂâçÂæåÁ´ØÁãÄÊÖã‰∏ÄËá¥Ôºå‰∏¶Ëá™ÂãïÊõ¥Êñ∞UIÂíåËΩâÁõ§
                                    fetchParticipants();
                                    alert(`ÂèÉËàáËÄÖ "${participant.displayName}" Â∑≤ÊàêÂäüÂà™Èô§„ÄÇ`);
                                } catch (error) {
                                    console.error('Error removing participant:', error);
                                    alert(`Âà™Èô§Â§±Êïó: ${error.message}`);
                                }
                            }
                        });

                        participantsListEl.appendChild(li);
                    });
                    
                    // Êõ¥Êñ∞ÂãïÁï´Ë¶ñÂúñ
                    setupAnimationView(animationModeEl.value);
                }
                
                function setupAnimationView(mode) {
                    if (participants.length === 0) {
                        wheelCanvas.style.display = 'none';
                        pointerAnimationEl.style.display = 'none';
                        punchHoleAnimationEl.style.display = 'none';
                        defaultAnimation.style.display = 'block';
                        defaultAnimation.textContent = 'Áõ£Êéß‰∏≠...Á≠âÂæÖÂèÉËàáËÄÖÂä†ÂÖ•';
                        stopReelIdleAnimation();
                        return;
                    }
                    
                    defaultAnimation.style.display = 'none';

                    if (mode === 'turntable') {
                        wheelCanvas.style.display = 'block';
                        pointerAnimationEl.style.display = 'none';
                        punchHoleAnimationEl.style.display = 'none';
                        stopReelIdleAnimation();
                        drawWheel();
                    } else if (mode === 'pointer') {
                        wheelCanvas.style.display = 'none';
                        pointerAnimationEl.style.display = 'block';
                        punchHoleAnimationEl.style.display = 'none';
                        buildParticipantsReel();
                    } else if (mode === 'punch-hole') {
                        wheelCanvas.style.display = 'none';
                        pointerAnimationEl.style.display = 'none';
                        punchHoleAnimationEl.style.display = 'block';
                        setupPunchHoleCards();
                    } else {
                        // Êú™‰æÜÂÖ∂‰ªñÊ®°ÂºèÁöÑËôïÁêÜ
                        wheelCanvas.style.display = 'none';
                        pointerAnimationEl.style.display = 'none';
                        punchHoleAnimationEl.style.display = 'none';
                        stopReelIdleAnimation();
                    }
                }
                
                function setupPunchHoleCards() {
                    if (!punchHoleAnimationEl) return;
                    
                    // Ê∏ÖÈô§ÊâÄÊúâÂç°Áâá
                    punchHoleAnimationEl.querySelectorAll('.punch-card').forEach(card => card.remove());
                    punchHoleWinnerDisplayEl.textContent = '';
                    punchHoleWinnerDisplayEl.classList.remove('show');
                    
                    if (participants.length === 0) {
                        return;
                    }
                    
                    // ÈáçÁΩÆÁãÄÊÖã
                    punchHoleReady = true;
                    punchHoleWinnerSelected = false;
                    punchHoleWinner = null;
                    isPunchHoleShuffled = false;
                    
                    // ÈáçÁΩÆÂÆπÂô®Ê®£Âºè
                    punchHoleAnimationEl.style.display = 'grid';
                    punchHoleAnimationEl.style.position = ''; // Ê∏ÖÈô§ position Â±¨ÊÄß
                    
                    // ÂâµÂª∫Âç°Áâá - ÂàùÂßãÊôÇÊ≠£Èù¢Êúù‰∏äÔºåÊéíÂàóÊàêÁ£öÁâÜ
                    participants.forEach((participant, index) => {
                        const card = document.createElement('div');
                        card.className = 'punch-card';
                        card.dataset.channelId = participant.channelId;
                        card.dataset.index = index;
                        
                        card.innerHTML = `
                            <div class="punch-card-front">
                                <img src="${participant.profileImageUrl}" alt="${participant.displayName}">
                                <span>${participant.displayName}</span>
                            </div>
                            <div class="punch-card-back">
                                <span class="card-number"></span>
                            </div>
                        `;
                        
                        punchHoleAnimationEl.appendChild(card);
                    });
                    
                    // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠óÂíåÊåáÁ§∫
                    const buttonText = drawWinnerBtn.querySelector('.text');
                    if (buttonText) buttonText.textContent = 'Êâì‰∫ÇÂç°Áâá';
                    
                    document.querySelector('.punch-instruction').textContent = 'Ë´ãÈªûÊìä„ÄåÊâì‰∫ÇÂç°Áâá„ÄçÈñãÂßãÊäΩÁçé';
                }
                
                function shufflePunchHoleCards() {
                    if (!punchHoleReady || punchHoleWinnerSelected || isPunchHoleShuffled) return;
                    
                    // Á¶ÅÁî®ÊåâÈàïÈò≤Ê≠¢ÈáçË§áÈªûÊìä
                    drawWinnerBtn.disabled = true;
                    
                    // ÂèñÂæóÊâÄÊúâÂç°Áâá
                    const cards = punchHoleAnimationEl.querySelectorAll('.punch-card');
                    const containerWidth = punchHoleAnimationEl.clientWidth;
                    const containerHeight = punchHoleAnimationEl.clientHeight;
                    
                    // ÈáçË¶ÅÔºö‰øùÊåÅÁ∂≤Ê†ºÂ∏ÉÂ±ÄÔºå‰ΩÜÂ∞áÂç°ÁâáË®≠ÁÇ∫ÁµïÂ∞çÂÆö‰Ωç
                    // punchHoleAnimationEl.style.display = 'block'; // ÁßªÈô§ÈÄôË°åÔºå‰øùÊåÅÁ∂≤Ê†ºÂ∏ÉÂ±Ä
                    
                    // Èö®Ê©üÊâì‰∫ÇÂç°ÁâáÈ†ÜÂ∫è
                    const cardsArray = Array.from(cards);
                    const parentNode = punchHoleAnimationEl;
                    
                    // ÂÖàË®òÈåÑÊâÄÊúâÂç°ÁâáÁöÑÂàùÂßã‰ΩçÁΩÆ
                    const initialPositions = [];
                    cardsArray.forEach(card => {
                        const rect = card.getBoundingClientRect();
                        const parentRect = parentNode.getBoundingClientRect();
                        initialPositions.push({
                            top: rect.top - parentRect.top,
                            left: rect.left - parentRect.left
                        });
                    });
                    
                    // Ë®≠ÁΩÆÂÆπÂô®Ê®£ÂºèÔºåÂÖÅË®±ÁµïÂ∞çÂÆö‰ΩçÁöÑÂç°Áâá
                    punchHoleAnimationEl.style.position = 'relative';
                    
                    // ÂÖàÂ∞áÊâÄÊúâÂç°ÁâáËÆäÁÇ∫ÁµïÂ∞çÂÆö‰ΩçÔºåÊ∫ñÂÇôÂãïÁï´Ôºå‰ΩÜ‰øùÊåÅÂú®Âéü‰æÜÁöÑ‰ΩçÁΩÆ
                    cardsArray.forEach((card, index) => {
                        const pos = initialPositions[index];
                        card.style.position = 'absolute';
                        card.style.top = `${pos.top}px`;
                        card.style.left = `${pos.left}px`;
                        card.style.margin = '0'; // ÁßªÈô§marginÔºåÂõ†ÁÇ∫ÁèæÂú®‰ΩøÁî®ÁµïÂ∞çÂÆö‰Ωç
                        card.classList.add('shuffling');
                    });
                    
                    // Á¨¨‰∏ÄÈöéÊÆµÔºöÂÖàÁøªÈù¢ÔºàËÉåÈù¢Êúù‰∏äÔºâ- ‰ΩÜ‰∏çÁßªÂãï‰ΩçÁΩÆ
                    setTimeout(() => {
                        cardsArray.forEach(card => {
                            // Âè™Ê∑ªÂä†ÁøªÈù¢ÊïàÊûúÔºå‰∏çÊîπËÆä‰ΩçÁΩÆ
                            card.classList.add('face-down');
                        });
                        
                        // Á¢∫‰øùÂç°ÁâáÂÆåÂÖ®ÁøªÂà∞ËÉåÈù¢ÂæåÂÜçÈñãÂßãÊâì‰∫Ç
                        setTimeout(() => {
                            // Á¨¨‰∫åÈöéÊÆµÔºöÁõ¥Êé•Êâì‰∫ÇÂç°ÁâáÔºà‰∏çÈõÜ‰∏≠Âà∞‰∏≠ÂøÉÔºâ
                            
                            // È¶ñÂÖàÔºåÂâµÂª∫‰∏ÄÂÄãÁ∂≤Ê†º‰ΩçÁΩÆÁöÑÈô£Âàó
                            const positions = [];
                            const cardWidth = 120; // Âç°ÁâáÂØ¨Â∫¶Ôºå‰∏çÂåÖÂê´margin
                            const cardHeight = 150; // Âç°ÁâáÈ´òÂ∫¶Ôºå‰∏çÂåÖÂê´margin
                            const cardMargin = 10; // Âç°Áâá‰πãÈñìÁöÑÈñìË∑ù
                            const effectiveCardWidth = cardWidth + cardMargin * 2;
                            const effectiveCardHeight = cardHeight + cardMargin * 2;
                            const cardsPerRow = Math.floor(containerWidth / effectiveCardWidth);
                            
                            // Ë®àÁÆóÊØèÂÄãÂç°ÁâáÂèØËÉΩÁöÑ‰ΩçÁΩÆ
                            for (let i = 0; i < cardsArray.length; i++) {
                                const row = Math.floor(i / cardsPerRow);
                                const col = i % cardsPerRow;
                                
                                const left = (col * effectiveCardWidth) + (containerWidth - cardsPerRow * effectiveCardWidth) / 2 + cardMargin;
                                const top = (row * effectiveCardHeight) + 20 + cardMargin;
                                
                                positions.push({ left, top });
                            }
                            
                            // Êâì‰∫Ç‰ΩçÁΩÆÈô£Âàó
                            for (let i = positions.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [positions[i], positions[j]] = [positions[j], positions[i]];
                            }
                            
                            // Á¨¨‰∏ÄÊ¨°Èö®Ê©üÁßªÂãï - ËÆìÂç°ÁâáÂú®Âéü‰ΩçÁΩÆÈôÑËøëÈö®Ê©üÂÅèÁßª
                            cardsArray.forEach((card, index) => {
                                // ‰ΩøÁî®ÂàùÂßã‰ΩçÁΩÆ‰ΩúÁÇ∫Âü∫Ê∫ñ
                                const initialPos = initialPositions[index];
                                
                                // Èö®Ê©üÂÅèÁßªÈáèÔºå‰ΩÜÂÅèÁßªÁØÑÂúçËºÉÂ∞è
                                const offsetX = (Math.random() - 0.5) * 60;
                                const offsetY = (Math.random() - 0.5) * 60;
                                
                                // Á¢∫‰øù‰∏çË∂ÖÂá∫ÂÆπÂô®
                                const newLeft = Math.max(0, Math.min(containerWidth - cardWidth, initialPos.left + offsetX));
                                const newTop = Math.max(0, Math.min(containerHeight - cardHeight, initialPos.top + offsetY));
                                
                                // Áõ¥Êé•Ë®≠ÁΩÆÊñ∞‰ΩçÁΩÆÔºå‰∏ç‰ΩøÁî®transform‰æÜÁßªÂãï
                                card.style.left = `${newLeft}px`;
                                card.style.top = `${newTop}px`;
                                // Âè™‰ΩøÁî®transform‰æÜËôïÁêÜÊóãËΩâÂíåÁøªÈù¢
                                card.style.transform = `rotate(${Math.random() * 20 - 10}deg) rotateY(180deg)`;
                            });
                            
                            // Á¨¨‰∫åÊ¨°Èö®Ê©üÁßªÂãï - Êõ¥Â§ßÂπÖÂ∫¶ÁöÑÁßªÂãï
                            setTimeout(() => {
                                cardsArray.forEach((card, index) => {
                                    // Áç≤ÂèñÁï∂Ââç‰ΩçÁΩÆ
                                    const currentLeft = parseFloat(card.style.left);
                                    const currentTop = parseFloat(card.style.top);
                                    
                                    // Êõ¥Â§ßÁöÑÈö®Ê©üÂÅèÁßª
                                    const offsetX = (Math.random() - 0.5) * 120;
                                    const offsetY = (Math.random() - 0.5) * 120;
                                    
                                    // Á¢∫‰øù‰∏çË∂ÖÂá∫ÂÆπÂô®
                                    const newLeft = Math.max(0, Math.min(containerWidth - cardWidth, currentLeft + offsetX));
                                    const newTop = Math.max(0, Math.min(containerHeight - cardHeight, currentTop + offsetY));
                                    
                                    // Áõ¥Êé•Ë®≠ÁΩÆÊñ∞‰ΩçÁΩÆ
                                    card.style.left = `${newLeft}px`;
                                    card.style.top = `${newTop}px`;
                                    // Âè™‰ΩøÁî®transform‰æÜËôïÁêÜÊóãËΩâÂíåÁøªÈù¢
                                    card.style.transform = `rotate(${Math.random() * 40 - 20}deg) rotateY(180deg)`;
                                });
                                
                                // Á¨¨‰∏âÈöéÊÆµÔºöÊúÄÁµÇÊéíÂàóÊàêÁ∂≤Ê†º
                                setTimeout(() => {
                                    // Â∞áÂç°ÁâáÁßªÂãïÂà∞ÊúÄÁµÇ‰ΩçÁΩÆ
                                    cardsArray.forEach((card, index) => {
                                        const position = positions[index];
                                        
                                        // Áõ¥Êé•Ë®≠ÁΩÆÊúÄÁµÇ‰ΩçÁΩÆ
                                        card.style.left = `${position.left}px`;
                                        card.style.top = `${position.top}px`;
                                        // ‰øùÊåÅÂç°ÁâáËÉåÈù¢Êúù‰∏äÔºå‰ΩÜÊóãËΩâËßíÂ∫¶ÊÅ¢Âæ©Ê≠£Â∏∏
                                        card.style.transform = `rotate(0deg) rotateY(180deg)`;
                                    });
                                    
                                    // ÁÇ∫ÊâÄÊúâÂç°ÁâáÊ∑ªÂä†ÈªûÊìä‰∫ã‰ª∂‰∏¶ÂàÜÈÖçÊï∏Â≠ó
                                    setTimeout(() => {
                                        // Ê†πÊìöË¶ñË¶∫‰ΩçÁΩÆÊéíÂ∫èÂç°ÁâáÔºå‰ª•‰æøÂàÜÈÖçÊ≠£Á¢∫ÁöÑÁ∑®Ëôü
                                        const sortedCards = cardsArray.sort((a, b) => {
                                            const topA = parseFloat(a.style.top);
                                            const topB = parseFloat(b.style.top);
                                            if (Math.abs(topA - topB) > 10) { // Â¶ÇÊûúÂûÇÁõ¥‰ΩçÁΩÆÂ∑ÆÁï∞Â§ßÊñº‰∏ÄÂÄãÈñæÂÄº
                                                return topA - topB;
                                            }
                                            return parseFloat(a.style.left) - parseFloat(b.style.left);
                                        });

                                        sortedCards.forEach((card, index) => {
                                            const numberEl = card.querySelector('.card-number');
                                            if (numberEl) {
                                                numberEl.textContent = index + 1;
                                            }
                                            
                                            // Á¢∫‰øùÂç°Áâá‰ªçÁÑ∂ÊòØËÉåÈù¢Êúù‰∏ä
                                            if (!card.classList.contains('face-down')) {
                                                card.classList.add('face-down');
                                            }
                                            card.addEventListener('click', handlePunchCardClick);
                                        });
                                        
                                        // Êõ¥Êñ∞ÁãÄÊÖãÂíåÊèêÁ§∫
                                        isPunchHoleShuffled = true;
                                        document.querySelector('.punch-instruction').textContent = 'Ë´ãÈÅ∏Êìá‰∏ÄÂºµÂç°ÁâáÊè≠Êõâ‰∏≠ÁçéËÄÖ';
                                        
                                        // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠ó
                                        const buttonText = drawWinnerBtn.querySelector('.text');
                                        if (buttonText) buttonText.textContent = 'ÈáçÊñ∞ÁôºÁâå';
                                        
                                        // ÈáçÊñ∞ÂïüÁî®ÊåâÈàï
                                        drawWinnerBtn.disabled = false;
                                    }, 800);
                                }, 800);
                            }, 400);
                        }, 200); // Ê∑ªÂä†Â∞èÂª∂ÈÅ≤Á¢∫‰øùÁøªÈù¢ÂÆåÊàê
                    }, 50);
                }
                
                function handlePunchCardClick(e) {
                    if (!punchHoleReady || punchHoleWinnerSelected || !isPunchHoleShuffled) return;
                    
                    const card = e.currentTarget;
                    if (card.classList.contains('selected')) return;
                    
                    // ÈÅ∏Êìá‰∫ÜÈÄôÂºµÂç°Áâá‰ΩúÁÇ∫‰∏≠ÁçéËÄÖ
                    card.classList.add('selected');
                    card.classList.remove('face-down');
                    
                    punchHoleWinnerSelected = true;
                    
                    // Áç≤Âèñ‰∏≠ÁçéËÄÖË≥áË®ä
                    const channelId = card.dataset.channelId;
                    const winner = participants.find(p => p.channelId === channelId);
                    
                    if (winner) {
                        punchHoleWinner = winner;
                        selectedWinner = winner;
                        highlightWinner(winner);
                        
                        // Ê®ôË®òÂç°ÁâáÁÇ∫‰∏≠ÁçéÔºå‰∏¶ÊîæÂ§ßÈ°ØÁ§∫
                        setTimeout(() => {
                            card.classList.add('winner');
                        }, 500);
                        
                        // È°ØÁ§∫‰∏≠ÁçéÊèêÁ§∫
                        punchHoleWinnerDisplayEl.textContent = `üéâ ÊÅ≠Âñú ${winner.displayName} ‰∏≠ÁçéÔºÅ`;
                        punchHoleWinnerDisplayEl.classList.add('show');
                        
                        // Êõ¥Êñ∞ÊåáÁ§∫ÊñáÂ≠ó
                        document.querySelector('.punch-instruction').textContent = 'Â∑≤ÈÅ∏Âá∫‰∏≠ÁçéËÄÖÔºåÈªûÊìä„ÄåÈáçÊñ∞ÁôºÁâå„ÄçÈñãÂßãÊñ∞‰∏ÄËº™ÊäΩÁçé';
                        
                        // Êí≠ÊîæÊÖ∂Á•ùÁâπÊïà
                        myConfetti({
                            particleCount: 150,
                            spread: 90,
                            origin: { y: 0.6 }
                        });

                        saveWinnerToHistory(winner);
                    }
                    
                    // Èò≤Ê≠¢ÁπºÁ∫åÈªûÊìäÂÖ∂‰ªñÂç°Áâá
                    punchHoleAnimationEl.querySelectorAll('.punch-card:not(.selected)').forEach(otherCard => {
                        otherCard.removeEventListener('click', handlePunchCardClick);
                        otherCard.style.opacity = '0.5';
                        otherCard.style.cursor = 'default';
                    });
                }
                
                function resetPunchHoleAnimation() {
                    punchHoleReady = false;
                    punchHoleWinnerSelected = false;
                    punchHoleWinner = null;
                    isPunchHoleShuffled = false;
                    
                    // Ê∏ÖÈô§È´ò‰∫Æ
                    const participantsList = participantsListEl.querySelectorAll('li');
                    participantsList.forEach(li => {
                        li.classList.remove('winner-highlight');
                    });
                    
                    // ÈáçÊñ∞Ë®≠ÁΩÆ
                    setupPunchHoleCards();
                }

                function showTemporaryAnimation(participants, callback) {
                    animationContainer.style.display = 'block';
                    winnerDisplayEl.style.display = 'none';
                    
                    if (participants.length === 0) {
                        animationContainer.textContent = 'Ê≤íÊúâÂèÉËàáËÄÖ!';
                        return;
                    }
                    
                    let animationInterval = setInterval(() => {
                        const randomParticipant = participants[Math.floor(Math.random() * participants.length)];
                        animationContainer.innerHTML = `
                            <img src="${randomParticipant.profileImageUrl}" style="width: 80px; height: 80px; border-radius: 50%; margin-right: 20px;">
                            <span>${randomParticipant.displayName}</span>
                        `;
                    }, 100);

                    setTimeout(() => {
                        clearInterval(animationInterval);
                        callback();
                    }, 5000);
                }

                function showWinner(winner) {
                    const winnerDisplay = document.getElementById('winner-display');
                    const winnerAvatar = document.getElementById('winner-avatar');
                    const winnerName = document.getElementById('winner-name');
                    
                    winnerAvatar.src = winner.profileImageUrl;
                    winnerName.textContent = winner.displayName;
                    winnerDisplay.classList.add('show');

                    const closeBtn = winnerDisplay.querySelector('.close-winner');
                    if (closeBtn) {
                        closeBtn.onclick = () => {
                            winnerDisplay.classList.remove('show');
                        };
                    }

                    setTimeout(() => {
                        winnerDisplay.classList.remove('show');
                    }, 10000); // Âª∂Èï∑È°ØÁ§∫ÊôÇÈñì
                }

                drawWinnerBtn.addEventListener('click', async () => {
                    const animationMode = animationModeEl.value;
                    
                    if (animationMode === 'turntable') {
                        startSpin();
                    } else if (animationMode === 'pointer') {
                        if (pointerWinnerDecided) {
                            resetPointerAnimation();
                        } else {
                            startPointerLottery();
                        }
                    } else if (animationMode === 'punch-hole') {
                        // Ê¥ûÊ¥ûÊ®ÇÊ®°Âºè
                        if (isPunchHoleShuffled) {
                            // Â¶ÇÊûúÂ∑≤Á∂ìÊâì‰∫ÇÔºåÂ∞±ÈáçÊñ∞ÁôºÁâå
                            resetPunchHoleAnimation();
                        } else {
                            // Â¶ÇÊûúÈÇÑÊ≤íÊâì‰∫ÇÔºåÂ∞±Êâì‰∫ÇÂç°Áâá
                            shufflePunchHoleCards();
                        }
                    } else {
                        // Â∞çÊñºÂÖ∂‰ªñÊ®°ÂºèÔºåÁ∂≠ÊåÅÂéüÊ®£ÔºåÂÖàÂæûÂæåÁ´ØÁç≤ÂèñÁµêÊûú
                        try {
                            const response = await fetch('/api/admin/lottery/draw', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    animationMode,
                                    duration: 0 
                                })
                            });

                            const result = await response.json();
                            if (!response.ok) throw new Error(result.error || 'ÊäΩÁçéÂ§±Êïó');
                            if (!result.winner) throw new Error('Êú™ËÉΩÁç≤Âèñ‰∏≠ÁçéËÄÖË≥áË®ä');

                            const winner = result.winner;
                            selectedWinner = winner;
                            highlightWinner(winner);
                            showWinner(winner);
                            myConfetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }});
                        } catch (error) {
                            console.error('ÊäΩÁçéÂá∫ÈåØ:', error);
                            alert(`ÊäΩÁçéÂ§±Êïó: ${error.message}`);
                        }
                    }
                });
                
                viewHistoryBtn.addEventListener('click', () => {
                    window.location.href = 'lottery-history.html';
                });
                
                animationModeEl.addEventListener('change', () => {
                    if(isReelSpinning || isSpinning) {
                        alert('Ë´ãÁ≠âÂæÖÁõÆÂâçÊäΩÁçéÂãïÁï´ÁµêÊùüÔºÅ');
                        animationModeEl.value = isSpinning ? 'turntable' : 'pointer';
                        return;
                    }
                    if (pointerWinnerDecided) {
                        alert('Ë´ãÂÖàÈáçË®≠ÊåáÈáùÊäΩÁçéÔºåÊâçËÉΩÂàáÊèõÊ®°ÂºèÔºÅ');
                        animationModeEl.value = 'pointer';
                        return;
                    }
                    if (punchHoleWinnerSelected) {
                        alert('Ë´ãÂÖàÈáçÊñ∞ÁôºÁâåÔºåÊâçËÉΩÂàáÊèõÊ®°ÂºèÔºÅ');
                        animationModeEl.value = 'punch-hole';
                        return;
                    }
                    setupAnimationView(animationModeEl.value);
                });

                // Áï∂APIË´ãÊ±ÇÈñìÈöîÊîπËÆäÊôÇÔºåÂ¶ÇÊûúÊ≠£Âú®Áõ£Êéß‰∏≠ÔºåÂâáÈáçË®≠Ë®àÊôÇÂô®
                apiRateInput.addEventListener('change', () => {
                    if (updateTimer) {
                        startAutoUpdate();
                    }
                });

                // Áõ£ÊéßÈñãÈóúÁöÑ‰∫ã‰ª∂ËôïÁêÜ
                monitoringToggle.addEventListener('change', async function() {
                    if (this.checked) {
                        // ÈñãÂßãÁõ£Êéß
                        const videoId = videoIdEl.value.trim();
                        const keyword = keywordEl.value.trim();
                        const apiRateLimit = parseInt(apiRateInput.value, 10);

                        if (!videoId || !keyword) {
                            alert('Ë´ãÂ°´ÂØ´ Video ID ÂíåÈóúÈçµÂ≠óÔºÅ');
                            this.checked = false;
                            return;
                        }

                        try {
                            const response = await fetch('/api/admin/lottery/set-video', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    videoId,
                                    keyword,
                                    apiRateLimit
                                })
                            });

                            const result = await response.json();
                            if (!response.ok) throw new Error(result.error || 'Ë®≠ÁΩÆÂ§±Êïó');
                            
                            monitoringVideoIdEl.textContent = ` (${result.videoTitle})`;
                            apiRateInput.disabled = !result.isLive;

                            if (result.isLive) {
                                // Áõ¥Êí≠Ê®°Âºè
                                toggleStatusEl.textContent = 'Á≥ªÁµ±ÁãÄÊÖã: Áõ£Êéß‰∏≠';
                                startAutoUpdate();
                            } else {
                                // ÂΩ±ÁâáÁïôË®ÄÊ®°Âºè
                                toggleStatusEl.textContent = `Á≥ªÁµ±ÁãÄÊÖã: ÁïôË®ÄÂ∑≤ËºâÂÖ•`;
                                stopAutoUpdate(); // Á¢∫‰øùÊ≤íÊúâËàäÁöÑË®àÊôÇÂô®Âú®Ë∑ë
                                // ÂæåÁ´ØÂ∑≤ËøîÂõûÂèÉËàáËÄÖÊï∏ÈáèÔºåÂèØ‰ª•Áõ¥Êé•Êõ¥Êñ∞Ôºå‰∏¶ÊâãÂãïÊäìÂèñ‰∏ÄÊ¨°ÂàóË°®
                                participantsCountEl.textContent = `ÁõÆÂâçÂèÉËàá‰∫∫Êï∏Ôºö${result.participantCount} ‰∫∫`;
                                fetchParticipants(); 
                            }

                        } catch (error) {
                            console.error('Error setting video:', error);
                            alert(`Ë®≠ÁΩÆÂ§±Êïó: ${error.message}`);
                            this.checked = false;
                        }
                    } else {
                        // ÂÅúÊ≠¢Áõ£Êéß
                        try {
                            const response = await fetch('/api/admin/lottery/stop-monitoring', {
                                method: 'POST'
                            });
                            const result = await response.json();
                            
                            if (response.ok && result.success) {
                                stopAutoUpdate();
                                monitoringVideoIdEl.textContent = '';
                                defaultAnimation.textContent = 'Â∑≤ÂÅúÊ≠¢Áõ£Êéß';
                                apiRateInput.disabled = false; // ÈáçÊñ∞ÂïüÁî® API È†ªÁéáÈÅ∏È†Ö
                            } else {
                                throw new Error(result.error || 'ÂÅúÊ≠¢Áõ£ÊéßÂ§±Êïó');
                            }
                        } catch (error) {
                            console.error('Error stopping monitoring:', error);
                            alert(`ÂÅúÊ≠¢Áõ£ÊéßÂ§±Êïó: ${error.message}`);
                            this.checked = true;
                        }
                    }
                });

                // Initial setup
                setupAnimationView(animationModeEl.value);
            }

            checkAccess();
        });
    </script>
</body>
</html> 