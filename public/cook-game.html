<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烹飪模擬器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #2c3e50;
            --surface-color: #34495e;
            --text-color: #fff;   /* #edf3f5; */
            --text-muted-color: #bdc3c7;
            --border-color: #4a6278;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --success-color: #27ae60;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background-color: var(--surface-color);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .sidebar nav a {
            
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-muted-color);
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar nav a i { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar nav a.active, .sidebar nav a:hover { background-color: var(--primary-color); color: #fff; }
        
        .admin-sidebar { display: flex; flex-direction: column; height: 100%; }
        .admin-sidebar h2 { text-align: center; margin-bottom: 30px; font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .admin-sidebar .user-profile { padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; }
        .admin-sidebar .user-profile img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .admin-sidebar .user-profile .user-info { line-height: 1.2; color: #ecf0f1; }
        .admin-sidebar .user-info strong { font-size: 16px; display: block; margin-bottom: 4px; }
        .admin-sidebar .user-info span { font-size: 14px; opacity: 0.8; }

        .main-content {  flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden;}
        header { padding: 15px 30px; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        header h1 { margin: 0; font-size: 24px; color: #ecf0f1;}
        .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }

        .tier-0 { background-color: #e9ecef; color: #212529; } /* 基礎食材 */
        .tier-1 { background-color: #fff3cd; color: #212529; } /* 半成品 */
        .tier-2 { background-color: #d4edda; color: #212529; } /* 最終料理 */

        /* 模擬器相關樣式 */
        .sim-item {
            width: 70px;
            height: 70px;
            border: 1px solid #ddd;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            cursor: grab;
            position: relative;
            user-select: none;
            overflow: hidden;
        }

        .sim-item:active {
            cursor: grabbing;
        }

        .sim-item .ascii-symbol {
            font-size: 40px;
            line-height: 1;
            opacity: 0.8;
            z-index: 1;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .sim-item .item-name {
            font-size: 12px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            padding: 2px 3px;
            position: absolute;
            bottom: 0;
            left: 0;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 2;
            color: #000;
            font-weight: bold;
        }

        .crafting-slot .sim-item .item-name {
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .sim-item .tier-badge {
            position: absolute;
            top: 1px;
            right: 1px;
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 2px;
            z-index: 3;
        }

        .crafting-slot {
            position: relative;
            transition: background-color 0.2s;
        }

        .crafting-slot.drag-over {
            background-color: rgba(52, 152, 219, 0.2) !important;
        }

        .crafting-slot .sim-item {
            width: 100%;
            height: 100%;
        }

        .cooking-method-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .cooking-method-btn.recommended {
            background-color: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        #simulationResults {
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.5;
        }

        .simulation-success {
            color: #2ecc71;
        }

        .simulation-error {
            color: #e74c3c;
        }

        .simulation-info {
            color: #3498db;
        }

        /* 水煮模擬動畫 */
        .boil-animation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px 0;
        }
        
        /* 全螢幕水煮動畫覆蓋層 */
        .fullscreen-boil-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .fullscreen-boil-spinner {
            width: 150px;
            height: 150px;
            border: 10px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-boil-wave {
            color: #3182ce;
            font-size: 4rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .fullscreen-boil-text {
            margin-top: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        /* 成功訊息覆蓋層 */
        .success-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease-in-out, fadeOut 0.5s ease-in-out 2.5s forwards;
        }
        
        .success-message-content {
            background-color: rgba(47, 133, 90, 0.9);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            animation: popIn 0.5s ease-out forwards;
        }
        
        .success-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: white;
        }
        
        .success-text {
            color: white;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .item-name-text {
            color: #ffeb3b;
            font-size: 32px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .item-ascii {
            font-size: 72px;
            line-height: 1;
            margin: 10px 0;
            color: white;
        }
        
        .tier-badge-large {
            display: inline-block;
            background-color: #ffeb3b;
            color: #333;
            font-size: 18px;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            margin-left: 10px;
        }
        
        .boil-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .boil-wave {
            color: #3182ce;
            font-size: 2rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .view-path-btn {
            position: absolute;
            bottom: 1px;
            right: 1px;
            padding: 1px 4px;
            font-size: 9px;
            line-height: 1.2;
        }

        #synthesisPathContent ul {
            padding-left: 20px;
            list-style-type: none;
        }
        #synthesisPathContent li {
            position: relative;
        }
        #synthesisPathContent li::before {
            content: '';
            position: absolute;
            left: -20px;
            top: -1.2em;
            border-left: 1px dashed #999;
            border-bottom: 1px dashed #999;
            width: 15px;
            height: 100%;
        }
        #synthesisPathContent li:last-child::before {
             border-left: 1px dashed #999;
        }

        .card-header {
            color: #212529;
        }

        .mb-3 {
            color: #212529;
        }
        
        #simulatorSection h5 {
            color: #212529;
        }

        /* 新增烹飪按鈕樣式 */
        .btn-cooking {
            background-color: #ff7043;
            color: white;
            border: 1px solid #e64a19;
            transition: all 0.3s ease;
        }
        
        .btn-cooking:hover {
            background-color: #ff5722;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn-cooking.active {
            background-color: #e64a19;
            color: white;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(0);
        }

        /* 現代化工具欄樣式 */
        .modern-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            margin: 0 auto 1rem auto;
            transition: all 0.3s ease;
        }
        
        .modern-toolbar:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        .toolbar-btn {
            color: #4a5568;
            margin: 0 0.5rem;
            transition: all 0.2s ease-in-out;
            background: transparent;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            outline: none;
        }
        
        .toolbar-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        
        .toolbar-btn svg {
            height: 1.5rem;
            width: 1.5rem;
        }
        
        .toolbar-btn-grill {
            color: #ed8936;
        }
        
        .toolbar-btn-grill:hover {
            color: #dd6b20;
            transform: scale(1.1);
        }
        
        .toolbar-btn-fry {
            color: #d69e2e;
        }
        
        .toolbar-btn-fry:hover {
            color: #b7791f;
            transform: rotate(12deg);
        }
        
        .toolbar-btn-deep-fry {
            color: #e53e3e;
        }
        
        .toolbar-btn-deep-fry:hover {
            color: #c53030;
            background-color: rgba(0, 0, 0, 0.05);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .toolbar-btn-boil {
            color: #3182ce;
        }
        
        .toolbar-btn-boil:hover {
            color: #2c5282;
            transform: translateY(-4px);
        }
        
        .toolbar-btn-assembly {
            color: #805ad5;
        }
        
        .toolbar-btn-assembly:hover {
            color: #6b46c1;
            transform: rotate(180deg);
        }
        
        .toolbar-btn.active {
            background-color: rgba(0, 0, 0, 0.1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes popIn {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }

        /* 全螢幕油炸動畫覆蓋層 */
        .fullscreen-fry-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .fullscreen-fry-spinner {
            width: 150px;
            height: 150px;
            border: 10px solid #ffeaa7;
            border-top-color: #e67e22;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-fry-bubbles {
            position: relative;
            width: 80px;
            height: 80px;
            color: #e67e22;
            animation: pulse 1s ease-in-out infinite alternate;
        }
        
        .fry-bubble {
            position: absolute;
            background-color: #e67e22;
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .fry-bubble:nth-child(1) {
            width: 15px;
            height: 15px;
            top: 10px;
            left: 10px;
            animation: bubbleFloat 1.2s infinite ease-in-out;
        }
        
        .fry-bubble:nth-child(2) {
            width: 12px;
            height: 12px;
            top: 30px;
            left: 50px;
            animation: bubbleFloat 1.5s infinite ease-in-out 0.2s;
        }
        
        .fry-bubble:nth-child(3) {
            width: 18px;
            height: 18px;
            top: 50px;
            left: 15px;
            animation: bubbleFloat 1.1s infinite ease-in-out 0.5s;
        }
        
        .fry-bubble:nth-child(4) {
            width: 10px;
            height: 10px;
            top: 20px;
            left: 60px;
            animation: bubbleFloat 1.3s infinite ease-in-out 0.3s;
        }
        
        .fry-bubble:nth-child(5) {
            width: 14px;
            height: 14px;
            top: 60px;
            left: 40px;
            animation: bubbleFloat 1.4s infinite ease-in-out 0.1s;
        }
        
        @keyframes bubbleFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-15px) scale(1.2);
                opacity: 0.9;
            }
            100% {
                transform: translateY(-30px) scale(0.8);
                opacity: 0;
            }
        }
        
        .fullscreen-fry-text {
            margin-top: 20px;
            color: #e67e22;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* 全螢幕烤製動畫覆蓋層 */
        .fullscreen-grill-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .fullscreen-grill-text {
            margin-top: 20px;
            color: #e74c3c;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* 烤製火焰動畫 */
        @keyframes scaleUpDown {
            0%, 100% {
                transform: scaleY(1) scaleX(1);
            }
            50%, 90% {
                transform: scaleY(1.1);
            }
            75% {
                transform: scaleY(0.95);
            }
            80% {
                transform: scaleX(0.95);
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: skewX(0) scale(1);
            }
            50% {
                transform: skewX(5deg) scale(0.9);
            }
        }

        @keyframes particleUp {
            0% {
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                top: -100%;
                transform: scale(0.5);
            }
        }

        @keyframes glow {
            0%, 100% {
                background-color: #ef5a00;
            }
            50% {
                background-color: #ff7800;
            }
        }

        .fire {
            position: relative;
            width: 150px;
            height: 150px;
            background-color: transparent;
            margin: 0 auto;
        }

        .fire-center {
            position: absolute;
            height: 100%;
            width: 100%;
            animation: scaleUpDown 3s ease-out;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

        .fire-center .main-fire {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(farthest-corner at 10px 0, #d43300 0%, #ef5a00 95%);
            transform: scaleX(0.8) rotate(45deg);
            border-radius: 0 40% 60% 40%;
            filter: drop-shadow(0 0 10px #d43322);
        }

        .fire-center .particle-fire {
            position: absolute;
            top: 60%;
            left: 45%;
            width: 10px;
            height: 10px;
            background-color: #ef5a00;
            border-radius: 50%;
            filter: drop-shadow(0 0 10px #d43322);
            animation: particleUp 2s ease-out 0;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

        .fire-right {
            height: 100%;
            width: 100%;
            position: absolute;
            animation: shake 2s ease-out 0;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

        .fire-right .main-fire {
            position: absolute;
            top: 15%;
            right: -25%;
            width: 80%;
            height: 80%;
            background-color: #ef5a00;
            transform: scaleX(0.8) rotate(45deg);
            border-radius: 0 40% 60% 40%;
            filter: drop-shadow(0 0 10px #d43322);
        }

        .fire-right .particle-fire {
            position: absolute;
            top: 45%;
            left: 50%;
            width: 15px;
            height: 15px;
            background-color: #ef5a00;
            transform: scaleX(0.8) rotate(45deg);
            border-radius: 50%;
            filter: drop-shadow(0 0 10px #d43322);
            animation: particleUp 2s ease-out 0;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

        .fire-left {
            position: absolute;
            height: 100%;
            width: 100%;
            animation: shake 3s ease-out 0;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

        .fire-left .main-fire {
            position: absolute;
            top: 15%;
            left: -20%;
            width: 80%;
            height: 80%;
            background-color: #ef5a00;
            transform: scaleX(0.8) rotate(45deg);
            border-radius: 0 40% 60% 40%;
            filter: drop-shadow(0 0 10px #d43322);
        }

        .fire-left .particle-fire {
            position: absolute;
            top: 10%;
            left: 20%;
            width: 10%;
            height: 10%;
            background-color: #ef5a00;
            border-radius: 50%;
            filter: drop-shadow(0 0 10px #d43322);
            animation: particleUp 3s infinite ease-out 0;
            animation-fill-mode: both;
        }

        .fire-bottom .main-fire {
            position: absolute;
            top: 30%;
            left: 20%;
            width: 75%;
            height: 75%;
            background-color: #ff7800;
            transform: scaleX(0.8) rotate(45deg);
            border-radius: 0 40% 100% 40%;
            filter: blur(10px);
            animation: glow 2s ease-out 0;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }
        
        /* 移除舊的烤製動畫 */
        .pl {
            width: 6em;
            height: 6em;
        }

        .pl circle {
            transform-box: fill-box;
            transform-origin: 50% 50%;
        }

        .pl__ring1 {
            animation: ring1 4s 0s ease-in-out infinite;
            stroke: #e74c3c;
            stroke-dasharray: 180;
            stroke-dashoffset: -376.237129776;
            stroke-width: 8px;
            fill: none;
        }

        .pl__ring2 {
            animation: ring2 4s 0.04s ease-in-out infinite;
            stroke: #f39c12;
            stroke-dasharray: 180;
            stroke-dashoffset: -329.207488554;
            stroke-width: 7px;
            fill: none;
        }

        .pl__ring3 {
            animation: ring3 4s 0.08s ease-in-out infinite;
            stroke: #f1c40f;
            stroke-dasharray: 180;
            stroke-dashoffset: -288.4484661616;
            stroke-width: 6px;
            fill: none;
        }

        .pl__ring4 {
            animation: ring4 4s 0.12s ease-in-out infinite;
            stroke: #e67e22;
            stroke-dasharray: 180;
            stroke-dashoffset: -253.9600625988;
            stroke-width: 5px;
            fill: none;
        }

        .pl__ring5 {
            animation: ring5 4s 0.16s ease-in-out infinite;
            stroke: #d35400;
            stroke-dasharray: 180;
            stroke-dashoffset: -225.7422778656;
            stroke-width: 4px;
            fill: none;
        }

        .pl__ring6 {
            animation: ring6 4s 0.2s ease-in-out infinite;
            stroke: #c0392b;
            stroke-dasharray: 180;
            stroke-dashoffset: -203.795111962;
            stroke-width: 3px;
            fill: none;
        }

        /* 烤製動畫關鍵幀 */
        @keyframes ring1 {
            from {
                stroke-dashoffset: -376.237129776;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -94.247778;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -376.237129776;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -94.247778;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -376.237129776;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring2 {
            from {
                stroke-dashoffset: -329.207488554;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -82.46680575;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -329.207488554;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -82.46680575;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -329.207488554;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring3 {
            from {
                stroke-dashoffset: -288.4484661616;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -72.2566298;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -288.4484661616;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -72.2566298;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -288.4484661616;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring4 {
            from {
                stroke-dashoffset: -253.9600625988;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -63.61725015;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -253.9600625988;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -63.61725015;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -253.9600625988;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring5 {
            from {
                stroke-dashoffset: -225.7422778656;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -56.5486668;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -225.7422778656;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -56.5486668;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -225.7422778656;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring6 {
            from {
                stroke-dashoffset: -203.795111962;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -51.05087975;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -203.795111962;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -51.05087975;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -203.795111962;
                transform: rotate(4.75turn);
            }
        }

        .fire-bottom .main-fire {
            position: absolute;
            top: 30%;
            left: 20%;
            width: 75%;
            height: 75%;
            background-color: #ff7800;
            transform: scaleX(0.8) rotate(45deg);
            border-radius: 0 40% 100% 40%;
            filter: blur(10px);
            animation: glow 2s ease-out 0;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }
        
        /* 煎炒動畫 */
        .fullscreen-pan-fry-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .fullscreen-pan-fry-text {
            margin-top: 20px;
            color: #f39c12;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .loader {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .panWrapper {
            width: 200px;
            height: fit-content;
            position: relative;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            flex-direction: column;
            gap: 20px;
        }

        .pan {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            width: 100%;
            height: fit-content;
            animation: cooking 1.7s infinite;
            position: relative;
        }
        
        @keyframes cooking {
            0% {
                transform: rotate(0deg);
                transform-origin: top right;
            }
            10% {
                transform: rotate(-4deg);
                transform-origin: top right;
            }
            50% {
                transform: rotate(20deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }

        .food {
            position: absolute;
            width: 40%;
            height: 6px;
            background: linear-gradient(to bottom, rgb(82, 33, 33), rgb(200, 106, 106));
            left: 10px;
            border-radius: 50%;
            animation: flip 1.7s infinite;
            z-index: 2;
        }
        
        @keyframes flip {
            0% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-100px) rotate(180deg);
            }
            100% {
                transform: translateY(0px) rotate(360deg);
            }
        }
        
        .panBase {
            z-index: 3;
            width: 50%;
            height: 22px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            background: linear-gradient(to top, rgb(3, 156, 156), rgb(10, 191, 191));
        }
        
        .panHandle {
            width: 40%;
            background: linear-gradient(to bottom, rgb(18, 18, 18), rgb(74, 74, 74));
            height: 10px;
            border-radius: 10px;
        }
        
        .panShadow {
            width: 70px;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.21);
            margin-left: 15px;
            border-radius: 10px;
            animation: shadow 1.7s infinite;
            filter: blur(5px);
        }
        
        @keyframes shadow {
            0% {
                transform: scaleX(0.7);
            }
            50% {
                transform: scaleX(1);
            }
            100% {
                transform: scaleX(0.7);
            }
        }
        
        /* 添加火焰效果 */
        .pan-flames {
            position: absolute;
            bottom: -15px;
            left: 10px;
            width: 50%;
            height: 15px;
            display: flex;
            justify-content: space-around;
            z-index: 1;
        }
        
        .flame {
            width: 10px;
            height: 15px;
            background: linear-gradient(to top, #f39c12, #e74c3c);
            border-radius: 50% 50% 20% 20%;
            animation: flicker 0.5s infinite alternate;
        }
        
        @keyframes flicker {
            0% {
                height: 15px;
                opacity: 1;
            }
            100% {
                height: 10px;
                opacity: 0.8;
            }
        }
        
        .flame:nth-child(2) {
            animation-delay: 0.1s;
            height: 12px;
        }
        
        .flame:nth-child(3) {
            animation-delay: 0.2s;
            height: 17px;
        }
        
        .flame:nth-child(4) {
            animation-delay: 0.15s;
            height: 14px;
        }
        
        .flame:nth-child(5) {
            animation-delay: 0.05s;
            height: 13px;
        }
        
        /* 移除舊的烤製動畫 */
        .pl {
            width: 6em;
            height: 6em;
        }

        .pl circle {
            transform-box: fill-box;
            transform-origin: 50% 50%;
        }

        .pl__ring1 {
            animation: ring1 4s 0s ease-in-out infinite;
            stroke: #e74c3c;
            stroke-dasharray: 180;
            stroke-dashoffset: -376.237129776;
            stroke-width: 8px;
            fill: none;
        }

        .pl__ring2 {
            animation: ring2 4s 0.04s ease-in-out infinite;
            stroke: #f39c12;
            stroke-dasharray: 180;
            stroke-dashoffset: -329.207488554;
            stroke-width: 7px;
            fill: none;
        }

        .pl__ring3 {
            animation: ring3 4s 0.08s ease-in-out infinite;
            stroke: #f1c40f;
            stroke-dasharray: 180;
            stroke-dashoffset: -288.4484661616;
            stroke-width: 6px;
            fill: none;
        }

        .pl__ring4 {
            animation: ring4 4s 0.12s ease-in-out infinite;
            stroke: #e67e22;
            stroke-dasharray: 180;
            stroke-dashoffset: -253.9600625988;
            stroke-width: 5px;
            fill: none;
        }

        .pl__ring5 {
            animation: ring5 4s 0.16s ease-in-out infinite;
            stroke: #d35400;
            stroke-dasharray: 180;
            stroke-dashoffset: -225.7422778656;
            stroke-width: 4px;
            fill: none;
        }

        .pl__ring6 {
            animation: ring6 4s 0.2s ease-in-out infinite;
            stroke: #c0392b;
            stroke-dasharray: 180;
            stroke-dashoffset: -203.795111962;
            stroke-width: 3px;
            fill: none;
        }

        /* 烤製動畫關鍵幀 */
        @keyframes ring1 {
            from {
                stroke-dashoffset: -376.237129776;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -94.247778;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -376.237129776;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -94.247778;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -376.237129776;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring2 {
            from {
                stroke-dashoffset: -329.207488554;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -82.46680575;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -329.207488554;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -82.46680575;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -329.207488554;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring3 {
            from {
                stroke-dashoffset: -288.4484661616;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -72.2566298;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -288.4484661616;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -72.2566298;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -288.4484661616;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring4 {
            from {
                stroke-dashoffset: -253.9600625988;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -63.61725015;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -253.9600625988;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -63.61725015;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -253.9600625988;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring5 {
            from {
                stroke-dashoffset: -225.7422778656;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -56.5486668;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -225.7422778656;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -56.5486668;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -225.7422778656;
                transform: rotate(4.75turn);
            }
        }

        @keyframes ring6 {
            from {
                stroke-dashoffset: -203.795111962;
                transform: rotate(-0.25turn);
                animation-timing-function: ease-in;
            }

            23% {
                stroke-dashoffset: -51.05087975;
                transform: rotate(1turn);
                animation-timing-function: ease-out;
            }

            46%, 50% {
                stroke-dashoffset: -203.795111962;
                transform: rotate(2.25turn);
                animation-timing-function: ease-in;
            }

            73% {
                stroke-dashoffset: -51.05087975;
                transform: rotate(3.5turn);
                animation-timing-function: ease-out;
            }

            96%, to {
                stroke-dashoffset: -203.795111962;
                transform: rotate(4.75turn);
            }
        }

        /* 組合動畫 */
        .fullscreen-assembly-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .fullscreen-assembly-text {
            margin-top: 20px;
            color: #a78bfa;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .assembly-loader {
            --duration: 3s;
            --primary: #805ad5; /* 主色調 - 紫色 */
            --primary-light: #a78bfa; /* 亮紫色 */
            --primary-rgba: rgba(128, 90, 213, 0);
            width: 200px;
            height: 320px;
            position: relative;
            transform-style: preserve-3d;
        }

        @media (max-width: 480px) {
            .assembly-loader {
                zoom: 0.44;
            }
        }
        
        .assembly-loader .ground {
            position: absolute;
            left: -50px;
            bottom: -120px;
            transform-style: preserve-3d;
            transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1);
        }

        .assembly-loader .ground div {
            transform: rotateX(90deg) rotateY(0deg) translate(-48px, -120px) translateZ(100px) scale(0);
            width: 200px;
            height: 200px;
            /* 盤子樣式 */
            background: #e0e0e0;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
            animation: ground var(--duration) linear forwards infinite;
        }

        .assembly-loader .box {
            --x: 0;
            --y: 0;
            position: absolute;
            animation: var(--duration) linear forwards infinite;
            transform: translate(var(--x), var(--y));
        }

        .assembly-loader .box div {
            background-color: var(--primary);
            width: 48px;
            height: 48px;
            position: relative;
            transform-style: preserve-3d;
            animation: var(--duration) ease forwards infinite;
            transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0);
        }

        .assembly-loader .box div:before,
        .assembly-loader .box div:after {
            --rx: 90deg;
            --ry: 0deg;
            --z: 24px;
            --y: -24px;
            --x: 0;
            content: "";
            position: absolute;
            background-color: inherit;
            width: inherit;
            height: inherit;
            transform: rotateX(var(--rx)) rotateY(var(--ry)) translate(var(--x), var(--y)) translateZ(var(--z));
            filter: brightness(var(--b, 1.2));
        }

        .assembly-loader .box div:after {
            --rx: 0deg;
            --ry: 90deg;
            --x: 24px;
            --y: 0;
            --b: 1.4;
        }
        
        .assembly-loader .box.box0 { --x: -220px; --y: -120px; left: 58px; top: 108px; }
        .assembly-loader .box.box1 { --x: -260px; --y: 120px; left: 25px; top: 120px; }
        .assembly-loader .box.box2 { --x: 120px; --y: -190px; left: 58px; top: 64px; }
        .assembly-loader .box.box3 { --x: 280px; --y: -40px; left: 91px; top: 120px; }
        .assembly-loader .box.box4 { --x: 60px; --y: 200px; left: 58px; top: 132px; }
        .assembly-loader .box.box5 { --x: -220px; --y: -120px; left: 25px; top: 76px; }
        .assembly-loader .box.box6 { --x: -260px; --y: 120px; left: 91px; top: 76px; }
        .assembly-loader .box.box7 { --x: -240px; --y: 200px; left: 58px; top: 87px; }

        .assembly-loader .box0 { animation-name: box-move0; }
        .assembly-loader .box0 div { animation-name: box-scale0; }
        .assembly-loader .box1 { animation-name: box-move1; }
        .assembly-loader .box1 div { animation-name: box-scale1; }
        .assembly-loader .box2 { animation-name: box-move2; }
        .assembly-loader .box2 div { animation-name: box-scale2; }
        .assembly-loader .box3 { animation-name: box-move3; }
        .assembly-loader .box3 div { animation-name: box-scale3; }
        .assembly-loader .box4 { animation-name: box-move4; }
        .assembly-loader .box4 div { animation-name: box-scale4; }
        .assembly-loader .box5 { animation-name: box-move5; }
        .assembly-loader .box5 div { animation-name: box-scale5; }
        .assembly-loader .box6 { animation-name: box-move6; }
        .assembly-loader .box6 div { animation-name: box-scale6; }
        .assembly-loader .box7 { animation-name: box-move7; }
        .assembly-loader .box7 div { animation-name: box-scale7; }

        @keyframes box-move0 { 12% { transform: translate(var(--x), var(--y)); } 25%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale0 { 6% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 14%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move1 { 16% { transform: translate(var(--x), var(--y)); } 29%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale1 { 10% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 18%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move2 { 20% { transform: translate(var(--x), var(--y)); } 33%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale2 { 14% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 22%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move3 { 24% { transform: translate(var(--x), var(--y)); } 37%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale3 { 18% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 26%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move4 { 28% { transform: translate(var(--x), var(--y)); } 41%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale4 { 22% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 30%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move5 { 32% { transform: translate(var(--x), var(--y)); } 45%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale5 { 26% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 34%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move6 { 36% { transform: translate(var(--x), var(--y)); } 49%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale6 { 30% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 38%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }
        @keyframes box-move7 { 40% { transform: translate(var(--x), var(--y)); } 53%, 52% { transform: translate(0, 0); } 80% { transform: translate(0, -32px); } 90%, 100% { transform: translate(0, 0); } }
        @keyframes box-scale7 { 34% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(0); } 42%, 100% { transform: rotateY(-47deg) rotateX(-15deg) rotateZ(15deg) scale(1); } }

        @keyframes ground {
            0% { transform: rotateX(90deg) rotateY(0deg) translate(-48px, -120px) translateZ(100px) scale(0); }
            15%, 100% { transform: rotateX(90deg) rotateY(0deg) translate(-48px, -120px) translateZ(100px) scale(1); }
        }

        /* 添加組合提示框樣式 */
        .recipe-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 200px;
            max-width: 300px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 14px;
            text-align: left;
        }

        .recipe-tooltip-title {
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }

        .recipe-tooltip-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .recipe-tooltip-symbol {
            font-size: 18px;
            margin-right: 8px;
        }

        .recipe-tooltip-method {
            margin-top: 8px;
            font-style: italic;
            color: #f39c12;
        }

        .recipe-path-arrow {
            margin: 0 5px;
            color: #3498db;
        }
    </style>
</head>
<body style="--bs-body-bg: var(--background-color); --bs-body-color: var(--text-color);">

    <div class="main-content" style="width: 100vw;">
        <main class="page-content">
            <div class="container-fluid">
                <!-- 1. 將結果區域移到最上方 -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div id="simulationResults" class="p-2 border rounded text-center" style="height: 40px; line-height: 24px; background-color: #f8f9fa; overflow: hidden;">
                            <p class="text-muted m-0">請完成訂單...</p>
                        </div>
                    </div>
                </div>

                <!-- 烹飪模擬器區 -->
                <div id="simulatorSection">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <!-- 1. 結果區與T2區域整合在一起 -->
                                    <div class="row mb-2">
                                        <div class="col-md-12">
                                            <!-- T2 最終料理區 -->
                                            <div id="t2ItemsContainer" class="d-flex flex-wrap gap-1 p-2 border rounded" style="min-height: 112px; background-color: #d4edda;">
                                            </div>
                                        </div>
                                        <!-- 移除舊的結果區域 -->
                                    </div>

                                    <!-- 新增: 隨機T2料理展示區 -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="d-flex justify-content-center align-items-center p-3 border rounded" style="background-color: transparent; min-height: 150px;">
                                                <div id="randomT2Display" class="text-center">
                                                     <div id="randomT2Item" class="mx-auto position-relative" style="width: 100px; height: 100px;"></div>
                                                     <div id="recipeTooltip" class="recipe-tooltip"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. T1區域 -->
                                    <div class="mb-2">
                                        <div id="t1ItemsContainer" class="d-flex flex-wrap gap-1 p-2 border rounded" style="min-height: 75px; background-color: #fff3cd;">
                                        </div>
                                    </div>

                                    <!-- 3. 工作組合區 -->
                                    <div class="row mb-2 align-items-center">
                                        <div class="col-md-12 mb-3">
                                            <!-- 現代化工具欄 -->
                                            <div class="modern-toolbar">
                                                <button class="toolbar-btn toolbar-btn-grill cooking-method-btn" data-method="grill">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <!-- 烤架 -->
                                                        <line x1="3" y1="6" x2="21" y2="6"></line>
                                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                                        <line x1="3" y1="14" x2="21" y2="14"></line>
                                                        <!-- 火焰 -->
                                                        <path d="M7,20c0-2,1-3,1-4c0-1-0.5-1.5-0.5-2c0,0,1,0,1.5,2c0.5-1,0.5-2,0.5-2s0.5,0,0.5,1c0,2-1,3-1,4c0,0.5,0.5,1,1.5,1c-0.5,0.5-1.5,0.5-2,0C7.5,20,7,19.5,7,20z"></path>
                                                        <path d="M13,20c0-2,1-3,1-4c0-1-0.5-1.5-0.5-2c0,0,1,0,1.5,2c0.5-1,0.5-2,0.5-2s0.5,0,0.5,1c0,2-1,3-1,4c0,0.5,0.5,1,1.5,1c-0.5,0.5-1.5,0.5-2,0C13.5,20,13,19.5,13,20z"></path>
                                                    </svg>
                                                </button>
                                                <button class="toolbar-btn toolbar-btn-fry cooking-method-btn" data-method="pan_fry">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <!-- 平底鍋 -->
                                                        <path d="M3,12c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2v-2H3V12z"></path>
                                                        <path d="M19,10V8c0-1.1-0.9-2-2-2H7C5.9,6,5,6.9,5,8v2"></path>
                                                        <!-- 鍋柄 -->
                                                        <path d="M19,11h3"></path>
                                                        <!-- 食物和蒸汽 -->
                                                        <circle cx="9" cy="10" r="1"></circle>
                                                        <circle cx="13" cy="10" r="1"></circle>
                                                        <circle cx="17" cy="10" r="1"></circle>
                                                        <path d="M8,7c0,0,0.5-1,1.5-1"></path>
                                                        <path d="M12,7c0,0,0.5-1,1.5-1"></path>
                                                        <path d="M16,7c0,0,0.5-1,1.5-1"></path>
                                                    </svg>
                                                </button>
                                                <button class="toolbar-btn toolbar-btn-deep-fry cooking-method-btn" data-method="deep_fry">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <!-- 油炸鍋 -->
                                                        <path d="M4,8v8c0,2.2,3.6,4,8,4s8-1.8,8-4V8"></path>
                                                        <ellipse cx="12" cy="8" rx="8" ry="4"></ellipse>
                                                        <!-- 油 -->
                                                        <path d="M6,12c3,1,9,1,12,0" stroke-dasharray="1,1"></path>
                                                        <!-- 氣泡 -->
                                                        <circle cx="8" cy="10" r="0.5"></circle>
                                                        <circle cx="10" cy="11" r="0.5"></circle>
                                                        <circle cx="14" cy="10" r="0.5"></circle>
                                                        <circle cx="16" cy="11" r="0.5"></circle>
                                                        <!-- 食物 -->
                                                        <rect x="10" y="9" width="4" height="2" rx="1"></rect>
                                                    </svg>
                                                </button>
                                                <button class="toolbar-btn toolbar-btn-boil cooking-method-btn" data-method="boil">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <!-- 鍋 -->
                                                        <path d="M5,9v7c0,2,3.1,4,7,4s7-2,7-4V9"></path>
                                                        <path d="M5,9c0,2,3.1,4,7,4s7-2,7-4"></path>
                                                        <!-- 鍋蓋 -->
                                                        <path d="M19,9c0-1-3.1-2-7-2s-7,1-7,2"></path>
                                                        <line x1="12" y1="7" x2="12" y2="5"></line>
                                                        <circle cx="12" cy="4" r="1"></circle>
                                                        <!-- 水和蒸汽 -->
                                                        <path d="M7,12c3,1,7,1,10,0" stroke-dasharray="1,1"></path>
                                                        <path d="M8,6c0,0,0.5-1,1-1"></path>
                                                        <path d="M16,6c0,0-0.5-1-1-1"></path>
                                                        <path d="M12,3c0,0,0-1,1-1"></path>
                                                    </svg>
                                                </button>
                                                <button class="toolbar-btn toolbar-btn-assembly cooking-method-btn" data-method="assembly">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <!-- 盤子 -->
                                                        <ellipse cx="12" cy="14" rx="8" ry="3"></ellipse>
                                                        <path d="M12,14c-4.4,0-8-1.3-8-3s3.6-3,8-3s8,1.3,8,3"></path>
                                                        <!-- 食材組合 -->
                                                        <circle cx="9" cy="10" r="2"></circle>
                                                        <rect x="12" y="8" width="4" height="4" rx="1"></rect>
                                                        <path d="M16,6l2,2l-2,2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div id="craftingArea" class="d-flex flex-wrap gap-1 p-2 border rounded justify-content-center" style="background-color: #f8f9fa;">
                                                <div class="crafting-slot border rounded d-flex justify-content-center align-items-center" style="width: 56px; height: 56px; background-color: white;"></div>
                                                <div class="crafting-slot border rounded d-flex justify-content-center align-items-center" style="width: 56px; height: 56px; background-color: white;"></div>
                                                <div class="crafting-slot border rounded d-flex justify-content-center align-items-center" style="width: 56px; height: 56px; background-color: white;"></div>
                                                <div class="crafting-slot border rounded d-flex justify-content-center align-items-center" style="width: 56px; height: 56px; background-color: white;"></div>
                                                <div class="crafting-slot border rounded d-flex justify-content-center align-items-center" style="width: 56px; height: 56px; background-color: white;"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                             <!-- 烹飪方法選擇 - 隱藏原來的按鈕 -->
                                            <div class="btn-group-vertical w-100" style="display: none;">
                                                <button class="btn btn-cooking cooking-method-btn mb-1" data-method="grill">烤製</button>
                                                <button class="btn btn-cooking cooking-method-btn mb-1" data-method="pan_fry">煎炒</button>
                                                <button class="btn btn-cooking cooking-method-btn mb-1" data-method="deep_fry">油炸</button>
                                                <button class="btn btn-cooking cooking-method-btn mb-1" data-method="boil">水煮</button>
                                                <button class="btn btn-outline-secondary cooking-method-btn" data-method="assembly">組合</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 4. 分類按鈕 (T0 items) -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-center mb-1">
                                            <div id="t0CategoryFilters" class="btn-group btn-group-sm" role="group">
                                                <!-- 分類按鈕將由JavaScript動態填充 -->
                                            </div>
                                        </div>
                                        <div id="t0ItemsContainer" class="d-flex flex-wrap gap-1 p-2 border rounded" style="min-height: 75px; background-color: #f8f9fa;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Synthesis Path Modal -->
            <div class="modal fade" id="synthesisPathModal" tabindex="-1" aria-labelledby="synthesisPathModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="synthesisPathModalLabel">合成路徑</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="synthesisPathContent">
                            <!-- Path tree will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局變數
        let currentItems = [];
        
        // 獲取用戶令牌
        function getUserToken() {
            const userId = localStorage.getItem('boxCurrentUserId');
            if (!userId) return null;
            const tokenKey = `boxUserToken_${userId}`;
            return localStorage.getItem(tokenKey);
        }

        // API 請求工具函數
        async function apiFetch(endpoint, options = {}) {
            const token = getUserToken();
            if (!token) {
                alert('權限不足或登入已超時，請重新登入。');
                window.location.href = '/cook-login.html?redirect=/cook-game.html';
                throw new Error('令牌未找到，無法發送請求');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            const mergedOptions = { ...defaultOptions, ...options };
            if (mergedOptions.body) {
                mergedOptions.body = JSON.stringify(mergedOptions.body);
            }

            try {
                const response = await fetch(`/cook-api${endpoint}`, mergedOptions);
                if (!response.ok) {
                    if(response.status === 401 || response.status === 403) {
                        alert('權限不足或登入已超時，請重新登入。');
                        window.location.href = '/cook-login.html?redirect=/cook-game.html';
                        throw new Error('認證失敗');
                    }
                    const errorData = await response.json().catch(() => ({ message: '無法解析來自伺服器的錯誤訊息' }));
                    throw new Error(errorData.error || errorData.message || `HTTP 錯誤! 狀態碼: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Fetch Error:', error);
                throw error;
            }
        }

        // 載入物品列表
        async function loadItems() {
            try {
                const items = await apiFetch('/v3/items');
                currentItems = items;
            } catch (error) {
                console.error('載入物品失敗:', error);
                alert(`載入物品失敗: ${error.message}`);
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await loadItems();
            initializeSimulator();
        });

        // 模擬器全局變數
        let simulatorItems = {
            t0: [], // 基礎食材
            t1: [], // 半成品
            t2: []  // 最終料理
        };
        let selectedCookingMethod = '';
        let simulationHistory = [];
        let selectedT0Category = '肉類'; // 預設顯示肉類

        // 初始化模擬器
        function initializeSimulator() {
            // 載入 T0 物品到模擬器
            simulatorItems.t0 = currentItems.filter(item => item.item_tier === 0);
            
            setupT0CategoryFilters();

            renderSimulatorItems();
            
            // 清空 T1 和 T2 區域
            simulatorItems.t1 = [];
            simulatorItems.t2 = [];
            
            // 清空組合區
            document.querySelectorAll('.crafting-slot').forEach(slot => {
                while (slot.firstChild) {
                    slot.removeChild(slot.firstChild);
                }
            });
            
            // 重置烹飪方法選擇
            document.querySelectorAll('.cooking-method-btn').forEach(btn => {
                btn.classList.remove('active', 'recommended');
            });
            selectedCookingMethod = '';
            
            // 清空模擬結果
            document.getElementById('simulationResults').innerHTML = '<p class="text-muted m-0">請完成訂單...</p>';
            
            // 設置拖放事件
            setupCraftingSlotListeners();
            setupDraggableItemListeners();
            
            // 設置烹飪方法選擇
            setupCookingMethodSelection();
            
            // 新增: 顯示隨機T2料理
            displayRandomT2Item();
        }

        function setupT0CategoryFilters() {
            const filterContainer = document.getElementById('t0CategoryFilters');
            if (!filterContainer) return;
            filterContainer.innerHTML = '';

            const categories = ['肉類', '蔬菜', '加工品', '調味醬料'];

            categories.forEach(category => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-secondary mx-1';
                button.textContent = category;
                button.dataset.category = category;

                if (category === selectedT0Category) {
                    button.classList.add('active');
                }

                button.addEventListener('click', function() {
                    selectedT0Category = this.dataset.category;
                    // Update active state
                    filterContainer.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render T0 items and re-attach listeners
                    renderSimulatorItems();
                    setupDraggableItemListeners();
                });
                filterContainer.appendChild(button);
            });
        }

        // 渲染模擬器物品
        function renderSimulatorItems() {
            // 渲染 T0 物品
            const t0Container = document.getElementById('t0ItemsContainer');
            t0Container.innerHTML = '';
            
            const filteredT0Items = selectedT0Category === '全部'
                ? simulatorItems.t0
                : simulatorItems.t0.filter(item => item.category === selectedT0Category);

            filteredT0Items.forEach(item => {
                const itemElement = createSimItemElement(item, 0);
                t0Container.appendChild(itemElement);
            });
            
            // 渲染 T1 物品
            const t1Container = document.getElementById('t1ItemsContainer');
            t1Container.innerHTML = '';
            simulatorItems.t1.forEach(item => {
                const itemElement = createSimItemElement(item, 1);
                t1Container.appendChild(itemElement);
            });
            
            // 渲染 T2 物品
            const t2Container = document.getElementById('t2ItemsContainer');
            t2Container.innerHTML = '';
            simulatorItems.t2.forEach(item => {
                const itemElement = createSimItemElement(item, 2);
                t2Container.appendChild(itemElement);
            });
            // 為新生成的 T2 物品按鈕綁定事件
            setupPathButtonListeners();
        }

        // 創建模擬物品元素
        function createSimItemElement(item, tier) {
            const itemElement = document.createElement('div');
            itemElement.className = 'sim-item';
            itemElement.draggable = true;
            itemElement.dataset.itemId = item.item_id;
            itemElement.dataset.tier = tier;
            
            // 添加 ASCII 符號
            const symbolElement = document.createElement('div');
            symbolElement.className = 'ascii-symbol';
            symbolElement.textContent = item.ascii_symbol || '?';
            itemElement.appendChild(symbolElement);
            
            // 添加物品名稱
            const nameElement = document.createElement('div');
            nameElement.className = 'item-name';
            nameElement.title = item.item_name;
            nameElement.textContent = item.item_name;
            itemElement.appendChild(nameElement);
            
            if (tier === 2) {
                const pathButton = document.createElement('button');
                pathButton.className = 'btn btn-sm btn-outline-info view-path-btn';
                pathButton.innerHTML = '🌳';
                pathButton.title = '檢視合成路徑';
                pathButton.dataset.itemId = item.item_id;
                itemElement.appendChild(pathButton);
            }

            return itemElement;
        }

        // 設置可拖曳物品的事件
        function setupDraggableItemListeners() {
            const draggableItems = document.querySelectorAll('#t0ItemsContainer .sim-item, #t1ItemsContainer .sim-item');
            draggableItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });
        }

        // 設置組合區的拖放目標事件 (此函數只應被呼叫一次)
        function setupCraftingSlotListeners() {
            const craftingSlots = document.querySelectorAll('.crafting-slot');
            craftingSlots.forEach(slot => {
                // 防止重複綁定監聽器
                if (slot.dataset.listenersAttached) return;

                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                
                // 點擊移除物品
                slot.addEventListener('click', function(e) {
                    if (e.target.closest('.sim-item')) {
                        e.target.closest('.sim-item').remove();
                        updateRecommendedCookingMethod();
                    }
                });
                slot.dataset.listenersAttached = 'true';
            });
        }

        // 拖放事件處理函數
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                itemId: this.dataset.itemId,
                tier: this.dataset.tier
            }));
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            // 檢查槽位是否已有物品
            if (this.querySelector('.sim-item')) {
                return; // 槽位已被佔用
            }
            
            // 獲取拖放的物品數據
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const itemId = data.itemId;
            const tier = parseInt(data.tier);
            
            // 找到對應的物品
            let item;
            if (tier === 0) {
                item = simulatorItems.t0.find(i => i.item_id === itemId);
            } else if (tier === 1) {
                item = simulatorItems.t1.find(i => i.item_id === itemId);
            } else {
                return; // T2 物品不能被拖放到組合區
            }
            
            if (!item) return;
            
            // 創建物品元素並添加到槽位
            const itemElement = createSimItemElement(item, tier);
            itemElement.draggable = false; // 組合區內的物品不能再拖動
            this.appendChild(itemElement);
            
            // 更新推薦的烹飪方法
            updateRecommendedCookingMethod();
        }

        // 設置烹飪方法選擇
        function setupCookingMethodSelection() {
            const cookingMethodBtns = document.querySelectorAll('.cooking-method-btn');
            cookingMethodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除其他按鈕的活動狀態
                    cookingMethodBtns.forEach(b => b.classList.remove('active'));
                    // 設置當前按鈕為活動狀態
                    this.classList.add('active');
                    // 更新選中的烹飪方法
                    selectedCookingMethod = this.dataset.method;
                    // 直接執行模擬
                    executeSimulation();
                });
            });
        }

        // 更新推薦的烹飪方法
        function updateRecommendedCookingMethod() {
            // 獲取組合區中的所有物品
            const craftingItems = Array.from(document.querySelectorAll('.crafting-slot .sim-item'));
            
            // 檢查是否有 T1 物品
            const hasT1Items = craftingItems.some(item => parseInt(item.dataset.tier) === 1);
            
            // 移除所有推薦標記
            document.querySelectorAll('.cooking-method-btn').forEach(btn => {
                btn.classList.remove('recommended');
            });
            
            // 如果有 T1 物品，推薦「組合」方法
            if (hasT1Items) {
                const assemblyBtn = document.querySelector('.cooking-method-btn[data-method="assembly"]');
                if (assemblyBtn) {
                    assemblyBtn.classList.add('recommended');
                }
            }
        }

        // 執行模擬
        async function executeSimulation() {
            // 獲取組合區中的物品
            const craftingItems = Array.from(document.querySelectorAll('.crafting-slot .sim-item')).map(item => ({
                itemId: item.dataset.itemId,
                tier: parseInt(item.dataset.tier)
            }));
            
            // 檢查是否有物品
            if (craftingItems.length === 0) {
                updateSimulationResults('請先將物品拖曳到組合區。', 'error');
                return;
            }
            
            // 檢查是否選擇了烹飪方法
            if (!selectedCookingMethod) {
                updateSimulationResults('請選擇一種烹飪方法。', 'error');
                return;
            }
            
            // 準備模擬數據
            const simulationData = {
                items: craftingItems.map(item => item.itemId),
                cookingMethod: selectedCookingMethod
            };
            
            // 根據烹飪方法顯示不同的模擬訊息
            const cookingMethodMap = {
                'grill': '烤製',
                'pan_fry': '煎炒',
                'deep_fry': '油炸',
                'boil': '水煮',
                'assembly': '組合'
            };
            
            const methodText = cookingMethodMap[selectedCookingMethod] || selectedCookingMethod;
            
            try {
                // 呼叫模擬 API
                const result = await apiFetch('/v3/simulate', {
                    method: 'POST',
                    body: simulationData
                });
                
                // 獲取食譜的烹飪時間（如果成功）
                let cookTime = 3; // 默認3秒
                if (result.success && result.recipe && result.recipe.cook_time_sec) {
                    cookTime = result.recipe.cook_time_sec;
                }
                
                // 顯示帶有倒數計時的模擬訊息
                updateSimulationResults(`${methodText}中...`, 'info', cookTime);
                
                // 延遲處理結果，模擬烹飪時間
                setTimeout(() => {
                    handleSimulationResult(result, craftingItems);
                }, cookTime * 1000);
                
            } catch (error) {
                updateSimulationResults(`模擬失敗: ${error.message}`, 'error');
            }
        }

        // 處理模擬結果
        function handleSimulationResult(result, inputItems) {
            // 移除任何可能存在的覆蓋層
            const existingBoilOverlay = document.getElementById('boilOverlay');
            if (existingBoilOverlay) {
                existingBoilOverlay.remove();
            }
            const existingFryOverlay = document.getElementById('fryOverlay');
            if (existingFryOverlay) {
                existingFryOverlay.remove();
            }
            const existingGrillOverlay = document.getElementById('grillOverlay');
            if (existingGrillOverlay) {
                existingGrillOverlay.remove();
            }
            const existingPanFryOverlay = document.getElementById('panFryOverlay');
            if (existingPanFryOverlay) {
                existingPanFryOverlay.remove();
            }
            const existingAssemblyOverlay = document.getElementById('assemblyOverlay');
            if (existingAssemblyOverlay) {
                existingAssemblyOverlay.remove();
            }
            
            // 清除倒數計時器
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                window.countdownInterval = null;
            }
            
            if (result.success) {
                // 顯示成功訊息
                const outputItem = result.outputItem;
                const outputTier = outputItem.item_tier;
                
                // 添加到對應的物品列表
                if (outputTier === 1) {
                    // 檢查是否已存在
                    if (!simulatorItems.t1.some(item => item.item_id === outputItem.item_id)) {
                        simulatorItems.t1.push(outputItem);
                    }
                } else if (outputTier === 2) {
                    // 檢查是否已存在
                    if (!simulatorItems.t2.some(item => item.item_id === outputItem.item_id)) {
                        simulatorItems.t2.push(outputItem);
                    }
                }
                
                // 重新渲染物品列表
                renderSimulatorItems();
                // 重新為新生成的物品設置拖曳事件
                setupDraggableItemListeners();
                
                // 清空組合區
                document.querySelectorAll('.crafting-slot .sim-item').forEach(item => item.remove());
                
                // 添加到模擬歷史
                simulationHistory.push({
                    inputItems: inputItems,
                    cookingMethod: selectedCookingMethod,
                    outputItem: outputItem
                });
                
                // 顯示成功訊息
                const inputItemsText = inputItems.map(item => {
                    const itemObj = item.tier === 0 ? 
                        simulatorItems.t0.find(i => i.item_id === item.itemId) : 
                        simulatorItems.t1.find(i => i.item_id === item.itemId);
                    return itemObj ? `${itemObj.item_name}(T${item.tier})` : `未知物品(T${item.tier})`;
                }).join(', ');
                
                const cookingMethodMap = {
                    'grill': '烤製',
                    'pan_fry': '煎炒',
                    'deep_fry': '油炸',
                    'boil': '水煮',
                    'assembly': '組合'
                };
                
                const methodText = cookingMethodMap[selectedCookingMethod] || selectedCookingMethod;
                
                // 在結果區域顯示簡單成功訊息
                let resultHtml = `
                    
                    <div class="simulation-success">
                        ✅ 成功! 獲得: [${outputItem.item_name}]  
                    </div>
                `;
                
                // 如果是 T1 物品，提示可以繼續使用
                if (outputTier === 1) {
                    resultHtml += `
                         
                    `;
                }
                
                // 更新結果區域
                document.getElementById('simulationResults').innerHTML = resultHtml;
                
                // 如果是水煮或油炸或烤製方法，顯示大型成功訊息覆蓋層
                if (selectedCookingMethod === 'boil' || selectedCookingMethod === 'deep_fry' || 
                    selectedCookingMethod === 'grill' || selectedCookingMethod === 'pan_fry') {
                    // 創建成功訊息覆蓋層
                    const successOverlay = document.createElement('div');
                    successOverlay.className = 'success-message-overlay';
                    successOverlay.id = 'successOverlay';
                    successOverlay.innerHTML = `
                        <div class="success-message-content">
                            <div class="item-ascii">${outputItem.ascii_symbol || '?'}</div>
                            <div class="item-name-text">${outputItem.item_name}</div>
                            <div class="success-text">獲得！</div>
                        </div>
                    `;
                    document.body.appendChild(successOverlay);
                    
                    // 3秒後自動移除成功訊息
                    setTimeout(() => {
                        const existingSuccessOverlay = document.getElementById('successOverlay');
                        if (existingSuccessOverlay) {
                            existingSuccessOverlay.remove();
                        }
                    }, 3000);
                }
            } else {
                // 顯示錯誤訊息
                let errorMessage = result.error || '模擬失敗，未知錯誤。';
                
                // 檢查是否是 V3 規則錯誤
                if (result.ruleViolation) {
                    errorMessage = `${result.ruleViolation}`;
                }
                
                updateSimulationResults(errorMessage, 'error');
            }
        }

        // 更新模擬結果
        function updateSimulationResults(message, type = 'info', cookTime = 3) {
            const resultsElement = document.getElementById('simulationResults');
            
            // 移除任何可能存在的覆蓋層和計時器
            const existingOverlays = document.querySelectorAll('.fullscreen-boil-overlay, .fullscreen-fry-overlay, .fullscreen-grill-overlay, .fullscreen-pan-fry-overlay, .fullscreen-assembly-overlay');
            existingOverlays.forEach(overlay => overlay.remove());
            
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                window.countdownInterval = null;
            }
            
            // 檢查是否是水煮模擬
            if (message === '水煮中...') {
                // 在結果區域顯示簡單提示
                resultsElement.innerHTML = `<div class="simulation-${type}">${message}</div>`;
                
                // 創建全螢幕覆蓋層
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-boil-overlay';
                overlay.id = 'boilOverlay';
                overlay.innerHTML = `
                    <div class="fullscreen-boil-spinner">
                        <svg viewBox="0 0 24 24" fill="currentColor" class="fullscreen-boil-wave">
                            <path d="M12.001 4.8c-3.2 0-5.2 1.6-6 4.8 1.2-1.6 2.6-2.2 4.2-1.8.913.228 1.565.89 2.288 1.624C13.666 10.618 15.027 12 18.001 12c3.2 0 5.2-1.6 6-4.8-1.2 1.6-2.6 2.2-4.2 1.8-.913-.228-1.565-.89-2.288-1.624C16.337 6.182 14.976 4.8 12.001 4.8zm-6 7.2c-3.2 0-5.2 1.6-6 4.8 1.2-1.6 2.6-2.2 4.2-1.8.913.228 1.565.89 2.288 1.624 1.177 1.194 2.538 2.576 5.512 2.576 3.2 0 5.2-1.6 6-4.8-1.2 1.6-2.6 2.2-4.2 1.8-.913-.228-1.565-.89-2.288-1.624C10.337 13.382 8.976 12 6.001 12z"></path>
                        </svg>
                    </div>
                    <div class="fullscreen-boil-text">水煮中... <span id="countdownTimer">${cookTime}</span>秒</div>
                `;
                document.body.appendChild(overlay);
                
                // 設置倒數計時
                let timeLeft = cookTime;
                const countdownElement = document.getElementById('countdownTimer');
                window.countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    if (timeLeft <= 0) {
                        clearInterval(window.countdownInterval);
                    }
                }, 1000);
            } 
            // 檢查是否是油炸模擬
            else if (message === '油炸中...') {
                // 在結果區域顯示簡單提示
                resultsElement.innerHTML = `<div class="simulation-${type}">${message}</div>`;
                
                // 創建全螢幕覆蓋層
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-fry-overlay';
                overlay.id = 'fryOverlay';
                overlay.innerHTML = `
                    <div class="fullscreen-fry-spinner">
                        <div class="fullscreen-fry-bubbles">
                            <div class="fry-bubble"></div>
                            <div class="fry-bubble"></div>
                            <div class="fry-bubble"></div>
                            <div class="fry-bubble"></div>
                            <div class="fry-bubble"></div>
                        </div>
                    </div>
                    <div class="fullscreen-fry-text">油炸中... <span id="countdownTimer">${cookTime}</span>秒</div>
                `;
                document.body.appendChild(overlay);
                
                // 設置倒數計時
                let timeLeft = cookTime;
                const countdownElement = document.getElementById('countdownTimer');
                window.countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    if (timeLeft <= 0) {
                        clearInterval(window.countdownInterval);
                    }
                }, 1000);
            }
            // 檢查是否是烤製模擬
            else if (message === '烤製中...') {
                // 在結果區域顯示簡單提示
                resultsElement.innerHTML = `<div class="simulation-${type}">${message}</div>`;
                
                // 創建全螢幕覆蓋層
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-grill-overlay';
                overlay.id = 'grillOverlay';
                overlay.innerHTML = `
                    <div class="fire">
                        <div class="fire-center">
                            <div class="main-fire"></div>
                            <div class="particle-fire"></div>
                        </div>
                        <div class="fire-right">
                            <div class="main-fire"></div>
                            <div class="particle-fire"></div>
                        </div>
                        <div class="fire-left">
                            <div class="main-fire"></div>
                            <div class="particle-fire"></div>
                        </div>
                        <div class="fire-bottom">
                            <div class="main-fire"></div>
                        </div>
                    </div>
                    <div class="fullscreen-grill-text">烤製中... <span id="countdownTimer">${cookTime}</span>秒</div>
                `;
                document.body.appendChild(overlay);
                
                // 設置倒數計時
                let timeLeft = cookTime;
                const countdownElement = document.getElementById('countdownTimer');
                window.countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    if (timeLeft <= 0) {
                        clearInterval(window.countdownInterval);
                    }
                }, 1000);
            }
            // 檢查是否是煎炒模擬
            else if (message === '煎炒中...') {
                // 在結果區域顯示簡單提示
                resultsElement.innerHTML = `<div class="simulation-${type}">${message}</div>`;
                
                // 創建全螢幕覆蓋層
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-pan-fry-overlay';
                overlay.id = 'panFryOverlay';
                overlay.innerHTML = `
                    <div class="loader">
                        <div class="panWrapper">
                            <div class="pan">
                                <div class="food"></div>
                                <div class="panBase"></div>
                                <div class="panHandle"></div>
                                <div class="pan-flames">
                                    <div class="flame"></div>
                                    <div class="flame"></div>
                                    <div class="flame"></div>
                                    <div class="flame"></div>
                                    <div class="flame"></div>
                                </div>
                            </div>
                            <div class="panShadow"></div>
                        </div>
                    </div>
                    <div class="fullscreen-pan-fry-text">煎炒中... <span id="countdownTimer">${cookTime}</span>秒</div>
                `;
                document.body.appendChild(overlay);
                
                // 設置倒數計時
                let timeLeft = cookTime;
                const countdownElement = document.getElementById('countdownTimer');
                window.countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    if (timeLeft <= 0) {
                        clearInterval(window.countdownInterval);
                    }
                }, 1000);
            }
            // 檢查是否是組合模擬
            else if (message === '組合中...') {
                // 在結果區域顯示簡單提示
                resultsElement.innerHTML = `<div class="simulation-${type}">${message}</div>`;
                
                // 創建全螢幕覆蓋層
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-assembly-overlay';
                overlay.id = 'assemblyOverlay';
                overlay.innerHTML = `
                    <div class="assembly-loader">
                        <div class="ground"><div></div></div>
                        <div class="box box0"><div></div></div>
                        <div class="box box1"><div></div></div>
                        <div class="box box2"><div></div></div>
                        <div class="box box3"><div></div></div>
                        <div class="box box4"><div></div></div>
                        <div class="box box5"><div></div></div>
                        <div class="box box6"><div></div></div>
                        <div class="box box7"><div></div></div>
                    </div>
                    <div class="fullscreen-assembly-text">組合中... <span id="countdownTimer">${cookTime}</span>秒</div>
                `;
                document.body.appendChild(overlay);
                
                // 設置倒數計時
                let timeLeft = cookTime;
                const countdownElement = document.getElementById('countdownTimer');
                window.countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    if (timeLeft <= 0) {
                        clearInterval(window.countdownInterval);
                    }
                }, 1000);
            }
            else {
                // 確保移除任何可能存在的覆蓋層
                const existingBoilOverlay = document.getElementById('boilOverlay');
                if (existingBoilOverlay) {
                    existingBoilOverlay.remove();
                }
                const existingFryOverlay = document.getElementById('fryOverlay');
                if (existingFryOverlay) {
                    existingFryOverlay.remove();
                }
                const existingGrillOverlay = document.getElementById('grillOverlay');
                if (existingGrillOverlay) {
                    existingGrillOverlay.remove();
                }
                const existingPanFryOverlay = document.getElementById('panFryOverlay');
                if (existingPanFryOverlay) {
                    existingPanFryOverlay.remove();
                }
                const existingAssemblyOverlay = document.getElementById('assemblyOverlay');
                if (existingAssemblyOverlay) {
                    existingAssemblyOverlay.remove();
                }
                resultsElement.innerHTML = `<div class="simulation-${type}">${message}</div>`;
            }
        }

        // 新增：為路徑檢視按鈕綁定事件
        function setupPathButtonListeners() {
            document.querySelectorAll('.view-path-btn').forEach(btn => {
                // 為防止重複綁定，先移除舊的監聽器
                btn.replaceWith(btn.cloneNode(true));
            });
            // 重新為複製的節點綁定事件
            document.querySelectorAll('.view-path-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showSynthesisPath(this.dataset.itemId);
                });
            });
        }

        // 新增：顯示合成路徑
        function showSynthesisPath(t2ItemId) {
            const pathModal = new bootstrap.Modal(document.getElementById('synthesisPathModal'));
            const t2Item = currentItems.find(item => item.item_id === t2ItemId);
            
            if (!t2Item) return;

            document.getElementById('synthesisPathModalLabel').textContent = `🍔 ${t2Item.item_name} (T2) - 合成路徑`;
            
            const pathHtml = `<ul>${buildPathTree(t2ItemId)}</ul>`;
            document.getElementById('synthesisPathContent').innerHTML = pathHtml;
            
            pathModal.show();
        }

        function buildPathTree(itemId) {
            const item = currentItems.find(i => i.item_id === itemId);
            if (!item) return `<li>未知物品: ${itemId}</li>`;

            const recipe = simulationHistory.find(h => h.outputItem.item_id === itemId);

            // T0 Item (base case)
            if (!recipe) {
                return `<li><span class="badge bg-secondary">T0</span> ${item.ascii_symbol} ${item.item_name}</li>`;
            }

            // T1 or T2 item (recursive step)
            const cookingMethodMap = {
                'grill': '烤製', 'pan_fry': '煎炒', 'deep_fry': '油炸',
                'boil': '水煮', 'assembly': '組合'
            };
            const methodText = cookingMethodMap[recipe.cookingMethod] || recipe.cookingMethod;
            const tierBadge = item.item_tier === 1 ? 'bg-warning text-dark' : 'bg-success';
            
            let childrenHtml = '<ul>';
            recipe.inputItems.forEach(input => {
                childrenHtml += buildPathTree(input.itemId);
            });
            childrenHtml += '</ul>';

            return `
                <li>
                    <span class="badge ${tierBadge}">T${item.item_tier}</span>
                    ${item.ascii_symbol} ${item.item_name}
                    <small class="text-muted">(來自: ${methodText})</small>
                    ${childrenHtml}
                </li>
            `;
        }

        // 新增: 顯示隨機T2料理的函數
        async function displayRandomT2Item() {
            try {
                // 獲取所有T2等級的料理
                const t2Items = currentItems.filter(item => item.item_tier === 2);
                
                // 如果沒有T2料理，顯示提示訊息
                if (t2Items.length === 0) {
                    document.getElementById('randomT2Item').innerHTML = '<p class="text-muted">尚未發現最終料理</p>';
                    return;
                }
                
                // 隨機選擇一個T2料理
                const randomItem = t2Items[Math.floor(Math.random() * t2Items.length)];
                
                // 創建物品元素
                const itemElement = createSimItemElement(randomItem, 2);
                itemElement.style.width = '100px';
                itemElement.style.height = '100px';
                itemElement.style.margin = '0 auto';
                
                // 清空並添加到隨機T2展示區
                const container = document.getElementById('randomT2Item');
                container.innerHTML = '';
                container.appendChild(itemElement);
                
                // 移除料理名稱顯示
                
                // 添加按住顯示組合提示的功能
                setupRecipeTooltip(itemElement, randomItem);
                
            } catch (error) {
                console.error('顯示隨機T2料理失敗:', error);
                document.getElementById('randomT2Item').innerHTML = '<p class="text-danger">載入料理失敗</p>';
            }
        }
        
        // 新增: 設置組合提示功能
        function setupRecipeTooltip(element, item) {
            const tooltip = document.getElementById('recipeTooltip');
            
            // 按住顯示提示
            let pressTimer;
            
            element.addEventListener('mousedown', function(e) {
                pressTimer = setTimeout(function() {
                    showRecipeTooltip(item, tooltip, e);
                }, 300); // 300ms後顯示提示
            });
            
            element.addEventListener('touchstart', function(e) {
                pressTimer = setTimeout(function() {
                    const touch = e.touches[0];
                    showRecipeTooltip(item, tooltip, touch);
                }, 300); // 300ms後顯示提示
                e.preventDefault();
            });
            
            // 取消按住
            const cancelPress = function() {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                hideRecipeTooltip(tooltip);
            };
            
            element.addEventListener('mouseup', cancelPress);
            element.addEventListener('mouseleave', cancelPress);
            element.addEventListener('touchend', cancelPress);
            element.addEventListener('touchcancel', cancelPress);
        }
        
        // 新增: 顯示組合提示
        async function showRecipeTooltip(item, tooltip, event) {
            try {
                // 查找該物品的合成路徑
                const recipe = simulationHistory.find(h => h.outputItem.item_id === item.item_id);
                
                if (!recipe) {
                    // 如果沒有合成歷史，嘗試從API獲取配方信息
                    tooltip.innerHTML = `
                        <div>尚未獲得此料理的合成資訊</div>
                    `;
                } else {
                    // 從合成歷史中獲取原料信息
                    const inputItems = await Promise.all(recipe.inputItems.map(async input => {
                        const inputItem = currentItems.find(i => i.item_id === input.itemId);
                        return inputItem || { item_name: '未知物品', ascii_symbol: '?' };
                    }));
                    
                    // 烹飪方法映射
                    const cookingMethodMap = {
                        'grill': '烤製', 'pan_fry': '煎炒', 'deep_fry': '油炸',
                        'boil': '水煮', 'assembly': '組合'
                    };
                    const methodText = cookingMethodMap[recipe.cookingMethod] || recipe.cookingMethod;
                    
                    // 生成提示內容 - 移除料理名稱標題
                    let tooltipContent = '';
                    
                    // 如果是T2料理，顯示T1原料的合成路徑
                    if (item.item_tier === 2) {
                        // 查找T1原料的合成路徑
                        for (const inputItem of inputItems) {
                            if (inputItem.item_tier === 1) {
                                const t1Recipe = simulationHistory.find(h => h.outputItem.item_id === inputItem.item_id);
                                if (t1Recipe) {
                                    const t1Inputs = await Promise.all(t1Recipe.inputItems.map(async t1Input => {
                                        const t1InputItem = currentItems.find(i => i.item_id === t1Input.itemId);
                                        return t1InputItem || { item_name: '未知物品', ascii_symbol: '?' };
                                    }));
                                    
                                    tooltipContent += `
                                        <div class="recipe-tooltip-item">
                                            <span class="recipe-tooltip-symbol">${inputItem.ascii_symbol}</span>
                                            <span>T1 = </span>
                                            ${t1Inputs.map(i => `<span>${i.ascii_symbol}</span>`).join(' + ')}
                                        </div>
                                    `;
                                }
                            }
                        }
                    }
                    
                    // 顯示當前料理的合成方法 - 移除料理名稱
                    tooltipContent += `
                        <div class="recipe-tooltip-item">
                            <span class="recipe-tooltip-symbol">${item.ascii_symbol}</span>
                            <span>= </span>
                            ${inputItems.map(i => `<span>${i.ascii_symbol}</span>`).join(' + ')}
                        </div>
                        <div class="recipe-tooltip-method">烹飪方法: ${methodText}</div>
                    `;
                    
                    tooltip.innerHTML = tooltipContent;
                }
                
                // 定位提示框 - 修改為顯示在圖示旁邊
                const itemContainer = document.getElementById('randomT2Item');
                const containerRect = itemContainer.getBoundingClientRect();
                
                // 將提示框放在圖示的右側
                tooltip.style.position = 'fixed';
                tooltip.style.left = `${containerRect.right + 10}px`;
                tooltip.style.top = `${containerRect.top}px`;
                
                // 檢查是否超出視窗右側
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth) {
                    // 如果超出右側，則放在圖示的左側
                    tooltip.style.left = `${containerRect.left - tooltipRect.width - 10}px`;
                }
                
                // 顯示提示框
                tooltip.style.opacity = '1';
                
            } catch (error) {
                console.error('顯示組合提示失敗:', error);
                tooltip.innerHTML = '<div>載入失敗</div>';
                tooltip.style.opacity = '1';
            }
        }
        
        // 新增: 隱藏組合提示
        function hideRecipeTooltip(tooltip) {
            tooltip.style.opacity = '0';
        }
    </script>
</body>
</html> 