<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戲管理 - SunnyYummy</title>
    <link rel="stylesheet" href="style.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 管理頁面特定樣式 */
        body { background-color: #fff; color: #333; }
        .admin-container { max-width: 1100px; margin: 2rem auto; padding: 1.5rem; background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        #games-list-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; table-layout: fixed; }
        #games-list-table th, #games-list-table td { border: 1px solid #ddd; padding: 10px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #games-list-table th { background-color: #e9ecef; }
        
        #games-list-table th:nth-child(1), #games-list-table td:nth-child(1) { width: 8%; }  /* ID */
        #games-list-table th:nth-child(2), #games-list-table td:nth-child(2) { width: 18%; } /* 名稱 */
        #games-list-table th:nth-child(3), #games-list-table td:nth-child(3) { width: 30%; } /* 描述 */
        #games-list-table th:nth-child(4), #games-list-table td:nth-child(4) { width: 15%; text-align: center;} /* 遊玩次數 */
        #games-list-table th:nth-child(5), #games-list-table td:nth-child(5) { width: 15%; text-align: center;} /* 圖片 */
        #games-list-table th:nth-child(6), #games-list-table td:nth-child(6) { width: 14%; text-align: center;} /* 操作 */

        .action-btn { padding: 5px 8px; margin-right: 5px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; white-space: nowrap; }
        .edit-btn { background-color: #ffc107; border-color: #ffc107; color: #333; }
        .delete-btn { background-color: #dc3545; border-color: #dc3545; color: white; }
        .add-game-btn { display: inline-block; padding: 10px 15px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px; margin-bottom: 1.5rem; }

        /* 統計卡片 */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
            color: #ff6b6b;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* 表單樣式 */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="url"], .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        /* 標籤頁樣式 */
        .tabs-container {
            margin-bottom: 20px;
        }
        .tabs-nav {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            border-bottom: 1px solid #dee2e6;
        }
        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            position: relative;
            top: 1px;
        }
        .tab-item.active {
            border: 1px solid #dee2e6;
            border-bottom-color: #fff;
            background-color: #fff;
            font-weight: 600;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        
        /* 對對碰遊戲相關樣式 */
        .same-game-table {
            width: 100%;
            border-collapse: collapse;
        }
        .same-game-table th, .same-game-table td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        .same-game-table th {
            background-color: #e9ecef;
            text-align: left;
        }

        #addGameForm, #editGameForm, #templateDetailCard, #addTemplateForm, #editTemplateForm, #levelFormContainer {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        #image-preview, #edit-image-preview, #add-image-preview {
            max-width: 100px;
            max-height: 100px;
            display: none;
            margin-top: 5px;
            border: 1px solid #eee;
        }
        #image-preview[src], #edit-image-preview[src], #add-image-preview[src] {
            display: block;
        }
        
        .back-button { margin-bottom: 15px; }
        
        .form-error {
            color: red;
            margin-top: 10px;
            font-size: 0.9em;
            min-height: 1.2em;
        }

        /* Image list styling */
        .image-list { list-style: none; padding: 0; }
        .image-list-item { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; }
        .image-list-item img { width: 60px; height: 60px; object-fit: cover; margin-right: 10px; border-radius: 4px; }
        .image-preview-container { width: 60px; height: 60px; margin-right: 10px; display: none; } /* Initially hidden */
        .image-preview-container img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
   <nav class="admin-nav">
       <a href="/admin.html">商品管理</a>
       <a href="/music-admin.html">音樂管理</a>
       <a href="/news-admin.html">消息管理</a>
       <a href="/banner-admin.html">輪播圖管理</a>
       <a href="/figures-admin.html">庫存管理</a>
       <a href="/sales-report.html">銷售報告</a>
       <a href="/guestbook-admin.html">留言管理</a>
       <a href="/games-admin.html" class="active">遊戲管理</a>
 
       <a href="/file-admin.html">檔案管理</a>
       <a href="/store/report/report-admin.html">html報告管理</a>
   </nav>

   <div class="admin-container">
       <h1>遊戲管理</h1>
       <div class="mb-4">
           <a href="/games.html" class="btn btn-primary me-3">
               <i class="fas fa-gamepad me-2"></i>前往遊戲頁面
           </a>
           <a href="/rich/rich-admin.html" class="btn btn-success">
               <i class="fas fa-map me-2"></i>前往大富翁地圖管理
           </a>
       </div>
       
       <!-- 標籤頁導航 -->
       <div class="tabs-container">
           <ul class="tabs-nav">
               <li class="tab-item active" data-tab="general-games">一般遊戲管理</li>
               <li class="tab-item" data-tab="same-game">對對碰遊戲管理</li>
               <li class="tab-item" data-tab="diffrent-game">找出不同遊戲管理</li>
               <li class="tab-item" data-tab="add-game">新增一般遊戲</li>
           </ul>
       </div>
       
       <!-- 一般遊戲管理標籤頁 -->
       <div id="general-games" class="tab-content active">
           <!-- 遊戲數據統計卡片 -->
           <div class="stats-cards">
               <div class="stat-card">
                   <div class="stat-label">遊戲總數</div>
                   <div class="stat-value" id="total-games-count">-</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">總遊玩次數</div>
                   <div class="stat-value" id="total-plays-count">-</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">最受歡迎遊戲</div>
                   <div class="stat-value" id="most-popular-game">-</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">今日遊玩次數</div>
                   <div class="stat-value" id="today-plays-count">-</div>
               </div>
           </div>
           
           <h2>現有遊戲列表</h2>
           <div id="games-list-container">
               <table id="games-list-table">
                   <thead>
                       <tr>
                           <th>ID</th>
                           <th>名稱</th>
                           <th>描述</th>
                           <th>遊玩次數</th>
                           <th>縮圖</th>
                           <th>操作</th>
                       </tr>
                   </thead>
                   <tbody>
                       <!-- 遊戲列表將由 JavaScript 動態生成 -->
                   </tbody>
               </table>
           </div>
       </div>

       <!-- 對對碰遊戲管理標籤頁 -->
       <div id="same-game" class="tab-content">
           <div class="same-game-container">
               <!-- 對對碰標籤頁內的子標籤 -->
               <div class="tabs-container">
                   <ul class="tabs-nav same-game-tabs">
                       <li class="tab-item active" data-tab="templates-list">模板列表</li>
                       <li class="tab-item" data-tab="leaderboard">排行榜</li>
                       <li class="tab-item" data-tab="add-template">新增/編輯模板</li>
                   </ul>
               </div>
               
               <!-- 模板列表內容 -->
               <div id="templates-list" class="tab-content active">
                   <h2>遊戲模板列表</h2>
                   <div class="table-responsive">
                       <table class="same-game-table">
                           <thead>
                               <tr>
                                   <th scope="col" width="60">#</th>
                                   <th scope="col">模板名稱</th>
                                   <th scope="col">難度</th>
                                   <th scope="col">關卡數</th>
                                   <th scope="col">遊玩次數</th>
                                   <th scope="col">狀態</th>
                                   <th scope="col">更新時間</th>
                                   <th scope="col" width="200">操作</th>
                               </tr>
                           </thead>
                           <tbody id="templatesList">
                               <!-- 數據將通過 JavaScript 加載 -->
                               <tr><td colspan="8" class="text-center py-4">載入中...</td></tr>
                           </tbody>
                       </table>
                   </div>
                   <!-- 模板詳情顯示區 (取代原本的 card) -->
                   <div id="templateDetailContainer" style="display: none; margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                       <button class="btn btn-sm btn-outline-secondary back-button" id="backToListBtn"><i class="fas fa-arrow-left me-1"></i> 返回列表</button>
                       <h3 id="templateDetailTitle">模板詳情</h3>
                       <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="card-title" id="detailTemplateName"></h5>
                                <p class="card-text" id="detailTemplateDescription"></p>
                                <p><span class="badge bg-primary" id="detailTemplateDifficulty"></span></p>
                            </div>
                            <div class="col-md-6 text-end">
                                <!-- Edit button moved to the list view -->
                                <button class="btn btn-success btn-sm" id="addLevelBtn">
                                    <i class="fas fa-plus me-1"></i> 新增關卡
                                </button>
                            </div>
                       </div>
                       <h6 class="mb-3">關卡列表</h6>
                       <div class="table-responsive">
                            <table class="table table-hover" id="levelsTable">
                                <thead>
                                    <tr>
                                        <th scope="col">關卡</th>
                                        <th scope="col">網格</th>
                                        <th scope="col">圖片數</th>
                                        <th scope="col">更新時間</th>
                                        <th scope="col" width="180">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="levelsList"></tbody>
                            </table>
                       </div>
                       <!-- 關卡新增/編輯表單 (內嵌) -->
                       <div id="levelFormContainer" style="display: none; margin-top: 20px;">
                           <h4 id="levelFormTitle">新增關卡</h4>
                           <form id="levelForm">
                               <input type="hidden" id="levelId">
                               <input type="hidden" id="levelTemplateId">
                               <div class="row mb-3">
                                   <div class="col-md-4">
                                       <label for="levelNumber" class="form-label">關卡號碼 <span class="text-danger">*</span></label>
                                       <input type="number" class="form-control" id="levelNumber" min="1" required>
                                   </div>
                                   <div class="col-md-4">
                                       <label for="gridRows" class="form-label">網格行數 <span class="text-danger">*</span></label>
                                       <input type="number" class="form-control" id="gridRows" min="2" max="6" required>
                                   </div>
                                   <div class="col-md-4">
                                       <label for="gridColumns" class="form-label">網格列數 <span class="text-danger">*</span></label>
                                       <input type="number" class="form-control" id="gridColumns" min="2" max="6" required>
                                   </div>
                               </div>
                               <div class="mb-3">
                                   <label class="form-label">圖片列表 <span class="text-danger">*</span></label>
                                   <p class="text-muted small">請添加圖片 URL 或上傳新圖片。至少需 2 張，數量需為偶數，且不超過網格大小的兩倍。</p>
                                   <ul class="image-list" id="imageList"></ul>
                                   <button type="button" class="btn btn-outline-secondary mt-2" id="addImageBtn">
                                       <i class="fas fa-plus me-1"></i> 添加圖片欄位
                                   </button>
                               </div>
                               <div class="form-actions">
                                    <button type="button" class="btn btn-secondary action-btn cancel-btn" id="cancelLevelEditBtn">取消</button>
                                    <button type="submit" class="btn btn-primary action-btn save-btn">儲存關卡</button>
                               </div>
                               <p class="form-error" id="levelFormError"></p>
                           </form>
                       </div>
                   </div>
               </div>
               
               <!-- 排行榜內容 -->
               <div id="leaderboard" class="tab-content">
                   <h2>遊戲排行榜</h2>
                    <div class="mb-3">
                        <label for="leaderboardTemplateFilter" class="form-label">篩選模板:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="leaderboardTemplateFilter">
                            <option value="">所有模板</option>
                            <!-- 模板選項將通過 JavaScript 加載 -->
                        </select>
                    </div>
                   <div class="table-responsive">
                       <table class="same-game-table">
                           <thead>
                               <tr>
                                   <th scope="col" width="60">#</th>
                                   <th scope="col">玩家名稱</th>
                                   <th scope="col">模板</th>
                                   <th scope="col">總步數</th>
                                   <th scope="col">完成時間(秒)</th>
                                   <th scope="col">完成日期</th>
                               </tr>
                           </thead>
                           <tbody id="leaderboardList">
                               <!-- 數據將通過 JavaScript 加載 -->
                               <tr><td colspan="6" class="text-center py-4">載入中...</td></tr>
                           </tbody>
                       </table>
                   </div>
               </div>
               
               <!-- 新增/編輯模板表單 (內嵌) -->
               <div id="add-template" class="tab-content">
                   <div id="editTemplateForm"> <!-- Renamed from addTemplateForm for clarity -->
                       <h2 id="templateFormTitle">新增模板</h2>
                       <form id="templateForm">
                           <input type="hidden" id="templateId">
                           <div class="form-group">
                               <label for="templateName">模板名稱 <span class="text-danger">*</span></label>
                               <input type="text" class="form-control" id="templateName" required>
                           </div>
                           <div class="form-group">
                               <label for="templateDescription">模板描述</label>
                               <textarea class="form-control" id="templateDescription" rows="3"></textarea>
                           </div>
                           <div class="form-group">
                               <label for="templateDifficulty">難度</label>
                               <select class="form-select" id="templateDifficulty">
                                   <option value="簡單">簡單</option>
                                   <option value="普通">普通</option>
                                   <option value="困難">困難</option>
                               </select>
                           </div>
                           <div class="form-group form-check">
                               <input type="checkbox" class="form-check-input" id="templateActive" checked>
                               <label class="form-check-label" for="templateActive">啟用模板</label>
                           </div>
                           <div class="form-actions">
                               <button type="button" class="btn btn-secondary action-btn cancel-btn" id="cancelTemplateEditBtn">取消</button>
                               <button type="submit" class="btn btn-primary action-btn save-btn">儲存模板</button>
                           </div>
                           <p class="form-error" id="templateFormError"></p>
                       </form>
                   </div>
               </div>
           </div>
       </div>
        
       <!-- 新增一般遊戲標籤頁 -->
       <div id="add-game" class="tab-content">
           <div id="addGameForm">
               <h2>新增遊戲</h2>
               <form id="add-game-form">
                   <div class="form-group">
                       <label for="add-game-name">遊戲名稱:</label>
                       <input type="text" id="add-game-name" name="name" required>
                   </div>
                   <div class="form-group">
                       <label for="add-game-description">遊戲描述:</label>
                       <textarea id="add-game-description" name="description" rows="3"></textarea>
                   </div>
                   <div class="form-group">
                       <label for="add-game-play-url">遊戲連結:</label>
                       <input type="text" id="add-game-play-url" name="play_url" placeholder="例如: /game/new-game.html" required>
                   </div>
                   <div class="form-group">
                       <label for="add-game-image-url">縮圖路徑:</label>
                       <input type="text" id="add-game-image-url" name="image_url" placeholder="例如: /images/games/new-game.jpg">
                       <img id="add-image-preview" src="" alt="縮圖預覽">
                   </div>
                   <div class="form-group">
                       <label for="add-game-sort-order">排序順序:</label>
                       <input type="number" id="add-game-sort-order" name="sort_order" value="0" min="0">
                   </div>
                   <div class="form-group">
                       <label for="add-game-is-active">啟用狀態:</label>
                       <select id="add-game-is-active" name="is_active">
                           <option value="1" selected>啟用</option>
                           <option value="0">停用</option>
                       </select>
                   </div>
                   <div class="form-actions">
                       <button type="submit" class="action-btn save-btn">確認新增</button>
                       <!-- No cancel button needed as it's a tab -->
                   </div>
                   <p class="form-error" id="add-form-error"></p>
               </form>
           </div>
       </div>

       <!-- 找出不同遊戲管理標籤頁 -->
       <div id="diffrent-game" class="tab-content">
           <div class="diffrent-game-container">
               <!-- 子標籤頁導航 -->
               <div class="tabs-container">
                   <ul class="tabs-nav diffrent-game-tabs">
                       <li class="tab-item active" data-tab="diffrent-levels-list">關卡列表</li>
                       <li class="tab-item" data-tab="diffrent-leaderboard">排行榜</li>
                       <li class="tab-item" data-tab="diffrent-editor">差異點編輯器</li>
                   </ul>
               </div>
               
               <!-- 關卡列表內容 -->
               <div id="diffrent-levels-list" class="tab-content active">
                   <h2>找出不同遊戲關卡列表</h2>
                   <div class="mb-3">
                       <button class="btn btn-success" id="add-diffrent-level-btn">
                           <i class="fas fa-plus me-1"></i> 新增關卡
                       </button>
                   </div>
                   <div class="table-responsive">
                       <table class="table table-hover">
                           <thead>
                               <tr>
                                   <th scope="col">#</th>
                                   <th scope="col">關卡名稱</th>
                                   <th scope="col">圖片數</th>
                                   <th scope="col">建立時間</th>
                                   <th scope="col">遊玩次數</th>
                                   <th scope="col">狀態</th>
                                   <th scope="col">操作</th>
                               </tr>
                           </thead>
                           <tbody id="diffrent-levels-tbody">
                               <!-- 數據將通過 JavaScript 加載 -->
                               <tr><td colspan="7" class="text-center py-4">載入中...</td></tr>
                           </tbody>
                       </table>
                   </div>
               </div>
               
               <!-- 排行榜內容 -->
               <div id="diffrent-leaderboard" class="tab-content">
                   <h2>找出不同遊戲排行榜</h2>
                   <div class="table-responsive">
                       <table class="table table-hover">
                           <thead>
                               <tr>
                                   <th scope="col">排名</th>
                                   <th scope="col">玩家名稱</th>
                                   <th scope="col">耗時(秒)</th>
                                   <th scope="col">完成日期</th>
                               </tr>
                           </thead>
                           <tbody id="diffrent-leaderboard-tbody">
                               <!-- 數據將通過 JavaScript 加載 -->
                               <tr><td colspan="4" class="text-center py-4">載入中...</td></tr>
                           </tbody>
                       </table>
                   </div>
               </div>
               
               <!-- 差異點編輯器內容 -->
               <div id="diffrent-editor" class="tab-content">
                   <div class="row mb-3">
                       <div class="col-md-6">
                           <h2>差異點編輯器</h2>
                       </div>
                       <div class="col-md-6 text-end">
                           <div class="form-group">
                               <label for="diffrent-level-selector" class="me-2">選擇關卡:</label>
                               <select id="diffrent-level-selector" class="form-select form-select-sm d-inline-block w-auto">
                                   <option value="">請選擇關卡</option>
                                   <!-- 關卡選項將通過 JavaScript 加載 -->
                               </select>
                           </div>
                       </div>
                   </div>

                   <div class="editor-container" style="display: none;">
                       <div class="row">
                           <div class="col-md-6">
                               <div class="card mb-3">
                                   <div class="card-header">原圖</div>
                                   <div class="card-body text-center">
                                       <div class="position-relative" style="overflow: hidden;">
                                           <img id="diffrent-edit-left" src="" alt="原圖" class="img-fluid" style="max-width: 100%; cursor: crosshair;">
                                       </div>
                                   </div>
                                   <div class="card-footer">
                                       <div class="input-group">
                                           <input type="text" id="diffrent-left-url" class="form-control" placeholder="輸入原圖 URL">
                                           <input type="file" id="diffrent-left-upload" class="form-control" accept="image/*" style="display: none;">
                                           <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('diffrent-left-upload').click()">上傳</button>
                                       </div>
                                   </div>
                               </div>
                           </div>
                           <div class="col-md-6">
                               <div class="card mb-3">
                                   <div class="card-header">修改版</div>
                                   <div class="card-body text-center">
                                       <div class="position-relative" style="overflow: hidden;">
                                           <img id="diffrent-edit-right" src="" alt="修改版" class="img-fluid" style="max-width: 100%; cursor: crosshair;">
                                       </div>
                                   </div>
                                   <div class="card-footer">
                                       <div class="input-group">
                                           <input type="text" id="diffrent-right-url" class="form-control" placeholder="輸入修改版 URL">
                                           <input type="file" id="diffrent-right-upload" class="form-control" accept="image/*" style="display: none;">
                                           <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('diffrent-right-upload').click()">上傳</button>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                       
                       <div class="card mb-3">
                           <div class="card-header">
                               <div class="d-flex justify-content-between align-items-center">
                                   <span>差異點設置</span>
                                   <div>
                                       <button id="diffrent-save-btn" class="btn btn-primary btn-sm">儲存</button>
                                       <button id="diffrent-clear-btn" class="btn btn-secondary btn-sm ms-2">清除</button>
                                   </div>
                               </div>
                           </div>
                           <div class="card-body">
                               <p class="text-muted small">點擊圖片添加差異點，然後輸入描述。您可以拖動差異點調整位置。</p>
                               <div class="table-responsive">
                                   <table class="table table-bordered table-sm">
                                       <thead>
                                           <tr>
                                               <th>#</th>
                                               <th>描述</th>
                                               <th>位置 (Left, Top)</th>
                                               <th>操作</th>
                                           </tr>
                                       </thead>
                                       <tbody id="diffrent-points-list">
                                           <tr><td colspan="4" class="text-center">無差異點</td></tr>
                                       </tbody>
                                   </table>
                               </div>
                           </div>
                       </div>
                       
                       <div class="row mb-3">
                           <div class="col">
                               <div class="form-group">
                                   <label for="diffrent-level-name">關卡名稱:</label>
                                   <input type="text" id="diffrent-level-name" class="form-control" placeholder="例如：第一關">
                               </div>
                           </div>
                           <div class="col">
                               <div class="form-group">
                                   <label for="diffrent-level-active">狀態:</label>
                                   <select id="diffrent-level-active" class="form-control">
                                       <option value="1">啟用</option>
                                       <option value="0">停用</option>
                                   </select>
                               </div>
                           </div>
                       </div>
                       
                       <div class="form-group">
                           <pre id="diffrent-output" class="border p-3 bg-light" style="height: 200px; overflow: auto;"></pre>
                       </div>
                   </div>
                   
                   <div id="diffrent-editor-placeholder" class="text-center py-5 border rounded bg-light">
                       <p class="mb-3">請選擇一個關卡進行編輯，或者</p>
                       <button class="btn btn-primary" id="diffrent-new-level-btn">
                           <i class="fas fa-plus me-1"></i> 建立新關卡
                       </button>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- 編輯一般遊戲表單 (保持原樣，顯示/隱藏) -->
   <div id="editGameForm" style="display: none;">
       <div class="admin-container">
           <button class="back-button" onclick="closeEditForm()">返回列表</button>
           <h2>編輯遊戲</h2>
           <form id="edit-game-form">
               <input type="hidden" id="edit-game-id">
               <div class="form-group">
                   <label for="edit-game-name">遊戲名稱:</label>
                   <input type="text" id="edit-game-name" name="name" required>
               </div>
               <div class="form-group">
                   <label for="edit-game-description">遊戲描述:</label>
                   <textarea id="edit-game-description" name="description" rows="3"></textarea>
               </div>
               <div class="form-group">
                   <label for="edit-game-play-url">遊戲連結:</label>
                   <input type="text" id="edit-game-play-url" name="play_url" required>
               </div>
               <div class="form-group">
                   <label for="edit-game-image-url">縮圖路徑:</label>
                   <input type="text" id="edit-game-image-url" name="image_url">
                   <img id="edit-image-preview" src="" alt="縮圖預覽">
               </div>
               <div class="form-group">
                   <label for="edit-game-sort-order">排序順序:</label>
                   <input type="number" id="edit-game-sort-order" name="sort_order" min="0">
               </div>
               <div class="form-group">
                   <label for="edit-game-is-active">啟用狀態:</label>
                   <select id="edit-game-is-active" name="is_active">
                       <option value="1">啟用</option>
                       <option value="0">停用</option>
                   </select>
               </div>
               <div class="form-group">
                   <label>遊玩次數:</label>
                   <span id="edit-game-play-count" style="font-weight: bold; padding: 8px 0; display: inline-block;">-</span>
               </div>
               <div class="form-actions">
                   <button type="submit" class="action-btn save-btn">儲存變更</button>
               </div>
               <p class="form-error" id="edit-form-error"></p>
           </form>
       </div>
   </div>
   
   <!-- 通知提示容器 -->
   <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px;"></div>


   <!-- 引入 JS Libraries -->
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
   <!-- SortableJS for drag-and-drop functionality (optional, needed if level image reordering is required) -->
   <!-- <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> -->
    
   <script>
        // --- Start: Integrated JavaScript ---
        let currentTemplateId = null; // For tracking edited/viewed template in same-game section
        let currentEditingLevelId = null; // For tracking edited level

        document.addEventListener('DOMContentLoaded', function() {
            // --- General Game Logic ---
            fetchAndDisplayGames(); // Load general games list

            const addGameFormElement = document.getElementById('add-game-form');
            if (addGameFormElement) {
                addGameFormElement.addEventListener('submit', handleAddGameSubmit);
            } else { console.error("Add game form not found."); }

            const editGameFormElement = document.getElementById('edit-game-form');
            if (editGameFormElement) {
                editGameFormElement.addEventListener('submit', handleEditGameSubmit);
            } else { console.error("Edit game form not found."); }
            
            const addGameImageUrl = document.getElementById('add-game-image-url');
            if (addGameImageUrl) {
                addGameImageUrl.addEventListener('input', function() {
                    previewImage('add-image-preview', this.value);
                });
            }
            const editGameImageUrl = document.getElementById('edit-game-image-url');
            if (editGameImageUrl) {
                editGameImageUrl.addEventListener('input', function() {
                    previewImage('edit-image-preview', this.value);
                });
            }

            // --- Same Game Logic ---
            loadTemplates(); // Load same-game templates list
            loadLeaderboard(); // Load same-game leaderboard
            initializeSameGameEventListeners(); // Setup listeners for same-game section
            
            // --- 找出不同遊戲邏輯 ---
            initDiffrentGameFunctions(); // 初始化找出不同遊戲功能

            // --- Tab Switching Logic ---
            initializeTabSwitching();
            
            // 根據 URL 參數初始化活動標籤
            initActiveTabFromUrl();
        }); // End of DOMContentLoaded

        // ==================================
        // General Game Functions
        // ==================================
        function handleAddGameSubmit(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('add-game-name').value.trim(),
                description: document.getElementById('add-game-description').value.trim(),
                play_url: document.getElementById('add-game-play-url').value.trim(),
                image_url: document.getElementById('add-game-image-url').value.trim(),
                sort_order: parseInt(document.getElementById('add-game-sort-order').value) || 0,
                is_active: document.getElementById('add-game-is-active').value === '1'
            };
            const addErrorElement = document.getElementById('add-form-error');
            if (!formData.name || !formData.play_url) {
                addErrorElement.textContent = '遊戲名稱和連結不能為空'; return;
            }
            addErrorElement.textContent = '';

            fetch('/api/admin/games', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(formData) })
            .then(handleFetchResponse)
            .then(data => {
                document.getElementById('add-game-form').reset();
                previewImage('add-image-preview', '');
                switchTab('general-games'); // Switch back to list
                fetchAndDisplayGames();
                showAlert('一般遊戲新增成功', 'success');
            })
            .catch(error => { handleError(error, addErrorElement, '新增一般遊戲失敗'); });
        }

        function handleEditGameSubmit(e) {
            e.preventDefault();
            const gameId = document.getElementById('edit-game-id').value;
            const formData = {
                name: document.getElementById('edit-game-name').value.trim(),
                description: document.getElementById('edit-game-description').value.trim(),
                play_url: document.getElementById('edit-game-play-url').value.trim(),
                image_url: document.getElementById('edit-game-image-url').value.trim(),
                sort_order: parseInt(document.getElementById('edit-game-sort-order').value) || 0,
                is_active: document.getElementById('edit-game-is-active').value === '1'
            };
            const editErrorElement = document.getElementById('edit-form-error');
            if (!formData.name || !formData.play_url) {
                editErrorElement.textContent = '遊戲名稱和連結不能為空'; return;
            }
            editErrorElement.textContent = '';

            fetch(`/api/admin/games/${gameId}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(formData) })
            .then(handleFetchResponse)
            .then(data => {
                closeEditForm();
                fetchAndDisplayGames();
                showAlert('一般遊戲更新成功', 'success');
            })
            .catch(error => { handleError(error, editErrorElement, '更新一般遊戲失敗'); });
        }
        
        // Needs to be global for onclick
        window.editGame = function(id) {
            const editErrorElement = document.getElementById('edit-form-error');
            const editGameForm = document.getElementById('edit-game-form');
            const editImagePreview = document.getElementById('edit-image-preview');
            if(editErrorElement) editErrorElement.textContent = '';
            if(editGameForm) editGameForm.reset();
            if(editImagePreview) editImagePreview.style.display = 'none';

            fetch(`/api/admin/games/${id}`)
            .then(handleFetchResponse)
            .then(game => {
                document.getElementById('edit-game-id').value = game.id;
                document.getElementById('edit-game-name').value = game.title;
                document.getElementById('edit-game-description').value = game.description || '';
                document.getElementById('edit-game-play-url').value = game.play_url;
                document.getElementById('edit-game-image-url').value = game.image_url || '';
                document.getElementById('edit-game-sort-order').value = game.sort_order || 0;
                document.getElementById('edit-game-is-active').value = game.is_active ? '1' : '0';
                document.getElementById('edit-game-play-count').textContent = game.play_count || 0;
                
                previewImage('edit-image-preview', game.image_url);
                
                const editGameForm = document.getElementById('editGameForm');
                if (editGameForm) editGameForm.style.display = 'block';
                const adminContainer = document.querySelector('.admin-container');
                if (adminContainer) adminContainer.style.display = 'none';
            })
            .catch(error => { alert(`載入一般遊戲資料時出錯: ${error.message}`); });
        }

        // Needs to be global for onclick
        window.closeEditForm = function() {
            const editGameForm = document.getElementById('editGameForm');
            if (editGameForm) editGameForm.style.display = 'none';
            const adminContainer = document.querySelector('.admin-container');
            if (adminContainer) adminContainer.style.display = 'block';
        }

        // Needs to be global for onclick
        window.deleteGame = function(id) {
            if (confirm(`確定要刪除ID為 ${id} 的一般遊戲嗎？此操作無法復原！`)) {
                fetch(`/api/admin/games/${id}`, { method: 'DELETE' })
                .then(handleFetchResponse)
                .then(data => {
                    showAlert('一般遊戲刪除成功', 'success');
                    fetchAndDisplayGames(); // Refresh list
                })
                .catch(error => { handleError(error, null, '刪除一般遊戲失敗'); });
            }
        }

        function fetchAndDisplayGames() {
            const tableBody = document.querySelector('#games-list-table tbody');
            if (!tableBody) { console.error("General games table body not found."); return; }
            tableBody.innerHTML = '<tr><td colspan="6">正在載入一般遊戲列表...</td></tr>';

            fetch('/api/admin/games')
            .then(handleFetchResponse)
            .then(data => {
                renderTable(tableBody, data, renderGeneralGameRow, 6, "目前沒有任何一般遊戲");
                updateStatistics(data);
            })
            .catch(error => { handleError(error, tableBody, '載入一般遊戲列表失敗', 6); });
        }
        
        function renderGeneralGameRow(game) {
            const imageUrl = game.image_url || '/images/placeholder.png';
            const title = escapeHtml(game.title || '無標題');
            const description = escapeHtml(game.description || '');
            const playCount = game.play_count || 0;
            const gameId = game.id;

            return `
                <td>${gameId}</td>
                <td>${title}</td>
                <td>${description}</td>
                <td>${playCount}</td>
                <td><img src="${imageUrl}" alt="${title}" style="width: 50px; height: auto; border: 1px solid #eee;"></td>
                <td>
                    <button class="action-btn edit-btn" onclick="editGame(${gameId})">編輯</button>
                    <button class="action-btn delete-btn" onclick="deleteGame(${gameId})">刪除</button>
                </td>
            `;
        }

        function updateStatistics(data) {
            const totalGamesElement = document.getElementById('total-games-count');
            const totalPlaysElement = document.getElementById('total-plays-count');
            const mostPopularElement = document.getElementById('most-popular-game');
            const todayPlaysElement = document.getElementById('today-plays-count');

            if (data && Array.isArray(data)) {
                const totalGames = data.length;
                const totalPlays = data.reduce((sum, game) => sum + (game.play_count || 0), 0);
                const mostPopular = data.length > 0 ? [...data].sort((a, b) => (b.play_count || 0) - (a.play_count || 0))[0] : null;
                if(totalGamesElement) totalGamesElement.textContent = totalGames;
                if(totalPlaysElement) totalPlaysElement.textContent = totalPlays;
                if(mostPopularElement) mostPopularElement.textContent = mostPopular ? escapeHtml(mostPopular.title) : '-';
            }
               
            fetch('/api/admin/games/stats/today')
            .then(handleFetchResponse)
            .then(stats => {
                if(todayPlaysElement) todayPlaysElement.textContent = stats.today_count || 0;
            }) 
            .catch(error => {
                if(todayPlaysElement) todayPlaysElement.textContent = '?';
                console.error('獲取今日遊玩次數失敗:', error);
            });
        }

        // Needs to be global for input events
        window.previewImage = function(previewId, imageUrl) {
            const preview = document.getElementById(previewId);
            if (!preview) { console.error(`Preview image element ID '${previewId}' not found.`); return; }
            if (imageUrl) {
                preview.src = imageUrl;
                preview.style.display = 'block';
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        }

        // ==================================
        // Same Game (對對碰) Functions
        // ==================================
        function initializeSameGameEventListeners() {
            // Template form submission (for add/edit)
            $('#templateForm').submit(handleTemplateFormSubmit);

            // Cancel template edit button
            $('#cancelTemplateEditBtn').click(cancelTemplateEdit);

            // Back to list button from template detail view
            $('#backToListBtn').click(hideTemplateDetail);
             
            // Add level button (shows level form)
            $('#addLevelBtn').click(showAddLevelForm);

            // Level form submission
            $('#levelForm').submit(handleLevelFormSubmit);

            // Cancel level edit button
            $('#cancelLevelEditBtn').click(hideLevelForm);

            // Add image field button in level form
            $('#addImageBtn').click(() => addImageInput()); // Pass no URL for new field

            // Leaderboard template filter change
            $('#leaderboardTemplateFilter').change(function() {
                loadLeaderboard($(this).val());
            });

            // Event delegation for dynamically added buttons within lists
             $('#templatesList').on('click', '.view-btn', function() {
                viewTemplateDetail($(this).data('id'));
            });
             $('#templatesList').on('click', '.edit-template-btn', function() {
                editTemplate($(this).data('id'));
            });
            $('#templatesList').on('click', '.delete-template-btn', function() {
                const templateId = $(this).data('id');
                const templateName = $(this).data('name');
                confirmDeleteTemplate(templateId, templateName);
            });
            $('#levelsList').on('click', '.edit-level-btn', function() {
                editLevel($(this).data('id'));
            });
            $('#levelsList').on('click', '.delete-level-btn', function() {
                const levelId = $(this).data('id');
                const levelNumber = $(this).data('level');
                confirmDeleteLevel(levelId, levelNumber);
            });
            $('#imageList').on('click', '.remove-image-btn', function() {
                $(this).closest('.image-list-item').remove();
            });
            $('#imageList').on('change', '.image-file-input', function(event) {
                handleImageFileUpload(event.target);
            });
        }

        function loadTemplates() {
            const tableBody = $('#templatesList');
            if (!tableBody.length) { console.error("Templates table body not found."); return; }
            tableBody.html('<tr><td colspan="8" class="text-center py-4">載入中...</td></tr>');
            
            fetch('/api/samegame/templates')
            .then(handleFetchResponse)
            .then(data => {
                renderTable(tableBody[0], data, renderTemplateRow, 8, "目前沒有任何模板");
                populateTemplateFilter(data); // Populate leaderboard filter
            })
            .catch(error => { handleError(error, tableBody[0], '載入模板列表失敗', 8); });
        }
        
        function renderTemplateRow(template, index) {
            const templateId = template.id;
            const name = escapeHtml(template.name);
            const difficulty = escapeHtml(template.difficulty || '未設置');
            const levelCount = template.level_count || 0;
            const playCount = template.play_count || 0;
            const status = template.is_active ? '<span class="badge bg-success">啟用</span>' : '<span class="badge bg-secondary">停用</span>';
            const updated = formatDate(template.updated_at);

            return `
                <td>${index + 1}</td>
                <td>${name}</td>
                <td>${difficulty}</td>
                <td>${levelCount}</td>
                <td>${playCount}</td>
                <td>${status}</td>
                <td>${updated}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-btn" data-id="${templateId}">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                     <button class="btn btn-sm btn-outline-warning edit-template-btn" data-id="${templateId}">
                        <i class="fas fa-edit"></i> 編輯
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-template-btn" data-id="${templateId}" data-name="${name}">
                        <i class="fas fa-trash"></i> 刪除
                    </button>
                </td>
            `;
        }

        function populateTemplateFilter(templates) {
            const filterSelect = $('#leaderboardTemplateFilter');
            if (!filterSelect.length) return;
            let options = '<option value="">所有模板</option>';
            if (Array.isArray(templates)) {
                templates.forEach(template => {
                    options += `<option value="${template.id}">${escapeHtml(template.name)}</option>`;
                });
            }
            filterSelect.html(options);
        }

        function loadLeaderboard(templateId = '') {
            const tableBody = $('#leaderboardList');
            if (!tableBody.length) { console.error("Leaderboard table body not found."); return; }
            tableBody.html('<tr><td colspan="6" class="text-center py-4">載入中...</td></tr>');
            
            let url = '/api/samegame/leaderboard';
            if (templateId) {
                url += `?template_id=${templateId}`;
            }
            
            fetch(url)
            .then(handleFetchResponse)
            .then(data => {
                renderTable(tableBody[0], data, renderLeaderboardRow, 6, "目前沒有任何排行紀錄");
            })
            .catch(error => { handleError(error, tableBody[0], '載入排行榜失敗', 6); });
        }

        function renderLeaderboardRow(record, index) {
             const playerName = escapeHtml(record.player_name);
             const templateName = escapeHtml(record.template_name);
             const totalMoves = record.total_moves;
             const completionTime = record.completion_time ? record.completion_time : '未記錄';
             const createdAt = formatDate(record.created_at);

             return `
                 <tr>
                     <td>${index + 1}</td>
                     <td>${playerName}</td>
                     <td>${templateName}</td>
                     <td>${totalMoves}</td>
                     <td>${completionTime}</td>
                     <td>${createdAt}</td>
                 </tr>
             `;
        }

        function viewTemplateDetail(templateId) {
            currentTemplateId = templateId; // Store globally for later use (e.g., adding levels)
            $('#templateDetailContainer').hide(); // Hide first
            $('#levelsList').empty(); // Clear previous levels
             
            fetch(`/api/samegame/templates/${templateId}`)
            .then(handleFetchResponse)
            .then(data => {
                $('#detailTemplateName').text(data.name);
                $('#detailTemplateDescription').text(data.description || '無描述');
                $('#detailTemplateDifficulty').text(data.difficulty || '未設置');
                $('#templateDetailTitle').text(`模板詳情: ${escapeHtml(data.name)}`);
                
                // Render levels list within the detail container
                renderTable(document.getElementById('levelsList'), data.levels || [], renderLevelRow, 5, "尚未設置任何關卡");

                $('#templateDetailContainer').show(); // Show the container with details and levels
                // Hide the main list view (optional, depends on desired UI)
                // $('#templates-list').hide(); 
            })
            .catch(error => { showAlert(`載入模板詳情失敗: ${error.message}`, 'danger'); });
        }
        
        function renderLevelRow(level) {
            const levelId = level.id;
            const levelNumber = level.level_number;
            const grid = `${level.grid_rows} × ${level.grid_columns}`;
            const imageCount = level.images ? level.images.length : 0;
            const updated = formatDate(level.updated_at);

            return `
                <tr>
                    <td>${levelNumber}</td>
                    <td>${grid}</td>
                    <td>${imageCount} 張</td>
                    <td>${updated}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-level-btn" data-id="${levelId}">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-level-btn" data-id="${levelId}" data-level="${levelNumber}">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </td>
                </tr>
            `;
        }

        function hideTemplateDetail() {
            $('#templateDetailContainer').hide();
             hideLevelForm(); // Also hide level form if open
            currentTemplateId = null;
            // Show the main list view again if it was hidden
            // $('#templates-list').show(); 
        }

        function editTemplate(templateId) {
             fetch(`/api/samegame/templates/${templateId}`)
            .then(handleFetchResponse)
            .then(data => {
                resetTemplateForm(); // Clear form first
                $('#templateId').val(data.id); // Set the ID for update
                $('#templateName').val(data.name);
                $('#templateDescription').val(data.description || '');
                $('#templateDifficulty').val(data.difficulty || '簡單');
                $('#templateActive').prop('checked', data.is_active);
                $('#templateFormTitle').text('編輯模板');
                
                // Switch to the add/edit template tab
                switchTab('add-template');
            })
            .catch(error => { showAlert(`載入模板數據失敗: ${error.message}`, 'danger'); });
        }

        function handleTemplateFormSubmit(e) {
            e.preventDefault();
            const templateId = $('#templateId').val();
            const name = $('#templateName').val().trim();
            const templateData = {
                name: name,
                description: $('#templateDescription').val().trim(),
                difficulty: $('#templateDifficulty').val(),
                is_active: $('#templateActive').is(':checked')
            };
            const errorElement = $('#templateFormError');

            if (!name) { errorElement.text('請輸入模板名稱'); return; }
            errorElement.text('');

            const url = templateId ? `/api/samegame/templates/${templateId}` : '/api/samegame/templates';
            const method = templateId ? 'PUT' : 'POST';

            fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(templateData) })
            .then(handleFetchResponse)
            .then(data => {
                showAlert(templateId ? '模板更新成功' : '模板創建成功', 'success');
                resetTemplateForm();
                loadTemplates(); // Refresh list
                switchTab('templates-list'); // Go back to list tab
            })
            .catch(error => { handleError(error, errorElement[0], templateId ? '更新模板失敗' : '創建模板失敗'); });
        }

        function cancelTemplateEdit() {
             resetTemplateForm();
             switchTab('templates-list'); // Switch back to the list view
        }
        
        function resetTemplateForm() {
            $('#templateForm')[0].reset(); // Use native reset
            $('#templateId').val(''); // Clear hidden ID
            $('#templateFormTitle').text('新增模板');
            $('#templateFormError').text('');
             $('#templateActive').prop('checked', true); // Default to active
        }
        
        function showAddLevelForm() {
            resetLevelForm(); // Clear the form
            currentEditingLevelId = null; // Ensure we are adding, not editing
             $('#levelTemplateId').val(currentTemplateId); // Set the parent template ID
            $('#levelFormTitle').text('新增關卡');
            $('#levelFormContainer').show(); // Show the form within the detail view
        }

         function editLevel(levelId) {
            resetLevelForm();
            currentEditingLevelId = levelId; // Set the ID for update

            fetch(`/api/samegame/levels/${levelId}`) // Assuming an endpoint to get level details
            .then(handleFetchResponse)
            .then(level => {
                $('#levelId').val(level.id);
                $('#levelTemplateId').val(level.template_id || currentTemplateId); // Use template_id from response or current context
                $('#levelNumber').val(level.level_number);
                $('#gridRows').val(level.grid_rows);
                $('#gridColumns').val(level.grid_columns);
                
                if (level.images && level.images.length > 0) {
                    level.images.forEach(image => {
                        addImageInput(image.image_url); // Populate existing images
                    });
                }
                
                $('#levelFormTitle').text(`編輯關卡 ${level.level_number}`);
                $('#levelFormContainer').show(); // Show the form
            })
            .catch(error => { showAlert(`載入關卡數據失敗: ${error.message}`, 'danger'); });
        }

        function handleLevelFormSubmit(e) {
             e.preventDefault();
             const levelId = $('#levelId').val(); // Use hidden input value
             const templateId = $('#levelTemplateId').val();
             const levelNumber = $('#levelNumber').val();
             const gridRows = $('#gridRows').val();
             const gridColumns = $('#gridColumns').val();
             const errorElement = $('#levelFormError');
             errorElement.text(''); // Clear previous errors

             if (!levelNumber || !gridRows || !gridColumns || !templateId) {
                 errorElement.text('請填寫所有必填欄位'); return;
             }
             
             const images = [];
             $('#imageList .image-list-item').each(function() {
                 const urlInput = $(this).find('.image-url-input').val();
                 const url = urlInput ? urlInput.trim() : '';
                 if (url) {
                     images.push({ image_url: url });
                 }
             });

             if (images.length < 2) { errorElement.text('請至少添加2張圖片'); return; }
             if (images.length % 2 !== 0) { errorElement.text('圖片數量必須是偶數'); return; }
             const maxPairs = (parseInt(gridRows) * parseInt(gridColumns)) / 2;
             if (images.length > maxPairs * 2) { errorElement.text(`圖片數量 (${images.length}) 不能超過網格大小的兩倍 (${maxPairs * 2})`); return; }

             const levelData = {
                 level_number: parseInt(levelNumber),
                 grid_rows: parseInt(gridRows),
                 grid_columns: parseInt(gridColumns),
                 images: images,
                 template_id: parseInt(templateId) // Ensure template_id is sent
             };

             const url = levelId ? `/api/samegame/levels/${levelId}` : `/api/samegame/templates/${templateId}/levels`;
             const method = levelId ? 'PUT' : 'POST';

             fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(levelData) })
             .then(handleFetchResponse)
             .then(data => {
                 showAlert(levelId ? '關卡更新成功' : '關卡創建成功', 'success');
                 hideLevelForm();
                 viewTemplateDetail(templateId); // Refresh the level list in the detail view
             })
             .catch(error => { handleError(error, errorElement[0], levelId ? '更新關卡失敗' : '創建關卡失敗'); });
        }

        function hideLevelForm() {
            $('#levelFormContainer').hide();
            resetLevelForm();
        }

        function resetLevelForm() {
            $('#levelForm')[0].reset();
            $('#levelId').val('');
            $('#imageList').empty(); // Clear dynamic image list
            $('#levelFormError').text('');
        }

        function confirmDeleteTemplate(templateId, templateName) {
            if (confirm(`您確定要刪除模板 "${escapeHtml(templateName)}" 嗎？
此操作將刪除所有關聯的關卡和圖片，且無法撤銷。`)) {
                deleteTemplate(templateId);
            }
        }
        
        function deleteTemplate(templateId) {
            fetch(`/api/samegame/templates/${templateId}`, { method: 'DELETE' })
            .then(handleFetchResponse)
            .then(() => {
                showAlert('模板已成功刪除', 'success');
                if (currentTemplateId && currentTemplateId === templateId) {
                    hideTemplateDetail(); // Hide detail view if it was the deleted one
                }
                loadTemplates(); // Refresh list
            })
            .catch(error => { handleError(error, null, '刪除模板失敗'); });
        }

        function confirmDeleteLevel(levelId, levelNumber) {
             if (confirm(`您確定要刪除第 ${levelNumber} 關嗎？此操作無法撤銷。`)) {
                deleteLevel(levelId);
            }
        }

        function deleteLevel(levelId) {
             fetch(`/api/samegame/levels/${levelId}`, { method: 'DELETE' })
            .then(handleFetchResponse)
            .then(() => {
                showAlert('關卡已成功刪除', 'success');
                if (currentTemplateId) {
                    viewTemplateDetail(currentTemplateId); // Refresh level list in detail view
                }
            })
            .catch(error => { handleError(error, null, '刪除關卡失敗'); });
        }
        
        function addImageInput(imageUrl = '') {
            const itemId = 'image-item-' + Date.now();
            const listItem = $(`
                <li class="image-list-item" id="${itemId}">
                    <div class="image-preview-container" style="${imageUrl ? '' : 'display: none;'}">
                        <img src="${escapeHtml(imageUrl)}" class="img-thumbnail">
                    </div>
                    <div class="flex-grow-1">
                        <div class="input-group">
                            <input type="text" class="form-control image-url-input" value="${escapeHtml(imageUrl)}" placeholder="輸入圖片 URL">
                            <input type="file" class="form-control image-file-input" style="display: none;" accept="image/*" data-target="${itemId}">
                             <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('${itemId}').querySelector('.image-file-input').click()">
                                <i class="fas fa-upload"></i> 上傳
                            </button>
                            <button type="button" class="btn btn-outline-danger remove-image-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </li>
            `);
            
            // Update preview on URL input change
            listItem.find('.image-url-input').on('input', function() {
                const url = $(this).val().trim();
                const previewContainer = $(`#${itemId} .image-preview-container`);
                const previewImg = previewContainer.find('img');
                if (url) {
                    previewImg.attr('src', url);
                    previewContainer.show();
                } else {
                    previewContainer.hide();
                }
            });

            $('#imageList').append(listItem);
        }

        function handleImageFileUpload(fileInput) {
             const file = fileInput.files[0];
             const targetId = $(fileInput).data('target'); // Get target li ID
             const previewContainer = $(`#${targetId} .image-preview-container`);
             const previewImg = previewContainer.find('img');
             const urlInput = $(`#${targetId} .image-url-input`);

             if (!file) return;

             const formData = new FormData();
             formData.append('file', file);

             // Show temporary loading state? (Optional)
             urlInput.prop('disabled', true).val('上傳中...');

             fetch('/api/admin/files/upload', { method: 'POST', body: formData })
             .then(handleFetchResponse)
             .then(response => {
                 if (response.success && response.file && response.file.file_path) {
                     const imageUrl = response.file.file_path;
                     urlInput.val(imageUrl);
                     previewImg.attr('src', imageUrl);
                     previewContainer.show();
                     showAlert('圖片上傳成功', 'success');
                 } else {
                     throw new Error('伺服器返回無效的響應');
                 }
             })
             .catch(error => {
                 showAlert(`圖片上傳失敗: ${error.message}`, 'danger');
             })
             .finally(() => {
                 urlInput.prop('disabled', false);
                 if (!urlInput.val() || urlInput.val() === '上傳中...') {
                      urlInput.val(''); // Clear if upload failed or was cancelled
                 }
                 // Reset file input so the same file can be selected again if needed
                 $(fileInput).val(''); 
             });
        }

        // ==================================
        // Tab Switching Logic
        // ==================================
        function initializeTabSwitching() {
            const mainTabs = document.querySelectorAll('.tabs-nav .tab-item:not(.same-game-tabs .tab-item):not(.diffrent-game-tabs .tab-item)');
            const mainTabContents = document.querySelectorAll('.admin-container > .tab-content');
            
            mainTabs.forEach(item => {
                item.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'), mainTabs, mainTabContents);
                    // If switching away from same-game, ensure detail view is hidden
                    if (this.getAttribute('data-tab') !== 'same-game') {
                       hideTemplateDetail();
                       hideLevelForm();
                    }
                    // If switching away from general-games, ensure edit form is hidden
                     if (this.getAttribute('data-tab') !== 'general-games') {
                        closeEditForm(); // Use existing function to hide general edit form
                    }
                     // When switching TO add-template, reset the form
                     if (this.getAttribute('data-tab') === 'add-template') {
                        resetTemplateForm(); 
                    }
                     // When switching TO templates-list, ensure detail is hidden
                     if (this.getAttribute('data-tab') === 'templates-list') {
                         hideTemplateDetail();
                         hideLevelForm();
                     }
                });
            });

            const sameGameTabs = document.querySelectorAll('.same-game-tabs .tab-item');
            const sameGameTabContents = document.querySelectorAll('.same-game-container .tab-content');

            sameGameTabs.forEach(item => {
                item.addEventListener('click', function() {
                     switchTab(this.getAttribute('data-tab'), sameGameTabs, sameGameTabContents);
                      // When switching TO add-template sub-tab, reset the form
                     if (this.getAttribute('data-tab') === 'add-template') {
                        resetTemplateForm(); 
                    }
                      // When switching TO templates-list sub-tab, ensure detail/forms are hidden
                     if (this.getAttribute('data-tab') === 'templates-list') {
                         hideTemplateDetail();
                         hideLevelForm();
                     }
                });
            });
            
            // 添加找出不同遊戲管理的子標籤頁切換
            const diffrentGameTabs = document.querySelectorAll('.diffrent-game-tabs .tab-item');
            const diffrentGameTabContents = document.querySelectorAll('.diffrent-game-container .tab-content');
            
            diffrentGameTabs.forEach(item => {
                item.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'), diffrentGameTabs, diffrentGameTabContents);
                });
            });
        }
        
        function switchTab(tabId, tabItemsNodeList = null, tabContentsNodeList = null) {
             // Determine which set of tabs/content to use if not provided
            if (!tabItemsNodeList || !tabContentsNodeList) {
                // Check if it's a main tab or a sub-tab
                const isSubTab = !!document.querySelector(`.same-game-tabs .tab-item[data-tab='${tabId}']`);
                if (isSubTab) {
                    tabItemsNodeList = document.querySelectorAll('.same-game-tabs .tab-item');
                    tabContentsNodeList = document.querySelectorAll('.same-game-container .tab-content');
                } else {
                    tabItemsNodeList = document.querySelectorAll('.tabs-nav .tab-item:not(.same-game-tabs .tab-item)');
                    tabContentsNodeList = document.querySelectorAll('.admin-container > .tab-content');
                }
            }

            tabItemsNodeList.forEach(tab => tab.classList.remove('active'));
            tabContentsNodeList.forEach(content => content.classList.remove('active'));

            const currentTabItem = document.querySelector(`.tab-item[data-tab='${tabId}']`);
            const currentTabContent = document.getElementById(tabId);

            if (currentTabItem) { currentTabItem.classList.add('active'); } 
            else { console.warn(`Tab item '${tabId}' not found.`); }
            
            if (currentTabContent) { currentTabContent.classList.add('active'); } 
            else { console.warn(`Tab content ID '${tabId}' not found.`); }

            // Special handling: Ensure the parent 'same-game' tab is active if a sub-tab is selected
            if (Array.from(document.querySelectorAll('.same-game-tabs .tab-item')).includes(currentTabItem)) {
                const sameGameTab = document.querySelector('.tab-item[data-tab="same-game"]');
                if (sameGameTab) sameGameTab.classList.add('active');
                
                const sameGameContent = document.getElementById('same-game');
                if (sameGameContent) sameGameContent.classList.add('active');
            }
        }

        // ==================================
        // Utility Functions
        // ==================================
        function handleFetchResponse(response) {
            if (!response.ok) {
                return response.text().then(text => { 
                   let errorMsg = `請求失敗: ${response.status} ${response.statusText}`;
                   try {
                       const jsonError = JSON.parse(text);
                       if (jsonError && jsonError.error) {
                           errorMsg += ` - ${jsonError.error}`;
                       } else {
                            errorMsg += ` - ${text}`;
                       }
                   } catch(e) {
                       errorMsg += ` - ${text}`; // Not JSON
                   }
                   throw new Error(errorMsg); 
                });
            }
            // Handle empty response body for methods like DELETE
             const contentType = response.headers.get("content-type");
             if (contentType && contentType.indexOf("application/json") !== -1) {
                 return response.json();
             } else {
                 return {}; // Return empty object for non-JSON or empty responses
             }
        }
        
        function handleError(error, element, contextMessage, colspan = 1) {
             const message = `${contextMessage}: ${error.message}`;
             console.error(message, error);
             if (element) {
                 if (element.tagName === 'TBODY') {
                     element.innerHTML = `<tr><td colspan="${colspan}">${escapeHtml(message)}</td></tr>`;
                 } else if (element.classList.contains('form-error')) {
                     element.textContent = escapeHtml(error.message);
                 } else {
                     // Default to alert for other errors if element is not specific
                     showAlert(message, 'danger');
                 }
             } else {
                  showAlert(message, 'danger'); // Fallback alert
             }
        }

        function renderTable(tableBodyElement, data, rowRenderer, colspan, emptyMessage) {
             if (!tableBodyElement) return;
             tableBodyElement.innerHTML = ''; // Clear previous content
             if (!Array.isArray(data)) {
                console.error("Received non-array data for table:", data);
                tableBodyElement.innerHTML = `<tr><td colspan="${colspan}">載入資料格式錯誤</td></tr>`; 
                return;
             }
             if (data.length === 0) {
                 tableBodyElement.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4">${emptyMessage}</td></tr>`;
                 return;
             }
             data.forEach((item, index) => {
                 const rowHtml = rowRenderer(item, index);
                 if (rowHtml) { // Ensure renderer returned something
                     const row = document.createElement('tr');
                     row.innerHTML = rowHtml;
                     tableBodyElement.appendChild(row);
                 }
             });
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = $('#alertContainer'); // Use jQuery selector
             if (!alertContainer.length) return; // Check if container exists

            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 10px;">
                    ${escapeHtml(message)}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.append(alertHtml);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                $(`#${alertId}`).alert('close');
            }, 3000);
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (e) {
                return 'Invalid Date';
            }
        }
        
        function escapeHtml(str) {
            if (str === null || typeof str === 'undefined') return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }




// --- 添加找出不同遊戲的 JavaScript 代碼 ---
// ==================================
// 找出不同遊戲管理
// ==================================
let diffrentEditorDifferences = []; // 存儲目前編輯的差異點
let currentDiffrentLevel = null; // 當前編輯的關卡

// 當文件加載完成時，初始化找出不同遊戲功能
document.addEventListener('DOMContentLoaded', function() {
    // 已有的初始化代碼
    
    // 初始化找出不同遊戲功能
    initDiffrentGameFunctions();
});

function initDiffrentGameFunctions() {
    console.log("初始化找出不同遊戲功能");
    
    // 載入關卡列表
    loadDiffrentLevels();
    
    // 載入排行榜
    loadDiffrentLeaderboard();
    
    // 初始化關卡選擇器下拉清單
    populateDiffrentLevelSelector();
    
    // 監聽關卡選擇器變化
    const levelSelector = document.getElementById('diffrent-level-selector');
    if (levelSelector) {
        levelSelector.addEventListener('change', function() {
            const levelId = this.value;
            if (levelId) {
                loadDiffrentLevelToEditor(levelId);
            } else {
                hideDiffrentEditor();
            }
        });
    } else {
        console.error("找出不同遊戲關卡選擇器不存在");
    }
    
    // 監聽新增關卡按鈕（在編輯器內）
    const newLevelBtn = document.getElementById('diffrent-new-level-btn');
    if (newLevelBtn) {
        newLevelBtn.addEventListener('click', function() {
            console.log("點擊建立新關卡按鈕");
            showDiffrentEditor();
            clearDiffrentEditor();
            currentDiffrentLevel = null;
            
            // 設置默認值
            const levelName = document.getElementById('diffrent-level-name');
            const levelActive = document.getElementById('diffrent-level-active');
            if (levelName) levelName.value = '新關卡';
            if (levelActive) levelActive.value = '1';
        });
    } else {
        console.error("建立新關卡按鈕不存在");
    }
    
    // 監聽添加關卡按鈕（在關卡列表中）
    const addLevelBtn = document.getElementById('add-diffrent-level-btn');
    if (addLevelBtn) {
        console.log("找到添加關卡按鈕");
        addLevelBtn.addEventListener('click', function() {
            console.log("點擊添加關卡按鈕");
            // 切換到編輯器分頁
            switchTab('diffrent-editor', document.querySelectorAll('.diffrent-game-tabs .tab-item'), document.querySelectorAll('.diffrent-game-container .tab-content'));
            
            // 顯示空白編輯器
            showDiffrentEditor();
            clearDiffrentEditor();
            currentDiffrentLevel = null;
            
            // 設置默認值
            const levelName = document.getElementById('diffrent-level-name');
            const levelActive = document.getElementById('diffrent-level-active');
            if (levelName) levelName.value = '新關卡';
            if (levelActive) levelActive.value = '1';
        });
    } else {
        console.error("添加關卡按鈕不存在");
    }
    
    // 監聽原圖上傳按鈕
    const leftUpload = document.getElementById('diffrent-left-upload');
    if (leftUpload) {
        leftUpload.addEventListener('change', function(e) {
            console.log("選擇原圖上傳");
            uploadDiffrentImage(e.target.files[0], 'left');
        });
    } else {
        console.error("原圖上傳按鈕不存在");
    }
    
    // 監聽修改版上傳按鈕
    const rightUpload = document.getElementById('diffrent-right-upload');
    if (rightUpload) {
        rightUpload.addEventListener('change', function(e) {
            console.log("選擇修改版上傳");
            uploadDiffrentImage(e.target.files[0], 'right');
        });
    } else {
        console.error("修改版上傳按鈕不存在");
    }
    
    // 監聽圖片URL輸入框
    const leftUrl = document.getElementById('diffrent-left-url');
    if (leftUrl) {
        leftUrl.addEventListener('input', function() {
            const leftImg = document.getElementById('diffrent-edit-left');
            if (leftImg) leftImg.src = this.value;
            updateDiffrentOutput();
        });
    }
    
    const rightUrl = document.getElementById('diffrent-right-url');
    if (rightUrl) {
        rightUrl.addEventListener('input', function() {
            const rightImg = document.getElementById('diffrent-edit-right');
            if (rightImg) rightImg.src = this.value;
            updateDiffrentOutput();
        });
    }
    
    // 監聽原圖點擊事件
    const editLeftImg = document.getElementById('diffrent-edit-left');
    if (editLeftImg) {
        editLeftImg.addEventListener('click', function(e) {
            console.log("點擊原圖添加差異點");
            addDiffrentDot(e, this);
        });
    } else {
        console.error("原圖元素不存在");
    }
    
    // 監聽保存按鈕
    const saveBtn = document.getElementById('diffrent-save-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            console.log("點擊保存按鈕");
            saveDiffrentData();
        });
    } else {
        console.error("保存按鈕不存在");
    }
    
    // 監聽清除按鈕
    const clearBtn = document.getElementById('diffrent-clear-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            console.log("點擊清除按鈕");
            clearDiffrentEditor();
        });
    } else {
        console.error("清除按鈕不存在");
    }
}

// 修正顯示編輯器函數
function showDiffrentEditor() {
    console.log("顯示編輯器");
    const editorContainer = document.querySelector('.editor-container');
    const placeholder = document.getElementById('diffrent-editor-placeholder');
    
    if (editorContainer) {
        editorContainer.style.display = 'block';
    } else {
        console.error("編輯器容器不存在");
    }
    
    if (placeholder) {
        placeholder.style.display = 'none';
    } else {
        console.error("編輯器預留位置不存在");
    }
}

// 修正保存找出不同遊戲資料函數
function saveDiffrentData() {
    console.log("執行保存找出不同遊戲資料");
    
    const levelName = document.getElementById('diffrent-level-name').value.trim();
    const isActive = document.getElementById('diffrent-level-active').value === '1';
    const leftImage = document.getElementById('diffrent-left-url').value.trim();
    const rightImage = document.getElementById('diffrent-right-url').value.trim();
    
    if (!levelName) {
        showAlert('請輸入關卡名稱', 'warning');
        return;
    }
    
    if (!leftImage || !rightImage) {
        showAlert('請上傳或輸入兩張圖片的 URL', 'warning');
        return;
    }
    
    if (diffrentEditorDifferences.length < 1) {
        showAlert('請至少添加一個差異點', 'warning');
        return;
    }
    
    // 將差異點排序，確保順序一致
    diffrentEditorDifferences.sort((a, b) => {
        // 先按照原始ID排序（如果有），否則按照創建順序排序
        if (a.id.includes('diff') && b.id.includes('diff')) {
            return parseInt(a.id.replace('diff', '')) - parseInt(b.id.replace('diff', ''));
        }
        return 0;
    });
    
    // 準備數據
    const levelData = {
        name: levelName,
        is_active: isActive,
        left_image_url: leftImage,
        right_image_url: rightImage
    };
    
    console.log("保存關卡數據:", levelData);
    console.log("差異點數據:", diffrentEditorDifferences);
    
    // 決定是更新還是創建
    const isUpdate = currentDiffrentLevel && currentDiffrentLevel.id;
    const url = isUpdate 
        ? `/api/diffrent-game/levels/${currentDiffrentLevel.id}` 
        : '/api/diffrent-game/levels';
    const method = isUpdate ? 'PUT' : 'POST';
    
    // 添加保存中的提示
    showAlert('正在保存...', 'info');
    
    // 發送關卡數據
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(levelData)
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('API端點不存在，請確認後端服務已正確設置');
            }
            throw new Error(`HTTP錯誤: ${response.status}`);
        }
        return response.json();
    })
    .then(responseData => {
        console.log("關卡保存成功:", responseData);
        
        // 獲取關卡 ID（新建的或現有的）
        const levelId = isUpdate ? currentDiffrentLevel.id : (responseData.id || responseData.level_id);
        
        if (!levelId) {
            throw new Error('無法獲取關卡ID，請檢查API響應格式');
        }
        
        // 準備差異點數據
        const differencesData = diffrentEditorDifferences.map(diff => ({
            level_id: levelId,
            description: diff.description,
            position_top: diff.position.top,
            position_left: diff.position.left
        }));
        
        // 發送差異點數據
        return fetch(`/api/diffrent-game/levels/${levelId}/differences`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(differencesData)
        });
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('差異點API端點不存在，請確認後端服務已正確設置');
            }
            throw new Error(`差異點保存失敗: HTTP錯誤 ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("差異點保存成功:", data);
        showAlert(isUpdate ? '關卡更新成功' : '關卡創建成功', 'success');
        
        // 重新載入關卡列表和選擇器
        loadDiffrentLevels();
        populateDiffrentLevelSelector();
        
        // 切換到關卡列表分頁
        switchTab('diffrent-levels-list', document.querySelectorAll('.diffrent-game-tabs .tab-item'), document.querySelectorAll('.diffrent-game-container .tab-content'));
    })
    .catch(error => {
        console.error('保存找出不同遊戲數據失敗:', error);
        showAlert('保存失敗：' + error.message, 'danger');
        
        // 如果是API不存在的問題，提供更詳細的說明
        if (error.message.includes('API端點不存在')) {
            alert(`
後端API未實現。要完成這個功能，您需要實現以下API:
1. ${url} - ${method} (保存關卡資訊)
2. /api/diffrent-game/levels/:levelId/differences - POST (保存差異點)

請先確認這些API端點已正確設置並且可用。
            `);
        }
    });
}

// 修正在圖片上添加差異點函數
function addDiffrentDot(e, imgElement) {
    console.log("執行添加差異點");
    // 先檢查圖片是否有載入
    if (!imgElement.complete || !imgElement.naturalWidth) {
        showAlert('請先上傳或設置圖片', 'warning');
        return;
    }
    
    const rect = imgElement.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    
    console.log(`點擊位置: (${x.toFixed(2)}%, ${y.toFixed(2)}%)`);
    
    const description = prompt('請輸入差異點描述：', `差異點 ${diffrentEditorDifferences.length + 1}`);
    if (description === null) return; // 用戶取消
    
    // 添加到數組
    diffrentEditorDifferences.push({
        id: `diff${Date.now()}`,
        description: description,
        position: {
            top: y,
            left: x
        }
    });
    
    console.log(`添加差異點: ${description} 在 (${x.toFixed(2)}%, ${y.toFixed(2)}%)`);
    
    // 在圖片上添加視覺元素
    addDiffrentDotElement(x, y, description);
    
    // 更新輸出和列表
    updateDiffrentOutput();
    updateDiffrentPointsList();
}

// 載入找出不同遊戲關卡列表
function loadDiffrentLevels() {
    const tbody = document.getElementById('diffrent-levels-tbody');
    if (!tbody) {
        console.error("找出不同遊戲關卡列表元素不存在");
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">載入中...</td></tr>';
    
    // 先檢查後端 API 是否可用
    fetch('/api/diffrent-game/levels')
        .then(response => {
            if (!response.ok) {
                // 如果API不可用，顯示友好的錯誤訊息
                if (response.status === 404) {
                    throw new Error('API端點不存在，請確認後端服務已正確設置');
                }
                throw new Error(`HTTP錯誤: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("載入找出不同遊戲關卡列表成功:", data);
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">目前沒有任何關卡</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            data.forEach((level, index) => {
                const tr = document.createElement('tr');
                const statusBadge = level.is_active ? 
                    '<span class="badge bg-success">啟用</span>' : 
                    '<span class="badge bg-secondary">停用</span>';
                
                tr.innerHTML = `
                    <td>${level.id}</td>
                    <td>${escapeHtml(level.name || `第${level.id}關`)}</td>
                    <td>2</td>
                    <td>${formatDate(level.created_at)}</td>
                    <td>${level.play_count || 0}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editDiffrentLevel(${level.id})">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDiffrentLevel(${level.id})">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('載入找出不同遊戲關卡列表失敗:', error);
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">載入失敗：${escapeHtml(error.message)}</td></tr>`;
            
            // 如果是API不存在的問題，提供更詳細的說明
            if (error.message.includes('API端點不存在')) {
                tbody.innerHTML += `
                    <tr>
                        <td colspan="7" class="px-4 pb-4">
                            <div class="alert alert-warning">
                                <strong>提示：</strong> 請確認以下事項：
                                <ol>
                                    <li>後端是否已經實作 <code>/api/diffrent-game/levels</code> API</li>
                                    <li>後端服務是否正常運行</li>
                                    <li>若尚未實作，請先建立一些測試關卡資料</li>
                                </ol>
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
}

// 載入找出不同遊戲排行榜
function loadDiffrentLeaderboard() {
    const tbody = document.getElementById('diffrent-leaderboard-tbody');
    if (!tbody) {
        console.error("找出不同遊戲排行榜元素不存在");
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">載入中...</td></tr>';
    
    fetch('/api/diffrent-game/leaderboard')
        .then(response => {
            if (!response.ok) {
                // 如果API不可用，顯示友好的錯誤訊息
                if (response.status === 404) {
                    throw new Error('API端點不存在，請確認後端服務已正確設置');
                }
                throw new Error(`HTTP錯誤: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("載入找出不同遊戲排行榜成功:", data);
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">目前沒有任何排行紀錄</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            data.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${escapeHtml(record.player_name || 'N/A')}</td>
                    <td>${record.time_seconds || 'N/A'}</td>
                    <td>${formatDate(record.created_at)}</td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('載入找出不同遊戲排行榜失敗:', error);
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">載入失敗：${escapeHtml(error.message)}</td></tr>`;
            
            // 如果是API不存在的問題，提供更詳細的說明
            if (error.message.includes('API端點不存在')) {
                tbody.innerHTML += `
                    <tr>
                        <td colspan="4" class="px-4 pb-4">
                            <div class="alert alert-warning">
                                <strong>提示：</strong> 請確認以下事項：
                                <ol>
                                    <li>後端是否已經實作 <code>/api/diffrent-game/leaderboard</code> API</li>
                                    <li>後端服務是否正常運行</li>
                                </ol>
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
}

// 填充關卡選擇器
function populateDiffrentLevelSelector() {
    const selector = document.getElementById('diffrent-level-selector');
    if (!selector) {
        console.error("找出不同遊戲關卡選擇器元素不存在");
        return;
    }
    
    // 保留第一個"請選擇關卡"選項
    selector.innerHTML = '<option value="">請選擇關卡</option>';
    
    fetch('/api/diffrent-game/levels')
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('API端點不存在');
                }
                throw new Error(`HTTP錯誤: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("填充關卡選擇器成功:", data);
            
            if (data && Array.isArray(data)) {
                data.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.id;
                    option.textContent = level.name || `第${level.id}關`;
                    selector.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('填充關卡選擇器失敗:', error);
            
            // 添加一個提示選項
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "載入關卡失敗";
            option.disabled = true;
            selector.appendChild(option);
            
            // 顯示錯誤提示
            showAlert('無法載入關卡列表：' + error.message, 'danger');
        });
}

// 顯示編輯器並隱藏預留位置
function showDiffrentEditor() {
    const editorContainer = document.querySelector('.editor-container');
    const placeholder = document.getElementById('diffrent-editor-placeholder');
    
    if (editorContainer) editorContainer.style.display = 'block';
    if (placeholder) placeholder.style.display = 'none';
}

// 隱藏編輯器並顯示預留位置
function hideDiffrentEditor() {
    const editorContainer = document.querySelector('.editor-container');
    const placeholder = document.getElementById('diffrent-editor-placeholder');
    
    if (editorContainer) editorContainer.style.display = 'none';
    if (placeholder) placeholder.style.display = 'block';
}

// 載入關卡到編輯器
function loadDiffrentLevelToEditor(levelId) {
    console.log(`載入關卡 ID: ${levelId} 到編輯器`);
    showDiffrentEditor();
    clearDiffrentEditor();
    
    fetch(`/api/diffrent-game/levels/${levelId}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('API端點不存在，請確認後端服務已正確設置');
                }
                throw new Error(`HTTP錯誤: ${response.status}`);
            }
            return response.json();
        })
        .then(level => {
            console.log(`成功載入關卡數據:`, level);
            currentDiffrentLevel = level;
            
            // 設置圖片
            const leftImg = document.getElementById('diffrent-edit-left');
            const rightImg = document.getElementById('diffrent-edit-right');
            const leftUrl = document.getElementById('diffrent-left-url');
            const rightUrl = document.getElementById('diffrent-right-url');
            
            if (leftImg && level.left_image_url) leftImg.src = level.left_image_url;
            if (rightImg && level.right_image_url) rightImg.src = level.right_image_url;
            if (leftUrl && level.left_image_url) leftUrl.value = level.left_image_url;
            if (rightUrl && level.right_image_url) rightUrl.value = level.right_image_url;
            
            // 設置關卡信息
            const levelName = document.getElementById('diffrent-level-name');
            const levelActive = document.getElementById('diffrent-level-active');
            
            if (levelName) levelName.value = level.name || '';
            if (levelActive) levelActive.value = level.is_active ? '1' : '0';
            
            // 載入差異點
            loadDiffrentDifferences(level.id);
        })
        .catch(error => {
            console.error('載入找出不同遊戲關卡失敗:', error);
            showAlert('無法載入關卡：' + error.message, 'danger');
            hideDiffrentEditor();
            
            // 如果是API不存在的問題，提供更詳細的說明
            if (error.message.includes('API端點不存在')) {
                alert(`
後端API未實現。要完成這個功能，您需要實現以下API:
/api/diffrent-game/levels/${levelId} - GET (獲取關卡詳情)

請先確認此API端點已正確設置並且可用。
                `);
            }
        });
}

// 載入差異點
function loadDiffrentDifferences(levelId) {
    console.log(`載入關卡 ID: ${levelId} 的差異點`);
    
    fetch(`/api/diffrent-game/differences/${levelId}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('API端點不存在，請確認後端服務已正確設置');
                }
                throw new Error(`HTTP錯誤: ${response.status}`);
            }
            return response.json();
        })
        .then(differences => {
            console.log(`成功載入差異點數據:`, differences);
            diffrentEditorDifferences = [];
            
            if (differences && Array.isArray(differences)) {
                differences.forEach((diff, index) => {
                    diffrentEditorDifferences.push({
                        id: diff.id || `diff${index + 1}`,
                        description: diff.description || `差異點 ${index + 1}`,
                        position: {
                            top: diff.position_top || 0,
                            left: diff.position_left || 0
                        }
                    });
                    
                    // 在圖片上添加差異點
                    addDiffrentDotElement(diff.position_left, diff.position_top, diff.description);
                });
                
                console.log(`成功添加 ${differences.length} 個差異點到編輯器`);
            } else {
                console.log('未找到差異點或格式不正確');
            }
            
            updateDiffrentOutput();
            updateDiffrentPointsList();
        })
        .catch(error => {
            console.error('載入找出不同遊戲差異點失敗:', error);
            showAlert('無法載入差異點：' + error.message, 'danger');
            
            // 如果是API不存在的問題，提供更詳細的說明
            if (error.message.includes('API端點不存在')) {
                alert(`
後端API未實現。要完成這個功能，您需要實現以下API:
/api/diffrent-game/differences/${levelId} - GET (獲取差異點列表)

請先確認此API端點已正確設置並且可用。
                `);
            }
        });
}

// 在圖片上添加差異點（通過點擊）
function addDiffrentDot(e, imgElement) {
    const rect = imgElement.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    
    const description = prompt('請輸入差異點描述：', `差異點 ${diffrentEditorDifferences.length + 1}`);
    if (description === null) return; // 用戶取消
    
    // 添加到數組
    diffrentEditorDifferences.push({
        id: `diff${Date.now()}`,
        description: description,
        position: {
            top: y,
            left: x
        }
    });
    
    // 在圖片上添加視覺元素
    addDiffrentDotElement(x, y, description);
    
    // 更新輸出和列表
    updateDiffrentOutput();
    updateDiffrentPointsList();
}

// 添加差異點視覺元素
function addDiffrentDotElement(left, top, description) {
    const leftImg = document.getElementById('diffrent-edit-left');
    if (!leftImg) return;
    
    const dot = document.createElement('div');
    dot.className = 'position-absolute';
    dot.style.left = `${left}%`;
    dot.style.top = `${top}%`;
    dot.style.width = '30px';
    dot.style.height = '30px';
    dot.style.borderRadius = '50%';
    dot.style.border = '2px solid red';
    dot.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
    dot.style.transform = 'translate(-50%, -50%)';
    dot.style.cursor = 'move';
    dot.setAttribute('data-index', diffrentEditorDifferences.length - 1);
    dot.setAttribute('title', description);
    
    // 將其附加到父容器
    leftImg.parentElement.appendChild(dot);
    
    // 添加拖動功能
    makeDiffrentDotDraggable(dot);
}

// 使差異點可拖動
function makeDiffrentDotDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    element.onmousedown = dragMouseDown;
    
    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // 獲取滑鼠位置
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }
    
    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // 計算新位置
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // 獲取父容器
        const parent = element.parentElement;
        const rect = parent.getBoundingClientRect();
        
        // 計算新的百分比位置
        let newLeft = ((element.offsetLeft - pos1) / rect.width) * 100;
        let newTop = ((element.offsetTop - pos2) / rect.height) * 100;
        
        // 限制在範圍內
        newLeft = Math.max(0, Math.min(100, newLeft));
        newTop = Math.max(0, Math.min(100, newTop));
        
        // 更新元素位置
        element.style.left = newLeft + '%';
        element.style.top = newTop + '%';
        
        // 更新數據
        const index = element.getAttribute('data-index');
        if (index && diffrentEditorDifferences[index]) {
            diffrentEditorDifferences[index].position.left = newLeft;
            diffrentEditorDifferences[index].position.top = newTop;
            updateDiffrentOutput();
            updateDiffrentPointsList();
        }
    }
    
    function closeDragElement() {
        // 停止移動
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

// 更新差異點列表
function updateDiffrentPointsList() {
    const tbody = document.getElementById('diffrent-points-list');
    if (!tbody) return;
    
    if (diffrentEditorDifferences.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">無差異點</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    diffrentEditorDifferences.forEach((diff, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${escapeHtml(diff.description)}</td>
            <td>${diff.position.left.toFixed(2)}%, ${diff.position.top.toFixed(2)}%</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="removeDiffrentPoint(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 移除差異點
window.removeDiffrentPoint = function(index) {
    // 移除視覺元素
    const dots = document.querySelectorAll('#diffrent-edit-left ~ div[data-index]');
    dots.forEach(dot => {
        const dotIndex = parseInt(dot.getAttribute('data-index'));
        if (dotIndex === index) {
            dot.remove();
        } else if (dotIndex > index) {
            dot.setAttribute('data-index', dotIndex - 1);
        }
    });
    
    // 從數組中移除
    diffrentEditorDifferences.splice(index, 1);
    
    // 更新輸出和列表
    updateDiffrentOutput();
    updateDiffrentPointsList();
};

// 更新輸出區域
function updateDiffrentOutput() {
    const outputArea = document.getElementById('diffrent-output');
    if (!outputArea) return;
    
    const leftUrl = document.getElementById('diffrent-left-url').value;
    const rightUrl = document.getElementById('diffrent-right-url').value;
    
    const outputData = {
        leftImage: leftUrl,
        rightImage: rightUrl,
        differences: diffrentEditorDifferences.map(diff => ({
            id: diff.id,
            description: diff.description,
            position: diff.position
        }))
    };
    
    outputArea.textContent = JSON.stringify(outputData, null, 2);
}

// 清除編輯器
function clearDiffrentEditor() {
    // 清除差異點數組
    diffrentEditorDifferences = [];
    
    // 清除圖片
    const leftImg = document.getElementById('diffrent-edit-left');
    const rightImg = document.getElementById('diffrent-edit-right');
    const leftUrl = document.getElementById('diffrent-left-url');
    const rightUrl = document.getElementById('diffrent-right-url');
    
    if (leftImg) leftImg.src = '';
    if (rightImg) rightImg.src = '';
    if (leftUrl) leftUrl.value = '';
    if (rightUrl) rightUrl.value = '';
    
    // 移除所有差異點視覺元素
    const leftImgParent = leftImg ? leftImg.parentElement : null;
    if (leftImgParent) {
        const dots = leftImgParent.querySelectorAll('div[data-index]');
        dots.forEach(dot => dot.remove());
    }
    
    // 清除列表和輸出
    updateDiffrentPointsList();
    updateDiffrentOutput();
    
    // 重置當前關卡
    currentDiffrentLevel = null;
}

// 上傳圖片
function uploadDiffrentImage(file, side) {
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/admin/files/upload', {
        method: 'POST',
        body: formData
    })
    .then(handleFetchResponse)
    .then(response => {
        if (response.success && response.file && response.file.file_path) {
            const imageUrl = response.file.file_path;
            if (side === 'left') {
                document.getElementById('diffrent-left-url').value = imageUrl;
                document.getElementById('diffrent-edit-left').src = imageUrl;
            } else if (side === 'right') {
                document.getElementById('diffrent-right-url').value = imageUrl;
                document.getElementById('diffrent-edit-right').src = imageUrl;
            }
            updateDiffrentOutput();
            showAlert('圖片上傳成功', 'success');
        } else {
            throw new Error('伺服器返回無效的響應');
        }
    })
    .catch(error => {
        console.error('上傳圖片失敗:', error);
        showAlert('上傳圖片失敗：' + error.message, 'danger');
    });
}

// 編輯關卡
window.editDiffrentLevel = function(levelId) {
    console.log(`執行編輯關卡 ID: ${levelId}`);
    
    // 切換到編輯器分頁
    switchTab('diffrent-editor', document.querySelectorAll('.diffrent-game-tabs .tab-item'), document.querySelectorAll('.diffrent-game-container .tab-content'));
    
    // 設置關卡選擇器
    const levelSelector = document.getElementById('diffrent-level-selector');
    if (levelSelector) {
        levelSelector.value = levelId;
        console.log(`設置關卡選擇器為 ID: ${levelId}`);
        
        // 觸發 change 事件
        const event = new Event('change');
        levelSelector.dispatchEvent(event);
    } else {
        console.error("找出不同遊戲關卡選擇器不存在");
        // 直接載入
        loadDiffrentLevelToEditor(levelId);
    }
};

// 刪除關卡
window.deleteDiffrentLevel = function(levelId) {
    console.log(`準備刪除關卡 ID: ${levelId}`);
    
    if (confirm(`確定要刪除 ID 為 ${levelId} 的關卡嗎？此操作無法復原！`)) {
        console.log(`確認刪除關卡 ID: ${levelId}`);
        
        fetch(`/api/diffrent-game/levels/${levelId}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('API端點不存在，請確認後端服務已正確設置');
                    }
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                
                // DELETE 可能返回空值
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    return {};
                }
            })
            .then(data => {
                console.log(`成功刪除關卡 ID: ${levelId}`);
                showAlert('關卡刪除成功', 'success');
                loadDiffrentLevels();
                populateDiffrentLevelSelector();
                
                // 如果正在編輯該關卡，則清除編輯器
                if (currentDiffrentLevel && currentDiffrentLevel.id === levelId) {
                    clearDiffrentEditor();
                    hideDiffrentEditor();
                }
            })
            .catch(error => {
                console.error('刪除找出不同遊戲關卡失敗:', error);
                showAlert('刪除失敗：' + error.message, 'danger');
                
                // 如果是API不存在的問題，提供更詳細的說明
                if (error.message.includes('API端點不存在')) {
                    alert(`
後端API未實現。要完成這個功能，您需要實現以下API:
/api/diffrent-game/levels/${levelId} - DELETE (刪除關卡)

請先確認此API端點已正確設置並且可用。
                    `);
                }
            });
    }
};

// 添加到初始化標籤切換邏輯中
function initializeTabSwitching() {
    // ... existing code ...
    
    // 找出不同遊戲管理的子標籤頁切換
    const diffrentGameTabs = document.querySelectorAll('.diffrent-game-tabs .tab-item');
    const diffrentGameTabContents = document.querySelectorAll('.diffrent-game-container .tab-content');
    
    diffrentGameTabs.forEach(item => {
        item.addEventListener('click', function() {
            switchTab(this.getAttribute('data-tab'), diffrentGameTabs, diffrentGameTabContents);
        });
    });
}

// 添加根據 URL 參數初始化活動標籤的函數
function initActiveTabFromUrl() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        const subtab = urlParams.get('subtab');
        
        if (tab) {
            console.log(`根據 URL 參數切換到標籤: ${tab}`);
            
            // 切換到指定的主標籤
            const mainTabs = document.querySelectorAll('.tabs-nav .tab-item:not(.same-game-tabs .tab-item):not(.diffrent-game-tabs .tab-item)');
            const mainTabContents = document.querySelectorAll('.admin-container > .tab-content');
            
            const tabElement = document.querySelector(`.tab-item[data-tab="${tab}"]`);
            if (tabElement) {
                switchTab(tab, mainTabs, mainTabContents);
                
                // 如果指定了子標籤，進一步切換
                if (subtab) {
                    console.log(`根據 URL 參數切換到子標籤: ${subtab}`);
                    
                    // 根據主標籤決定子標籤選擇器和內容選擇器
                    let subtabItems, subtabContents;
                    
                    if (tab === 'same-game') {
                        subtabItems = document.querySelectorAll('.same-game-tabs .tab-item');
                        subtabContents = document.querySelectorAll('.same-game-container .tab-content');
                    } else if (tab === 'diffrent-game') {
                        subtabItems = document.querySelectorAll('.diffrent-game-tabs .tab-item');
                        subtabContents = document.querySelectorAll('.diffrent-game-container .tab-content');
                    }
                    
                    if (subtabItems && subtabContents) {
                        const subtabElement = document.querySelector(`.tab-item[data-tab="${subtab}"]`);
                        if (subtabElement) {
                            switchTab(subtab, subtabItems, subtabContents);
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.error('初始化標籤頁時出錯:', error);
    }
}

        // --- End: Integrated JavaScript ---
   </script>
</body>
</html> 